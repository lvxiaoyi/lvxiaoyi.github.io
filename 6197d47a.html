<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>jvm基础3之性能监控与调优篇 | 吕小医's BLOG</title><meta name="keywords" content="jvm"><meta name="author" content="lvxiaoyi"><meta name="copyright" content="lvxiaoyi"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="jvm基础3之性能监控与调优篇">
<meta property="og:type" content="article">
<meta property="og:title" content="jvm基础3之性能监控与调优篇">
<meta property="og:url" content="https://lvxiaoyi.top/6197d47a.html">
<meta property="og:site_name" content="吕小医&#39;s BLOG">
<meta property="og:description" content="jvm基础3之性能监控与调优篇">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://img.lvxiaoyi.top/typora-img/202111011421399.jpeg/lvxiaoyi">
<meta property="article:published_time" content="2022-09-12T07:22:48.760Z">
<meta property="article:modified_time" content="2022-09-12T07:22:48.761Z">
<meta property="article:author" content="lvxiaoyi">
<meta property="article:tag" content="jvm">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://img.lvxiaoyi.top/typora-img/202111011421399.jpeg/lvxiaoyi"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://lvxiaoyi.top/6197d47a"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":true,"languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'jvm基础3之性能监控与调优篇',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-09-12 15:22:48'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 5.4.0"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://p0.meituan.net/csc/8a1b1d488e6a8ab5108c9c78f36b3a1776955.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">204</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">26</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">50</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 小医</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://img.lvxiaoyi.top/typora-img/202111011421399.jpeg/lvxiaoyi')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">吕小医's BLOG</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 小医</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">jvm基础3之性能监控与调优篇</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2022-09-12T07:22:48.760Z" title="发表于 2022-09-12 15:22:48">2022-09-12</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2022-09-12T07:22:48.761Z" title="更新于 2022-09-12 15:22:48">2022-09-12</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/jvm/">jvm</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/jvm/jvm%E7%90%86%E8%AE%BA/">jvm理论</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="jvm基础3之性能监控与调优篇"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="jvm基础3之性能监控与调优篇"><a href="#jvm基础3之性能监控与调优篇" class="headerlink" title="jvm基础3之性能监控与调优篇"></a>jvm基础3之性能监控与调优篇</h1><span id="more"></span>

<h1 id="概述篇"><a href="#概述篇" class="headerlink" title="概述篇"></a>概述篇</h1><h2 id="大厂面试题"><a href="#大厂面试题" class="headerlink" title="大厂面试题"></a>大厂面试题</h2><blockquote>
<p>支付宝：</p>
<p>支付宝三面：JVM 性能调优都做了什么？</p>
<p>小米：</p>
<p>有做过 JVM 内存优化吗？</p>
<p>从 SQL、JVM、架构、数据库四个方面讲讲优化思路</p>
<p>蚂蚁金服：</p>
<p>JVM 的编译优化</p>
<p>jvm 性能调优都做了什么</p>
<p>JVM 诊断调优工具用过哪些？</p>
<p>二面：jvm 怎样调优，堆内存、栈空间设置多少合适</p>
<p>三面：JVM 相关的分析工具使用过的有哪些？具体的性能调优步骤如何</p>
<p>阿里：</p>
<p>如何进行 JVM 调优？有哪些方法？</p>
<p>如何理解内存泄漏问题？有哪些情况会导致内存泄漏？如何解决？</p>
<p>字节跳动：</p>
<p>三面：JVM 如何调优、参数怎么调？</p>
<p>拼多多：</p>
<p>从 SQL、JVM、架构、数据库四个方面讲讲优化思路</p>
<p>京东：</p>
<p>JVM 诊断调优工具用过哪些？</p>
<p>每秒几十万并发的秒杀系统为什么会频繁发生 GC？</p>
<p>日均百万级交易系统如何优化 JVM？</p>
<p>线上生产系统 OOM 如何监控及定位与解决？</p>
<p>高并发系统如何基于 G1 垃圾回收器优化性能？</p>
</blockquote>
<h2 id="背景说明"><a href="#背景说明" class="headerlink" title="背景说明"></a>背景说明</h2><h3 id="生产环境中的问题"><a href="#生产环境中的问题" class="headerlink" title="生产环境中的问题"></a><strong>生产环境中的问题</strong></h3><ul>
<li>生产环境发生了内存溢出该如何处理？</li>
<li>生产环境应该给服务器分配多少内存合适？</li>
<li>如何对垃圾回收器的性能进行调优？</li>
<li>生产环境 CPU 负载飙高该如何处理？</li>
<li>生产环境应该给应用分配多少线程合适？</li>
<li>不加 log，如何确定请求是否执行了某一行代码？</li>
<li>不加 log，如何实时查看某个方法的入参与返回值？</li>
</ul>
<h3 id="为什么要调优"><a href="#为什么要调优" class="headerlink" title="为什么要调优"></a><strong>为什么要调优</strong></h3><ul>
<li>防止出现 OOM</li>
<li>解决 OOM</li>
<li>减少 Full GC 出现的频率</li>
</ul>
<h3 id="不同阶段的考虑"><a href="#不同阶段的考虑" class="headerlink" title="不同阶段的考虑"></a><strong>不同阶段的考虑</strong></h3><ul>
<li>上线前</li>
<li>项目运行阶段</li>
<li>线上出现 OOM</li>
</ul>
<h2 id="调优概述"><a href="#调优概述" class="headerlink" title="调优概述"></a>调优概述</h2><h3 id="监控的依据"><a href="#监控的依据" class="headerlink" title="监控的依据"></a><strong>监控的依据</strong></h3><ul>
<li>运行日志</li>
<li>异常堆栈</li>
<li>GC 日志</li>
<li>线程快照</li>
<li>堆转储快照</li>
</ul>
<h3 id="调优的大方向"><a href="#调优的大方向" class="headerlink" title="调优的大方向"></a><strong>调优的大方向</strong></h3><ul>
<li>合理地编写代码</li>
<li>充分并合理的使用硬件资源</li>
<li>合理地进行 JVM 调优</li>
</ul>
<h2 id="性能优化的步骤"><a href="#性能优化的步骤" class="headerlink" title="性能优化的步骤"></a>性能优化的步骤</h2><h3 id="第-1-步：性能监控"><a href="#第-1-步：性能监控" class="headerlink" title="第 1 步：性能监控"></a><strong>第 1 步：性能监控</strong></h3><p>一种以非强行或者入侵方式<strong>收集或查看</strong>应用运营性能数据的活动。</p>
<p>监控通常是指一种在生产、质量评估或者开发环境下实施的带有预防或主动性的活动。</p>
<p>当应用相关干系人提出性能问题却没有提供足够多的线索时，首先我们需要进行性能监控，随后是性能分析。</p>
<ul>
<li>GC 频繁</li>
<li>cpu load 过高</li>
<li>OOM</li>
<li>内存泄露</li>
<li>死锁</li>
<li>程序响应时间较长</li>
</ul>
<h3 id="第-2-步：性能分析"><a href="#第-2-步：性能分析" class="headerlink" title="第 2 步：性能分析"></a><strong>第 2 步：性能分析</strong></h3><p>一种以侵入方式收集运行性能数据的活动，它会影响应用的吞吐量或响应性。</p>
<p>性能分析是针对性能问题的答复结果，关注的范围通常比性能监控更加集中。</p>
<p>性能分析很少在生产环境下进行，通常是在质量评估、系统测试或者开发环境下进行，是性能监控之后的步骤。</p>
<ul>
<li>打印 GC 日志，通过 GCviewer 或者 <a target="_blank" rel="noopener" href="http://gceasy.io/">http://gceasy.io</a> 来分析异常信息</li>
<li>灵活运用命令行工具、jstack、jmap、jinfo 等</li>
<li>dump 出堆文件，使用内存分析工具分析文件</li>
<li>使用阿里 Arthas、jconsole、JVisualVM 来实时查看 JVM 状态</li>
<li>jstack 查看堆栈信息</li>
</ul>
<h3 id="第-3-步：性能调优"><a href="#第-3-步：性能调优" class="headerlink" title="第 3 步：性能调优"></a><strong>第 3 步：性能调优</strong></h3><p>一种为改善应用响应性或香吐量而更改参数、源代码、属性配置的活动，性能调优是在性能监控、性能分析之后的活动。</p>
<ul>
<li>适当增加内存，根据业务背景选择垃圾回收器</li>
<li>优化代码，控制内存使用</li>
<li>增加机器，分散节点压力</li>
<li>合理设置线程池线程数量</li>
<li>使用中间件提高程序效率，比如缓存、消息队列等</li>
<li>其他……</li>
</ul>
<h2 id="性能评价-测试指标"><a href="#性能评价-测试指标" class="headerlink" title="性能评价/测试指标"></a>性能评价/测试指标</h2><h3 id="停顿时间（或响应时间）"><a href="#停顿时间（或响应时间）" class="headerlink" title="停顿时间（或响应时间）"></a><strong>停顿时间（或响应时间）</strong></h3><p>提交请求和返回该请求的响应之间使用的时间，一般比较关注平均响应时间。常用操作的响应时间列表：</p>
<table>
<thead>
<tr>
<th>操作</th>
<th>响应时间</th>
</tr>
</thead>
<tbody><tr>
<td>打开一个站点</td>
<td>几秒</td>
</tr>
<tr>
<td>数据库查询一条记录（有索引）</td>
<td>十几毫秒</td>
</tr>
<tr>
<td>机械磁盘一次寻址定位</td>
<td>4 毫秒</td>
</tr>
<tr>
<td>从机械磁盘顺序读取 1M 数据</td>
<td>2 毫秒</td>
</tr>
<tr>
<td>从 SSD 磁盘顺序读取 1M 数据</td>
<td>0.3 毫秒</td>
</tr>
<tr>
<td>从远程分布式换成 Redis 读取一个数据</td>
<td>0.5 毫秒</td>
</tr>
<tr>
<td>从内存读取 1M 数据</td>
<td>十几微妙</td>
</tr>
<tr>
<td>Java 程序本地方法调用</td>
<td>几微妙</td>
</tr>
<tr>
<td>网络传输 2Kb 数据</td>
<td>1 微妙</td>
</tr>
</tbody></table>
<p>在垃圾回收环节中：</p>
<ul>
<li>暂停时间：执行垃圾收集时，程序的工作线程被暂停的时间。<ul>
<li>STW</li>
</ul>
</li>
<li>-XX:MaxGCPauseMillis</li>
</ul>
<h3 id="吞吐量"><a href="#吞吐量" class="headerlink" title="吞吐量"></a><strong>吞吐量</strong></h3><ul>
<li>对单位时间内完成的工作量（请求）的量度</li>
<li>在 GC 中：运行用户代码的事件占总运行时间的比例（总运行时间：程序的运行时间+内存回收的时间）</li>
<li>吞吐量为 1-1/(1+n)，其中-XX::GCTimeRatio=n</li>
</ul>
<h3 id="并发数"><a href="#并发数" class="headerlink" title="并发数"></a><strong>并发数</strong></h3><ul>
<li>同一时刻，对服务器有实际交互的请求数<ul>
<li>网站在线用户，估计并发数在5%-15%之间</li>
<li>例如：1000人同时在线，并发数在50-150之间</li>
</ul>
</li>
</ul>
<h3 id="内存占用"><a href="#内存占用" class="headerlink" title="内存占用"></a><strong>内存占用</strong></h3><ul>
<li>Java 堆区所占的内存大小</li>
</ul>
<h3 id="相互间的关系"><a href="#相互间的关系" class="headerlink" title="相互间的关系"></a><strong>相互间的关系</strong></h3><p>以高速公路通行状况为例</p>
<ul>
<li>吞吐量：每天通过高速公路收费站的车辆的数据</li>
<li>并发数：高速公路上正在行驶的车辆的数目</li>
<li>响应时间：车速</li>
</ul>
<h1 id="JVM-监控及诊断工具-命令行篇"><a href="#JVM-监控及诊断工具-命令行篇" class="headerlink" title="JVM 监控及诊断工具-命令行篇"></a>JVM 监控及诊断工具-命令行篇</h1><h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>性能诊断是软件工程师在日常工作中需要经常面对和解决的问题，在<strong>用户体验</strong>至上的今天，解决好应用的性能问题能带来非常大的收益。</p>
<p>Java 作为最流行的编程语言之一，其应用性能诊断一直受到业界广泛关注。可能造成 Java 应用出现性能问题的因素非常多，例如线程控制、磁盘读写、数据库访问、网络 I/O、垃圾收集等。想要定位这些问题，一款优秀的性能诊断工具必不可少。</p>
<p>体会 1：==使用数据说明问题，使用知识分析问题，使用工具处理问题==。</p>
<p>体会 2：==无监控、不调优！==</p>
<p><strong>简单命令行工具</strong></p>
<p>在我们刚接触 java 学习的时候，大家肯定最先了解的两个命令就是 javac，java，那么除此之外，还有没有其他的命令可以供我们使用呢？</p>
<p>我们进入到安装 jdk 的 bin 目录，发现还有一系列辅助工具。这些辅助工具用来获取目标 JVM 不同方面、不同层次的信息，帮助开发人员很好地解决 Java 应用程序的一些疑难杂症。</p>
<p>mac系统下：</p>
<img src="https://img.lvxiaoyi.top/typora-img/202111021340757.png/lvxiaoyi" alt="image-20210504195803526" style="zoom: 67%;" />

<p>Windows系统下：</p>
<img src="https://img.lvxiaoyi.top/typora-img/image-20210927161412430.png/lvxiaoyi" alt="image-20210927161412430" style="zoom: 50%;" />

<img src="https://img.lvxiaoyi.top/typora-img/image-20210927161650207.png/lvxiaoyi" alt="image-20210927161650207" style="zoom:67%;" />

<p>官方源码地址：<a target="_blank" rel="noopener" href="http://hg.openjdk.java.net/jdk/jdk11/file/1ddf9a99e4ad/src/jdk.jcmd/share/classes/sun/tools">http://hg.openjdk.java.net/jdk/jdk11/file/1ddf9a99e4ad/src/jdk.jcmd/share/classes/sun/tools</a></p>
<h2 id="jps：查看正在运行的-Java-进程"><a href="#jps：查看正在运行的-Java-进程" class="headerlink" title="jps：查看正在运行的 Java 进程"></a>jps：查看正在运行的 Java 进程</h2><h3 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h3><p>jps(Java Process Status)：</p>
<p>显示指定系统内所有的 HotSpot 虚拟机进程（查看虚拟机进程信息），可用于查询正在运行的虚拟机进程。</p>
<p>说明：对于本地虚拟机进程来说，进程的本地虚拟机 ID 与操作系统的进程 ID 是一致的，是唯一的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> lvxiaoyi</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021/9/27 16:37</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ScannerTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Scanner scanner = <span class="keyword">new</span> Scanner(System.in);</span><br><span class="line">        String info = scanner.next();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\Think&gt;jps</span><br><span class="line"><span class="comment"># java.exe，我的idea的插件</span></span><br><span class="line">23336 RemoteMavenServer</span><br><span class="line"><span class="comment"># idea的运行程序</span></span><br><span class="line">21428 </span><br><span class="line"><span class="comment"># jps程序</span></span><br><span class="line">12544 Jps</span><br><span class="line"><span class="comment"># 我们的运行程序</span></span><br><span class="line">6604 ScannerTest</span><br><span class="line"><span class="comment"># 虚拟机的类加载器，所有类加载器的父类</span></span><br><span class="line">13880 Launcher</span><br></pre></td></tr></table></figure>

<p>基本使用语法为：jps [options] [hostid]</p>
<p>我们还可以通过追加参数，来打印额外的信息。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\Think&gt;jps -<span class="built_in">help</span></span><br><span class="line">usage: jps [-<span class="built_in">help</span>]</span><br><span class="line">       jps [-q] [-mlvV] [&lt;hostid&gt;]</span><br><span class="line"></span><br><span class="line">Definitions:</span><br><span class="line">    &lt;hostid&gt;:      &lt;hostname&gt;[:&lt;port&gt;]</span><br></pre></td></tr></table></figure>

<h3 id="options-参数"><a href="#options-参数" class="headerlink" title="options 参数"></a><strong>options 参数</strong></h3><ul>
<li><p>-q：仅仅显示 LVMID（local virtual machine id），即本地虚拟机唯一 id。不显示主类的名称等</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\Think&gt;jps -q</span><br><span class="line">21428</span><br><span class="line">13880</span><br><span class="line">23336</span><br><span class="line">7128</span><br><span class="line">6604</span><br></pre></td></tr></table></figure></li>
<li><p>-l：输出应用程序主类的全类名 或 如果进程执行的是 jar 包，则输出 jar 完整路径</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\Think&gt;jps -l</span><br><span class="line">14804 sun.tools.jps.Jps</span><br><span class="line">21428</span><br><span class="line">13880 org.jetbrains.jps.cmdline.Launcher</span><br><span class="line">23336 org.jetbrains.idea.maven.server.RemoteMavenServer</span><br><span class="line">6604 top.lvxiaoyi.three.chapter02.code02.ScannerTest</span><br></pre></td></tr></table></figure></li>
<li><p>-m：输出虚拟机进程启动时传递给主类 main()的参数</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\Think&gt;jps -m</span><br><span class="line">21428</span><br><span class="line"></span><br><span class="line">13880 Launcher </span><br><span class="line">D:/ideaJetBrains/IntelliJIDEA2019.3/lib/trove4j.jar;</span><br><span class="line">D:/ideaJetBrains/IntelliJIDEA2019.3/plugins/java/lib/maven-builder-support3.3.9.jar;</span><br><span class="line">D:/ideaJetBrains/IntelliJIDEA2019.3/lib/util.jar;</span><br><span class="line">D:/ideaJetBrains/IntelliJIDEA2019.3/lib/jna-platform.jar;</span><br><span class="line">D:/ideaJetBrains/IntelliJIDEA2019.3/plugins/java/lib/maven-aether-provider-3.3.9.jar;</span><br><span class="line">D:/ideaJetBrains/IntelliJIDEA2019.3/lib/netty-codec-4.1.41.Final.jar;</span><br><span class="line">D:/ideaJetBrains/IntelliJIDEA2019.3/lib/netty-buffer-4.1.41.Final.jar;</span><br><span class="line">D:/ideaJetBrains/IntelliJIDEA2019.3/lib/protobuf-java-3.5.1.jar;</span><br><span class="line">D:/ideaJetBrains/IntelliJIDEA2019.3/lib/annotations.jar;</span><br><span class="line">D:/ideaJetBrains/IntelliJIDEA2019.3/lib/httpcore-4.4.12.jar;</span><br><span class="line">D:/ideaJetBrains/IntelliJIDEA2019.3/plugins/java/lib/javac2.jar;</span><br><span class="line">D:/ideaJetBrains/IntelliJIDEA2019.3/plugins/java/lib/maven-repository-metadata-3.3.9.jar;</span><br><span class="line">D:/ideaJetBrains/IntelliJIDEA2019.3/plugins/java/lib/maven-artifact-3.3.9.jar;</span><br><span class="line">D:/ideaJetBrains/IntelliJIDEA2019.3/plugins/java/lib/aether-spi-1.1.0.jar;</span><br><span class="line">D:/ideaJetBrains/IntelliJIDEA2019.3/p</span><br><span class="line"></span><br><span class="line">23336 RemoteMavenServer</span><br><span class="line"></span><br><span class="line">23932 Jps -m</span><br><span class="line"></span><br><span class="line">6604 ScannerTest</span><br></pre></td></tr></table></figure></li>
<li><p>-v：列出虚拟机进程启动时的 JVM 参数。比如：-Xms20m -Xmx50m 是启动程序指定的 jvm 参数。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\Think&gt;jps -v</span><br><span class="line">21428  <span class="built_in">exit</span> -Xms128m -Xmx2035m -XX:ReservedCodeCacheSize=240m -XX:+UseConcMarkSweepGC -XX:SoftRefLRUPolicyMSPerMB=50 -ea -XX:CICompilerCount=2 -Dsun.io.useCanonPrefixCache=<span class="literal">false</span> -Djava.net.preferIPv4Stack=<span class="literal">true</span> -Djdk.http.auth.tunneling.disabledSchemes=<span class="string">&quot;&quot;</span> -XX:+HeapDumpOnOutOfMemoryError -XX:-OmitStackTraceInFastThrow -Djdk.attach.allowAttachSelf=<span class="literal">true</span> -Dkotlinx.coroutines.debug=off -Djdk.module.illegalAccess.silent=<span class="literal">true</span> -javaagent:D:\ideaJetBrains\IntelliJIDEA2019.3\bin\jetbrains-agent.jar -Djb.vmOptionsFile=C:\Users\Think\.IntelliJIdea2019.3\config\idea64.exe.vmoptions -Djava.library.path=D:\ideaJetBrains\IntelliJIDEA2019.3\jbr\\bin;D:\ideaJetBrains\IntelliJIDEA2019.3\jbr\\bin\server -Didea.jre.check=<span class="literal">true</span> -Dide.native.launcher=<span class="literal">true</span> -Didea.paths.selector=IntelliJIdea2019.3 -XX:ErrorFile=C:\Users\Think\java_error_in_idea_%p.log -XX:HeapDumpPath=C:\Users\Think\java_error_in_idea.hprof</span><br><span class="line"></span><br><span class="line">13880 Launcher -Xmx700m -Djava.awt.headless=<span class="literal">true</span> -Djava.endorsed.dirs=<span class="string">&quot;&quot;</span> -Djdt.compiler.useSingleThread=<span class="literal">true</span> -Dpreload.project.path=D:/interview/jvm -Dpreload.config.path=C:/Users/Think/.IntelliJIdea2019.3/config/options -Dcompile.parallel=<span class="literal">false</span> -Drebuild.on.dependency.change=<span class="literal">true</span> -Djava.net.preferIPv4Stack=<span class="literal">true</span> -Dio.netty.initialSeedUniquifier=-7881113560423034109 -Dfile.encoding=GBK -Duser.language=zh -Duser.country=CN -Didea.paths.selector=IntelliJIdea2019.3 -Didea.home.path=D:\ideaJetBrains\IntelliJIDEA2019.3 -Didea.config.path=C:\Users\Think/.IntelliJIdea2019.3/config -Didea.plugins.path=C:\Users\Think/.IntelliJIdea2019.3/config/plugins -Djps.log.dir=C:/Users/Think/.IntelliJIdea2019.3/system/<span class="built_in">log</span>/build-log -Djps.fallback.jdk.home=D:/ideaJetBrains/IntelliJIDEA2019.3/jbr -Djps.fallback.jdk.version=11.0.4 -Dio.netty.noUnsafe=<span class="literal">true</span> -Djava.io.tmpdir=C:/Users/Think/.IntelliJIdea2019.3/system/compile-server/jvm_9ac3b829/_temp_ -Djps.backward.ref.index.builder=<span class="literal">true</span> -Dkotlin.incremental.compilation=<span class="literal">true</span> -Dkotlin.incremental.compi</span><br><span class="line"></span><br><span class="line">23336 RemoteMavenServer -Djava.awt.headless=<span class="literal">true</span> -Dmaven.defaultProjectBuilder.disableGlobalModelCache=<span class="literal">true</span> -Xmx768m -Didea.maven.embedder.version=3.5.2 -Dmaven.ext.class.path=D:\ideaJetBrains\IntelliJIDEA2019.3\plugins\maven\lib\maven-event-listener.jar -Dfile.encoding=GBK</span><br><span class="line"></span><br><span class="line">18156 Jps -Dapplication.home=C:\Program Files\Java\jdk1.8.0_101 -Xms8m</span><br><span class="line"></span><br><span class="line">6604 ScannerTest -javaagent:D:\ideaJetBrains\IntelliJIDEA2019.3\lib\idea_rt.jar=59998:D:\ideaJetBrains\IntelliJIDEA2019.3\bin -Dfile.encoding=UTF-8</span><br></pre></td></tr></table></figure></li>
</ul>
<p>说明：以上参数可以综合使用。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\Think&gt;jps -lmv</span><br></pre></td></tr></table></figure>

<p>==jps命令中的q命令与lmv命令是独立的，优先展示q==</p>
<p>补充：如果某 Java 进程关闭了默认开启的 UsePerfData 参数（即使用参数<code>-XX:-UsePerfData</code>），那么 jps 命令（以及下面介绍的 jstat）将无法探知该 Java 进程。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-XX:-UsePerfData</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\Think&gt;jps</span><br><span class="line">21428</span><br><span class="line">23336 RemoteMavenServer</span><br><span class="line">15612 Jps</span><br><span class="line">20412 Launcher</span><br></pre></td></tr></table></figure>

<h3 id="hostid-参数"><a href="#hostid-参数" class="headerlink" title="hostid 参数"></a><strong>hostid 参数</strong></h3><p>RMI 注册表中注册的主机名。如果想要远程监控主机上的 java 程序，需要安装 jstatd。</p>
<p>对于具有更严格的安全实践的网络场所而言，可能使用一个自定义的策略文件来显示对特定的可信主机或网络的访问，尽管这种技术容易受到 IP 地址欺诈攻击。</p>
<p><strong>如果安全问题无法使用一个定制的策略文件来处理，那么最安全的操作是不运行 jstatd 服务器，而是在本地使用 jstat 和 jps 工具。</strong></p>
<h2 id="jstat：查看-JVM-统计信息"><a href="#jstat：查看-JVM-统计信息" class="headerlink" title="jstat：查看 JVM 统计信息"></a>jstat：查看 JVM 统计信息</h2><h3 id="概念-1"><a href="#概念-1" class="headerlink" title="概念"></a>概念</h3><p>jstat（JVM Statistics Monitoring Tool）：用于监视虚拟机各种运行状态信息的命令行工具。它可以显示本地或者远程虚拟机进程中的类装载、内存、垃圾收集、JIT 编译等运行数据。</p>
<p>在没有 GUI 图形界面，只提供了纯文本控制台环境的服务器上，它将是运行期定位虚拟机性能问题的首选工具。常用于检测垃圾回收问题以及内存泄漏问题。</p>
<p>官方文档：<a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/8/docs/technotes/tools/unix/jstat.html">https://docs.oracle.com/javase/8/docs/technotes/tools/unix/jstat.html</a></p>
<p>基本使用语法为：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jstat -&lt;option&gt; [-t] [-h&lt;lines&gt;] &lt;vmid&gt; [&lt;interval&gt; [&lt;count&gt;]]</span><br></pre></td></tr></table></figure>

<p>查看命令相关参数：jstat-h 或 jstat-help</p>
<p>其中 vmid 是进程 id 号，也就是 jps 之后看到的前面的号码，如下：</p>
<p><img src="https://img.lvxiaoyi.top/typora-img/202111021342291.png/lvxiaoyi" alt="image-20210504201703222"></p>
<h3 id="option-参数"><a href="#option-参数" class="headerlink" title="option 参数"></a><strong>option 参数</strong></h3><p>选项 option 可以由以下值构成。</p>
<p>类装载相关的：</p>
<ul>
<li>-class：显示 ClassLoader 的相关信息：类的装载、卸载数量、总空间、类装载所消耗的时间等</li>
</ul>
<p>垃圾回收相关的：</p>
<ul>
<li><p>-gc：显示与 GC 相关的堆信息。包括 Eden 区、两个 Survivor 区、老年代、永久代等的容量、已用空间、GC 时间合计等信息。</p>
</li>
<li><p>-gccapacity：显示内容与-gc 基本相同，但输出主要关注 Java 堆各个区域使用到的最大、最小空间。</p>
</li>
<li><p>-gcutil：显示内容与-gc 基本相同，但输出主要关注已使用空间占总空间的百分比。</p>
</li>
<li><p>-gccause：与-gcutil 功能一样，但是会额外输出导致最后一次或当前正在发生的 GC 产生的原因。</p>
</li>
<li><p>-gcnew：显示新生代 GC 状况</p>
</li>
<li><p>-gcnewcapacity：显示内容与-gcnew 基本相同，输出主要关注使用到的最大、最小空间</p>
</li>
<li><p>-geold：显示老年代 GC 状况</p>
</li>
<li><p>-gcoldcapacity：显示内容与-gcold 基本相同，输出主要关注使用到的最大、最小空间</p>
</li>
<li><p>-gcpermcapacity（**-gcmetacapacity**）：显示永久代使用到的最大、最小空间。</p>
<ul>
<li><p>==注意-gcpermcapacity是jdk1.7前的指令，在jdk1.8后，永久代改为了元空间，所以如果你用永久代的参数在jdk1.8中会提示没有该条命令，但是显示的参数都是一样的==</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\Think&gt;jstat -options -help</span><br><span class="line">-class</span><br><span class="line">-compiler</span><br><span class="line">-gc</span><br><span class="line">-gccapacity</span><br><span class="line">-gccause</span><br><span class="line">-gcmetacapacity</span><br><span class="line">-gcnew</span><br><span class="line">-gcnewcapacity</span><br><span class="line">-gcold</span><br><span class="line">-gcoldcapacity</span><br><span class="line">-gcutil</span><br><span class="line">-printcompilation</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<p>这些参数的意义参考官网文档：<a target="_blank" rel="noopener" href="https://docs.oracle.com/en/java/javase/14/docs/specs/man/jstat.html">https://docs.oracle.com/en/java/javase/14/docs/specs/man/jstat.html</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/756623607-zhang/p/8980774.html#4951951%E7%94%B1%E8%BF%99%E8%BE%B9%E6%96%87%E7%AB%A0%E7%9A%84%E5%8D%9A%E4%B8%BB%E6%8F%90%E4%BE%9B%EF%BC%8C%E6%88%91%E5%BC%80%E5%A7%8B%E4%B9%9F%E6%B2%A1%E6%9C%89%E6%89%BE%E5%88%B0">https://www.cnblogs.com/756623607-zhang/p/8980774.html#4951951由这边文章的博主提供，我开始也没有找到</a></p>
<p>JIT 相关的：</p>
<ul>
<li>-compiler：显示 JIT 编译器编译过的方法、耗时等信息</li>
<li>-printcompilation：输出已经被 JIT 编译的方法</li>
</ul>
<h4 id="类装载相关的"><a href="#类装载相关的" class="headerlink" title="类装载相关的"></a>类装载相关的</h4><h5 id="jstat-class"><a href="#jstat-class" class="headerlink" title="jstat -class"></a><strong>jstat -class</strong></h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\Think&gt;jps</span><br><span class="line">3376 Jps</span><br><span class="line">11940 Launcher</span><br><span class="line">21428</span><br><span class="line">12312 ScannerTest</span><br><span class="line">23336 RemoteMavenServer</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\Think&gt;jstat -class 12312</span><br><span class="line">Loaded  Bytes  Unloaded  Bytes     Time</span><br><span class="line">   699  1398.0        0     0.0       0.35</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>参数</th>
<th>loaded</th>
<th>Bytes</th>
<th>Unloaded</th>
<th>Bytes</th>
<th>Time</th>
</tr>
</thead>
<tbody><tr>
<td>说明</td>
<td>加载类的个数</td>
<td>加载类的字节数</td>
<td>卸载类的个数</td>
<td>卸载来的字节数</td>
<td>花费的总体时间</td>
</tr>
</tbody></table>
<h4 id="JIT-相关的"><a href="#JIT-相关的" class="headerlink" title="JIT 相关的"></a>JIT 相关的</h4><h5 id="jstat-compiler"><a href="#jstat-compiler" class="headerlink" title="jstat -compiler"></a><strong>jstat -compiler</strong></h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\Think&gt;jstat -compiler 12312</span><br><span class="line">Compiled Failed Invalid   Time   FailedType FailedMethod</span><br><span class="line">   94      0       0     0.10          0</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>参数</th>
<th>Compiled</th>
<th>Failed</th>
<th>Invalid</th>
<th>Time</th>
<th>FailedTypeTime</th>
<th>FailedMethod</th>
</tr>
</thead>
<tbody><tr>
<td>说明</td>
<td>编译的数量</td>
<td>失败的数量</td>
<td>不可用数量</td>
<td>编译时间</td>
<td>失败编译的时间</td>
<td>失败的方法</td>
</tr>
</tbody></table>
<h5 id="jstat-printcompilation"><a href="#jstat-printcompilation" class="headerlink" title="jstat -printcompilation"></a><strong>jstat -printcompilation</strong></h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\Think&gt;jstat -printcompilation 12312</span><br><span class="line">Compiled  Size  Type Method</span><br><span class="line">      94    138    1 java/lang/StringBuffer append</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>参数</th>
<th>Compiled</th>
<th>Size</th>
<th>Type</th>
<th>Method</th>
</tr>
</thead>
<tbody><tr>
<td>说明</td>
<td>最近编译方法的数量</td>
<td>最近编译方法的字节码数量</td>
<td>最近编译方法的编译类型</td>
<td>方法名标识</td>
</tr>
</tbody></table>
<h4 id="垃圾回收相关的"><a href="#垃圾回收相关的" class="headerlink" title="垃圾回收相关的"></a>垃圾回收相关的</h4><h5 id="jstat-gc"><a href="#jstat-gc" class="headerlink" title="jstat -gc"></a><strong>jstat -gc</strong></h5><p>显示与 GC 相关的堆信息。包括 Eden 区、两个 Survivor 区、老年代、永久代等的容量、已用空间、GC 时间合计等信息。</p>
<h6 id="例一："><a href="#例一：" class="headerlink" title="例一："></a><strong>例一：</strong></h6><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\Think&gt;jstat -gc 12312</span><br><span class="line"> S0C    S1C    S0U    S1U      EC       EU        OC         OU       MC     MU    CCSC   CCSU   YGC     YGCT    FGC    FGCT     GCT</span><br><span class="line">10752.0 10752.0  0.0    0.0   65536.0   6559.6   175104.0     0.0     4480.0 769.9  384.0   75.8       0    0.000   0      0.000    0.000</span><br></pre></td></tr></table></figure>

<p><img src="https://img.lvxiaoyi.top/typora-img/image-20210927180425090.png/lvxiaoyi" alt="image-20210927180425090"></p>
<table>
<thead>
<tr>
<th>参数</th>
<th>解释</th>
</tr>
</thead>
<tbody><tr>
<td>S0C</td>
<td>幸存者 0 区的大小</td>
</tr>
<tr>
<td>S1C</td>
<td>幸存者 1 区的大小</td>
</tr>
<tr>
<td>S0U</td>
<td>幸存者 0 区已使用的大小</td>
</tr>
<tr>
<td>S1U</td>
<td>幸存者 1 区已使用的大小</td>
</tr>
<tr>
<td>EC</td>
<td>Eden 区的大小</td>
</tr>
<tr>
<td>EU</td>
<td>Eden 区已使用的大小</td>
</tr>
<tr>
<td>OC</td>
<td>老年代的大小</td>
</tr>
<tr>
<td>OU</td>
<td>老年代已使用的大小</td>
</tr>
<tr>
<td>MC</td>
<td>元空间（方法区）的大小</td>
</tr>
<tr>
<td>MU</td>
<td>元空间（方法区）已使用的大小</td>
</tr>
<tr>
<td>CCSC</td>
<td>压缩类空间的大小</td>
</tr>
<tr>
<td>CCSU</td>
<td>压缩类空间已使用的大小</td>
</tr>
<tr>
<td>YGC</td>
<td>从应用程序启动到采样时 young gc 的次数</td>
</tr>
<tr>
<td>YGCT</td>
<td>从应用程序启动到采样时 young gc 消耗时间（秒）</td>
</tr>
<tr>
<td>FGC</td>
<td>从应用程序启动到采样时 full gc 的次数</td>
</tr>
<tr>
<td>FGCT</td>
<td>从应用程序启动到采样时的 full gc 的消耗时间（秒）</td>
</tr>
<tr>
<td>GCT</td>
<td>从应用程序启动到采样时 gc 的总时间</td>
</tr>
</tbody></table>
<h6 id="例二："><a href="#例二：" class="headerlink" title="例二："></a><strong>例二：</strong></h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> lvxiaoyi</span></span><br><span class="line"><span class="comment"> * -Xms60m -Xmx60m -XX:SurvivorRatio=8</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021/9/27 18:12</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GCTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        ArrayList&lt;<span class="keyword">byte</span>[]&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">byte</span>[] arr = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span> * <span class="number">100</span>];</span><br><span class="line">            list.add(arr);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Thread.sleep(<span class="number">120</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\Think&gt;jps</span><br><span class="line">14372 GCTest</span><br><span class="line">14804 Jps</span><br><span class="line">21428</span><br><span class="line">17160 Launcher</span><br><span class="line">23336 RemoteMavenServer</span><br><span class="line">12364 KotlinCompileDaemon</span><br><span class="line"></span><br><span class="line">C:\Users\Think&gt;jstat -gc 14372 1000 10</span><br><span class="line"> S0C    S1C    S0U    S1U      EC       EU        OC         OU       MC     MU    CCSC   CCSU   YGC     YGCT    FGC    FGCT     GCT</span><br><span class="line">2048.0 2048.0  0.0   2016.2 16384.0   1807.1   40960.0    12353.8   4864.0 3782.2 512.0  419.4       1    0.006   0      0.000    0.006</span><br><span class="line">2048.0 2048.0  0.0   2016.2 16384.0   2607.2   40960.0    12353.8   4864.0 3782.2 512.0  419.4       1    0.006   0      0.000    0.006</span><br><span class="line">2048.0 2048.0  0.0   2016.2 16384.0   3407.3   40960.0    12353.8   4864.0 3782.2 512.0  419.4       1    0.006   0      0.000    0.006</span><br><span class="line">2048.0 2048.0  0.0   2016.2 16384.0   4314.3   40960.0    12353.8   4864.0 3782.2 512.0  419.4       1    0.006   0      0.000    0.006</span><br><span class="line">2048.0 2048.0  0.0   2016.2 16384.0   5014.4   40960.0    12353.8   4864.0 3782.2 512.0  419.4       1    0.006   0      0.000    0.006</span><br><span class="line">2048.0 2048.0  0.0   2016.2 16384.0   5914.5   40960.0    12353.8   4864.0 3782.2 512.0  419.4       1    0.006   0      0.000    0.006</span><br><span class="line">2048.0 2048.0  0.0   2016.2 16384.0   6714.7   40960.0    12353.8   4864.0 3782.2 512.0  419.4       1    0.006   0      0.000    0.006</span><br><span class="line">2048.0 2048.0  0.0   2016.2 16384.0   7514.8   40960.0    12353.8   4864.0 3782.2 512.0  419.4       1    0.006   0      0.000    0.006</span><br><span class="line">2048.0 2048.0  0.0   2016.2 16384.0   8314.9   40960.0    12353.8   4864.0 3782.2 512.0  419.4       1    0.006   0      0.000    0.006</span><br><span class="line">2048.0 2048.0  0.0   2016.2 16384.0   9115.0   40960.0    12353.8   4864.0 3782.2 512.0  419.4       1    0.006   0      0.000    0.006</span><br></pre></td></tr></table></figure>

<p><img src="https://img.lvxiaoyi.top/typora-img/image-20210927204921489.png/lvxiaoyi" alt="image-20210927204921489"></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Exception <span class="keyword">in</span> thread <span class="string">&quot;main&quot;</span> java.lang.OutOfMemoryError: Java heap space</span><br><span class="line">	at top.lvxiaoyi.three.chapter02.code02.GCTest.main(GCTest.java:16)</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">-Xms60m -Xmx60m -XX:SurvivorRatio=8</span><br><span class="line"><span class="comment"># 设置堆初始大小为60m，设置堆最大为60m，设置幸存区和伊甸园区比例为1:1:8（幸存1区和二区的大小要一致）</span></span><br></pre></td></tr></table></figure>

<p>默认新生代与老年代比例为1:2，所以新生代为为20M，老年代为40M</p>
<p>幸存区和伊甸园区比例为1:1:8，所以S0C为2M，S1C为2M，EC为16M，OC为40M，发生了YGC1次，FGC没有出现，</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">S0C：第一个幸存区的大小</span><br><span class="line">S1C：第二个幸存区的大小</span><br><span class="line">S0U：第一个幸存区的使用大小</span><br><span class="line">S1U：第二个幸存区的使用大小</span><br><span class="line">EC：伊甸园区的大小</span><br><span class="line">EU：伊甸园区的使用大小</span><br><span class="line">OC：老年代大小</span><br><span class="line">OU：老年代使用大小</span><br><span class="line">MC：方法区大小</span><br><span class="line">MU：方法区使用大小</span><br><span class="line">CCSC:压缩类空间大小</span><br><span class="line">CCSU:压缩类空间使用大小</span><br><span class="line">YGC：年轻代垃圾回收次数</span><br><span class="line">YGCT：年轻代垃圾回收消耗时间</span><br><span class="line">FGC：老年代垃圾回收次数</span><br><span class="line">FGCT：老年代垃圾回收消耗时间</span><br><span class="line">GCT：垃圾回收消耗总时间</span><br></pre></td></tr></table></figure>



<h5 id="jstat-gccapacity"><a href="#jstat-gccapacity" class="headerlink" title="jstat -gccapacity"></a><strong>jstat -gccapacity</strong></h5><p>-gccapacity：显示内容与-gc 基本相同，但输出主要关注 Java 堆各个区域使用到的最大、最小空间。</p>
<p><img src="https://img.lvxiaoyi.top/typora-img/image-20210927221432416.png/lvxiaoyi" alt="image-20210927221432416"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">NGCMN：新生代最小容量</span><br><span class="line">NGCMX：新生代最大容量</span><br><span class="line">NGC：当前新生代容量</span><br><span class="line">S0C：第一个幸存区大小</span><br><span class="line">S1C：第二个幸存区的大小</span><br><span class="line">EC：伊甸园区的大小</span><br><span class="line">OGCMN：老年代最小容量</span><br><span class="line">OGCMX：老年代最大容量</span><br><span class="line">OGC：当前老年代大小</span><br><span class="line">OC:当前老年代大小</span><br><span class="line">MCMN:最小元数据容量</span><br><span class="line">MCMX：最大元数据容量</span><br><span class="line">MC：当前元数据空间大小</span><br><span class="line">CCSMN：最小压缩类空间大小</span><br><span class="line">CCSMX：最大压缩类空间大小</span><br><span class="line">CCSC：当前压缩类空间大小</span><br><span class="line">YGC：年轻代gc次数</span><br><span class="line">FGC：老年代GC次数</span><br></pre></td></tr></table></figure>



<h5 id="jstat-gcutil"><a href="#jstat-gcutil" class="headerlink" title="jstat -gcutil"></a><strong>jstat -gcutil</strong></h5><p>显示内容与-gc 基本相同，但输出主要关注已使用空间占总空间的百分比。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\Think&gt;jps</span><br><span class="line">21428</span><br><span class="line">22484 GCTest</span><br><span class="line">23336 RemoteMavenServer</span><br><span class="line">3384 Launcher</span><br><span class="line">12364 KotlinCompileDaemon</span><br><span class="line">12780 Jps</span><br><span class="line"></span><br><span class="line">C:\Users\Think&gt;jstat -gcutil 22484 500 30</span><br><span class="line">  S0     S1     E      O      M     CCS    YGC     YGCT    FGC    FGCT     GCT</span><br><span class="line">  0.00  98.65  87.46  29.92  77.76  81.91      1    0.004     0    0.000    0.004</span><br><span class="line">  0.00  98.65  89.90  29.92  77.76  81.91      1    0.004     0    0.000    0.004</span><br><span class="line">  0.00  98.65  92.95  29.92  77.76  81.91      1    0.004     0    0.000    0.004</span><br><span class="line">  0.00  98.65  94.79  29.92  77.76  81.91      1    0.004     0    0.000    0.004</span><br><span class="line">  0.00  98.65  97.84  29.92  77.76  81.91      1    0.004     0    0.000    0.004</span><br><span class="line">  0.00   0.00   0.61  74.42  77.76  81.91      2    0.011     1    0.016    0.026</span><br><span class="line">  0.00   0.00   3.14  74.42  77.76  81.91      2    0.011     1    0.016    0.026</span><br><span class="line">  0.00   0.00   5.58  74.42  77.76  81.91      2    0.011     1    0.016    0.026</span><br><span class="line">  0.00   0.00   8.02  74.42  77.76  81.91      2    0.011     1    0.016    0.026</span><br><span class="line">  0.00   0.00  10.46  74.42  77.76  81.91      2    0.011     1    0.016    0.026</span><br><span class="line">  0.00   0.00  12.90  74.42  77.76  81.91      2    0.011     1    0.016    0.026</span><br><span class="line">  0.00   0.00  15.35  74.42  77.76  81.91      2    0.011     1    0.016    0.026</span><br><span class="line">  0.00   0.00  17.79  74.42  77.76  81.91      2    0.011     1    0.016    0.026</span><br><span class="line">  0.00   0.00  20.84  74.42  77.76  81.91      2    0.011     1    0.016    0.026</span><br><span class="line">  0.00   0.00  23.28  74.42  77.76  81.91      2    0.011     1    0.016    0.026</span><br><span class="line">  0.00   0.00  25.72  74.42  77.76  81.91      2    0.011     1    0.016    0.026</span><br><span class="line">  0.00   0.00  28.17  74.42  77.76  81.91      2    0.011     1    0.016    0.026</span><br><span class="line">  0.00   0.00  30.61  74.42  77.76  81.91      2    0.011     1    0.016    0.026</span><br><span class="line">  0.00   0.00  33.05  74.42  77.76  81.91      2    0.011     1    0.016    0.026</span><br><span class="line">  0.00   0.00  35.49  74.42  77.76  81.91      2    0.011     1    0.016    0.026</span><br><span class="line">  0.00   0.00  37.93  74.42  77.76  81.91      2    0.011     1    0.016    0.026</span><br><span class="line">  0.00   0.00  40.37  74.42  77.76  81.91      2    0.011     1    0.016    0.026</span><br><span class="line">  0.00   0.00  42.82  74.42  77.76  81.91      2    0.011     1    0.016    0.026</span><br><span class="line">  0.00   0.00  45.26  74.42  77.76  81.91      2    0.011     1    0.016    0.026</span><br><span class="line">  0.00   0.00  47.70  74.42  77.76  81.91      2    0.011     1    0.016    0.026</span><br><span class="line">  0.00   0.00  50.14  74.42  77.76  81.91      2    0.011     1    0.016    0.026</span><br><span class="line">  0.00   0.00  52.58  74.42  77.76  81.91      2    0.011     1    0.016    0.026</span><br><span class="line">  0.00   0.00  55.64  74.42  77.76  81.91      2    0.011     1    0.016    0.026</span><br><span class="line">  0.00   0.00  58.08  74.42  77.76  81.91      2    0.011     1    0.016    0.026</span><br><span class="line">  0.00   0.00  60.52  74.42  77.76  81.91      2    0.011     1    0.016    0.026</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">S0：幸存1区当前使用比例</span><br><span class="line">S1：幸存2区当前使用比例</span><br><span class="line">E：伊甸园区使用比例</span><br><span class="line">O：老年代使用比例</span><br><span class="line">M：元数据区使用比例</span><br><span class="line">CCS：压缩使用比例</span><br><span class="line">YGC：年轻代垃圾回收次数</span><br><span class="line">FGC：老年代垃圾回收次数</span><br><span class="line">FGCT：老年代垃圾回收消耗时间</span><br><span class="line">GCT：所有GC总耗时</span><br></pre></td></tr></table></figure>



<h5 id="jstat-gccause"><a href="#jstat-gccause" class="headerlink" title="jstat -gccause"></a><strong>jstat -gccause</strong></h5><p>与-gcutil 功能一样，但是会额外输出导致最后一次或当前正在发生的 GC 产生的原因。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\Think&gt;jps</span><br><span class="line">19600 Jps</span><br><span class="line">21428</span><br><span class="line">23892 Launcher</span><br><span class="line">23336 RemoteMavenServer</span><br><span class="line">12364 KotlinCompileDaemon</span><br><span class="line">22604 GCTest</span><br><span class="line"></span><br><span class="line">C:\Users\Think&gt;jstat -gccause 22604 1000 30</span><br><span class="line">  S0     S1     E      O      M     CCS    YGC     YGCT    FGC    FGCT     GCT    LGCC                 GCC</span><br><span class="line">  0.00  98.65   3.09  30.05  77.76  81.91      1    0.005     0    0.000    0.005 Allocation Failure   No GC</span><br><span class="line">  0.00  98.65   6.15  30.05  77.76  81.91      1    0.005     0    0.000    0.005 Allocation Failure   No GC</span><br><span class="line">  0.00  98.65  11.03  30.05  77.76  81.91      1    0.005     0    0.000    0.005 Allocation Failure   No GC</span><br><span class="line">  0.00  98.65  16.52  30.05  77.76  81.91      1    0.005     0    0.000    0.005 Allocation Failure   No GC</span><br><span class="line">  0.00  98.65  21.41  30.05  77.76  81.91      1    0.005     0    0.000    0.005 Allocation Failure   No GC</span><br><span class="line">  0.00  98.65  26.33  30.05  77.76  81.91      1    0.005     0    0.000    0.005 Allocation Failure   No GC</span><br><span class="line">  0.00  98.65  31.22  30.05  77.76  81.91      1    0.005     0    0.000    0.005 Allocation Failure   No GC</span><br><span class="line">  0.00  98.65  36.10  30.05  77.76  81.91      1    0.005     0    0.000    0.005 Allocation Failure   No GC</span><br><span class="line">  0.00  98.65  40.98  30.05  77.76  81.91      1    0.005     0    0.000    0.005 Allocation Failure   No GC</span><br><span class="line">  0.00  98.65  45.87  30.05  77.76  81.91      1    0.005     0    0.000    0.005 Allocation Failure   No GC</span><br><span class="line">  0.00  98.65  50.75  30.05  77.76  81.91      1    0.005     0    0.000    0.005 Allocation Failure   No GC</span><br><span class="line">  0.00  98.65  56.24  30.05  77.76  81.91      1    0.005     0    0.000    0.005 Allocation Failure   No GC</span><br><span class="line">  0.00  98.65  61.13  30.05  77.76  81.91      1    0.005     0    0.000    0.005 Allocation Failure   No GC</span><br><span class="line">  0.00  98.65  66.01  30.05  77.76  81.91      1    0.005     0    0.000    0.005 Allocation Failure   No GC</span><br><span class="line">  0.00  98.65  70.94  30.05  77.76  81.91      1    0.005     0    0.000    0.005 Allocation Failure   No GC</span><br><span class="line">  0.00  98.65  75.82  30.05  77.76  81.91      1    0.005     0    0.000    0.005 Allocation Failure   No GC</span><br><span class="line">  0.00  98.65  81.97  30.05  77.76  81.91      1    0.005     0    0.000    0.005 Allocation Failure   No GC</span><br><span class="line">  0.00  98.65  85.63  30.05  77.76  81.91      1    0.005     0    0.000    0.005 Allocation Failure   No GC</span><br><span class="line">  0.00  98.65  90.51  30.05  77.76  81.91      1    0.005     0    0.000    0.005 Allocation Failure   No GC</span><br><span class="line">  0.00  98.65  95.40  30.05  77.76  81.91      1    0.005     0    0.000    0.005 Allocation Failure   No GC</span><br><span class="line">  0.00   0.00   3.14  74.42  77.76  81.91      2    0.010     1    0.012    0.022 Allocation Failure   No GC</span><br><span class="line">  0.00   0.00   6.19  74.42  77.76  81.91      2    0.010     1    0.012    0.022 Allocation Failure   No GC</span><br><span class="line">  0.00   0.00  11.07  74.42  77.76  81.91      2    0.010     1    0.012    0.022 Allocation Failure   No GC</span><br><span class="line">  0.00   0.00  15.96  74.42  77.76  81.91      2    0.010     1    0.012    0.022 Allocation Failure   No GC</span><br><span class="line">  0.00   0.00  20.84  74.42  77.76  81.91      2    0.010     1    0.012    0.022 Allocation Failure   No GC</span><br><span class="line">  0.00   0.00  25.72  74.42  77.76  81.91      2    0.010     1    0.012    0.022 Allocation Failure   No GC</span><br><span class="line">  0.00   0.00  30.61  74.42  77.76  81.91      2    0.010     1    0.012    0.022 Allocation Failure   No GC</span><br><span class="line">  0.00   0.00  35.49  74.42  77.76  81.91      2    0.010     1    0.012    0.022 Allocation Failure   No GC</span><br><span class="line">  0.00   0.00  40.37  74.42  77.76  81.91      2    0.010     1    0.012    0.022 Allocation Failure   No GC</span><br><span class="line">  0.00   0.00  45.26  74.42  77.76  81.91      2    0.010     1    0.012    0.022 Allocation Failure   No GC</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">S0：幸存1区当前使用比例</span><br><span class="line">S1：幸存2区当前使用比例</span><br><span class="line">E：伊甸园区使用比例</span><br><span class="line">O：老年代使用比例</span><br><span class="line">M：元数据区使用比例</span><br><span class="line">CCS：压缩使用比例</span><br><span class="line">YGC：年轻代垃圾回收次数</span><br><span class="line">FGC：老年代垃圾回收次数</span><br><span class="line">FGCT：老年代垃圾回收消耗时间</span><br><span class="line">GCT：所有GC总耗时</span><br><span class="line">LGCC：上次GC的原因</span><br><span class="line">GCC：当前GC的原因</span><br></pre></td></tr></table></figure>



<h5 id="jstat-gcnew"><a href="#jstat-gcnew" class="headerlink" title="jstat -gcnew"></a><strong>jstat -gcnew</strong></h5><p>显示新生代 GC 状况</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\Think&gt;jstat -gcnew 24584 1000 10</span><br><span class="line"> S0C    S1C    S0U    S1U   TT MTT  DSS      EC       EU     YGC     YGCT</span><br><span class="line">2048.0 2048.0    0.0 2032.3  7  15 2048.0  16384.0  15129.6      1    0.004</span><br><span class="line">2048.0 2048.0    0.0 2032.3  7  15 2048.0  16384.0  16029.8      1    0.004</span><br><span class="line">2048.0 2048.0    0.0    0.0  7  15 2048.0  16384.0    841.7      2    0.011</span><br><span class="line">2048.0 2048.0    0.0    0.0  7  15 2048.0  16384.0   1641.8      2    0.011</span><br><span class="line">2048.0 2048.0    0.0    0.0  7  15 2048.0  16384.0   2442.0      2    0.011</span><br><span class="line">2048.0 2048.0    0.0    0.0  7  15 2048.0  16384.0   3242.1      2    0.011</span><br><span class="line">2048.0 2048.0    0.0    0.0  7  15 2048.0  16384.0   4042.2      2    0.011</span><br><span class="line">2048.0 2048.0    0.0    0.0  7  15 2048.0  16384.0   4842.3      2    0.011</span><br><span class="line">2048.0 2048.0    0.0    0.0  7  15 2048.0  16384.0   5642.5      2    0.011</span><br><span class="line">2048.0 2048.0    0.0    0.0  7  15 2048.0  16384.0   6442.6      2    0.011</span><br></pre></td></tr></table></figure>



<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">S0C：第一个幸存区大小</span><br><span class="line">S1C：第二个幸存区的大小</span><br><span class="line">S0U：第一个幸存区的使用大小</span><br><span class="line">S1U：第二个幸存区的使用大小</span><br><span class="line">TT:对象在新生代存活的次数</span><br><span class="line">MTT:对象在新生代存活的最大次数</span><br><span class="line">DSS:期望的幸存区大小</span><br><span class="line">EC：伊甸园区的大小</span><br><span class="line">EU：伊甸园区的使用大小</span><br><span class="line">YGC：年轻代垃圾回收次数</span><br><span class="line">YGCT：年轻代垃圾回收消耗时间</span><br></pre></td></tr></table></figure>



<h5 id="jstat-gcnewcapacity"><a href="#jstat-gcnewcapacity" class="headerlink" title="jstat -gcnewcapacity"></a><strong>jstat -gcnewcapacity</strong></h5><p>显示内容与-gcnew 基本相同，输出主要关注使用到的最大、最小空间</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\Think&gt;jstat -gcnewcapacity 10620 1000 10</span><br><span class="line">  NGCMN      NGCMX       NGC      S0CMX     S0C     S1CMX     S1C       ECMX        EC      YGC   FGC</span><br><span class="line">   20480.0    20480.0    20480.0   2048.0   2048.0   2048.0   2048.0    19456.0    16384.0     1     0</span><br><span class="line">   20480.0    20480.0    20480.0   2048.0   2048.0   2048.0   2048.0    19456.0    16384.0     1     0</span><br><span class="line">   20480.0    20480.0    20480.0   2048.0   2048.0   2048.0   2048.0    19456.0    16384.0     1     0</span><br><span class="line">   20480.0    20480.0    20480.0   2048.0   2048.0   2048.0   2048.0    19456.0    16384.0     1     0</span><br><span class="line">   20480.0    20480.0    20480.0   2048.0   2048.0   2048.0   2048.0    19456.0    16384.0     1     0</span><br><span class="line">   20480.0    20480.0    20480.0   2048.0   2048.0   2048.0   2048.0    19456.0    16384.0     1     0</span><br><span class="line">   20480.0    20480.0    20480.0   2048.0   2048.0   2048.0   2048.0    19456.0    16384.0     1     0</span><br><span class="line">   20480.0    20480.0    20480.0   2048.0   2048.0   2048.0   2048.0    19456.0    16384.0     1     0</span><br><span class="line">   20480.0    20480.0    20480.0   2048.0   2048.0   2048.0   2048.0    19456.0    16384.0     2     1</span><br><span class="line">   20480.0    20480.0    20480.0   2048.0   2048.0   2048.0   2048.0    19456.0    16384.0     2     1</span><br></pre></td></tr></table></figure>



<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">NGCMN：新生代最小容量</span><br><span class="line">NGCMX：新生代最大容量</span><br><span class="line">NGC：当前新生代容量</span><br><span class="line">S0CMX：最大幸存1区大小</span><br><span class="line">S0C：当前幸存1区大小</span><br><span class="line">S1CMX：最大幸存2区大小</span><br><span class="line">S1C：当前幸存2区大小</span><br><span class="line">ECMX：最大伊甸园区大小</span><br><span class="line">EC：当前伊甸园区大小</span><br><span class="line">YGC：年轻代垃圾回收次数</span><br><span class="line">FGC：老年代回收次数</span><br></pre></td></tr></table></figure>



<h5 id="jstat-gcold"><a href="#jstat-gcold" class="headerlink" title="jstat -gcold"></a><strong>jstat -gcold</strong></h5><p>显示老年代 GC 状况</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\Think&gt;jstat -gcold 21912 1000 10</span><br><span class="line">   MC       MU      CCSC     CCSU       OC          OU       YGC    FGC    FGCT     GCT</span><br><span class="line">  4480.0    769.9    384.0     75.8     40960.0         0.0      0     0    0.000    0.000</span><br><span class="line">  4864.0   3781.9    512.0    419.4     40960.0     12265.8      1     0    0.000    0.005</span><br><span class="line">  4864.0   3781.9    512.0    419.4     40960.0     12265.8      1     0    0.000    0.005</span><br><span class="line">  4864.0   3781.9    512.0    419.4     40960.0     12265.8      1     0    0.000    0.005</span><br><span class="line">  4864.0   3781.9    512.0    419.4     40960.0     12265.8      1     0    0.000    0.005</span><br><span class="line">  4864.0   3781.9    512.0    419.4     40960.0     12265.8      1     0    0.000    0.005</span><br><span class="line">  4864.0   3781.9    512.0    419.4     40960.0     12265.8      1     0    0.000    0.005</span><br><span class="line">  4864.0   3781.9    512.0    419.4     40960.0     12265.8      1     0    0.000    0.005</span><br><span class="line">  4864.0   3781.9    512.0    419.4     40960.0     12265.8      1     0    0.000    0.005</span><br><span class="line">  4864.0   3781.9    512.0    419.4     40960.0     12265.8      1     0    0.000    0.005</span><br></pre></td></tr></table></figure>



<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">MC：方法区大小</span><br><span class="line">MU：方法区使用大小</span><br><span class="line">CCSC:压缩类空间大小</span><br><span class="line">CCSU:压缩类空间使用大小</span><br><span class="line">OC：老年代大小</span><br><span class="line">OU：老年代使用大小</span><br><span class="line">YGC：年轻代垃圾回收次数</span><br><span class="line">FGC：老年代垃圾回收次数</span><br><span class="line">FGCT：老年代垃圾回收消耗时间</span><br><span class="line">GCT：垃圾回收消耗总时间</span><br></pre></td></tr></table></figure>



<h5 id="jstat-gcoldcapacity"><a href="#jstat-gcoldcapacity" class="headerlink" title="jstat -gcoldcapacity"></a><strong>jstat -gcoldcapacity</strong></h5><p>显示内容与-gcold 基本相同，输出主要关注使用到的最大、最小空间</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\Think&gt;jstat -gcoldcapacity 24112 1000 10</span><br><span class="line">   OGCMN       OGCMX        OGC         OC       YGC   FGC    FGCT     GCT</span><br><span class="line">    40960.0     40960.0     40960.0     40960.0     1     0    0.000    0.004</span><br><span class="line">    40960.0     40960.0     40960.0     40960.0     1     0    0.000    0.004</span><br><span class="line">    40960.0     40960.0     40960.0     40960.0     1     0    0.000    0.004</span><br><span class="line">    40960.0     40960.0     40960.0     40960.0     1     0    0.000    0.004</span><br><span class="line">    40960.0     40960.0     40960.0     40960.0     1     0    0.000    0.004</span><br><span class="line">    40960.0     40960.0     40960.0     40960.0     1     0    0.000    0.004</span><br><span class="line">    40960.0     40960.0     40960.0     40960.0     1     0    0.000    0.004</span><br><span class="line">    40960.0     40960.0     40960.0     40960.0     1     0    0.000    0.004</span><br><span class="line">    40960.0     40960.0     40960.0     40960.0     1     0    0.000    0.004</span><br><span class="line">    40960.0     40960.0     40960.0     40960.0     1     0    0.000    0.004</span><br></pre></td></tr></table></figure>



<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">OGCMN：老年代最小容量</span><br><span class="line">OGCMX：老年代最大容量</span><br><span class="line">OGC：当前老年代大小</span><br><span class="line">OC：老年代大小</span><br><span class="line">YGC：年轻代垃圾回收次数</span><br><span class="line">FGC：老年代垃圾回收次数</span><br><span class="line">FGCT：老年代垃圾回收消耗时间</span><br><span class="line">GCT：垃圾回收消耗总时间</span><br></pre></td></tr></table></figure>



<h5 id="jstat-gcmetacapacity"><a href="#jstat-gcmetacapacity" class="headerlink" title="jstat -gcmetacapacity"></a><strong>jstat -gcmetacapacity</strong></h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\Think&gt;jstat -gcmetacapacity 15232 1000 10</span><br><span class="line">   MCMN       MCMX        MC       CCSMN      CCSMX       CCSC     YGC   FGC    FGCT     GCT</span><br><span class="line">       0.0  1056768.0     4480.0        0.0  1048576.0      384.0     0     0    0.000    0.000</span><br><span class="line">       0.0  1056768.0     4480.0        0.0  1048576.0      384.0     0     0    0.000    0.000</span><br><span class="line">       0.0  1056768.0     4480.0        0.0  1048576.0      384.0     0     0    0.000    0.000</span><br><span class="line">       0.0  1056768.0     4480.0        0.0  1048576.0      384.0     0     0    0.000    0.000</span><br><span class="line">       0.0  1056768.0     4864.0        0.0  1048576.0      512.0     1     0    0.000    0.004</span><br><span class="line">       0.0  1056768.0     4864.0        0.0  1048576.0      512.0     1     0    0.000    0.004</span><br><span class="line">       0.0  1056768.0     4864.0        0.0  1048576.0      512.0     1     0    0.000    0.004</span><br><span class="line">       0.0  1056768.0     4864.0        0.0  1048576.0      512.0     1     0    0.000    0.004</span><br><span class="line">       0.0  1056768.0     4864.0        0.0  1048576.0      512.0     1     0    0.000    0.004</span><br><span class="line">       0.0  1056768.0     4864.0        0.0  1048576.0      512.0     1     0    0.000    0.004</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">MCMN: 最小元数据容量</span><br><span class="line">MCMX：最大元数据容量</span><br><span class="line">MC：当前元数据空间大小</span><br><span class="line">CCSMN：最小压缩类空间大小</span><br><span class="line">CCSMX：最大压缩类空间大小</span><br><span class="line">CCSC：当前压缩类空间大小</span><br><span class="line">YGC：年轻代垃圾回收次数</span><br><span class="line">FGC：老年代垃圾回收次数</span><br><span class="line">FGCT：老年代垃圾回收消耗时间</span><br><span class="line">GCT：垃圾回收消耗总时间</span><br></pre></td></tr></table></figure>



<h3 id="interval-参数："><a href="#interval-参数：" class="headerlink" title="interval 参数："></a><strong>interval 参数：</strong></h3><p>用于指定输出统计数据的周期，单位为毫秒。即：查询间隔</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\Think&gt;jstat -class 12312 1000</span><br><span class="line">Loaded  Bytes  Unloaded  Bytes     Time</span><br><span class="line">   699  1398.0        0     0.0       0.35</span><br><span class="line">   699  1398.0        0     0.0       0.35</span><br><span class="line">   699  1398.0        0     0.0       0.35</span><br><span class="line">   699  1398.0        0     0.0       0.35</span><br><span class="line">   699  1398.0        0     0.0       0.35</span><br><span class="line">   699  1398.0        0     0.0       0.35</span><br></pre></td></tr></table></figure>

<h3 id="count-参数："><a href="#count-参数：" class="headerlink" title="count 参数："></a><strong>count 参数：</strong></h3><p>用于指定查询的总次数</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\Think&gt;jstat -class 12312 1000 10</span><br><span class="line">Loaded  Bytes  Unloaded  Bytes     Time</span><br><span class="line">   699  1398.0        0     0.0       0.35</span><br><span class="line">   699  1398.0        0     0.0       0.35</span><br><span class="line">   699  1398.0        0     0.0       0.35</span><br><span class="line">   699  1398.0        0     0.0       0.35</span><br><span class="line">   699  1398.0        0     0.0       0.35</span><br><span class="line">   699  1398.0        0     0.0       0.35</span><br><span class="line">   699  1398.0        0     0.0       0.35</span><br><span class="line">   699  1398.0        0     0.0       0.35</span><br><span class="line">   699  1398.0        0     0.0       0.35</span><br><span class="line">   699  1398.0        0     0.0       0.35</span><br><span class="line"></span><br><span class="line">C:\Users\Think&gt;</span><br></pre></td></tr></table></figure>

<h4 id="t-参数："><a href="#t-参数：" class="headerlink" title="-t 参数："></a><strong>-t 参数：</strong></h4><p>可以在输出信息前加上一个 Timestamp 列，显示程序的运行时间（从项目执行到现在运行的总时间）。单位：秒</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\Think&gt;jstat -class -t 12312</span><br><span class="line">Timestamp       Loaded   Bytes     Unloaded  Bytes     Time</span><br><span class="line">    464.9       699      1398.0        0     0.0       0.35</span><br></pre></td></tr></table></figure>

<p>我们可以比较Java进程的启动时间以及总GC时间（GCT列），或者两次测量的间隔时间以及总GC时间的增量,来得出<strong>GC时间占运行时间的比例</strong>。</p>
<p>如果该比例超过20%，则说明目前堆的压力较大;如果该比例超过90%，则说明堆里几乎没有可用空间，随时都可能抛出OOM异常。</p>
<h4 id="h-参数："><a href="#h-参数：" class="headerlink" title="-h 参数："></a><strong>-h 参数：</strong></h4><p>可以在周期性数据输出时，输出多少行数据后输出一个<strong>表头信息</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\Think&gt;jstat -class -t -h3 12312 1000 10</span><br><span class="line">Timestamp       Loaded  Bytes  Unloaded  Bytes     Time</span><br><span class="line">          647.3    699  1398.0        0     0.0       0.35</span><br><span class="line">          648.4    699  1398.0        0     0.0       0.35</span><br><span class="line">          649.4    699  1398.0        0     0.0       0.35</span><br><span class="line">Timestamp       Loaded  Bytes  Unloaded  Bytes     Time</span><br><span class="line">          650.4    699  1398.0        0     0.0       0.35</span><br><span class="line">          651.4    699  1398.0        0     0.0       0.35</span><br><span class="line">          652.4    699  1398.0        0     0.0       0.35</span><br><span class="line">Timestamp       Loaded  Bytes  Unloaded  Bytes     Time</span><br><span class="line">          653.4    699  1398.0        0     0.0       0.35</span><br><span class="line">          654.5    699  1398.0        0     0.0       0.35</span><br><span class="line">          655.5    699  1398.0        0     0.0       0.35</span><br><span class="line">Timestamp       Loaded  Bytes  Unloaded  Bytes     Time</span><br><span class="line">          656.5    699  1398.0        0     0.0       0.35</span><br></pre></td></tr></table></figure>

<h3 id="补充："><a href="#补充：" class="headerlink" title="补充："></a><strong>补充：</strong></h3><p>jstat 还可以用来判断是否出现内存泄漏。</p>
<p>第 1 步：在长时间运行的 Java 程序中，我们可以运行 jstat 命令连续获取多行性能数据，并取这几行数据中 OU 列（即已占用的老年代内存）的最小值。</p>
<p>第 2 步：然后，我们每隔一段较长的时间重复一次上述操作，来获得多组 OU 最小值。如果这些值呈上涨趋势，则说明该 Java 程序的老年代内存已使用量在不断上涨，这意味着无法回收的对象在不断增加，因此很有可能存在内存泄漏。</p>
<h2 id="jinfo：实时查看和修改-JVM-配置参数"><a href="#jinfo：实时查看和修改-JVM-配置参数" class="headerlink" title="jinfo：实时查看和修改 JVM 配置参数"></a>jinfo：实时查看和修改 JVM 配置参数</h2><h3 id="概述-1"><a href="#概述-1" class="headerlink" title="概述"></a>概述</h3><p>jinfo(Configuration Info for Java)：查看虚拟机配置参数信息，也可用于调整虚拟机的配置参数。</p>
<p>在很多情况下，Java 应用程序不会指定所有的 Java 虚拟机参数。而此时，开发人员可能不知道某一个具体的 Java 虚拟机参数的默认值。在这种情况下，可能需要通过查找文档获取某个参数的默认值。这个查找过程可能是非常艰难的。但有了 jinfo 工具，开发人员可以很方便地找到 Java 虚拟机参数的当前值。</p>
<p>官方地址：<a target="_blank" rel="noopener" href="https://docs.oracle.com/en/java/javase/11/tools/jinfo.html#GUID-69246B58-28C4-477D-B375-278F5F9830A5">https://docs.oracle.com/en/java/javase/11/tools/jinfo.html#GUID-69246B58-28C4-477D-B375-278F5F9830A5</a></p>
<p>基本使用语法为：jinfo [options] pid</p>
<p><strong>说明：java 进程 ID 必须要加上</strong></p>
<table>
<thead>
<tr>
<th>选项</th>
<th>选项说明</th>
</tr>
</thead>
<tbody><tr>
<td>no option</td>
<td>输出全部的参数和系统属性</td>
</tr>
<tr>
<td>-flag name</td>
<td>输出对应名称的参数</td>
</tr>
<tr>
<td>-flag [+-]name</td>
<td>开启或者关闭对应名称的参数 只有被标记为 manageable 的参数才可以被动态修改</td>
</tr>
<tr>
<td>-flag name=value</td>
<td>设定对应名称的参数</td>
</tr>
<tr>
<td>-flags</td>
<td>输出全部的参数</td>
</tr>
<tr>
<td>-sysprops</td>
<td>输出系统属性</td>
</tr>
</tbody></table>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\Think&gt;jps</span><br><span class="line">21428</span><br><span class="line">24660 KotlinCompileDaemon</span><br><span class="line">21288 ScannerTest</span><br><span class="line">23896 Jps</span><br><span class="line">15948 Launcher</span><br></pre></td></tr></table></figure>

<h3 id="查看"><a href="#查看" class="headerlink" title="查看"></a>查看</h3><h4 id="jinfo-sysprops-PID"><a href="#jinfo-sysprops-PID" class="headerlink" title="jinfo -sysprops PID"></a><strong>jinfo -sysprops PID</strong></h4><p>输出系统属性，可以查看由<code>System.getProperties()</code>取得参数</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\Think&gt;jinfo -sysprops 21288</span><br><span class="line">Attaching to process ID 21288, please <span class="built_in">wait</span>...</span><br><span class="line">Debugger attached successfully.</span><br><span class="line">Server compiler detected.</span><br><span class="line">JVM version is 25.101-b13</span><br><span class="line">java.runtime.name = Java(TM) SE Runtime Environment</span><br><span class="line">java.vm.version = 25.101-b13</span><br><span class="line">sun.boot.library.path = C:\Program Files\Java\jdk1.8.0_101\jre\bin</span><br><span class="line">java.vendor.url = http://java.oracle.com/</span><br><span class="line">java.vm.vendor = Oracle Corporation</span><br><span class="line">path.separator = ;</span><br><span class="line">file.encoding.pkg = sun.io</span><br><span class="line">java.vm.name = Java HotSpot(TM) 64-Bit Server VM</span><br><span class="line">sun.os.patch.level =</span><br><span class="line">sun.java.launcher = SUN_STANDARD</span><br><span class="line">user.script =</span><br><span class="line">user.country = CN</span><br><span class="line">user.dir = D:\interview\jvm</span><br><span class="line">java.vm.specification.name = Java Virtual Machine Specification</span><br><span class="line">java.runtime.version = 1.8.0_101-b13</span><br><span class="line">java.awt.graphicsenv = sun.awt.Win32GraphicsEnvironment</span><br><span class="line">os.arch = amd64</span><br><span class="line">java.endorsed.dirs = C:\Program Files\Java\jdk1.8.0_101\jre\lib\endorsed</span><br><span class="line">line.separator =</span><br><span class="line"></span><br><span class="line">java.io.tmpdir = C:\Users\Think\AppData\Local\Temp\</span><br><span class="line">java.vm.specification.vendor = Oracle Corporation</span><br><span class="line">user.variant =</span><br><span class="line">os.name = Windows 10</span><br><span class="line">sun.jnu.encoding = GBK</span><br><span class="line">java.library.path = C:\Program Files\Java\jdk1.8.0_101\bin;C:\WINDOWS\Sun\Java\bin;C:\WINDOWS\system32;C:\WINDOWS;D:\Program Files (x86)\MEGA5;%\jre\bin\Program Files (x86)\Common Files\Oracle\Java\javapath;C:\myJava\apache-maven-3.5.2\bin;C:\Program Files (x86)\Intel\iCLS Client\;C:\Program Files\Intel\iCLS Client\;C:\WINDOWS\system32;C:\WINDOWS;C:\WINDOWS\System32\Wbem;C:\WINDOWS\System32\WindowsPowerShell\v1.0\;C:\Program Files (x86)\Intel\Intel(R) Management Engine Components\DAL;C:\Program Files\Intel\Intel(R) Management Engine Components\DAL;C:\Program Files (x86)\Intel\Intel(R) Management Engine Components\IPT;C:\Program Files\Intel\Intel(R) Management Engine Components\IPT;C:\Program Files\Java\jdk1.8.0_101\bin;C:\Program Files\Java\jdk1.8.0_101\bin\jre\bin;c:\Program Files\JAVA\jdk1.8.0_101\\bin;C:\WINDOWS\System32\OpenSSH\;C:\Program Files\MySQL\MySQL Server 8.0\bin;C:\Program Files\OpenVPN\bin;D:\Dwimperl\c\bin;D:\Dwimperl\perl\bin;D:\Dwimperl\perl\site\bin;D:\Program Files (x86)\gradle-6.1.1/bin;D:\Program Files\Git\cmd;C:\Program Files\Calibre2\;D:\Program Files (x86)\Graphviz\bin;D:\Users\Think\AppData\Roaming\nvm;D:\Program Files\nodejs;D:\Program Files\MEGA-X;C:\Program Files\mingw-w64\x86_64-8.1.0-win32-seh-rt_v6-rev0\mingw64\bin;C:\Program Files\MySQL\mysql-5.7.34-winx64\bin;D:\Program Files (x86)\Lua\5.1;D:\Program Files (x86)\Lua\5.1\clibs;C:\Users\Think\AppData\Local\Microsoft\WindowsApps;C:\Program Files\Bandizip\;D:\Program Files (x86)\Microsoft VS Code\bin;D:\Users\Think\AppData\Roaming\nvm\v12.18.3\node_modules\npm;D:\idea\JetBrains\IntelliJIDEA2019.3\bin;;D:\Users\Think\AppData\Roaming\nvm;D:\Program Files\nodejs;<span class="string">&quot;;D:\Program Files\curl-7.78.0-win64-mingw\I386;&quot;</span>;;.</span><br><span class="line">java.specification.name = Java Platform API Specification</span><br><span class="line">java.class.version = 52.0</span><br><span class="line">sun.management.compiler = HotSpot 64-Bit Tiered Compilers</span><br><span class="line">os.version = 10.0</span><br><span class="line">user.home = C:\Users\Think</span><br><span class="line">user.timezone = Asia/Shanghai</span><br><span class="line">java.awt.printerjob = sun.awt.windows.WPrinterJob</span><br><span class="line">file.encoding = UTF-8</span><br><span class="line">java.specification.version = 1.8</span><br><span class="line">user.name = Think</span><br><span class="line">java.class.path = C:\Program Files\Java\jdk1.8.0_101\jre\lib\charsets.jar;C:\Program Files\Java\jdk1.8.0_101\jre\lib\deploy.jar;C:\Program Files\Java\jdk1.8.0_101\jre\lib\ext\access-bridge-64.jar;C:\Program Files\Java\jdk1.8.0_101\jre\lib\ext\cldrdata.jar;C:\Program Files\Java\jdk1.8.0_101\jre\lib\ext\dnsns.jar;C:\Program Files\Java\jdk1.8.0_101\jre\lib\ext\jaccess.jar;C:\Program Files\Java\jdk1.8.0_101\jre\lib\ext\jfxrt.jar;C:\Program Files\Java\jdk1.8.0_101\jre\lib\ext\localedata.jar;C:\Program Files\Java\jdk1.8.0_101\jre\lib\ext\nashorn.jar;C:\Program Files\Java\jdk1.8.0_101\jre\lib\ext\sunec.jar;C:\Program Files\Java\jdk1.8.0_101\jre\lib\ext\sunjce_provider.jar;C:\Program Files\Java\jdk1.8.0_101\jre\lib\ext\sunmscapi.jar;C:\Program Files\Java\jdk1.8.0_101\jre\lib\ext\sunpkcs11.jar;C:\Program Files\Java\jdk1.8.0_101\jre\lib\ext\zipfs.jar;C:\Program Files\Java\jdk1.8.0_101\jre\lib\javaws.jar;C:\Program Files\Java\jdk1.8.0_101\jre\lib\jce.jar;C:\Program Files\Java\jdk1.8.0_101\jre\lib\jfr.jar;C:\Program Files\Java\jdk1.8.0_101\jre\lib\jfxswt.jar;C:\Program Files\Java\jdk1.8.0_101\jre\lib\jsse.jar;C:\Program Files\Java\jdk1.8.0_101\jre\lib\management-agent.jar;C:\Program Files\Java\jdk1.8.0_101\jre\lib\plugin.jar;C:\Program Files\Java\jdk1.8.0_101\jre\lib\resources.jar;C:\Program Files\Java\jdk1.8.0_101\jre\lib\rt.jar;D:\interview\jvm\target\classes;D:\ideaJetBrains\IntelliJIDEA2019.3\lib\idea_rt.jar</span><br><span class="line">java.vm.specification.version = 1.8</span><br><span class="line">sun.arch.data.model = 64</span><br><span class="line">sun.java.command = top.lvxiaoyi.three.chapter02.code02.ScannerTest</span><br><span class="line">java.home = C:\Program Files\Java\jdk1.8.0_101\jre</span><br><span class="line">user.language = zh</span><br><span class="line">java.specification.vendor = Oracle Corporation</span><br><span class="line">awt.toolkit = sun.awt.windows.WToolkit</span><br><span class="line">java.vm.info = mixed mode</span><br><span class="line">java.version = 1.8.0_101</span><br><span class="line">java.ext.dirs = C:\Program Files\Java\jdk1.8.0_101\jre\lib\ext;C:\WINDOWS\Sun\Java\lib\ext</span><br><span class="line">sun.boot.class.path = C:\Program Files\Java\jdk1.8.0_101\jre\lib\resources.jar;C:\Program Files\Java\jdk1.8.0_101\jre\lib\rt.jar;C:\Program Files\Java\jdk1.8.0_101\jre\lib\sunrsasign.jar;C:\Program Files\Java\jdk1.8.0_101\jre\lib\jsse.jar;C:\Program Files\Java\jdk1.8.0_101\jre\lib\jce.jar;C:\Program Files\Java\jdk1.8.0_101\jre\lib\charsets.jar;C:\Program Files\Java\jdk1.8.0_101\jre\lib\jfr.jar;C:\Program Files\Java\jdk1.8.0_101\jre\classes</span><br><span class="line">java.vendor = Oracle Corporation</span><br><span class="line">file.separator = \</span><br><span class="line">java.vendor.url.bug = http://bugreport.sun.com/bugreport/</span><br><span class="line">sun.io.unicode.encoding = UnicodeLittle</span><br><span class="line">sun.cpu.endian = little</span><br><span class="line">sun.desktop = windows</span><br><span class="line">sun.cpu.isalist = amd64</span><br></pre></td></tr></table></figure>

<h4 id="jinfo-flags-PID"><a href="#jinfo-flags-PID" class="headerlink" title="jinfo -flags PID"></a><strong>jinfo -flags PID</strong></h4><p>输出全部的参数</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\Think&gt;jinfo -flags 21288</span><br><span class="line">Attaching to process ID 21288, please <span class="built_in">wait</span>...</span><br><span class="line">Debugger attached successfully.</span><br><span class="line">Server compiler detected.</span><br><span class="line">JVM version is 25.101-b13</span><br><span class="line">Non-default VM flags: -XX:CICompilerCount=4 -XX:InitialHeapSize=62914560 -XX:MaxHeapSize=62914560 -XX:MaxNewSize=20971520 -XX:MinHeapDeltaBytes=524288 -XX:NewSize=20971520 -XX:OldSize=41943040 -XX:SurvivorRatio=8 -XX:+UseCompressedClassPointers -XX:+UseCompressedOops -XX:+UseFastUnorderedTimeStamps -XX:-UseLargePagesIndividualAllocation -XX:+UseParallelGC</span><br><span class="line">Command line:  -Xms60m -Xmx60m -XX:SurvivorRatio=8 -javaagent:D:\ideaJetBrains\IntelliJIDEA2019.3\lib\idea_rt.jar=52057:D:\ideaJetBrains\IntelliJIDEA2019.3\bin -Dfile.encoding=UTF-8</span><br></pre></td></tr></table></figure>

<h4 id="jinfo-flag-name-PID"><a href="#jinfo-flag-name-PID" class="headerlink" title="jinfo -flag name PID"></a><strong>jinfo -flag name PID</strong></h4><p>输出对应名称的参数</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\Think&gt;jinfo -flag UseParallelGC 21288</span><br><span class="line">-XX:+UseParallelGC</span><br><span class="line"></span><br><span class="line">C:\Users\Think&gt;jinfo -flag UseSerialGC 21288</span><br><span class="line">-XX:-UseSerialGC</span><br></pre></td></tr></table></figure>

<h3 id="修改"><a href="#修改" class="headerlink" title="修改"></a>修改</h3><p>jinfo不仅可以查看运行时某一个Java虚拟机参数的实际取值，甚至可以在运行时修改部分参数，并使之立即生效。</p>
<p>但是，并非所有参数都支持动态修改。参数只有被标记为manageable的flag可以被实时修改。<strong>其实，这个修改能力是极其有限的</strong>。</p>
<ul>
<li>可以查看被标记为manageable的参数</li>
<li>下面为linux的指令，|就是管道符（如果不知道看操作系统，就是前面的的命令结果作为后面的标准输入），grep就是正则匹配筛选</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[root@iZ2ze0xc1pcwgfqh1z6tfgZ ~]<span class="comment"># java -XX:+PrintFlagsFinal -version | grep manageable</span></span><br><span class="line">     intx CMSAbortablePrecleanWaitMillis            = 100                                 &#123;manageable&#125;</span><br><span class="line">     intx CMSTriggerInterval                        = -1                                  &#123;manageable&#125;</span><br><span class="line">     intx CMSWaitDuration                           = 2000                                &#123;manageable&#125;</span><br><span class="line">     bool HeapDumpAfterFullGC                       = <span class="literal">false</span>                               &#123;manageable&#125;</span><br><span class="line">     bool HeapDumpBeforeFullGC                      = <span class="literal">false</span>                               &#123;manageable&#125;</span><br><span class="line">     bool HeapDumpOnOutOfMemoryError                = <span class="literal">false</span>                               &#123;manageable&#125;</span><br><span class="line">    ccstr HeapDumpPath                              =                                     &#123;manageable&#125;</span><br><span class="line">    uintx MaxHeapFreeRatio                          = 70                                  &#123;manageable&#125;</span><br><span class="line">    uintx MinHeapFreeRatio                          = 40                                  &#123;manageable&#125;</span><br><span class="line">     bool PrintClassHistogram                       = <span class="literal">false</span>                               &#123;manageable&#125;</span><br><span class="line">     bool PrintClassHistogramAfterFullGC            = <span class="literal">false</span>                               &#123;manageable&#125;</span><br><span class="line">     bool PrintClassHistogramBeforeFullGC           = <span class="literal">false</span>                               &#123;manageable&#125;</span><br><span class="line">     bool PrintConcurrentLocks                      = <span class="literal">false</span>                               &#123;manageable&#125;</span><br><span class="line">     bool PrintGC                                   = <span class="literal">false</span>                               &#123;manageable&#125;</span><br><span class="line">     bool PrintGCDateStamps                         = <span class="literal">false</span>                               &#123;manageable&#125;</span><br><span class="line">     bool PrintGCDetails                            = <span class="literal">false</span>                               &#123;manageable&#125;</span><br><span class="line">     bool PrintGCID                                 = <span class="literal">false</span>                               &#123;manageable&#125;</span><br><span class="line">     bool PrintGCTimeStamps                         = <span class="literal">false</span>                               &#123;manageable&#125;</span><br><span class="line">java version <span class="string">&quot;1.8.0_144&quot;</span></span><br><span class="line">Java(TM) SE Runtime Environment (build 1.8.0_144-b01)</span><br><span class="line">Java HotSpot(TM) 64-Bit Server VM (build 25.144-b01, mixed mode)</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h4 id="jinfo-flag-name-PID-1"><a href="#jinfo-flag-name-PID-1" class="headerlink" title="jinfo -flag [+-]name PID"></a><strong>jinfo -flag [+-]name PID</strong></h4><p>开启或者关闭对应名称的参数 只有被标记为 manageable 的参数才可以被动态修改</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\Think&gt;jinfo -flag PrintGCDetails 21288</span><br><span class="line">-XX:-PrintGCDetails</span><br><span class="line"></span><br><span class="line">C:\Users\Think&gt;jinfo -flag +PrintGCDetails 21288</span><br><span class="line"></span><br><span class="line">C:\Users\Think&gt;jinfo -flag PrintGCDetails 21288</span><br><span class="line">-XX:+PrintGCDetails</span><br></pre></td></tr></table></figure>

<h4 id="jinfo-flag-name-value-PID"><a href="#jinfo-flag-name-value-PID" class="headerlink" title="jinfo -flag name=value PID"></a><strong>jinfo -flag name=value PID</strong></h4><p>设定对应名称的参数</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\Think&gt;jinfo -flag MaxHeapFreeRatio 21288</span><br><span class="line">-XX:MaxHeapFreeRatio=100</span><br><span class="line"></span><br><span class="line">C:\Users\Think&gt;jinfo -flag MaxHeapFreeRatio=90 21288</span><br><span class="line"></span><br><span class="line">C:\Users\Think&gt;jinfo -flag MaxHeapFreeRatio 21288</span><br><span class="line">-XX:MaxHeapFreeRatio=90</span><br></pre></td></tr></table></figure>

<p>拓展：</p>
<ul>
<li><p>java -XX:+PrintFlagsInitial 查看所有 JVM 参数启动的初始值</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\Think&gt;java -XX:+PrintFlagsInitial</span><br><span class="line">[Global flags]</span><br><span class="line">    uintx AdaptiveSizeDecrementScaleFactor          = 4                                   &#123;product&#125;</span><br><span class="line">    uintx AdaptiveSizeMajorGCDecayTimeScale         = 10                                  &#123;product&#125;</span><br><span class="line">    uintx AdaptiveSizePausePolicy                   = 0                                   &#123;product&#125;</span><br><span class="line">     bool UseLargePagesIndividualAllocation        := <span class="literal">false</span>                               &#123;pd product&#125;</span><br><span class="line">     bool UseLockedTracing                          = <span class="literal">false</span>                               &#123;product&#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure></li>
<li><p>java -XX:+PrintFlagsFinal 查看所有 JVM 参数的最终值</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\Think&gt;java -XX:+PrintFlagsFinal</span><br><span class="line">[Global flags]</span><br><span class="line">    uintx AdaptiveSizeDecrementScaleFactor          = 4                                   &#123;product&#125;</span><br><span class="line">    uintx AdaptiveSizeMajorGCDecayTimeScale         = 10                                  &#123;product&#125;</span><br><span class="line">    uintx AdaptiveSizePausePolicy                   = 0                                   &#123;product&#125;</span><br><span class="line">    uintx AdaptiveSizePolicyCollectionCostMargin    = 50                                  &#123;product&#125;</span><br><span class="line">    uintx AdaptiveSizePolicyInitializingSteps       = 20                                  &#123;product&#125;</span><br><span class="line">    uintx AdaptiveSizePolicyOutputInterval          = 0                                   &#123;product&#125;</span><br><span class="line">    uintx AdaptiveSizePolicyWeight                  = 10                                  &#123;product&#125;</span><br><span class="line">    uintx AdaptiveSizeThroughPutPolicy              = 0                                   &#123;product&#125;</span><br><span class="line">    uintx AdaptiveTimeWeight                        = 25                                  &#123;product&#125;</span><br><span class="line">     bool AdjustConcurrency                         = <span class="literal">false</span>                               &#123;product&#125;</span><br><span class="line">    uintx InitialHeapSize                          := 268435456                           &#123;product&#125;</span><br><span class="line">    ...</span><br><span class="line">     bool UseCompressedClassPointers               := <span class="literal">true</span>                                &#123;lp64_product&#125;</span><br><span class="line">     bool UseCompressedOops                        := <span class="literal">true</span>                                &#123;lp64_product&#125;</span><br><span class="line">   ...  </span><br></pre></td></tr></table></figure></li>
<li><p>java -XX:+PrintCommandLineFlags 查看哪些已经被用户或者 JVM 设置过的详细的 XX 参数的名称和值</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\Think&gt;java -XX:PrintCommandLineFlags</span><br><span class="line">Missing +/- setting <span class="keyword">for</span> VM option <span class="string">&#x27;PrintCommandLineFlags&#x27;</span></span><br><span class="line">Error: Could not create the Java Virtual Machine.</span><br><span class="line">Error: A fatal exception has occurred. Program will <span class="built_in">exit</span>.</span><br><span class="line"></span><br><span class="line">C:\Users\Think&gt;java -XX:+PrintCommandLineFlags</span><br><span class="line">-XX:InitialHeapSize=266742976 -XX:MaxHeapSize=4267887616 -XX:+PrintCommandLineFlags -XX:+UseCompressedClassPointers -XX:+UseCompressedOops -XX:-UseLargePagesIndividualAllocation -XX:+UseParallelGC</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="jmap：导出内存映像文件-amp-内存使用情况"><a href="#jmap：导出内存映像文件-amp-内存使用情况" class="headerlink" title="jmap：导出内存映像文件&amp;内存使用情况"></a>jmap：导出内存映像文件&amp;内存使用情况</h2><h3 id="基本情况"><a href="#基本情况" class="headerlink" title="基本情况"></a>基本情况</h3><p>jmap（JVM Memory Map）：作用一方面是获取 dump 文件（堆转储快照文件，二进制文件），它还可以获取目标 Java 进程的内存相关信息，包括 Java 堆各区域的使用情况、堆中对象的统计信息、类加载信息等。开发人员可以在控制台中输入命令“jmap -help”查阅 jmap 工具的具体使用方式和一些标准选项配置。</p>
<p>官方帮助文档：<a target="_blank" rel="noopener" href="https://docs.oracle.com/en/java/javase/11/tools/jmap.html">https://docs.oracle.com/en/java/javase/11/tools/jmap.html</a></p>
<h3 id="基本语法"><a href="#基本语法" class="headerlink" title="基本语法"></a>基本语法</h3><p>基本使用语法为：</p>
<ul>
<li><code>jmap [option] &lt;pid&gt;</code></li>
<li><code>jmap [option] &lt;executable &lt;core&gt;</code></li>
<li><code>jmap [option] [server_id@] &lt;remote server IP or hostname&gt;</code></li>
</ul>
<table>
<thead>
<tr>
<th>选项</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td>-dump</td>
<td>生成 dump 文件（Java 堆转储快照），-dump:live 只保存堆中的存活对象</td>
</tr>
<tr>
<td>-heap</td>
<td>输出整个堆空间的详细信息，包括 GC 的使用、堆配置信息，以及内存的使用信息等</td>
</tr>
<tr>
<td>-histo</td>
<td>输出堆空间中对象的统计信息，包括类、实例数量和合计容量，-histo:live 只统计堆中的存活对象</td>
</tr>
<tr>
<td><code>-J &lt;flag&gt;</code></td>
<td>传递参数给 jmap 启动的 jvm</td>
</tr>
<tr>
<td>-finalizerinfo</td>
<td>显示在 F-Queue 中等待 Finalizer 线程执行 finalize 方法的对象，仅 linux/solaris 平台有效</td>
</tr>
<tr>
<td>-permstat</td>
<td>以 ClassLoader 为统计口径输出永久代的内存状态信息，仅 linux/solaris 平台有效</td>
</tr>
<tr>
<td>-F</td>
<td>当虚拟机进程对-dump 选项没有任何响应时，强制执行生成 dump 文件，仅 linux/solaris 平台有效</td>
</tr>
</tbody></table>
<p>说明：这些参数和 linux 下输入显示的命令多少会有不同，包括也受 jdk 版本的影响。</p>
<h3 id="导出内存映像文件"><a href="#导出内存映像文件" class="headerlink" title="导出内存映像文件"></a>导出内存映像文件</h3><p>一般来说，使用jmap指令生成dump文件的操作算得上是最常用的jmap命令之一,将堆中所有存活对象导出至一个文件之中。</p>
<p>Heap Dump又叫做堆存储文件，指一个Java进程在某个时间点的内存快照。Heap Dump在触发内存快照的时候会保存此刻的信息如下：</p>
<ul>
<li><p>All 0bjects</p>
<p>Class、fields 、 primitive values and references</p>
</li>
<li><p>All classes</p>
<p>classLoader、name 、 super class、static fields </p>
</li>
<li><p>Garbage Collection Roots</p>
<p>0bjects defined to be reachable by the JVM</p>
</li>
<li><p> Thread Stacks and Local Variables</p>
</li>
</ul>
<p>  The call-stacks of threads at the moment of the snapshot, and per-frameinformation about local objects</p>
<p>说明：</p>
<ol>
<li><p>通常在写Heap Dump文件前会触发一次Full GC，所以heap dump文件里保存的都是Full GC后留下的对象信息。</p>
</li>
<li><p>由于生成dump文件比较耗时，需要耐心等待，尤其是<strong>大内存镜像生成dump文件则需要耗费更长的时间</strong>来完成。</p>
</li>
</ol>
<h4 id="手动"><a href="#手动" class="headerlink" title="手动"></a>手动</h4><h5 id="jmap-dump"><a href="#jmap-dump" class="headerlink" title="jmap -dump"></a>jmap -dump</h5><p><code>jmap -dump:format=b,file=&lt;filename.hprof&gt; &lt;pid&gt;</code>：导出所有的dump文件，b代表着格式对齐</p>
<p><code>jmap -dump:live,format=b,file=&lt;filename.hprof&gt; &lt;pid&gt;</code>：只导出存活的dump文</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\Think&gt;jps</span><br><span class="line">2576 Jps</span><br><span class="line">19044 Launcher</span><br><span class="line">21428</span><br><span class="line">25096 GCTest</span><br><span class="line"></span><br><span class="line">C:\Users\Think&gt;jmap -dump:format=b,file=D:\interview\jvm\src\main\java\top\lvxiaoyi\three\chapter02\code02\1.hprof 25096</span><br><span class="line">Dumping heap to D:\interview\jvm\src\main\java\top\lvxiaoyi\three\chapter02\code02\1.hprof ...</span><br><span class="line">Heap dump file created</span><br><span class="line"></span><br><span class="line">C:\Users\Think&gt;jmap -dump:format=b,file=D:\interview\jvm\src\main\java\top\lvxiaoyi\three\chapter02\code02\2.hprof 25096</span><br><span class="line">Dumping heap to D:\interview\jvm\src\main\java\top\lvxiaoyi\three\chapter02\code02\2.hprof ...</span><br><span class="line">Heap dump file created</span><br><span class="line"></span><br><span class="line">C:\Users\Think&gt;jmap -dump:format=b,file=D:\interview\jvm\src\main\java\top\lvxiaoyi\three\chapter02\code02\3.hprof 25096</span><br><span class="line">Dumping heap to D:\interview\jvm\src\main\java\top\lvxiaoyi\three\chapter02\code02\3.hprof ...</span><br><span class="line">Heap dump file created</span><br><span class="line"></span><br><span class="line">C:\Users\Think&gt;jmap -dump:live,format=b,file=D:\interview\jvm\src\main\java\top\lvxiaoyi\three\chapter02\code02\4.hprof 25096</span><br><span class="line">Dumping heap to D:\interview\jvm\src\main\java\top\lvxiaoyi\three\chapter02\code02\4.hprof ...</span><br><span class="line">Heap dump file created</span><br></pre></td></tr></table></figure>



<p>更多的OOM是因为存活的对象所造成的，所有用live一个是文件更小，速度更快，一个也是因为更多的问题在存活的对象上</p>
<h4 id="自动"><a href="#自动" class="headerlink" title="自动"></a>自动</h4><p>当程序发生oOM退出系统时，一些瞬时信息都随着程序的终止而消失，而重现OOM问题往往比较困难或者耗时。此时若能在0OM时，自动导出dump文件就显得非常迫切。</p>
<p>这里介绍一种比较常用的取得堆快照文件的方法，即使用：</p>
<p><code>-XX:+HeapDumpOnOutOfMemoryError</code>：在程序发生O0M时，导出应用程序的当前堆快照。</p>
<p><code>-XX:HeapDumpPath</code>：可以指定堆快照的保存位置。<br>比如:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">-Xms60m</span><br><span class="line">-Xmx60m</span><br><span class="line">-XX:SurvivorRatio=8</span><br><span class="line">-XX:+HeapDumpOnOutOfMemoryError</span><br><span class="line">-XX:HeapDumpPath=D:\interview\jvm\src\main\java\top\lvxiaoyi\three\chapter02\code02\m.hprof</span><br></pre></td></tr></table></figure>

<p><img src="https://img.lvxiaoyi.top/typora-img/image-20210928145002893.png/lvxiaoyi" alt="image-20210928145002893"></p>
<p><strong>对m.hprof分析</strong></p>
<p><img src="https://img.lvxiaoyi.top/typora-img/image-20210928145640507.png/lvxiaoyi" alt="image-20210928145640507"></p>
<p><img src="https://img.lvxiaoyi.top/typora-img/image-20210928145823203.png/lvxiaoyi" alt="image-20210928145823203"></p>
<p>从上面分析我们可以看出来是arrylist导致的OOM</p>
<h3 id="显示堆内存相关信息"><a href="#显示堆内存相关信息" class="headerlink" title="显示堆内存相关信息"></a>显示堆内存相关信息</h3><h4 id="jmap-heap"><a href="#jmap-heap" class="headerlink" title="jmap -heap"></a>jmap -heap</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\Think&gt;jmap -heap 25652</span><br><span class="line">Attaching to process ID 25652, please <span class="built_in">wait</span>...</span><br><span class="line">Debugger attached successfully.</span><br><span class="line">Server compiler detected.</span><br><span class="line">JVM version is 25.101-b13</span><br><span class="line"></span><br><span class="line">using thread-local object allocation.</span><br><span class="line">Parallel GC with 8 thread(s)</span><br><span class="line"><span class="comment"># heap配置信息</span></span><br><span class="line">Heap Configuration:</span><br><span class="line">	<span class="comment"># 空闲堆空间的最小百分比，HeapFreeRatio =(CurrentFreeHeapSize/CurrentTotalHeapSize) * 100，值的区间为0到100，默认值为 40。如果HeapFreeRatio &lt; MinHeapFreeRatio，则需要进行堆扩容，扩容的时机应该在每次垃圾回收之后</span></span><br><span class="line">   MinHeapFreeRatio         = 0</span><br><span class="line">   <span class="comment"># 空闲堆空间的最大百分比，计算公式为：HeapFreeRatio =(CurrentFreeHeapSize/CurrentTotalHeapSize) * 100，值的区间为0到100，默认值为 70。如果HeapFreeRatio &gt; MaxHeapFreeRatio，则需要进行堆缩容，缩容的时机应该在每次垃圾回收之后</span></span><br><span class="line">   MaxHeapFreeRatio         = 100</span><br><span class="line">   <span class="comment"># JVM 堆空间允许的最大值</span></span><br><span class="line">   MaxHeapSize              = 62914560 (60.0MB)</span><br><span class="line">   <span class="comment"># JVM 新生代堆空间的默认值</span></span><br><span class="line">   NewSize                  = 20971520 (20.0MB)</span><br><span class="line">   <span class="comment"># JVM 新生代堆空间允许的最大值</span></span><br><span class="line">   MaxNewSize               = 20971520 (20.0MB)</span><br><span class="line">   <span class="comment"># JVM 老年代堆空间的默认值。</span></span><br><span class="line">   OldSize                  = 41943040 (40.0MB)</span><br><span class="line">   <span class="comment"># 新生代（2个Survivor区和Eden区 ）与老年代（不包括永久区）的堆空间比值，表示新生代：老年代=1：2。</span></span><br><span class="line">   NewRatio                 = 2</span><br><span class="line">   <span class="comment"># 两个Survivor区和Eden区的堆空间比值为 8，表示 S0 ： S1 ：Eden = 1：1：8。</span></span><br><span class="line">   SurvivorRatio            = 8</span><br><span class="line">   <span class="comment"># JVM 元空间的默认值。</span></span><br><span class="line">   MetaspaceSize            = 21807104 (20.796875MB)</span><br><span class="line">   <span class="comment"># 压缩后类空间大小</span></span><br><span class="line">   CompressedClassSpaceSize = 1073741824 (1024.0MB)</span><br><span class="line">   <span class="comment"># JVM 元空间允许的最大值。</span></span><br><span class="line">   MaxMetaspaceSize         = 17592186044415 MB</span><br><span class="line">   <span class="comment"># 在使用 G1 垃圾回收算法时，JVM 会将 Heap 空间分隔为若干个 Region，该参数用来指定每个 Region 空间的大小。</span></span><br><span class="line">   G1HeapRegionSize         = 0 (0.0MB)</span><br><span class="line"></span><br><span class="line">Heap Usage:</span><br><span class="line">PS Young Generation</span><br><span class="line"><span class="comment"># 伊甸园区（新生区分为Eden和survivor）</span></span><br><span class="line">Eden Space:</span><br><span class="line">	<span class="comment"># 容量</span></span><br><span class="line">   capacity = 16777216 (16.0MB)</span><br><span class="line">   <span class="comment"># 已使用</span></span><br><span class="line">   used     = 15072304 (14.374069213867188MB)</span><br><span class="line">   <span class="comment"># 空闲</span></span><br><span class="line">   free     = 1704912 (1.6259307861328125MB)</span><br><span class="line">   <span class="comment"># 使用率</span></span><br><span class="line">   89.83793258666992% used</span><br><span class="line"><span class="comment"># 幸存0区（也叫form区，新生区的sruvivor）   </span></span><br><span class="line">From Space:</span><br><span class="line">   capacity = 2097152 (2.0MB)</span><br><span class="line">   used     = 0 (0.0MB)</span><br><span class="line">   free     = 2097152 (2.0MB)</span><br><span class="line">   0.0% used</span><br><span class="line"><span class="comment"># 幸存1区（也叫to区，新生区的sruvivor）     </span></span><br><span class="line">To Space:</span><br><span class="line">   capacity = 2097152 (2.0MB)</span><br><span class="line">   used     = 0 (0.0MB)</span><br><span class="line">   free     = 2097152 (2.0MB)</span><br><span class="line">   0.0% used</span><br><span class="line"><span class="comment"># 老年代   </span></span><br><span class="line">PS Old Generation</span><br><span class="line">   capacity = 41943040 (40.0MB)</span><br><span class="line">   used     = 0 (0.0MB)</span><br><span class="line">   free     = 41943040 (40.0MB)</span><br><span class="line">   0.0% used</span><br><span class="line"></span><br><span class="line">3151 interned Strings occupying 258456 bytes.</span><br></pre></td></tr></table></figure>

<p>小总结：jmap只能是这一个时间点的，而jstat虽然也是时间点，但是能多个时间点。但是，<strong>还是图像化界面用着爽！</strong></p>
<h4 id="jmap-histo"><a href="#jmap-histo" class="headerlink" title="jmap -histo"></a>jmap -histo</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\Think&gt;jmap -histo 25652</span><br><span class="line"></span><br><span class="line"> num     <span class="comment">#instances         #bytes  class name</span></span><br><span class="line">----------------------------------------------</span><br><span class="line"><span class="comment"># 都在jvm基础2的Class文件结构章节中解释过</span></span><br><span class="line">   1:           624       21741720  [B    <span class="comment">#byte数组</span></span><br><span class="line">   2:          4649         446144  [C	  <span class="comment">#char数组</span></span><br><span class="line">   3:           224         173696  [I	  <span class="comment">#int数组</span></span><br><span class="line">   4:          4488         107712  java.lang.String</span><br><span class="line">   5:           704          80360  java.lang.Class</span><br><span class="line">   6:           633          42808  [Ljava.lang.Object;</span><br><span class="line">   7:           847          33880  java.util.TreeMap<span class="variable">$Entry</span></span><br><span class="line">   8:           628          25120  java.util.LinkedHashMap<span class="variable">$Entry</span></span><br><span class="line">   9:           426          19056  [Ljava.lang.String;</span><br><span class="line">  10:           421          13472  java.util.HashMap<span class="variable">$Node</span></span><br><span class="line">  ...</span><br><span class="line"> 270:             1             16  sun.util.locale.provider.AuxLocaleProviderAdapter<span class="variable">$NullProvider</span></span><br><span class="line"> 271:             1             16  sun.util.locale.provider.SPILocaleProviderAdapter</span><br><span class="line"> 272:             1             16  sun.util.locale.provider.TimeZoneNameUtility<span class="variable">$TimeZoneNameGetter</span></span><br><span class="line"> 273:             1             16  sun.util.resources.LocaleData</span><br><span class="line"> 274:             1             16  sun.util.resources.LocaleData<span class="variable">$LocaleDataResourceBundleControl</span></span><br><span class="line">Total         15712       22778864</span><br></pre></td></tr></table></figure>



<h3 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h3><h4 id="jmap-clstats-pid"><a href="#jmap-clstats-pid" class="headerlink" title="jmap -clstats pid"></a>jmap -clstats pid</h4><p>查看系统的ClassLoader信息</p>
<p>也就是视频上所说的<code>jmap -permstat pid</code>，在jdk8（无论是在windows还是linux中）中使用clstats，而不是permstat</p>
<p>windows（Jdk1.8.0_101）：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">where</span> &lt;option&gt; is one of:</span><br><span class="line">    &lt;none&gt;               to <span class="built_in">print</span> same info as Solaris pmap</span><br><span class="line">    -heap                to <span class="built_in">print</span> java heap summary</span><br><span class="line">    -histo[:live]        to <span class="built_in">print</span> histogram of java object heap; <span class="keyword">if</span> the <span class="string">&quot;live&quot;</span></span><br><span class="line">                         suboption is specified, only count live objects</span><br><span class="line">    <span class="comment"># jdk1.8中没有-permstat  ，改为了-clstats             </span></span><br><span class="line">    -clstats             to <span class="built_in">print</span> class loader statistics</span><br><span class="line">    -finalizerinfo       to <span class="built_in">print</span> information on objects awaiting finalization</span><br><span class="line">    -dump:&lt;dump-options&gt; to dump java heap <span class="keyword">in</span> hprof binary format</span><br><span class="line">                         dump-options:</span><br><span class="line">                           live         dump only live objects; <span class="keyword">if</span> not specified,</span><br><span class="line">                                        all objects <span class="keyword">in</span> the heap are dumped.</span><br><span class="line">                           format=b     binary format</span><br><span class="line">                           file=&lt;file&gt;  dump heap to &lt;file&gt;</span><br><span class="line">                         Example: jmap -dump:live,format=b,file=heap.bin &lt;pid&gt;</span><br><span class="line">    -F                   force. Use with -dump:&lt;dump-options&gt; &lt;pid&gt; or -histo</span><br><span class="line">                         to force a heap dump or histogram when &lt;pid&gt; does not</span><br><span class="line">                         respond. The <span class="string">&quot;live&quot;</span> suboption is not supported</span><br><span class="line">                         <span class="keyword">in</span> this mode.</span><br><span class="line">    -h | -<span class="built_in">help</span>           to <span class="built_in">print</span> this <span class="built_in">help</span> message</span><br><span class="line">    -J&lt;flag&gt;             to pass &lt;flag&gt; directly to the runtime system</span><br></pre></td></tr></table></figure>

<p>linux（jdk1.8.0_144）：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">where &lt;option&gt; is one of:</span><br><span class="line">    &lt;none&gt;               to print same info as Solaris pmap</span><br><span class="line">    -heap                to print java heap summary</span><br><span class="line">    -histo[:live]        to print histogram of java object heap; if the &quot;live&quot;</span><br><span class="line">                         suboption is specified, only count live objects</span><br><span class="line">    -clstats             to print class loader statistics</span><br><span class="line">    -finalizerinfo       to print information on objects awaiting finalization</span><br><span class="line">    -dump:&lt;dump-options&gt; to dump java heap in hprof binary format</span><br><span class="line">                         dump-options:</span><br><span class="line">                           live         dump only live objects; if not specified,</span><br><span class="line">                                        all objects in the heap are dumped.</span><br><span class="line">                           format=b     binary format</span><br><span class="line">                           file=&lt;file&gt;  dump heap to &lt;file&gt;</span><br><span class="line">                         Example: jmap -dump:live,format=b,file=heap.bin &lt;pid&gt;</span><br><span class="line">    -F                   force. Use with -dump:&lt;dump-options&gt; &lt;pid&gt; or -histo</span><br><span class="line">                         to force a heap dump or histogram when &lt;pid&gt; does not</span><br><span class="line">                         respond. The &quot;live&quot; suboption is not supported</span><br><span class="line">                         in this mode.</span><br><span class="line">    -h | -help           to print this help message</span><br><span class="line">    -J&lt;flag&gt;             to pass &lt;flag&gt; directly to the runtime system</span><br><span class="line"></span><br></pre></td></tr></table></figure>





<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\Think&gt;jmap -clstats 9080</span><br><span class="line">Attaching to process ID 9080, please wait...</span><br><span class="line">Debugger attached successfully.</span><br><span class="line">Server compiler detected.</span><br><span class="line">JVM version is 25.101-b13</span><br><span class="line">finding class loader instances ..done.</span><br><span class="line">computing per loader stat ..done.</span><br><span class="line">please wait.. computing liveness..................................................................................................done.</span><br><span class="line">class_loader    classes bytes   parent_loader   alive?  type</span><br><span class="line"></span><br><span class="line">&lt;bootstrap&gt;         618   1153211   null          		live    &lt;internal&gt;</span><br><span class="line">0x00000000ffc28010    0     0       null          		live    sun/misc/Launcher$ExtClassLoader@0x000000010000fa30</span><br><span class="line">0x00000000fcced778    0     0      0x00000000ffc202d8    live   java/util/ResourceBundle$RBClassLoader@0x0000000100066f40</span><br><span class="line">0x00000000ffc202d8    25    72291  0x00000000ffc28010    live    sun/misc/Launcher$AppClassLoader@0x000000010000f688</span><br><span class="line"></span><br><span class="line">total = 4       643     1225502     N/A         alive=4, dead=0     N/A</span><br></pre></td></tr></table></figure>



<h4 id="jmap-finalizerinfo"><a href="#jmap-finalizerinfo" class="headerlink" title="jmap -finalizerinfo"></a>jmap -finalizerinfo</h4><p>查看堆积在finalizer队列中的对象</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\Think&gt;jmap -finalizerinfo 20504</span><br><span class="line">Attaching to process ID 20504, please wait...</span><br><span class="line">Debugger attached successfully.</span><br><span class="line">Server compiler detected.</span><br><span class="line">JVM version is 25.101-b13</span><br><span class="line">Number of objects pending for finalization: 0</span><br></pre></td></tr></table></figure>



<h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><p>由于 jmap 将访问堆中的所有对象，为了保证在此过程中不被应用线程干扰，jmap 需要借助安全点机制，让所有线程停留在不改变堆中数据的状态。也就是说，由 jmap 导出的堆快照必定是安全点位置的。这可能导致基于该堆快照的分析结果存在偏差。</p>
<p>举个例子，假设在编译生成的机器码中，某些对象的生命周期在两个安全点之间，那么:live 选项将无法探知到这些对象。</p>
<p>另外，如果某个线程长时间无法跑到安全点，jmap 将一直等下去。</p>
<p>与前面讲的 jstat 则不同，垃圾回收器会主动将 jstat 所需要的摘要数据保存至固定位置之中，而 jstat 只需直接读取即可。</p>
<h2 id="jhat：JDK-自带堆分析工具"><a href="#jhat：JDK-自带堆分析工具" class="headerlink" title="jhat：JDK 自带堆分析工具"></a>jhat：JDK 自带堆分析工具</h2><h3 id="概述-2"><a href="#概述-2" class="headerlink" title="概述"></a>概述</h3><p>jhat(JVM Heap Analysis Tool)：</p>
<p>Sun JDK 提供的 jhat 命令与 jmap 命令搭配使用，用于分析 jmap 生成的 heap dump 文件（堆转储快照）。jhat 内置了一个微型的 HTTP/HTML 服务器，生成 dump 文件的分析结果后，用户可以在浏览器中查看分析结果（分析虚拟机转储快照信息）。</p>
<p>使用了 jhat 命令，就启动了一个 http 服务，端口是 7000，即 <a target="_blank" rel="noopener" href="http://localhost:7000/%EF%BC%8C%E5%B0%B1%E5%8F%AF%E4%BB%A5%E5%9C%A8%E6%B5%8F%E8%A7%88%E5%99%A8%E9%87%8C%E5%88%86%E6%9E%90%E3%80%82">http://localhost:7000/，就可以在浏览器里分析。</a></p>
<p>说明：jhat 命令在 JDK9、JDK10 中已经被删除，官方建议用 VisualVM 代替。</p>
<h3 id="语法"><a href="#语法" class="headerlink" title="语法"></a>语法</h3><p>基本适用语法：<code>jhat &lt;option&gt; &lt;dumpfile&gt;</code></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jhat [-stack &lt;bool&gt;] [-refs &lt;bool&gt;] [-port &lt;port&gt;] [-baseline &lt;file&gt;] [-debug &lt;int&gt;] [-version] [-h|-<span class="built_in">help</span>] &lt;file&gt;</span><br></pre></td></tr></table></figure>



<table>
<thead>
<tr>
<th>option 参数</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td>-stack false ｜ true</td>
<td>关闭｜打开对象分配调用栈跟踪</td>
</tr>
<tr>
<td>-refs false ｜ true</td>
<td>关闭｜打开对象引用跟踪</td>
</tr>
<tr>
<td>-port port-number</td>
<td>设置 jhat HTTP Server 的端口号，默认 7000</td>
</tr>
<tr>
<td>-exclude exclude-file</td>
<td>执行对象查询时需要排除的数据成员</td>
</tr>
<tr>
<td>-baseline exclude-file</td>
<td>指定一个基准堆转储</td>
</tr>
<tr>
<td>-debug int</td>
<td>设置 debug 级别</td>
</tr>
<tr>
<td>-version</td>
<td>启动后显示版本信息就退出</td>
</tr>
<tr>
<td><code>-J &lt;flag&gt;</code></td>
<td>传入启动参数，比如-J-Xmx512m</td>
</tr>
</tbody></table>
<h4 id="jhat"><a href="#jhat" class="headerlink" title="jhat"></a>jhat</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\Think&gt;jhat D:\interview\jvm\src\main\java\top\lvxiaoyi\three\chapter02\code02\2.hprof</span><br><span class="line">Reading from D:\interview\jvm\src\main\java\top\lvxiaoyi\three\chapter02\code02\2.hprof...</span><br><span class="line">Dump file created Tue Sep 28 14:32:46 CST 2021</span><br><span class="line">Snapshot <span class="built_in">read</span>, resolving...</span><br><span class="line">Resolving 15757 objects...</span><br><span class="line">Chasing references, expect 3 dots...</span><br><span class="line">Eliminating duplicate references...</span><br><span class="line">Snapshot resolved.</span><br><span class="line">Started HTTP server on port 7000</span><br><span class="line">Server is ready.</span><br></pre></td></tr></table></figure>

<p>访问：<a target="_blank" rel="noopener" href="http://localhost:7000/">http://localhost:7000/</a></p>
<img src="https://img.lvxiaoyi.top/typora-img/image-20210928164147327.png/lvxiaoyi" alt="image-20210928164147327" style="zoom:67%;" />

<p>访问：<a target="_blank" rel="noopener" href="http://localhost:7000/oql/">http://localhost:7000/oql/</a></p>
<img src="https://img.lvxiaoyi.top/typora-img/image-20210928164055033.png/lvxiaoyi" alt="image-20210928164055033" style="zoom: 67%;" />



<h2 id="jstack：打印-JVM-中线程快照"><a href="#jstack：打印-JVM-中线程快照" class="headerlink" title="jstack：打印 JVM 中线程快照"></a>jstack：打印 JVM 中线程快照</h2><h3 id="概述-3"><a href="#概述-3" class="headerlink" title="概述"></a>概述</h3><p>jstack（JVM Stack Trace）：</p>
<p>用于生成虚拟机指定进程当前时刻的线程快照（虚拟机堆栈跟踪）。线程快照就是当前虚拟机内指定进程的每一条线程正在执行的方法堆栈的集合。</p>
<p>生成线程快照的作用：可用于定位线程出现长时间停顿的原因，如线程间死锁、死循环、请求外部资源导致的长时间等待等问题。这些都是导致线程长时间停顿的常见原因。当线程出现停顿时，就可以用 jstack 显示各个线程调用的堆栈情况。</p>
<p>官方帮助文档：<a target="_blank" rel="noopener" href="https://docs.oracle.com/en/java/javase/11/tools/jstack.html">https://docs.oracle.com/en/java/javase/11/tools/jstack.html</a></p>
<p>在 thread dump 中，要留意下面几种状态</p>
<ul>
<li>死锁，Deadlock（重点关注）</li>
<li>等待资源，Waiting on condition（重点关注）</li>
<li>等待获取监视器，Waiting on monitor entry（重点关注）</li>
<li>阻塞，Blocked（重点关注）</li>
<li>执行中，Runnable</li>
<li>暂停，Suspended</li>
<li>对象等待中，Object.wait() 或 TIMED＿WAITING</li>
<li>停止，Parked</li>
</ul>
<h3 id="语法-1"><a href="#语法-1" class="headerlink" title="语法"></a>语法</h3><table>
<thead>
<tr>
<th>option 参数</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td>-F</td>
<td>当正常输出的请求不被响应时，强制输出线程堆栈</td>
</tr>
<tr>
<td>-l</td>
<td>除堆栈外，显示关于锁的附加信息</td>
</tr>
<tr>
<td>-m</td>
<td>如果调用本地方法的话，可以显示 C/C++的堆栈</td>
</tr>
</tbody></table>
<h4 id="例一"><a href="#例一" class="headerlink" title="例一"></a>例一</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> top.lvxiaoyi.three.chapter02.code02;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> lvxiaoyi</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021/9/28 16:50</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadDeadLock</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        StringBuilder s1 = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">        StringBuilder s2 = <span class="keyword">new</span> StringBuilder();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (s1) &#123;</span><br><span class="line">                s1.append(<span class="string">&quot;a&quot;</span>);</span><br><span class="line">                s2.append(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Thread.sleep(<span class="number">100</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">synchronized</span> (s2) &#123;</span><br><span class="line">                    s1.append(<span class="string">&quot;b&quot;</span>);</span><br><span class="line">                    s2.append(<span class="string">&quot;2&quot;</span>);</span><br><span class="line"></span><br><span class="line">                    System.out.println(s1);</span><br><span class="line">                    System.out.println(s2);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).start();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (s2) &#123;</span><br><span class="line">                s1.append(<span class="string">&quot;C&quot;</span>);</span><br><span class="line">                s2.append(<span class="string">&quot;3&quot;</span>);</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Thread.sleep(<span class="number">100</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">synchronized</span> (s1) &#123;</span><br><span class="line">                    s1.append(<span class="string">&quot;d&quot;</span>);</span><br><span class="line">                    s2.append(<span class="string">&quot;4&quot;</span>);</span><br><span class="line"></span><br><span class="line">                    System.out.println(s1);</span><br><span class="line">                    System.out.println(s2);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>发生死锁的四个条件：互斥、请求与保持、不可剥夺、循环等待</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\Think&gt;jstack 15488</span><br><span class="line">2021-09-28 17:06:13</span><br><span class="line">Full thread dump Java HotSpot(TM) 64-Bit Server VM (25.101-b13 mixed mode):</span><br><span class="line"></span><br><span class="line">&quot;DestroyJavaVM&quot; #14 prio=5 os_prio=0 tid=0x00000000031e2800 nid=0x6b58 waiting on condition [0x0000000000000000]</span><br><span class="line">   java.lang.Thread.State: RUNNABLE</span><br><span class="line"></span><br><span class="line">&quot;Thread-1&quot; #13 prio=5 os_prio=0 tid=0x000000001fa15000 nid=0x70fc waiting for monitor entry [0x00000000203ee000]</span><br><span class="line">   java.lang.Thread.State: BLOCKED (on object monitor)</span><br><span class="line">        at top.lvxiaoyi.three.chapter02.code02.ThreadDeadLock.lambda$main$1(ThreadDeadLock.java:44)</span><br><span class="line">        - waiting to lock &lt;0x000000076b5b2ee8&gt; (a java.lang.StringBuilder)</span><br><span class="line">        - locked &lt;0x000000076b5b2f30&gt; (a java.lang.StringBuilder)</span><br><span class="line">        at top.lvxiaoyi.three.chapter02.code02.ThreadDeadLock$$Lambda$2/990368553.run(Unknown Source)</span><br><span class="line">        at java.lang.Thread.run(Thread.java:745)</span><br><span class="line"></span><br><span class="line">&quot;Thread-0&quot; #12 prio=5 os_prio=0 tid=0x000000001fa12000 nid=0x790 waiting for monitor entry [0x00000000202ef000]</span><br><span class="line">   java.lang.Thread.State: BLOCKED (on object monitor)</span><br><span class="line">        at top.lvxiaoyi.three.chapter02.code02.ThreadDeadLock.lambda$main$0(ThreadDeadLock.java:23)</span><br><span class="line">        - waiting to lock &lt;0x000000076b5b2f30&gt; (a java.lang.StringBuilder)</span><br><span class="line">        - locked &lt;0x000000076b5b2ee8&gt; (a java.lang.StringBuilder)</span><br><span class="line">        at top.lvxiaoyi.three.chapter02.code02.ThreadDeadLock$$Lambda$1/2003749087.run(Unknown Source)</span><br><span class="line">        at java.lang.Thread.run(Thread.java:745)</span><br><span class="line"></span><br><span class="line">&quot;Service Thread&quot; #11 daemon prio=9 os_prio=0 tid=0x000000001ed68000 nid=0x5888 runnable [0x0000000000000000]</span><br><span class="line">   java.lang.Thread.State: RUNNABLE</span><br><span class="line"></span><br><span class="line">&quot;C1 CompilerThread3&quot; #10 daemon prio=9 os_prio=2 tid=0x000000001ecdc800 nid=0x52f0 waiting on condition [0x0000000000000000]</span><br><span class="line">   java.lang.Thread.State: RUNNABLE</span><br><span class="line"></span><br><span class="line">&quot;C2 CompilerThread2&quot; #9 daemon prio=9 os_prio=2 tid=0x000000001eccf800 nid=0x700 waiting on condition [0x0000000000000000]</span><br><span class="line">   java.lang.Thread.State: RUNNABLE</span><br><span class="line"></span><br><span class="line">&quot;C2 CompilerThread1&quot; #8 daemon prio=9 os_prio=2 tid=0x000000001ecca000 nid=0x6908 waiting on condition [0x0000000000000000]</span><br><span class="line">   java.lang.Thread.State: RUNNABLE</span><br><span class="line"></span><br><span class="line">&quot;C2 CompilerThread0&quot; #7 daemon prio=9 os_prio=2 tid=0x000000001ecc4800 nid=0x5ab8 waiting on condition [0x0000000000000000]</span><br><span class="line">   java.lang.Thread.State: RUNNABLE</span><br><span class="line"></span><br><span class="line">&quot;Monitor Ctrl-Break&quot; #6 daemon prio=5 os_prio=0 tid=0x000000001ecbe800 nid=0xb78 runnable [0x000000001f3ee000]</span><br><span class="line">   java.lang.Thread.State: RUNNABLE</span><br><span class="line">        at java.net.SocketInputStream.socketRead0(Native Method)</span><br><span class="line">        at java.net.SocketInputStream.socketRead(SocketInputStream.java:116)</span><br><span class="line">        at java.net.SocketInputStream.read(SocketInputStream.java:170)</span><br><span class="line">        at java.net.SocketInputStream.read(SocketInputStream.java:141)</span><br><span class="line">        at sun.nio.cs.StreamDecoder.readBytes(StreamDecoder.java:284)</span><br><span class="line">        at sun.nio.cs.StreamDecoder.implRead(StreamDecoder.java:326)</span><br><span class="line">        at sun.nio.cs.StreamDecoder.read(StreamDecoder.java:178)</span><br><span class="line">        - locked &lt;0x000000076b487b20&gt; (a java.io.InputStreamReader)</span><br><span class="line">        at java.io.InputStreamReader.read(InputStreamReader.java:184)</span><br><span class="line">        at java.io.BufferedReader.fill(BufferedReader.java:161)</span><br><span class="line">        at java.io.BufferedReader.readLine(BufferedReader.java:324)</span><br><span class="line">        - locked &lt;0x000000076b487b20&gt; (a java.io.InputStreamReader)</span><br><span class="line">        at java.io.BufferedReader.readLine(BufferedReader.java:389)</span><br><span class="line">        at com.intellij.rt.execution.application.AppMainV2$1.run(AppMainV2.java:64)</span><br><span class="line"></span><br><span class="line">&quot;Attach Listener&quot; #5 daemon prio=5 os_prio=2 tid=0x000000001ec7b800 nid=0x1480 waiting on condition [0x0000000000000000]</span><br><span class="line">   java.lang.Thread.State: RUNNABLE</span><br><span class="line"></span><br><span class="line">&quot;Signal Dispatcher&quot; #4 daemon prio=9 os_prio=2 tid=0x000000001ec2c000 nid=0x6fdc runnable [0x0000000000000000]</span><br><span class="line">   java.lang.Thread.State: RUNNABLE</span><br><span class="line"></span><br><span class="line">&quot;Finalizer&quot; #3 daemon prio=8 os_prio=1 tid=0x000000001ec10800 nid=0x69b8 in Object.wait() [0x000000001f0ef000]</span><br><span class="line">   java.lang.Thread.State: WAITING (on object monitor)</span><br><span class="line">        at java.lang.Object.wait(Native Method)</span><br><span class="line">        - waiting on &lt;0x000000076b308ee0&gt; (a java.lang.ref.ReferenceQueue$Lock)</span><br><span class="line">        at java.lang.ref.ReferenceQueue.remove(ReferenceQueue.java:143)</span><br><span class="line">        - locked &lt;0x000000076b308ee0&gt; (a java.lang.ref.ReferenceQueue$Lock)</span><br><span class="line">        at java.lang.ref.ReferenceQueue.remove(ReferenceQueue.java:164)</span><br><span class="line">        at java.lang.ref.Finalizer$FinalizerThread.run(Finalizer.java:209)</span><br><span class="line"></span><br><span class="line">&quot;Reference Handler&quot; #2 daemon prio=10 os_prio=2 tid=0x00000000032d9000 nid=0x61c in Object.wait() [0x000000001ebef000]</span><br><span class="line">   java.lang.Thread.State: WAITING (on object monitor)</span><br><span class="line">        at java.lang.Object.wait(Native Method)</span><br><span class="line">        - waiting on &lt;0x000000076b306b50&gt; (a java.lang.ref.Reference$Lock)</span><br><span class="line">        at java.lang.Object.wait(Object.java:502)</span><br><span class="line">        at java.lang.ref.Reference.tryHandlePending(Reference.java:191)</span><br><span class="line">        - locked &lt;0x000000076b306b50&gt; (a java.lang.ref.Reference$Lock)</span><br><span class="line">        at java.lang.ref.Reference$ReferenceHandler.run(Reference.java:153)</span><br><span class="line"></span><br><span class="line">&quot;VM Thread&quot; os_prio=2 tid=0x000000001cd19800 nid=0x3e80 runnable</span><br><span class="line"></span><br><span class="line">&quot;GC task thread#0 (ParallelGC)&quot; os_prio=0 tid=0x00000000031f8000 nid=0x358c runnable</span><br><span class="line"></span><br><span class="line">&quot;GC task thread#1 (ParallelGC)&quot; os_prio=0 tid=0x00000000031fa000 nid=0x6024 runnable</span><br><span class="line"></span><br><span class="line">&quot;GC task thread#2 (ParallelGC)&quot; os_prio=0 tid=0x00000000031fb800 nid=0x4704 runnable</span><br><span class="line"></span><br><span class="line">&quot;GC task thread#3 (ParallelGC)&quot; os_prio=0 tid=0x00000000031fe000 nid=0x5a1c runnable</span><br><span class="line"></span><br><span class="line">&quot;GC task thread#4 (ParallelGC)&quot; os_prio=0 tid=0x0000000003200000 nid=0x4e78 runnable</span><br><span class="line"></span><br><span class="line">&quot;GC task thread#5 (ParallelGC)&quot; os_prio=0 tid=0x0000000003201800 nid=0x6d58 runnable</span><br><span class="line"></span><br><span class="line">&quot;GC task thread#6 (ParallelGC)&quot; os_prio=0 tid=0x0000000003204800 nid=0x6c70 runnable</span><br><span class="line"></span><br><span class="line">&quot;GC task thread#7 (ParallelGC)&quot; os_prio=0 tid=0x0000000003205800 nid=0x72f8 runnable</span><br><span class="line"></span><br><span class="line">&quot;VM Periodic Task Thread&quot; os_prio=2 tid=0x000000001ed9e000 nid=0x31b0 waiting on condition</span><br><span class="line"></span><br><span class="line">JNI global references: 335</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Found one Java-level deadlock:</span><br><span class="line">=============================</span><br><span class="line">&quot;Thread-1&quot;:</span><br><span class="line">  waiting to lock monitor 0x000000001cd23708 (object 0x000000076b5b2ee8, a java.lang.StringBuilder),</span><br><span class="line">  which is held by &quot;Thread-0&quot;</span><br><span class="line">&quot;Thread-0&quot;:</span><br><span class="line">  waiting to lock monitor 0x000000001cd22268 (object 0x000000076b5b2f30, a java.lang.StringBuilder),</span><br><span class="line">  which is held by &quot;Thread-1&quot;</span><br><span class="line"></span><br><span class="line">Java stack information for the threads listed above:</span><br><span class="line">===================================================</span><br><span class="line">&quot;Thread-1&quot;:</span><br><span class="line">        at top.lvxiaoyi.three.chapter02.code02.ThreadDeadLock.lambda$main$1(ThreadDeadLock.java:44)</span><br><span class="line">        - waiting to lock &lt;0x000000076b5b2ee8&gt; (a java.lang.StringBuilder)</span><br><span class="line">        - locked &lt;0x000000076b5b2f30&gt; (a java.lang.StringBuilder)</span><br><span class="line">        at top.lvxiaoyi.three.chapter02.code02.ThreadDeadLock$$Lambda$2/990368553.run(Unknown Source)</span><br><span class="line">        at java.lang.Thread.run(Thread.java:745)</span><br><span class="line">&quot;Thread-0&quot;:</span><br><span class="line">        at top.lvxiaoyi.three.chapter02.code02.ThreadDeadLock.lambda$main$0(ThreadDeadLock.java:23)</span><br><span class="line">        - waiting to lock &lt;0x000000076b5b2f30&gt; (a java.lang.StringBuilder)</span><br><span class="line">        - locked &lt;0x000000076b5b2ee8&gt; (a java.lang.StringBuilder)</span><br><span class="line">        at top.lvxiaoyi.three.chapter02.code02.ThreadDeadLock$$Lambda$1/2003749087.run(Unknown Source)</span><br><span class="line">        at java.lang.Thread.run(Thread.java:745)</span><br><span class="line"></span><br><span class="line">Found 1 deadlock.</span><br></pre></td></tr></table></figure>

<h4 id="例二"><a href="#例二" class="headerlink" title="例二"></a>例二</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> lvxiaoyi</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021/9/28 17:12</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadSleepTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;hello lvxiaoyi&quot;</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">1000</span> * <span class="number">60</span> * <span class="number">10</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">&quot;hello lvxiaoyi , &quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="例三"><a href="#例三" class="headerlink" title="例三"></a>例三</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> top.lvxiaoyi.three.chapter02.code02;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> lvxiaoyi</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021/9/28 17:16</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadSyncTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Number number = <span class="keyword">new</span> Number();</span><br><span class="line">        Thread t1 = <span class="keyword">new</span> Thread(number);</span><br><span class="line">        Thread t2 = <span class="keyword">new</span> Thread(number);</span><br><span class="line"></span><br><span class="line">        t1.setName(<span class="string">&quot;线程1&quot;</span>);</span><br><span class="line">        t2.setName(<span class="string">&quot;线程2&quot;</span>);</span><br><span class="line">        t1.start();</span><br><span class="line">        t2.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Number</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> number = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (number &lt;= <span class="number">100</span>) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        Thread.sleep(<span class="number">500</span>);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    System.out.println(Thread.currentThread().getName() + <span class="string">&quot;：&quot;</span> + number);</span><br><span class="line">                    number++;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\Think&gt;jps</span><br><span class="line">15488 ThreadDeadLock</span><br><span class="line">21428</span><br><span class="line">19240 Jps</span><br><span class="line">25512 Program</span><br><span class="line">28808 ThreadSyncTest</span><br><span class="line">28968 Launcher</span><br><span class="line">29208 KotlinCompileDaemon</span><br><span class="line"></span><br><span class="line">C:\Users\Think&gt;jstack 28808</span><br><span class="line">2021-09-28 17:27:13</span><br><span class="line">Full thread dump Java HotSpot(TM) 64-Bit Server VM (25.101-b13 mixed mode):</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;DestroyJavaVM&quot;</span> <span class="comment">#14 prio=5 os_prio=0 tid=0x0000000002782800 nid=0x72e4 waiting on condition [0x0000000000000000]</span></span><br><span class="line">   java.lang.Thread.State: RUNNABLE</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;线程2&quot;</span> <span class="comment">#13 prio=5 os_prio=0 tid=0x000000001e41a800 nid=0x304c waiting for monitor entry [0x000000001f25e000]</span></span><br><span class="line">   java.lang.Thread.State: BLOCKED (on object monitor)</span><br><span class="line">        at top.lvxiaoyi.three.chapter02.code02.Number.run(ThreadSyncTest.java:27)</span><br><span class="line">        - waiting to lock &lt;0x000000076b5b4df0&gt; (a top.lvxiaoyi.three.chapter02.code02.Number)</span><br><span class="line">        at java.lang.Thread.run(Thread.java:745)</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;线程1&quot;</span> <span class="comment">#12 prio=5 os_prio=0 tid=0x000000001e41a000 nid=0x3f2c waiting on condition [0x000000001f15f000]</span></span><br><span class="line">   java.lang.Thread.State: TIMED_WAITING (sleeping)</span><br><span class="line">        at java.lang.Thread.sleep(Native Method)</span><br><span class="line">        at top.lvxiaoyi.three.chapter02.code02.Number.run(ThreadSyncTest.java:29)</span><br><span class="line">        - locked &lt;0x000000076b5b4df0&gt; (a top.lvxiaoyi.three.chapter02.code02.Number)</span><br><span class="line">        at java.lang.Thread.run(Thread.java:745)</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;Service Thread&quot;</span> <span class="comment">#11 daemon prio=9 os_prio=0 tid=0x000000001e36f000 nid=0x670c runnable [0x0000000000000000]</span></span><br><span class="line">   java.lang.Thread.State: RUNNABLE</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;C1 CompilerThread3&quot;</span> <span class="comment">#10 daemon prio=9 os_prio=2 tid=0x000000001e2e3000 nid=0x4730 waiting on condition [0x0000000000000000]</span></span><br><span class="line">   java.lang.Thread.State: RUNNABLE</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;C2 CompilerThread2&quot;</span> <span class="comment">#9 daemon prio=9 os_prio=2 tid=0x000000001e2dc000 nid=0x432c waiting on condition [0x0000000000000000]</span></span><br><span class="line">   java.lang.Thread.State: RUNNABLE</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;C2 CompilerThread1&quot;</span> <span class="comment">#8 daemon prio=9 os_prio=2 tid=0x000000001e2d8000 nid=0x3e88 waiting on condition [0x0000000000000000]</span></span><br><span class="line">   java.lang.Thread.State: RUNNABLE</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;C2 CompilerThread0&quot;</span> <span class="comment">#7 daemon prio=9 os_prio=2 tid=0x000000001e2d5000 nid=0x51cc waiting on condition [0x0000000000000000]</span></span><br><span class="line">   java.lang.Thread.State: RUNNABLE</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;Monitor Ctrl-Break&quot;</span> <span class="comment">#6 daemon prio=5 os_prio=0 tid=0x000000001e2cf000 nid=0x62e0 runnable [0x000000001ea5e000]</span></span><br><span class="line">   java.lang.Thread.State: RUNNABLE</span><br><span class="line">        at java.net.SocketInputStream.socketRead0(Native Method)</span><br><span class="line">        at java.net.SocketInputStream.socketRead(SocketInputStream.java:116)</span><br><span class="line">        at java.net.SocketInputStream.read(SocketInputStream.java:170)</span><br><span class="line">        at java.net.SocketInputStream.read(SocketInputStream.java:141)</span><br><span class="line">        at sun.nio.cs.StreamDecoder.readBytes(StreamDecoder.java:284)</span><br><span class="line">        at sun.nio.cs.StreamDecoder.implRead(StreamDecoder.java:326)</span><br><span class="line">        at sun.nio.cs.StreamDecoder.read(StreamDecoder.java:178)</span><br><span class="line">        - locked &lt;0x000000076b487b20&gt; (a java.io.InputStreamReader)</span><br><span class="line">        at java.io.InputStreamReader.read(InputStreamReader.java:184)</span><br><span class="line">        at java.io.BufferedReader.fill(BufferedReader.java:161)</span><br><span class="line">        at java.io.BufferedReader.readLine(BufferedReader.java:324)</span><br><span class="line">        - locked &lt;0x000000076b487b20&gt; (a java.io.InputStreamReader)</span><br><span class="line">        at java.io.BufferedReader.readLine(BufferedReader.java:389)</span><br><span class="line">        at com.intellij.rt.execution.application.AppMainV2<span class="variable">$1</span>.run(AppMainV2.java:64)</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;Attach Listener&quot;</span> <span class="comment">#5 daemon prio=5 os_prio=2 tid=0x000000001e28c000 nid=0x45ac waiting on condition [0x0000000000000000]</span></span><br><span class="line">   java.lang.Thread.State: RUNNABLE</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;Signal Dispatcher&quot;</span> <span class="comment">#4 daemon prio=9 os_prio=2 tid=0x000000001e23c000 nid=0x55a4 runnable [0x0000000000000000]</span></span><br><span class="line">   java.lang.Thread.State: RUNNABLE</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;Finalizer&quot;</span> <span class="comment">#3 daemon prio=8 os_prio=1 tid=0x0000000002879000 nid=0x4ffc in Object.wait() [0x000000001e6ff000]</span></span><br><span class="line">   java.lang.Thread.State: WAITING (on object monitor)</span><br><span class="line">        at java.lang.Object.wait(Native Method)</span><br><span class="line">        - waiting on &lt;0x000000076b308ee0&gt; (a java.lang.ref.ReferenceQueue<span class="variable">$Lock</span>)</span><br><span class="line">        at java.lang.ref.ReferenceQueue.remove(ReferenceQueue.java:143)</span><br><span class="line">        - locked &lt;0x000000076b308ee0&gt; (a java.lang.ref.ReferenceQueue<span class="variable">$Lock</span>)</span><br><span class="line">        at java.lang.ref.ReferenceQueue.remove(ReferenceQueue.java:164)</span><br><span class="line">        at java.lang.ref.Finalizer<span class="variable">$FinalizerThread</span>.run(Finalizer.java:209)</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;Reference Handler&quot;</span> <span class="comment">#2 daemon prio=10 os_prio=2 tid=0x0000000002878000 nid=0x2b00 in Object.wait() [0x000000001e1ff000]</span></span><br><span class="line">   java.lang.Thread.State: WAITING (on object monitor)</span><br><span class="line">        at java.lang.Object.wait(Native Method)</span><br><span class="line">        - waiting on &lt;0x000000076b306b50&gt; (a java.lang.ref.Reference<span class="variable">$Lock</span>)</span><br><span class="line">        at java.lang.Object.wait(Object.java:502)</span><br><span class="line">        at java.lang.ref.Reference.tryHandlePending(Reference.java:191)</span><br><span class="line">        - locked &lt;0x000000076b306b50&gt; (a java.lang.ref.Reference<span class="variable">$Lock</span>)</span><br><span class="line">        at java.lang.ref.Reference<span class="variable">$ReferenceHandler</span>.run(Reference.java:153)</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;VM Thread&quot;</span> os_prio=2 tid=0x000000001c309800 nid=0x5a60 runnable</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;GC task thread#0 (ParallelGC)&quot;</span> os_prio=0 tid=0x0000000002798000 nid=0x335c runnable</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;GC task thread#1 (ParallelGC)&quot;</span> os_prio=0 tid=0x000000000279a000 nid=0x5f04 runnable</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;GC task thread#2 (ParallelGC)&quot;</span> os_prio=0 tid=0x000000000279b800 nid=0x4a2c runnable</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;GC task thread#3 (ParallelGC)&quot;</span> os_prio=0 tid=0x000000000279e000 nid=0x32cc runnable</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;GC task thread#4 (ParallelGC)&quot;</span> os_prio=0 tid=0x00000000027a0000 nid=0x4980 runnable</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;GC task thread#5 (ParallelGC)&quot;</span> os_prio=0 tid=0x00000000027a1800 nid=0x523c runnable</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;GC task thread#6 (ParallelGC)&quot;</span> os_prio=0 tid=0x00000000027a4800 nid=0x448 runnable</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;GC task thread#7 (ParallelGC)&quot;</span> os_prio=0 tid=0x00000000027a5800 nid=0x2748 runnable</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;VM Periodic Task Thread&quot;</span> os_prio=2 tid=0x000000001e394800 nid=0x7288 waiting on condition</span><br><span class="line"></span><br><span class="line">JNI global references: 33</span><br></pre></td></tr></table></figure>

<h4 id="jstack-l"><a href="#jstack-l" class="headerlink" title="jstack -l"></a>jstack -l</h4><p><img src="https://img.lvxiaoyi.top/typora-img/image-20210928174640000.png/lvxiaoyi" alt="image-20210928174640000"></p>
<h4 id="例四"><a href="#例四" class="headerlink" title="例四"></a>例四</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> top.lvxiaoyi.three.chapter02.code02;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> lvxiaoyi</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021/9/28 18:02</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AllStackTrace</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Map&lt;Thread, StackTraceElement[]&gt; all = Thread.getAllStackTraces();</span><br><span class="line">        Set&lt;Map.Entry&lt;Thread, StackTraceElement[]&gt;&gt; entries =all.entrySet();</span><br><span class="line">        <span class="keyword">for</span> (Map.Entry&lt;Thread, StackTraceElement[]&gt; en : entries) &#123;</span><br><span class="line">            Thread t = en.getKey();</span><br><span class="line">            StackTraceElement[] v = en.getValue();</span><br><span class="line">            System.out.println(<span class="string">&quot;Thread name is :&quot;</span> + t.getName());</span><br><span class="line">            <span class="keyword">for</span> (StackTraceElement s : v) &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;\t&quot;</span> + s.toString());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h4 id="例五"><a href="#例五" class="headerlink" title="例五"></a>例五</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> top.lvxiaoyi.three.chapter02.code02;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> lvxiaoyi</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021/9/28 16:50</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadDeadLock2</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        StringBuilder s1 = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">        StringBuilder s2 = <span class="keyword">new</span> StringBuilder();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (s1) &#123;</span><br><span class="line">                s1.append(<span class="string">&quot;a&quot;</span>);</span><br><span class="line">                s2.append(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Thread.sleep(<span class="number">100</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">synchronized</span> (s2) &#123;</span><br><span class="line">                    s1.append(<span class="string">&quot;b&quot;</span>); <span class="comment">// 我是26行</span></span><br><span class="line">                    s2.append(<span class="string">&quot;2&quot;</span>);</span><br><span class="line"></span><br><span class="line">                    System.out.println(s1);</span><br><span class="line">                    System.out.println(s2);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).start();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (s2) &#123; </span><br><span class="line">                s1.append(<span class="string">&quot;C&quot;</span>);  </span><br><span class="line">                s2.append(<span class="string">&quot;3&quot;</span>);</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Thread.sleep(<span class="number">100</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">synchronized</span> (s1) &#123;</span><br><span class="line">                    s1.append(<span class="string">&quot;d&quot;</span>);  <span class="comment">// 我是47行</span></span><br><span class="line">                    s2.append(<span class="string">&quot;4&quot;</span>);</span><br><span class="line"></span><br><span class="line">                    System.out.println(s1);</span><br><span class="line">                    System.out.println(s2);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="comment">// 追踪线程中的所有线程</span></span><br><span class="line">                Map&lt;Thread, StackTraceElement[]&gt; all = Thread.getAllStackTraces(); <span class="comment">// 我是65行</span></span><br><span class="line">                Set&lt;Map.Entry&lt;Thread, StackTraceElement[]&gt;&gt; entries =all.entrySet();</span><br><span class="line">                <span class="keyword">for</span> (Map.Entry&lt;Thread, StackTraceElement[]&gt; en : entries) &#123;</span><br><span class="line">                    Thread t = en.getKey();</span><br><span class="line">                    StackTraceElement[] v = en.getValue();</span><br><span class="line">                    System.out.println(<span class="string">&quot;Thread name is :&quot;</span> + t.getName());</span><br><span class="line">                    <span class="keyword">for</span> (StackTraceElement s : v) &#123;</span><br><span class="line">                        System.out.println(<span class="string">&quot;\t&quot;</span> + s.toString());</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">Thread name is :Thread-<span class="number">0</span></span><br><span class="line">    <span class="comment">// 访问线程1的资源的时候停止了</span></span><br><span class="line">	top.lvxiaoyi.three.chapter02.code02.ThreadDeadLock2.lambda$main$<span class="number">0</span>(ThreadDeadLock2.java:<span class="number">26</span>)</span><br><span class="line">	top.lvxiaoyi.three.chapter02.code02.ThreadDeadLock2$$Lambda$<span class="number">1</span>/<span class="number">2003749087.</span>run(Unknown Source)</span><br><span class="line">	java.lang.Thread.run(Thread.java:<span class="number">745</span>)</span><br><span class="line">Thread name is :Attach Listener</span><br><span class="line">Thread name is :Finalizer</span><br><span class="line">	java.lang.Object.wait(Native Method)</span><br><span class="line">	java.lang.ref.ReferenceQueue.remove(ReferenceQueue.java:<span class="number">143</span>)</span><br><span class="line">	java.lang.ref.ReferenceQueue.remove(ReferenceQueue.java:<span class="number">164</span>)</span><br><span class="line">	java.lang.ref.Finalizer$FinalizerThread.run(Finalizer.java:<span class="number">209</span>)</span><br><span class="line">Thread name is :Thread-<span class="number">2</span></span><br><span class="line">	java.lang.Thread.dumpThreads(Native Method)</span><br><span class="line">	java.lang.Thread.getAllStackTraces(Thread.java:<span class="number">1603</span>)</span><br><span class="line">	top.lvxiaoyi.three.chapter02.code02.ThreadDeadLock2$<span class="number">1.</span>run(ThreadDeadLock2.java:<span class="number">65</span>)</span><br><span class="line">	java.lang.Thread.run(Thread.java:<span class="number">745</span>)</span><br><span class="line">Thread name is :DestroyJavaVM</span><br><span class="line">Thread name is :Signal Dispatcher</span><br><span class="line">Thread name is :Monitor Ctrl-Break</span><br><span class="line">	java.net.SocketInputStream.socketRead0(Native Method)</span><br><span class="line">	java.net.SocketInputStream.socketRead(SocketInputStream.java:<span class="number">116</span>)</span><br><span class="line">	java.net.SocketInputStream.read(SocketInputStream.java:<span class="number">170</span>)</span><br><span class="line">	java.net.SocketInputStream.read(SocketInputStream.java:<span class="number">141</span>)</span><br><span class="line">	sun.nio.cs.StreamDecoder.readBytes(StreamDecoder.java:<span class="number">284</span>)</span><br><span class="line">	sun.nio.cs.StreamDecoder.implRead(StreamDecoder.java:<span class="number">326</span>)</span><br><span class="line">	sun.nio.cs.StreamDecoder.read(StreamDecoder.java:<span class="number">178</span>)</span><br><span class="line">	java.io.InputStreamReader.read(InputStreamReader.java:<span class="number">184</span>)</span><br><span class="line">	java.io.BufferedReader.fill(BufferedReader.java:<span class="number">161</span>)</span><br><span class="line">	java.io.BufferedReader.readLine(BufferedReader.java:<span class="number">324</span>)</span><br><span class="line">	java.io.BufferedReader.readLine(BufferedReader.java:<span class="number">389</span>)</span><br><span class="line">	com.intellij.rt.execution.application.AppMainV2$<span class="number">1.</span>run(AppMainV2.java:<span class="number">64</span>)</span><br><span class="line">Thread name is :Reference Handler</span><br><span class="line">	java.lang.Object.wait(Native Method)</span><br><span class="line">	java.lang.Object.wait(Object.java:<span class="number">502</span>)</span><br><span class="line">	java.lang.ref.Reference.tryHandlePending(Reference.java:<span class="number">191</span>)</span><br><span class="line">	java.lang.ref.Reference$ReferenceHandler.run(Reference.java:<span class="number">153</span>)</span><br><span class="line">Thread name is :Thread-<span class="number">1</span></span><br><span class="line">     <span class="comment">// 访问线程1的资源的时候停止了</span></span><br><span class="line">	top.lvxiaoyi.three.chapter02.code02.ThreadDeadLock2.lambda$main$<span class="number">1</span>(ThreadDeadLock2.java:<span class="number">47</span>)</span><br><span class="line">	top.lvxiaoyi.three.chapter02.code02.ThreadDeadLock2$$Lambda$<span class="number">2</span>/<span class="number">990368553.</span>run(Unknown Source)</span><br><span class="line">	java.lang.Thread.run(Thread.java:<span class="number">745</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h2 id="jcmd：多功能命令行"><a href="#jcmd：多功能命令行" class="headerlink" title="jcmd：多功能命令行"></a>jcmd：多功能命令行</h2><h3 id="概述-4"><a href="#概述-4" class="headerlink" title="概述"></a>概述</h3><p>在 JDK 1.7 以后，新增了一个命令行工具 jcmd。它是一个多功能的工具，可以用来实现前面除了 jstat 之外所有命令的功能。比如：用它来导出堆、内存使用、查看 Java 进程、导出线程信息、执行 GC、JVM 运行时间等。</p>
<p>官方帮助文档：<a target="_blank" rel="noopener" href="https://docs.oracle.com/en/java/javase/11/tools/jcmd.html">https://docs.oracle.com/en/java/javase/11/tools/jcmd.html</a></p>
<p>jcmd 拥有 jmap 的大部分功能，并且在 Oracle 的官方网站上也推荐使用 jcmd 命令代 jmap 命令</p>
<h3 id="基本语法-1"><a href="#基本语法-1" class="headerlink" title="基本语法"></a>基本语法</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jcmd &lt;pid | main class&gt; &lt;<span class="built_in">command</span> ...|PerfCounter.print|-f file&gt;</span><br></pre></td></tr></table></figure>

<h4 id="jcmd-l"><a href="#jcmd-l" class="headerlink" title="jcmd -l"></a>jcmd -l</h4><p>列出所有的 JVM 进程，等于<code>jps -m</code></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\Think&gt;jcmd -l</span><br><span class="line">22560</span><br><span class="line">4720 org.jetbrains.jps.cmdline.Launcher D:/ideaJetBrains/IntelliJIDEA2019.3/lib/trove4j.jar;D:/ideaJetBrains/IntelliJIDEA2019.3/plugins/java/lib/maven-builder-support-3.3.9.jar;D:/ideaJetBrains/IntelliJIDEA2019.3/lib/util.jar;D:/ideaJetBrains/IntelliJIDEA2019.3/lib/jna-platform.jar;D:/ideaJetBrains/IntelliJIDEA2019.3/pluginsjava/lib/maven-aether-provider-3.3.9.jar;D:/ideaJetBrains/IntelliJIDEA2019.3/lib/netty-codec-4.1.41.Final.jar;D:/ideaJetBrains/IntelliJIDEA2019.3/lib/netty-buffer-4.1.41.Final.jar;D:/ideaJetBrains/IntelliJIDEA2019.3/lib/protobuf-java-3.5.1.jar;D:/ideaJetBrains/IntelliJIDEA2019.3/lib/annotations.jar;D:/ideaJetBrains/IntelliJIDEA2019.3/lib/httpcore-4.4.12.jar;D:/ideaJetBrains/IntelliJIDEA2019.3/plugins/java/lib/javac2.jar;D:/ideaJetBrains/IntelliJIDEA2019.3/plugins/java/lib/maven-repository-metadata-3.3.9.jar;D:/ideaJetBrains/IntelliJIDEA2019.3/plugins/java/lib/maven-artifact-3.3.9.jar;D:/ideaJetBrains/IntelliJIDEA2019.3/plugins/java/lib/aether-spi-1.1.0.jar;D:/ideaJetBrains/IntelliJIDEA2019.3/p</span><br><span class="line">24948 sun.tools.jcmd.JCmd -l</span><br><span class="line">16520 top.lvxiaoyi.three.chapter02.code02.ThreadDeadLock2</span><br><span class="line">29532 org.jetbrains.kotlin.daemon.KotlinCompileDaemon --daemon-runFilesPath C:\Users\Think\AppData\Local\kotlin\daemon --daemon-autoshutdownIdleSeconds=7200 --daemon-compilerClasspath D:\ideaJetBrains\IntelliJIDEA2019.3\plugins\Kotlin\kotlinc\lib\kotlin-compiler.jar;C:\Program Files\Java\jdk1.8.0_101\lib\tools.jar;D:\ideaJetBrains\IntelliJIDEA2019.3\plugins\Kotlin\kotlinc\lib\kotlin-daemon.jar</span><br></pre></td></tr></table></figure>

<h4 id="jcmd-进程号-help"><a href="#jcmd-进程号-help" class="headerlink" title="jcmd 进程号 help"></a>jcmd 进程号 help</h4><p>针对指定的进程，列出支持的所有具体命令</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\Think&gt;jcmd 16520 <span class="built_in">help</span></span><br><span class="line">16520:</span><br><span class="line">The following commands are available:</span><br><span class="line">JFR.stop</span><br><span class="line">JFR.start</span><br><span class="line">JFR.dump</span><br><span class="line">JFR.check</span><br><span class="line">VM.native_memory</span><br><span class="line">VM.check_commercial_features</span><br><span class="line">VM.unlock_commercial_features</span><br><span class="line">ManagementAgent.stop</span><br><span class="line">ManagementAgent.start_local</span><br><span class="line">ManagementAgent.start</span><br><span class="line">GC.rotate_log</span><br><span class="line">Thread.print</span><br><span class="line">GC.class_stats</span><br><span class="line">GC.class_histogram</span><br><span class="line">GC.heap_dump</span><br><span class="line">GC.run_finalization</span><br><span class="line">GC.run</span><br><span class="line">VM.uptime</span><br><span class="line">VM.flags</span><br><span class="line">VM.system_properties</span><br><span class="line">VM.command_line</span><br><span class="line">VM.version</span><br><span class="line"><span class="built_in">help</span></span><br></pre></td></tr></table></figure>



<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\Think&gt;jcmd 16520 Thread.print</span><br><span class="line">16520:</span><br><span class="line">2021-09-29 09:02:13</span><br><span class="line">Full thread dump Java HotSpot(TM) 64-Bit Server VM (25.101-b13 mixed mode):</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;DestroyJavaVM&quot;</span> <span class="comment">#15 prio=5 os_prio=0 tid=0x0000000003092800 nid=0x745c waiting on condition [0x0000000000000000]</span></span><br><span class="line">   java.lang.Thread.State: RUNNABLE</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;Thread-1&quot;</span> <span class="comment">#13 prio=5 os_prio=0 tid=0x000000001f8c7000 nid=0x57d4 waiting for monitor entry [0x00000000202af000]</span></span><br><span class="line">   java.lang.Thread.State: BLOCKED (on object monitor)</span><br><span class="line">        at top.lvxiaoyi.three.chapter02.code02.ThreadDeadLock2.lambda$main<span class="variable">$1</span>(ThreadDeadLock2.java:47)</span><br><span class="line">        - waiting to lock &lt;0x000000076b5b3078&gt; (a java.lang.StringBuilder)</span><br><span class="line">        - locked &lt;0x000000076b5b30c0&gt; (a java.lang.StringBuilder)</span><br><span class="line">        at top.lvxiaoyi.three.chapter02.code02.ThreadDeadLock2$$Lambda<span class="variable">$2</span>/990368553.run(Unknown Source)</span><br><span class="line">        at java.lang.Thread.run(Thread.java:745)</span><br><span class="line"> ...</span><br><span class="line"> ...</span><br></pre></td></tr></table></figure>

<p><strong>jcmd 进程号 具体命令：</strong>显示指定进程的指令命令的数据</p>
<ul>
<li>Thread.print 可以替换 jstack 指令</li>
<li>GC.class_histogram 可以替换 jmap 中的-histo 操作</li>
<li>GC.heap_dump 可以替换 jmap 中的-dump 操作</li>
<li>GC.run 可以查看 GC 的执行情况</li>
<li>VM.uptime 可以查看程序的总执行时间，可以替换 jstat 指令中的-t 操作</li>
<li>VM.system_properties 可以替换 jinfo -sysprops 进程 id</li>
<li>VM.flags 可以获取 JVM 的配置参数信息</li>
</ul>
<h2 id="jstatd：远程主机信息收集"><a href="#jstatd：远程主机信息收集" class="headerlink" title="jstatd：远程主机信息收集"></a>jstatd：远程主机信息收集</h2><p>之前的指令只涉及到监控本机的 Java 应用程序，而在这些工具中，一些监控工具也支持对远程计算机的监控（如 jps、jstat）。为了启用远程监控，则需要配合使用 jstatd 工具。</p>
<p>命令 jstatd 是一个 RMI 服务端程序，它的作用相当于代理服务器，建立本地计算机与远程监控工具的通信。jstatd 服务器将本机的 Java 应用程序信息传递到远程计算机。</p>
<p><img src="https://img.lvxiaoyi.top/typora-img/202111021347474.png/lvxiaoyi" alt="image-20210504213301077"></p>
<h1 id="JVM-监控及诊断工具-GUI-篇"><a href="#JVM-监控及诊断工具-GUI-篇" class="headerlink" title="JVM 监控及诊断工具-GUI 篇"></a>JVM 监控及诊断工具-GUI 篇</h1><h2 id="工具概述"><a href="#工具概述" class="headerlink" title="工具概述"></a>工具概述</h2><p>使用上一章命令行工具或组合能帮您获取目标 Java 应用性能相关的基础信息，但它们存在下列局限：</p>
<ul>
<li>无法获取方法级别的分析数据，如方法间的调用关系、各方法的调用次数和调用时间等（这对定位应用性能瓶颈至关重要）。</li>
<li>要求用户登录到目标 Java 应用所在的宿主机上，使用起来不是很方便。</li>
<li>分析数据通过终端输出，结果展示不够直观。</li>
</ul>
<p>为此，JDK 提供了一些内存泄漏的分析工具，如 jconsole，jvisualvm 等，用于辅助开发人员定位问题，但是这些工具很多时候并不足以满足快速定位的需求。所以这里我们介绍的工具相对多一些、丰富一些。</p>
<p><strong>JDK 自带的工具</strong></p>
<ul>
<li><p>jconsole：JDK 自带的可视化监控工具。查看 Java 应用程序的运行概况、监控堆信息、永久区（或元空间）使用情况、类加载情况等</p>
<ul>
<li>位置：<code>jdk\bin\jconcole.exe</code></li>
</ul>
</li>
<li><p>Visual VM：Visual VM 是一个工具，它提供了一个可视界面，用于查看 Java 虚拟机上运行的基于 Java 技术的应用程序的详细信息。</p>
<ul>
<li>位置：<code>jdk\bin\jvisualvm.exe</code></li>
</ul>
</li>
<li><p>JMC：Java Mission Control，内置 Java Flight Recorder。能够以极低的性能开销收集 Java 虚拟机的性能数据。</p>
</li>
</ul>
<p><strong>第三方工具</strong></p>
<ul>
<li>MAT：MAT（Memory Analyzer Tool）是基于 Eclipse 的内存分析工具，是一个快速、功能丰富的 Java heap 分析工具，它可以帮助我们查找内存泄漏和减少内存消耗</li>
<li>JProfiler：商业软件，需要付费。功能强大。<ul>
<li>与VisualVM类似</li>
</ul>
</li>
<li>Arthas：Alibaba开源的Java诊断工具。深受开发者喜爱。</li>
<li>Btrace：Java运行时追踪工具。可以在不停机的情况下，跟踪指定的方法调用、构造函数调用和系统内存等信息。</li>
</ul>
<h2 id="JConsole"><a href="#JConsole" class="headerlink" title="JConsole"></a>JConsole</h2><h3 id="概述-5"><a href="#概述-5" class="headerlink" title="概述"></a>概述</h3><p>jconsole：从 Java5 开始，在 JDK 中自带的 java 监控和管理控制台。用于对 JVM 中内存、线程和类等的监控，是一个基于 JMX（java management extensions）的 GUI 性能监控工具。</p>
<p>官方地址：<a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/7/docs/technotes/guides/management/jconsole.html">https://docs.oracle.com/javase/7/docs/technotes/guides/management/jconsole.html</a></p>
<h3 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h3><p>在jdk安装目录中找到jconsole.exe，双击该可执行文件就可以或者打开DOS窗口，直接输入jconsole就可以了</p>
<h3 id="连接方式"><a href="#连接方式" class="headerlink" title="连接方式"></a>连接方式</h3><h4 id="local"><a href="#local" class="headerlink" title="local"></a>local</h4><p>使用JConsole连接一个正在本地系统运行的JVM，并且执行程序的和运行JConsole的需要是同一个用户。</p>
<p>JConsole使用文件系统的授权通过RMI连接起链接到平台的MBean的服务器上。这种从本地连接的监控能力只有Sun的JDK具有。</p>
<h4 id="Remote"><a href="#Remote" class="headerlink" title="Remote"></a>Remote</h4><p>使用下面的URL通过RMI连接器连接到一个JMX代理，service:jmx:rmi:///jndi/rmi://hostName:portNum/jmxrmi。JConsole为建立连接，需要在环境变量中设置mx.remote.credentials来指定用户名和密码，从而进行授权。</p>
<h4 id="Advanced"><a href="#Advanced" class="headerlink" title="Advanced"></a>Advanced</h4><p>使用一个特殊的URL连接JMX代理。一般情况使用自己定制的连接器而不是RMI提供的连接器来连接JMX代理，或者是一个使用JDK1.4的实现了JMX和JMX Rmote的应用</p>
<h3 id="作用"><a href="#作用" class="headerlink" title="作用"></a>作用</h3><h4 id="概览"><a href="#概览" class="headerlink" title="概览"></a>概览</h4><p><img src="https://img.lvxiaoyi.top/typora-img/image-20210929101103771.png/lvxiaoyi" alt="image-20210929101103771"></p>
<h4 id="内存"><a href="#内存" class="headerlink" title="内存"></a>内存</h4><p><img src="https://img.lvxiaoyi.top/typora-img/image-20210929101117155.png/lvxiaoyi" alt="image-20210929101117155"></p>
<h4 id="根据线程检测死锁"><a href="#根据线程检测死锁" class="headerlink" title="根据线程检测死锁"></a>根据线程检测死锁</h4><p><img src="https://img.lvxiaoyi.top/typora-img/image-20210929101524427.png/lvxiaoyi" alt="image-20210929101524427"></p>
<h4 id="线程"><a href="#线程" class="headerlink" title="线程"></a>线程</h4><p><img src="https://img.lvxiaoyi.top/typora-img/image-20210929101131921.png/lvxiaoyi" alt="image-20210929101131921"></p>
<h4 id="VM概要"><a href="#VM概要" class="headerlink" title="VM概要"></a>VM概要</h4><p><img src="https://img.lvxiaoyi.top/typora-img/image-20210929101209659.png/lvxiaoyi" alt="image-20210929101209659"></p>
<h2 id="Visual-VM"><a href="#Visual-VM" class="headerlink" title="Visual VM"></a>Visual VM</h2><h3 id="概述-6"><a href="#概述-6" class="headerlink" title="概述"></a>概述</h3><p>Visual VM 是一个功能强大的多合一故障诊断和性能监控的可视化工具。</p>
<p>它集成了多个 JDK 命令行工具，使用 Visual VM 可用于显示虚拟机进程及进程的配置和环境信息（jps，jinfo），监视应用程序的 CPU、GC、堆、方法区及线程的信息（jstat、jstack）等，甚至代替 JConsole。</p>
<p>在 JDK 6 Update 7 以后，Visual VM 便作为 JDK 的一部分发布（VisualVM 在 JDK／bin 目录下）即：它完全免费。</p>
<p>此外，Visual VM也可以作为独立的软件安装。</p>
<p>官方地址：<a target="_blank" rel="noopener" href="https://visualvm.github.io/index.html">https://visualvm.github.io/index.html</a></p>
<p>使用：</p>
<ul>
<li>在jdk安装目录中找到jvisualvm.exe，然后双击执行即可</li>
<li>打开DOS窗口，输入jvisualvm就可以打开该软件</li>
</ul>
<h3 id="插件的安装"><a href="#插件的安装" class="headerlink" title="插件的安装"></a>插件的安装</h3><h4 id="软件安装"><a href="#软件安装" class="headerlink" title="软件安装"></a>软件安装</h4><p>在jdk高版本中没有带jvisualvm，需要到官网安装</p>
<p><a target="_blank" rel="noopener" href="https://visualvm.github.io/download.html">https://visualvm.github.io/download.html</a></p>
<h4 id="插件安装"><a href="#插件安装" class="headerlink" title="插件安装"></a>插件安装</h4><p>Visual VM的一大特点是支持插件扩展，并且插件安装非常方便。我们既可以通过离线下载插件文件*.nbm，然后在Plugin对话框的已下载页面下，添加已下载的插件。也可以在可用插件页面下，在线安装插件。**(这里建议安装上: VisualGC**)    ·<br>插件地址：<a target="_blank" rel="noopener" href="https://visualvm.github.io/pluginscenters.html">https://visualvm.github.io/pluginscenters.html</a></p>
<h4 id="idea插件安装"><a href="#idea插件安装" class="headerlink" title="idea插件安装"></a>idea插件安装</h4><ol>
<li>安装插件</li>
</ol>
<img src="https://img.lvxiaoyi.top/typora-img/image-20210929111150710.png/lvxiaoyi" alt="image-20210929111150710" style="zoom:50%;" />

<ol start="2">
<li><p>重启配置</p>
<img src="https://img.lvxiaoyi.top/typora-img/image-20210929111307637.png/lvxiaoyi" alt="image-20210929111307637" style="zoom:50%;" /></li>
</ol>
<p><img src="https://img.lvxiaoyi.top/typora-img/image-20210929111431926.png/lvxiaoyi" alt="image-20210929111431926"></p>
<h3 id="连接方式-1"><a href="#连接方式-1" class="headerlink" title="连接方式"></a>连接方式</h3><h4 id="本地连接"><a href="#本地连接" class="headerlink" title="本地连接"></a>本地连接</h4><p>监控本地Java进程的CPU、类、线程等</p>
<h4 id="远程连接"><a href="#远程连接" class="headerlink" title="远程连接"></a>远程连接</h4><p>1-确定远程服务器的ip地址</p>
<p>2-添加JMX（通过JMX技术具体监控远程服务器哪个Java进程）</p>
<p>3-修改bin/catalina.sh文件，连接远程的tomcat</p>
<p>4-在…/conf中添加jmxremote.access和jmxremote.password文件</p>
<p>5-将服务器地址改成公网ip地址</p>
<p>6-设置阿里云安全策略和防火墙策略</p>
<p>7-启动tomcat，查看tomcat启动日志和端口监听</p>
<p>8-JMX中输入端口号、用户名、密码登录</p>
<h3 id="主要功能："><a href="#主要功能：" class="headerlink" title="主要功能："></a><strong>主要功能：</strong></h3><h4 id="生成-读取堆内存-线程快照"><a href="#生成-读取堆内存-线程快照" class="headerlink" title="生成/读取堆内存/线程快照"></a>生成/读取堆内存/线程快照</h4><img src="https://img.lvxiaoyi.top/typora-img/image-20210929140550825.png/lvxiaoyi" alt="image-20210929140550825" style="zoom: 67%;" />

<img src="https://img.lvxiaoyi.top/typora-img/image-20210929140956618.png/lvxiaoyi" alt="image-20210929140956618" style="zoom: 67%;" />



<p><img src="https://img.lvxiaoyi.top/typora-img/image-20210929142933165.png/lvxiaoyi" alt="image-20210929142933165"></p>
<p><img src="https://img.lvxiaoyi.top/typora-img/image-20210929143255518.png/lvxiaoyi" alt="image-20210929143255518"></p>
<h4 id="查看-JVM-参数和系统属性"><a href="#查看-JVM-参数和系统属性" class="headerlink" title="查看 JVM 参数和系统属性"></a>查看 JVM 参数和系统属性</h4><h4 id="查看运行中的虚拟机进程"><a href="#查看运行中的虚拟机进程" class="headerlink" title="查看运行中的虚拟机进程"></a>查看运行中的虚拟机进程</h4><h4 id="生成-读取线程快照"><a href="#生成-读取线程快照" class="headerlink" title="生成/读取线程快照"></a>生成/读取线程快照</h4><p><img src="https://img.lvxiaoyi.top/typora-img/image-20210929143859912.png/lvxiaoyi" alt="image-20210929143859912"></p>
<img src="https://img.lvxiaoyi.top/typora-img/image-20210929144107979.png/lvxiaoyi" alt="image-20210929144107979" style="zoom:50%;" />

<h4 id="程序资源的实时监控"><a href="#程序资源的实时监控" class="headerlink" title="程序资源的实时监控"></a>程序资源的实时监控</h4><h4 id="JMX-代理连接、远程环境监控、CPU-分析和内存分析"><a href="#JMX-代理连接、远程环境监控、CPU-分析和内存分析" class="headerlink" title="JMX 代理连接、远程环境监控、CPU 分析和内存分析"></a>JMX 代理连接、远程环境监控、CPU 分析和内存分析</h4><p><img src="https://img.lvxiaoyi.top/typora-img/image-20210929144449125.png" alt="image-20210929144449125"></p>
<h4 id="其他功能"><a href="#其他功能" class="headerlink" title="其他功能"></a>其他功能</h4><h5 id="JMX代理连接"><a href="#JMX代理连接" class="headerlink" title="JMX代理连接"></a>JMX代理连接</h5><h5 id="远程环境监控"><a href="#远程环境监控" class="headerlink" title="远程环境监控"></a>远程环境监控</h5><h5 id="CPU分析和内存分析"><a href="#CPU分析和内存分析" class="headerlink" title="CPU分析和内存分析"></a>CPU分析和内存分析</h5><h2 id="Eclipse-MAT"><a href="#Eclipse-MAT" class="headerlink" title="Eclipse MAT"></a>Eclipse MAT</h2><h3 id="基本概述"><a href="#基本概述" class="headerlink" title="基本概述"></a>基本概述</h3><p>MAT（Memory Analyzer Tool）工具是一款功能强大的 Java 堆内存分析器。可以用于查找内存泄漏以及查看内存消耗情况。</p>
<p>MAT 是基于 Eclipse 开发的，不仅可以单独使用，还可以作为插件的形式嵌入在 Eclipse 中使用。是一款免费的性能分析工具，使用起来非常方便。</p>
<p>ecplise最新版下载地址：<a target="_blank" rel="noopener" href="https://ftp.jaist.ac.jp/pub/eclipse/technology/epp/downloads/release/2021-09/R/eclipse-java-2021-09-R-win32-x86_64.zip">https://ftp.jaist.ac.jp/pub/eclipse/technology/epp/downloads/release/2021-09/R/eclipse-java-2021-09-R-win32-x86_64.zip</a></p>
<p>==我之前的2018款的ecplice在插件商场中找不到这个插件，下载最新版后可以找到==</p>
<p>插件安装：</p>
<p>点击help-&gt;ecplise marketpace ，搜索mat</p>
<img src="https://img.lvxiaoyi.top/typora-img/image-20210929162728837.png/lvxiaoyi" alt="image-20210929162728837" style="zoom: 67%;" />

<p>重启后打开window - &gt; open perspective，看到Memory Analysis证明安装成功。</p>
<p><img src="https://img.lvxiaoyi.top/typora-img/image-20210929170610664.png/lvxiaoyi" alt="image-20210929170610664"></p>
<p>然后双击Memory Analysis，就跳转到mat分析界面</p>
<h3 id="获取堆dump文件"><a href="#获取堆dump文件" class="headerlink" title="获取堆dump文件"></a>获取堆dump文件</h3><h4 id="dump文件内容"><a href="#dump文件内容" class="headerlink" title="dump文件内容"></a>dump文件内容</h4><p>MAT 可以分析 heap dump 文件。在进行内存分析时，只要获得了反映当前设备内存映像的 hprof 文件，通过 MAT 打开就可以直观地看到当前的内存信息。一般说来，这些内存信息包含：</p>
<ul>
<li>所有的对象信息，包括对象实例、成员变量、存储于栈中的基本类型值和存储于堆中的其他对象的引用值。</li>
<li>所有的类信息，包括 classloader、类名称、父类、静态变量等</li>
<li>GCRoot 到所有的这些对象的引用路径</li>
<li>线程信息，包括线程的调用栈及此线程的线程局部变量（TLS）</li>
</ul>
<h4 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h4><p>说明1：</p>
<p>MAT 不是一个万能工具，它并不能处理所有类型的堆存储文件。但是比较主流的厂家和格式，例如 Sun，HP，SAP 所采用的 HPROF 二进制堆存储文件，以及 IBM 的 PHD 堆存储文件等都能被很好的解析。</p>
<p>说明2：</p>
<p>最吸引人的还是能够快速为开发人员生成内存泄漏报表，方便定位问题和分析问题。虽然 MAT 有如此强大的功能，但是内存分析也没有简单到一键完成的程度，很多内存问题还是需要我们从 MAT 展现给我们的信息当中通过经验和直觉来判断才能发现。</p>
<p>官方地址： <a target="_blank" rel="noopener" href="https://www.eclipse.org/mat/downloads.php">https://www.eclipse.org/mat/downloads.php</a></p>
<h4 id="获取dump文件"><a href="#获取dump文件" class="headerlink" title="获取dump文件"></a>获取dump文件</h4><p>方法一：通过前一章介绍的 jmap工具生成，可以生成任意一个java进程的dump文件；</p>
<p>方法二：通过配置VM参数生成。</p>
<ul>
<li>选项”-XX:+HeapDumpOnOutOfMemoryError”或”-XX:+HeapDumpBeforeFullGc”</li>
<li>选项”-XX:HeapDumpPath”所代表的含义就是当程序出现OutofMemory时，将会在相应的目录下生成一份dump文件。如果不指定选项“-XX:HeapDumpPath”则在当前目录下生成dump文件。</li>
</ul>
<p>对比：考虑到生产环境中几乎不可能在线对其进行分析，大都是采用离线分析，因此使用jmap+MAT工具是最常见的组合。</p>
<p>方法三：使用VisualVM可以导出堆dump文件</p>
<p>方法四：</p>
<p>使用MAT既可以打开一个已有的堆快照，也可以通过MAT直接从活动Java程序中导出堆快照。该功能将借助jps列出当前正在运行的Java进程，以供选择并获取快照。</p>
<h3 id="分析堆dump文件"><a href="#分析堆dump文件" class="headerlink" title="分析堆dump文件"></a>分析堆dump文件</h3><p>size为堆空间的大小</p>
<p><img src="https://img.lvxiaoyi.top/typora-img/image-20210929165743693.png/lvxiaoyi" alt="image-20210929165743693"></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\Think&gt;jps</span><br><span class="line">21744 Jps</span><br><span class="line">22096</span><br><span class="line">25952 OOMTest</span><br><span class="line">33616 Eclipse</span><br><span class="line">15540 Main</span><br><span class="line">35572 Launcher</span><br><span class="line">28668 RemoteMavenServer</span><br><span class="line">7292 KotlinCompileDaemon</span><br><span class="line"></span><br><span class="line">C:\Users\Think&gt;jmap -dump:format=b,file=D:\interview\jvm\src\main\java\top\lvxiaoyi\three\chapter02\code02\myhporf-analyse\mat_log\a.hprof 25952</span><br><span class="line">Dumping heap to D:\interview\jvm\src\main\java\top\lvxiaoyi\three\chapter02\code02\myhporf-analyse\mat_log\a.hprof ...</span><br><span class="line">Heap dump file created</span><br></pre></td></tr></table></figure>

<p><img src="https://img.lvxiaoyi.top/typora-img/image-20210929165432561.png/lvxiaoyi" alt="image-20210929165432561"></p>
<p><img src="https://img.lvxiaoyi.top/typora-img/image-20210929165605249.png/lvxiaoyi" alt="image-20210929165605249"></p>
<h4 id="histogram-直方图"><a href="#histogram-直方图" class="headerlink" title="histogram(直方图)"></a>histogram(直方图)</h4><p>展示了各个类的实例数目以及这些实例的Shallow heap或者Retained heap的总和</p>
<p><img src="https://img.lvxiaoyi.top/typora-img/image-20210929170852247.png/lvxiaoyi" alt="image-20210929170852247"></p>
<p><img src="https://img.lvxiaoyi.top/typora-img/image-20210929171051121.png/lvxiaoyi" alt="image-20210929171051121"></p>
<h4 id="thread-overview"><a href="#thread-overview" class="headerlink" title="thread overview"></a>thread overview</h4><p>查看系统中的java线程  </p>
<p><img src="https://img.lvxiaoyi.top/typora-img/image-20210929171335637.png/lvxiaoyi" alt="image-20210929171335637"></p>
<p>查看局部变量表的信息</p>
<h4 id="获得对象相互引用的关系"><a href="#获得对象相互引用的关系" class="headerlink" title="获得对象相互引用的关系"></a>获得对象相互引用的关系</h4><p><img src="https://img.lvxiaoyi.top/typora-img/image-20210929172058916.png/lvxiaoyi" alt="image-20210929172058916"></p>
<h4 id="with-outgoing-references"><a href="#with-outgoing-references" class="headerlink" title="with outgoing references"></a>with outgoing references</h4><p>当前对象对象引用谁了</p>
<h5 id="with-incoming-references"><a href="#with-incoming-references" class="headerlink" title="with incoming references"></a>with incoming references</h5><p>当前对象被谁引用了</p>
<h4 id="浅堆和深堆"><a href="#浅堆和深堆" class="headerlink" title="浅堆和深堆"></a>浅堆和深堆</h4><h5 id="shallow-heap（浅堆）"><a href="#shallow-heap（浅堆）" class="headerlink" title="shallow heap（浅堆）"></a>shallow heap（浅堆）</h5><p>浅堆(Shallow Heap)是指一个对象所消耗的内存。在32位系统中，一个对象引用会占据4个字节，一个int类型会占据4个字节，long型变量会占据8个字节，每个对象头需要占用8个字节（32位JVM）。根据堆快照格式不同，对象的大小可能会向8字节进行对齐。</p>
<p>以String为例：2个int值共占8字节，对象引用占用4字节，对象头8字节，合计20字节，向8字节对齐，故占24字节。(jdk7中)</p>
<table>
<thead>
<tr>
<th>int</th>
<th>hash32</th>
<th>0</th>
</tr>
</thead>
<tbody><tr>
<td>int</td>
<td>hash</td>
<td>0</td>
</tr>
<tr>
<td>ref</td>
<td>value</td>
<td></td>
</tr>
</tbody></table>
<p>这24字节为String对象的浅堆大小。它与String的value实际取值无关，无论字符串长度如何，浅堆大小始终是24字节。</p>
<p>对象头代表根据类创建的对象的对象头，还有对象的大小不是可能向8字节对齐，而是就向8字节对齐</p>
<h5 id="retained-heap（深堆）"><a href="#retained-heap（深堆）" class="headerlink" title="retained heap（深堆）"></a>retained heap（深堆）</h5><h6 id="保留集-Retained-Set-："><a href="#保留集-Retained-Set-：" class="headerlink" title="保留集(Retained Set)："></a>保留集(Retained Set)：</h6><p>对象A的保留集指当对象A被垃圾回收后，可以被释放的所有的对象集合(包括对象A本身)，即对象A的保留集可以被认为是只能通过对象A被直接或间接访问到的所有对象的集合。通俗地说，就是指<strong>仅被对象A所持有的对象的集合</strong>。</p>
<p>也就是一个对象被回收后，能够释放的集合</p>
<h6 id="深堆-Retained-Heap-："><a href="#深堆-Retained-Heap-：" class="headerlink" title="深堆(Retained Heap)："></a>深堆(Retained Heap)：</h6><p>深堆是指对象的保留集中所有的对象的浅堆大小之和。</p>
<p>注意：浅堆指对象本身占用的内存，不包括其内部引用对象的大小。一个对象的深堆指只能通过该对象访问到的(直接或间接)所有对象的浅堆之和，即对象被回收后，可以释放的真实空间。</p>
<h5 id="补充：对象的实际大小"><a href="#补充：对象的实际大小" class="headerlink" title="补充：对象的实际大小"></a>补充：对象的实际大小</h5><p>另外一个常用的概念是对象的实际大小。这里，对象的实际大小定义为一个对象所能触及的所有对象的浅堆大小之和，也就是通常意义上我们说的对象大小。与深堆相比，似乎这个在日常开发中更为直观和被人接受。<strong>但实际上，这个概念和垃圾回收无关</strong>。</p>
<p>下图显示了一个简单的对象引用关系图，对象A引用了C和D，对象B引用了C和E。那么<strong>对象A的浅堆大小只是A本身</strong>，不含C和D，而<strong>A的实际大小为A、C、D三者之和</strong>。而<strong>A的深堆大小为A与D之和</strong>，由于对象C还可以通过对象B访问到，因此不在对象A的深堆范围内。</p>
<img src="https://img.lvxiaoyi.top/typora-img/image-20210929173833165.png/lvxiaoyi" alt="image-20210929173833165" style="zoom:50%;" />

<h5 id="练习"><a href="#练习" class="headerlink" title="练习"></a>练习</h5><p>GC Roots直接引用了A和B两个对象</p>
<img src="https://img.lvxiaoyi.top/typora-img/image-20210929174243951.png/lvxiaoyi" alt="image-20210929174243951" style="zoom:50%;" />

<p>A的浅堆：A</p>
<p>A的深堆：A</p>
<p>B的浅堆：B</p>
<p>B的深堆：B+C</p>
<p>如果GC Roots不引用了A和B两个对象，则B的深堆：B+C+D</p>
<h5 id="案例分析："><a href="#案例分析：" class="headerlink" title="案例分析："></a>案例分析：</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> top.lvxiaoyi.three.chapter03;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> lvxiaoyi</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021/9/29 17:49</span></span><br><span class="line"><span class="comment"> * -XX:+HeapDumpBeforeFullGC </span></span><br><span class="line"><span class="comment"> * -XX:HeapDumpPath=D:\interview\jvm\src\main\java\top\lvxiaoyi\three\chapter03\student-dump\student.hprof</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StudentTrance</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> List&lt;WebPage&gt; webPages = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">createWebPages</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) &#123;</span><br><span class="line">            WebPage wp = <span class="keyword">new</span> WebPage();</span><br><span class="line">            wp.setUrl(<span class="string">&quot;http://www.&quot;</span> + Integer.toString(i) + <span class="string">&quot;.com&quot;</span>);</span><br><span class="line">            wp.setContent(Integer.toString(i));</span><br><span class="line">            webPages.add(wp);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 创建100个网页</span></span><br><span class="line">        createWebPages();</span><br><span class="line">        <span class="comment">// 创建三个学生对象</span></span><br><span class="line">        Student st3 = <span class="keyword">new</span> Student(<span class="number">3</span>, <span class="string">&quot;Xiaoyi lv&quot;</span>);</span><br><span class="line">        Student st5 = <span class="keyword">new</span> Student(<span class="number">5</span>, <span class="string">&quot;Taylor swift&quot;</span>);</span><br><span class="line">        Student st7 = <span class="keyword">new</span> Student(<span class="number">7</span>, <span class="string">&quot;Ariana Grande&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; webPages.size(); i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (i % st3.getId() == <span class="number">0</span>) &#123;</span><br><span class="line">                st3.visit(webPages.get(i));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (i % st5.getId() == <span class="number">0</span>) &#123;</span><br><span class="line">                st5.visit(webPages.get(i));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (i % st7.getId() == <span class="number">0</span>) &#123;</span><br><span class="line">                st7.visit(webPages.get(i));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        webPages.clear();</span><br><span class="line">        System.gc();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Student</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> id;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> List&lt;WebPage&gt; history = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Student</span><span class="params">(<span class="keyword">int</span> id, String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>();</span><br><span class="line">        <span class="keyword">this</span>.id = id;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setId</span><span class="params">(<span class="keyword">int</span> id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.id = id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;WebPage&gt; <span class="title">getHistory</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> history;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setHistory</span><span class="params">(List&lt;WebPage&gt; history)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.history = history;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visit</span><span class="params">(WebPage wp)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (wp != <span class="keyword">null</span>) &#123;</span><br><span class="line">            history.add(wp);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">WebPage</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String url;</span><br><span class="line">    <span class="keyword">private</span> String content;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getUrl</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> url;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUrl</span><span class="params">(String url)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.url = url;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getContent</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> content;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setContent</span><span class="params">(String content)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.content = content;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h6 id="对象大小分析："><a href="#对象大小分析：" class="headerlink" title="对象大小分析："></a>对象大小分析：</h6><p>我发现这个地方存在疑问，搜索了两篇博客，感觉可信度较高：</p>
<p><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1658707">https://cloud.tencent.com/developer/article/1658707</a></p>
<p><a target="_blank" rel="noopener" href="https://www.zhihu.com/question/63340239/answer/207968569">https://www.zhihu.com/question/63340239/answer/207968569</a></p>
<p>小结论：基本数据类型的大小基本没有疑问，主要是对象头的大小。</p>
<p>对象头的大小</p>
<p><code>jdk8</code>版本是默认开启指针压缩的</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 还是原来的程序，只是在最后添加了一个休眠，避免程序停止</span></span><br><span class="line">C:\Users\Think&gt;jps</span><br><span class="line">22096</span><br><span class="line">33616 Eclipse</span><br><span class="line">37744 KotlinCompileDaemon</span><br><span class="line">35604 Launcher</span><br><span class="line">35800 Jps</span><br><span class="line">37192 StudentTrance</span><br><span class="line">28668 RemoteMavenServer</span><br><span class="line"></span><br><span class="line">C:\Users\Think&gt;jinfo -flag UseCompressedOops 37192</span><br><span class="line">-XX:+UseCompressedOops</span><br><span class="line"><span class="comment"># 所以确实jdk8，64位的版本压缩指针是默认开启的</span></span><br></pre></td></tr></table></figure>

<p>开启压缩指针的情况下：对象头占12个字节，引用类型占据4个字节，而int也是占据四个字节，所以一共是<code>4*3+12=24</code>个字节，不需要对齐。（对齐的意思是，大小必须是8的倍数）</p>
<p>验证：只有int的对象大小</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> top.lvxiaoyi.three.chapter03;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> lvxiaoyi</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021/9/29 21:01</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ClassHeaderTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        studenHeader studenHeader = <span class="keyword">new</span> studenHeader();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">100000</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">studenHeader</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> id;</span><br><span class="line"><span class="comment">//    private String name;</span></span><br><span class="line"><span class="comment">//    private List&lt;WebPage&gt; history = new ArrayList&lt;&gt;();</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\Think&gt;jps</span><br><span class="line">17664 ClassHeaderTest</span><br><span class="line">22096</span><br><span class="line">33616 Eclipse</span><br><span class="line">37744 KotlinCompileDaemon</span><br><span class="line">33992 Launcher</span><br><span class="line">28668 RemoteMavenServer</span><br><span class="line">36700 Jps</span><br><span class="line"></span><br><span class="line">C:\Users\Think&gt;jmap -dump:format=b,file=D:\interview\jvm\src\main\java\top\lvxiaoyi\three\chapter03\student-dump\studentHeader.hprof 17664</span><br><span class="line">Dumping heap to D:\interview\jvm\src\main\java\top\lvxiaoyi\three\chapter03\student-dump\studentHeader.hprof ...</span><br><span class="line">Heap dump file created</span><br></pre></td></tr></table></figure>

<p><img src="https://img.lvxiaoyi.top/typora-img/image-20210929211528345.png/lvxiaoyi" alt="image-20210929211528345"></p>
<p>验证：空的对象大小</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">class studenHeader &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>生成dump文件</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\Think&gt;jps</span><br><span class="line">22096</span><br><span class="line">33616 Eclipse</span><br><span class="line">37744 KotlinCompileDaemon</span><br><span class="line">36484 Launcher</span><br><span class="line">34536 ClassHeaderTest</span><br><span class="line">28668 RemoteMavenServer</span><br><span class="line">36796 Jps</span><br><span class="line"></span><br><span class="line">C:\Users\Think&gt;jmap -dump:format=b,file=D:\interview\jvm\src\main\java\top\lvxiaoyi\three\chapter03\student-dump\studentHeader2.hprof 34536</span><br><span class="line">Dumping heap to D:\interview\jvm\src\main\java\top\lvxiaoyi\three\chapter03\student-dump\studentHeader2.hprof ...</span><br><span class="line">Heap dump file created</span><br></pre></td></tr></table></figure>

<p><img src="https://img.lvxiaoyi.top/typora-img/image-20210929211818659.png/lvxiaoyi" alt="image-20210929211818659"></p>
<p>在只有int的对象中，对象的大小为<code>4（int大小）+12（对象头大小）=16</code>，刚好是8的倍数，不用对齐</p>
<p>在空对象中，对象的大小为<code>12（对象头大小）+4（对齐的大小）=16</code></p>
<p>小结论：通过经验和博客，==在jdk8，64位，默认开启指针压缩的情况下，对象头的大小为12==</p>
<h6 id="深堆分析"><a href="#深堆分析" class="headerlink" title="深堆分析"></a>深堆分析</h6><p>15个webpage</p>
<p>每个对应152个字节 15*152-16=2264字节</p>
<p>这个144我感觉确实应该加上去，这个是因为不同的url长度不一致导致的，有的是一位数，有的是两位数：</p>
<p>【普通对象头(12) + 数组长度(4)】 + 16个字符(32) = 48字节，符合8字节对齐</p>
<p>【普通对象头(12) + 数组长度(4)】 + 17个字符(34) = 50字节，不符合8字节对齐，对齐为56</p>
<img src="https://img.lvxiaoyi.top/typora-img/image-20210930085251803.png/lvxiaoyi" alt="image-20210930085251803" style="zoom:67%;" />

<p>7个数能被 7整除，且能被3整除，以及能被7整除，且能被5整除的值数值有 ：0，21，42，63，84，35，70</p>
<p>这个可以通过incomeing references查看，当前对象被几个对象引用</p>
<p>6*152+144=1056</p>
<p>2264-1056=1208</p>
<p>80个字节是什么呢（==下面为个人猜测，不一定正确==）：</p>
<p>每个arrylist中都是用的elementData存储，占据4个字节</p>
<p>15个elementData的元素 * 4 = 60字节</p>
<p>60 + 12对象头的字节数 + 4字节（数组） + 4（补齐） = 80字节。 </p>
<p>==验证：==</p>
<p>下面验证80个字节到底对不对</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// vm参数</span></span><br><span class="line"><span class="comment">// -XX:+HeapDumpBeforeFullGC </span></span><br><span class="line"><span class="comment">// -XX:HeapDumpPath=D:\interview\jvm\src\main\java\top\lvxiaoyi\three\chapter03\student-dump\student6.hprof </span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">createWebPages</span><span class="params">()</span> </span>&#123;</span><br><span class="line"> 		<span class="comment">// 创建15个webpage对象，这个15个像的url地址不一样，且都是二位数</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">10</span>; i &lt; <span class="number">25</span>; i++) &#123;</span><br><span class="line">            WebPage wp = <span class="keyword">new</span> WebPage();</span><br><span class="line">            wp.setUrl(<span class="string">&quot;http://www.&quot;</span> + i + <span class="string">&quot;.com&quot;</span>);</span><br><span class="line">            wp.setContent(Integer.toString(i));</span><br><span class="line">            webPages.add(wp);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 创建100个网页</span></span><br><span class="line">        createWebPages();</span><br><span class="line">        <span class="comment">// 创建三个学生对象</span></span><br><span class="line">        Student st3 = <span class="keyword">new</span> Student(<span class="number">3</span>, <span class="string">&quot;Xiaoyi lv&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; webPages.size(); i++) &#123;</span><br><span class="line">            <span class="comment">// 15个对象全部由一个人占用</span></span><br><span class="line">            st3.visit(webPages.get(i));</span><br><span class="line">        &#125;</span><br><span class="line">        webPages.clear();</span><br><span class="line">        System.gc();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<img src="https://img.lvxiaoyi.top/typora-img/image-20210930085719134.png/lvxiaoyi" alt="image-20210930085719134" style="zoom:67%;" />

<p>深堆分析</p>
<p>15个webpage</p>
<p>每个对应152个字节 15*152=2280字节</p>
<p>2280+80=2360字节</p>
<p>80个字节是什么呢（==这个验证了，确实应该为80字节==）</p>
<p>每个arrylist中都是用的elementData存储，占据4个字节</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// arrylist的jdk1.8源码，transient关键字是为了禁止这个字段序列化</span></span><br><span class="line"><span class="keyword">transient</span> Object[] elementData;</span><br></pre></td></tr></table></figure>

<p>15个elementData的元素 * 4 = 60字节</p>
<p>60 + 12对象头的字节数 + 4字节（数组） + 4（补齐） = 80字节。 </p>
<h4 id="支配树（Dominator-Tree"><a href="#支配树（Dominator-Tree" class="headerlink" title="支配树（Dominator Tree)"></a>支配树（Dominator Tree)</h4><p>支配树的概念源自图论。</p>
<p>MAT提供了一个称为支配树（Dominator Tree）的对象图。支配树体现了对象实例间的支配关系。<strong>在对象引用图中，所有指向对象B的路径都经过对象A，则认为对象A支配对象B</strong>。如果<strong>对象A是离对象B最近的一个支配对象，则认为对象A为对象B的直接支配者</strong>。支配树是基于对象间的引用图所建立的，它有以下基本性质：</p>
<ul>
<li><p>对象A的子树（所有被对象A支配的对象集合）表示对象A的保留集（retained set)，即深堆。</p>
</li>
<li><p>如果对象A支配对象B，那么对象A的直接支配者也支配对象B。</p>
</li>
<li><p>支配树的边与对象引用图的边不直接对应。</p>
</li>
</ul>
<p>如下图所示：左图表示对象引用图，右图表示左图所对应的支配树。对象A和B由根对象直接支配，由于在到对象C的路径中，可以经过A，也可以经过B，因此对象C的直接支配者也是根对象。对象F与对象D相互引用，因为到对象F的所有路径必然经过对象D，因此，对象D是对象F的直接支配者。而到对象D的所有路径中，必然经过对象c，即使是从对象F到对象D的引用，从根节点出发，也是经过对象c的，所以，对象D的直接支配者为对象C。</p>
<img src="https://img.lvxiaoyi.top/typora-img/image-20210930093637404.png/lvxiaoyi" alt="image-20210930093637404" style="zoom:67%;" />

<p>同理，对象E支配对象G。到达对象H的可以通过对象D，也可以通过对象E，因此对象D和E都不能支配对象H，而经过对象C既可以到达D也可以到达E，因此对象C为对象H的直接支配者。</p>
<p>在MAT中，单击工具栏上的对象支配树按钮，可以打开对象支配树视图。</p>
<p><img src="https://img.lvxiaoyi.top/typora-img/image-20210930095214205.png/lvxiaoyi" alt="image-20210930095214205"></p>
<h3 id="案例：Tomcat堆溢出分析"><a href="#案例：Tomcat堆溢出分析" class="headerlink" title="案例：Tomcat堆溢出分析"></a>案例：Tomcat堆溢出分析</h3><h4 id="说明-1"><a href="#说明-1" class="headerlink" title="说明"></a>说明</h4><p>Tomcat是最常用的Java Servlet容器之一，同时也可以当做单独的web服务器使用。Tomcat本身使用Java实现，并运行于Java虚拟机之上。在大规模请求时，Tomcat有可能会因为无法承受压力而发生内存溢出错误。这里根据一个被压垮的Tomcat的堆快照文件，来分析Tomcat在崩溃时的内部情况。</p>
<h4 id="分析过程"><a href="#分析过程" class="headerlink" title="分析过程"></a>分析过程</h4><p>size为堆空间的大小</p>
<p>保留大小为16.4MB</p>
<p>图一：</p>
<img src="https://img.lvxiaoyi.top/typora-img/image-20210930100607889.png/lvxiaoyi" alt="image-20210930100607889" style="zoom: 67%;" />

<p>图二：</p>
<img src="https://img.lvxiaoyi.top/typora-img/image-20210930101107460.png/lvxiaoyi" alt="image-20210930101107460" style="zoom: 67%;" />

<p>图三：</p>
<p>sessions对象，占用约17MB空间，而保留空间为16.4M，所以我们怀疑是sessions这个对象出现了问题</p>
<p><img src="https://img.lvxiaoyi.top/typora-img/image-20210930101213140.png/lvxiaoyi" alt="image-20210930101213140"></p>
<p>图四：</p>
<p>可以看到sessions对象为ConcurrentHashMap，其内部分为16个Segment。从深堆大小看，每个Segment都比较平均，大约为1MB，合计17MB。</p>
 <img src="https://img.lvxiaoyi.top/typora-img/image-20210930101545502.png/lvxiaoyi" alt="image-20210930101545502" style="zoom: 67%;" />



<p>图五：</p>
<p>然后探究在sessions中的session的数量，看看到底是什么导致session对象这么大</p>
<img src="https://img.lvxiaoyi.top/typora-img/image-20210930101716115.png" alt="image-20210930101716115" style="zoom: 67%;" />

<p>图六：</p>
<p>当前堆中含有9941个session，并且每一个session的深堆为1592字节，合计约15NB，达到当前堆大N的50%。</p>
<p>然后就是想看看这些session是不是在很短时间内创建，然后导致来不及回收，导致OOM异常</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="number">0</span>BJECTS s <span class="keyword">from</span> org.apache.catalina.session.StandardSession s</span><br></pre></td></tr></table></figure>

<img src="https://img.lvxiaoyi.top/typora-img/image-20210930102334215.png/lvxiaoyi" alt="image-20210930102334215" style="zoom: 67%;" />

<p>图七：</p>
<p>选择一个session查看详细信息</p>
<img src="https://img.lvxiaoyi.top/typora-img/image-20210930102538142.png/lvxiaoyi" alt="image-20210930102538142" style="zoom: 67%;" />

<p>图八：</p>
<img src="https://img.lvxiaoyi.top/typora-img/image-20210930102628563.png/lvxiaoyi" alt="image-20210930102628563" style="zoom:50%;" />

<p>根据当前的session总数，可以计算每秒的平均压力为：9941/(1403124677648-1403324645728)*1000=311次/秒。</p>
<p>由此推断，在发生Tomcat堆溢出时，Tomcat在连续30秒的时间内，平均每秒接收了约311次不同客户端的请求，创建了合计9941个session。</p>
<h2 id="补充：内存泄露"><a href="#补充：内存泄露" class="headerlink" title="补充：内存泄露"></a>补充：内存泄露</h2><h3 id="概述-7"><a href="#概述-7" class="headerlink" title="概述"></a>概述</h3><h4 id="什么是内存泄露"><a href="#什么是内存泄露" class="headerlink" title="什么是内存泄露"></a>什么是内存泄露</h4><img src="https://img.lvxiaoyi.top/typora-img/image-20210930110446754.png/lvxiaoyi" alt="image-20210930110446754" style="zoom:67%;" />

<p>可达性分析算法来判断对象是否是不再使用的对象，本质都是判断一个对象是否还被引用。那么对于这种情况下，由于代码的实现不同就会出现很多种内存泄漏问题（让 JVM 误以为此对象还在引用中，无法回收，造成内存泄漏）。</p>
<p>如果对象还被使用但是不被需要，那么这就是内存泄露，但是如果还需要则不是内存泄露</p>
<ul>
<li><p>是否还被使用？是</p>
</li>
<li><p>是否还被需要？否</p>
</li>
</ul>
<h4 id="内存泄露理解"><a href="#内存泄露理解" class="headerlink" title="内存泄露理解"></a>内存泄露理解</h4><p>严格来说，<strong>只有对象不会再被程序用到了，但是 GC 又不能回收他们的情况，才叫内存泄漏</strong>。</p>
<p>但实际情况很多时候一些不太好的实践（或疏忽）会导致对象的生命周期变得很长甚至导致 OOM，也可以叫做宽泛意义上的“内存泄漏”。</p>
<p> <img src="https://img.lvxiaoyi.top/typora-img/image-20210930111143440.png/lvxiaoyi" alt="image-20210930111143440"></p>
<p>对象X引用对象Y，X的生命周期比Y的生命周期长；</p>
<p>那么当Y生命周期结束的时候，x依然引用着Y，这时候，垃圾回收期是不会回收对象Y的；</p>
<p>如果对象 X 还引用着生命周期比较短的 A、B、C，对象 A 又引用着对象 a、b、c，这样就可能造成大量无用的对象不能被回收，进而占据了内存资源，造成内存泄漏，直到内存溢出。</p>
<h4 id="内存泄露与和内存溢出关系"><a href="#内存泄露与和内存溢出关系" class="headerlink" title="内存泄露与和内存溢出关系"></a>内存泄露与和内存溢出关系</h4><h5 id="内存泄露（memory-leak）"><a href="#内存泄露（memory-leak）" class="headerlink" title="内存泄露（memory leak）"></a>内存泄露（memory leak）</h5><p>申请了内存用完了不释放，比如一共有 1024M 的内存，分配了 512M 的内存一直不回收，那么可以用的内存只有 512M 了，仿佛泄露掉了一部分；通俗一点讲的话，内存泄漏就是【占着茅坑不拉 shi】</p>
<h5 id="内存溢出（out-of-memory）"><a href="#内存溢出（out-of-memory）" class="headerlink" title="内存溢出（out of memory）"></a>内存溢出（out of memory）</h5><p>申请内存时，没有足够的内存可以使用；通俗一点儿讲，一个厕所就三个坑，有两个站着茅坑不走的（内存泄漏），剩下最后一个坑，厕所表示接待压力很大，这时候一下子来了两个人，坑位（内存）就不够了，内存泄漏变成内存溢出了。</p>
<p>可见，内存泄漏和内存溢出的关系：内存泄漏的增多，最终会导致内存溢出。</p>
<p>泄漏的分类</p>
<ul>
<li>经常发生：发生内存泄露的代码会被多次执行，每次执行，泄露一块内存；</li>
<li>偶然发生：在某些特定情况下才会发生</li>
<li>一次性：发生内存泄露的方法只会执行一次；</li>
<li>隐式泄漏：一直占着内存不释放，直到执行结束；严格的说这个不算内存泄漏，因为最终释放掉了，但是如果执行时间特别长，也可能会导致内存耗尽。</li>
</ul>
<h3 id="Java-中内存泄露的-8-种情况"><a href="#Java-中内存泄露的-8-种情况" class="headerlink" title="Java 中内存泄露的 8 种情况"></a>Java 中内存泄露的 8 种情况</h3><h4 id="静态集合类"><a href="#静态集合类" class="headerlink" title="静态集合类"></a>静态集合类</h4><p>静态集合类，如 HashMap、LinkedList 等等。如果这些容器为静态的，那么它们的生命周期与 JVM 程序一致，则容器中的对象在程序结束之前将不能被释放，从而造成内存泄漏。简单而言，长生命周期的对象持有短生命周期对象的引用，尽管短生命周期的对象不再使用，但是因为长生命周期对象持有它的引用而导致不能被回收。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MemoryLeak</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> List list = <span class="keyword">new</span> ArrayList();</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">oomTests</span><span class="params">()</span></span>&#123;</span><br><span class="line">        Object obj＝<span class="keyword">new</span> Object();<span class="comment">//局部变量</span></span><br><span class="line">        list.add(obj);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这一点在工作中我们需要注意，因为我们现在的项目都是多人开发，我们需要调用别人的接口，而别人又需要调用我们的接口。假如有着一种情况：你现在写了这个类（这个类比较底层，生命周期特别长），然后把这个一个全局变量List生命为为static，然后提供了对这个变量的一下业务逻辑操作，然后你的同事需要用到你的这个接口，他在用的时候对list一系列操作添加了一些列对象，然后出方法的时候忘记了，没有主动对list这些无用的对象销毁，那么这个时候就造成了内存泄露。</p>
<h4 id="单例模式"><a href="#单例模式" class="headerlink" title="单例模式"></a>单例模式</h4><p>单例模式，和静态集合导致内存泄露的原因类似，因为单例的静态特性，它的生命周期和 JVM 的生命周期一样长，所以如果单例对象如果持有外部对象的引用，那么这个外部对象也不会被回收，那么就会造成内存泄漏。</p>
<h4 id="内部类持有外部类"><a href="#内部类持有外部类" class="headerlink" title="内部类持有外部类"></a>内部类持有外部类</h4><p>内部类持有外部类，如果一个外部类的实例对象的方法返回了一个内部类的实例对象。这个内部类对象被长期引用了，即使那个外部类实例对象不再被使用，但由于内部类持有外部类的实例对象，这个外部类对象将不会被垃圾回收，这也会造成内存泄漏。</p>
<h4 id="各种连接，如数据库连接、网络连接和-IO-连接等"><a href="#各种连接，如数据库连接、网络连接和-IO-连接等" class="headerlink" title="各种连接，如数据库连接、网络连接和 IO 连接等"></a>各种连接，如数据库连接、网络连接和 IO 连接等</h4><p>在对数据库进行操作的过程中，首先需要建立与数据库的连接，当不再使用时，需要调用 close 方法来释放与数据库的连接。<strong>只有连接被关闭后，垃圾回收器才会回收对应的对象</strong>，因为GC不能示释放非托管资源（各种连接），不会帮你主动关闭。</p>
<p>否则，如果在访问数据库的过程中，对 Connection、Statement 或 ResultSet 不显性地关闭，将会造成大量的对象无法被回收，从而引起内存泄漏。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">        Connection conn =<span class="keyword">null</span>;</span><br><span class="line">        Class.forName(<span class="string">&quot;com.mysql.jdbc.Driver&quot;</span>);</span><br><span class="line">        conn =DriverManager.getConnection(<span class="string">&quot;url&quot;</span>,<span class="string">&quot;&quot;</span>,<span class="string">&quot;&quot;</span>);</span><br><span class="line">        Statement stmt =conn.createStatement();</span><br><span class="line">        ResultSet rs =stmt.executeQuery(<span class="string">&quot;....&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span>（Exception e）&#123;<span class="comment">//异常日志</span></span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="comment">// 1．关闭结果集 Statement</span></span><br><span class="line">        <span class="comment">// 2．关闭声明的对象 ResultSet</span></span><br><span class="line">        <span class="comment">// 3．关闭连接 Connection</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="变量不合理的作用域"><a href="#变量不合理的作用域" class="headerlink" title="变量不合理的作用域"></a>变量不合理的作用域</h4><p>变量不合理的作用域。一般而言，一个变量的定义的作用范围大于其使用范围，很有可能会造成内存泄漏。另一方面，如果没有及时地把对象设置为 null，很有可能导致内存泄漏的发生。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UsingRandom</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String msg;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">receiveMsg</span><span class="params">()</span></span>&#123;</span><br><span class="line">     	<span class="comment">// private String msg;</span></span><br><span class="line">        msg = readFromNet();<span class="comment">//从网络中接受数据保存到msg中</span></span><br><span class="line">        saveDB(msg);<span class="comment">//把msg保存到数据库中</span></span><br><span class="line">        <span class="comment">//在使用完 msg 后，把 msg 设置为 null</span></span><br><span class="line">        <span class="comment">// msg = null;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如上面这个伪代码，通过 readFromNet 方法把接受的消息保存在变量 msg 中，然后调用 saveDB 方法把 msg 的内容保存到数据库中，此时 msg 已经就没用了，由于 msg 的生命周期与对象的生命周期相同，此时 msg 还不能回收，因此造成了内存泄漏。</p>
<p>实际上这个 msg 变量可以放在 receiveMsg 方法内部，当方法使用完，那么 msg 的生命周期也就结束，此时就可以回收了。还有一种方法，在使用完 msg 后，把 msg 设置为 null，这样垃圾回收器也会回收 msg 的内存空间。</p>
<h4 id="改变哈希值"><a href="#改变哈希值" class="headerlink" title="改变哈希值"></a>改变哈希值</h4><p>改变哈希值，当一个对象被存储进 HashSet 集合中以后，就不能修改这个对象中的那些参与计算哈希值的字段了。</p>
<p>否则，对象修改后的哈希值与最初存储进 HashSet 集合中时的哈希值就不同了，在这种情况下，即使在 contains 方法使用该对象的当前引用作为的参数去 HashSet 集合中检索对象，也将返回找不到对象的结果，这也会导致无法从 HashSet 集合中单独删除当前对象，造成内存泄漏。</p>
<p>这也是 String 为什么被设置成了不可变类型，我们可以放心地把 String 存入 HashSet，或者把 String 当做 HashMap 的 key 值；</p>
<p>当我们想把自己定义的类保存到散列表的时候，需要保证对象的 hashCode 不可变。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> top.lvxiaoyi.three.chapter03.code041;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashSet;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ChangeHashCode1</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        HashSet&lt;Point&gt; hs = <span class="keyword">new</span> HashSet&lt;Point&gt;();</span><br><span class="line">        Point cc = <span class="keyword">new</span> Point();</span><br><span class="line">        <span class="comment">//hashCode = 41</span></span><br><span class="line">        cc.setX(<span class="number">10</span>);</span><br><span class="line">        hs.add(cc);</span><br><span class="line">        <span class="comment">//hashCode = 51  此行为导致了内存的泄漏</span></span><br><span class="line">        cc.setX(<span class="number">20</span>);</span><br><span class="line">        <span class="comment">// 删除元素需要hashcode，但是hashcode又和x的值是相关的，所以西面remove失败</span></span><br><span class="line">        System.out.println(<span class="string">&quot;hs.remove = &quot;</span> + hs.remove(cc));<span class="comment">//false</span></span><br><span class="line">        <span class="comment">// 因为hashcode不一样，所以这里能够放进去</span></span><br><span class="line">        hs.add(cc);</span><br><span class="line">        <span class="comment">// 造成了同一个对象，却能够存放进去hashSet两次</span></span><br><span class="line">        System.out.println(<span class="string">&quot;hs.size = &quot;</span> + hs.size());<span class="comment">//size = 2</span></span><br><span class="line">        System.out.println(hs);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Point</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> x;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getX</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> x;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setX</span><span class="params">(<span class="keyword">int</span> x)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.x = x;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">hashCode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> prime = <span class="number">31</span>;</span><br><span class="line">        <span class="keyword">int</span> result = <span class="number">1</span>;</span><br><span class="line">        result = prime * result + x;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">equals</span><span class="params">(Object obj)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span> == obj) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (obj == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (getClass() != obj.getClass()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        Point other = (Point) obj;</span><br><span class="line">        <span class="keyword">if</span> (x != other.x) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Point&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;x=&quot;</span> + x +</span><br><span class="line">                <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> top.lvxiaoyi.three.chapter03.code041;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashSet;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ChangeHashCode</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        HashSet set = <span class="keyword">new</span> HashSet();</span><br><span class="line">        Person p1 = <span class="keyword">new</span> Person(<span class="number">1001</span>, <span class="string">&quot;AA&quot;</span>);</span><br><span class="line">        Person p2 = <span class="keyword">new</span> Person(<span class="number">1002</span>, <span class="string">&quot;BB&quot;</span>);</span><br><span class="line"></span><br><span class="line">        set.add(p1);</span><br><span class="line">        set.add(p2);</span><br><span class="line"></span><br><span class="line">        p1.name = <span class="string">&quot;CC&quot;</span>;<span class="comment">//导致了内存的泄漏</span></span><br><span class="line">        set.remove(p1); <span class="comment">//删除失败</span></span><br><span class="line"></span><br><span class="line">        System.out.println(set);</span><br><span class="line"></span><br><span class="line">        set.add(<span class="keyword">new</span> Person(<span class="number">1001</span>, <span class="string">&quot;CC&quot;</span>));</span><br><span class="line">        System.out.println(set);</span><br><span class="line"></span><br><span class="line">        set.add(<span class="keyword">new</span> Person(<span class="number">1001</span>, <span class="string">&quot;AA&quot;</span>));</span><br><span class="line">        System.out.println(set);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> id;</span><br><span class="line">    String name;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Person</span><span class="params">(<span class="keyword">int</span> id, String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.id = id;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">equals</span><span class="params">(Object o)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span> == o) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!(o <span class="keyword">instanceof</span> Person)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Person person = (Person) o;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (id != person.id) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> name != <span class="keyword">null</span> ? name.equals(person.name) : person.name == <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">hashCode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> result = id;</span><br><span class="line">        result = <span class="number">31</span> * result + (name != <span class="keyword">null</span> ? name.hashCode() : <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Person&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;id=&quot;</span> + id +</span><br><span class="line">                <span class="string">&quot;, name=&#x27;&quot;</span> + name + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="缓存泄露"><a href="#缓存泄露" class="headerlink" title="缓存泄露"></a>缓存泄露</h4><p>内存泄漏的另一个常见来源是缓存，一旦你把对象引用放入到缓存中，他就很容易遗忘。比如：之前项目在一次上线的时候，应用启动奇慢直到夯死，就是因为代码中会加载一个表中的数据到缓存（内存）中，测试环境只有几百条数据，但是生产环境有几百万的数据。</p>
<p>对于这个问题，可以使用 WeakHashMap 代表缓存，此种 Map 的特点是，当除了自身有对 key 的引用外，此 key 没有其他引用那么此 map 会自动丢弃此值。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> top.lvxiaoyi.three.chapter03.code041;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.WeakHashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MapTest</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 弱引用</span></span><br><span class="line">    <span class="keyword">static</span> Map wMap = <span class="keyword">new</span> WeakHashMap();</span><br><span class="line">    <span class="keyword">static</span> Map map = <span class="keyword">new</span> HashMap();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        init();</span><br><span class="line">        testWeakHashMap();</span><br><span class="line">        testHashMap();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        String ref1 = <span class="keyword">new</span> String(<span class="string">&quot;obejct1&quot;</span>);</span><br><span class="line">        String ref2 = <span class="keyword">new</span> String(<span class="string">&quot;obejct2&quot;</span>);</span><br><span class="line">        String ref3 = <span class="keyword">new</span> String(<span class="string">&quot;obejct3&quot;</span>);</span><br><span class="line">        String ref4 = <span class="keyword">new</span> String(<span class="string">&quot;obejct4&quot;</span>);</span><br><span class="line">        wMap.put(ref1, <span class="string">&quot;cacheObject1&quot;</span>);</span><br><span class="line">        wMap.put(ref2, <span class="string">&quot;cacheObject2&quot;</span>);</span><br><span class="line">        map.put(ref3, <span class="string">&quot;cacheObject3&quot;</span>);</span><br><span class="line">        map.put(ref4, <span class="string">&quot;cacheObject4&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;String引用ref1，ref2，ref3，ref4 消失&quot;</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">testWeakHashMap</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;WeakHashMap GC之前&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (Object o : wMap.entrySet()) &#123;</span><br><span class="line">            System.out.println(o);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// gc的时候会主动回收弱引用中的内容</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            System.gc();</span><br><span class="line">            TimeUnit.SECONDS.sleep(<span class="number">5</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">&quot;WeakHashMap GC之后&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (Object o : wMap.entrySet()) &#123;</span><br><span class="line">            System.out.println(o);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">testHashMap</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;HashMap GC之前&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (Object o : map.entrySet()) &#123;</span><br><span class="line">            System.out.println(o);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            System.gc();</span><br><span class="line">            TimeUnit.SECONDS.sleep(<span class="number">5</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">&quot;HashMap GC之后&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (Object o : map.entrySet()) &#123;</span><br><span class="line">            System.out.println(o);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<img src="https://img.lvxiaoyi.top/typora-img/image-20210930145355127.png/lvxiaoyi" alt="image-20210930145355127" style="zoom:67%;" />

<p>上面代码和图示主演演示 WeakHashMap 如何自动释放缓存对象，当 init 函数执行完成后，局部变量字符串引用 weakd1，weakd2，d1，d2 都会消失，此时只有静态 map 中保存中对字符串对象的引用，可以看到，调用 gc 之后，HashMap 的没有被回收，而 WeakHashMap 里面的缓存被回收了。</p>
<h4 id="监听器和其他回调"><a href="#监听器和其他回调" class="headerlink" title="监听器和其他回调"></a>监听器和其他回调</h4><p>内存泄漏第三个常见来源是<strong>监听器和其他回调</strong>，如果客户端在你实现的 API 中注册回调，却没有显示的取消，那么就会积聚。</p>
<p>需要确保回调立即被当作垃圾回收的最佳方法是只保存它的弱引用，例如将他们保存成为 WeakHashMap 中的键。</p>
<p>这个在大量的源码中都有这样的案例</p>
<h3 id="内存泄露案例分析"><a href="#内存泄露案例分析" class="headerlink" title="内存泄露案例分析"></a>内存泄露案例分析</h3><h4 id="案例一："><a href="#案例一：" class="headerlink" title="案例一："></a>案例一：</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Stack</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Object[] elements;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> size = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DEFAULT_INITIAL_CAPACITY = <span class="number">16</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Stack</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        elements = <span class="keyword">new</span> Object[DEFAULT_INITIAL_CAPACITY];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">push</span><span class="params">(Object e)</span> </span>&#123; <span class="comment">//入栈</span></span><br><span class="line">        ensureCapacity();</span><br><span class="line">        elements[size++] = e;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">pop</span><span class="params">()</span> </span>&#123; <span class="comment">//出栈</span></span><br><span class="line">        <span class="keyword">if</span> (size == <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> EmptyStackException();</span><br><span class="line">        <span class="keyword">return</span> elements[--size];</span><br><span class="line">    &#125;</span><br><span class="line">        <span class="comment">// 应该用这种的，把引用置空</span></span><br><span class="line"><span class="comment">//    public Object pop() &#123;</span></span><br><span class="line"><span class="comment">//        if (size == 0) &#123;</span></span><br><span class="line"><span class="comment">//            throw new EmptyStackException();</span></span><br><span class="line"><span class="comment">//        &#125;</span></span><br><span class="line"><span class="comment">//        Object result = elements[--size];</span></span><br><span class="line"><span class="comment">//        elements[size] = null;</span></span><br><span class="line"><span class="comment">//        return result;</span></span><br><span class="line"><span class="comment">//    &#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">ensureCapacity</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (elements.length == size)</span><br><span class="line">            elements = Arrays.copyOf(elements, <span class="number">2</span> * size + <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上述程序并没有明显的错误，但是这段程序有一个内存泄漏，随着 GC 活动的增加，或者内存占用的不断增加，程序性能的降低就会表现出来，严重时可导致内存泄漏，但是这种失败情况相对较少。</p>
<p>代码的主要问题在 pop 函数，下面通过这张图示展现。假设这个栈一直增长，增长后如下图所示</p>
<p><img src="https://img-blog.csdnimg.cn/img_convert/36134d739f40208bf54a0b5c89a8f882.png" alt="image-20210505160114618"></p>
<p>当进行大量的 pop 操作时，由于引用未进行置空，gc 是不会释放的，如下图所示</p>
<p><img src="https://img-blog.csdnimg.cn/img_convert/52eed9c8a0279db4b1f07fd23c0d5eca.png" alt="image-20210505160158618"></p>
<p>从上图中看以看出，如果栈先增长，再收缩，那么从栈中弹出的对象将不会被当作垃圾回收，即使程序不再使用栈中的这些队象，他们也不会回收，因为栈中仍然保存这对象的引用，俗称过期引用，这个内存泄露很隐蔽。</p>
<p>将代码中的 pop()方法变成如下方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">pop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (size == <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> EmptyStackException();</span><br><span class="line">    Object result = elements[--size];</span><br><span class="line">    elements[size] = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>一旦引用过期，清空这些引用，将引用置空。</p>
<p><img src="https://img-blog.csdnimg.cn/img_convert/513c31471d30b0458114859524c35adc.png" alt="image-20210505160423289"></p>
<h4 id="案例二"><a href="#案例二" class="headerlink" title="案例二"></a>案例二</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> top.lvxiaoyi.three.chapter03.code041;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> lvxiaoyi</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021/9/30 15:18</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestActivity</span> <span class="keyword">extends</span> <span class="title">Activity</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Object key = <span class="keyword">new</span> Object();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstancestate)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstancestate);</span><br><span class="line"></span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> Thread() &#123;<span class="comment">//匿名线程</span></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">synchronized</span> (key) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        key.wait();</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>图一：</p>
<p><img src="https://img.lvxiaoyi.top/typora-img/image-20210930153051236.png/lvxiaoyi" alt="image-20210930153051236"></p>
<p>图二：</p>
<p><img src="https://img.lvxiaoyi.top/typora-img/image-20210930153029077.png/lvxiaoyi" alt="image-20210930153029077"></p>
<p>解决：</p>
<ol>
<li><p>使用线程时，一定要确保线程在周期性对象（如Activity）销毁时能正常结束，如能正常结束，但是Activity销毁后还需执行一段时间，也可能造成泄露，此时可采用weakReference方法来解决，另外在使用Handler的时候，如存在Delay操作，也可以采用weakReference；</p>
</li>
<li><p>使用Handler + HandlerThread时，记住在周期性对象销毁时调用looper.quit()方法;</p>
</li>
</ol>
<h2 id="补充：使用-OQL-语言查询对象信息"><a href="#补充：使用-OQL-语言查询对象信息" class="headerlink" title="补充：使用 OQL 语言查询对象信息"></a>补充：使用 OQL 语言查询对象信息</h2><p>MAT 支持一种类似于 SQL 的查询语言 OQL（Object Query Language）。OQL 使用类 SQL 语法，可以在堆中进行对象的查找和筛选。</p>
<h3 id="SELECT-子句"><a href="#SELECT-子句" class="headerlink" title="SELECT 子句"></a>SELECT 子句</h3><p>在 MAT 中，Select 子句的格式与 SQL 基本一致，用于指定要显示的列。Select 子句中可以使用“＊”，查看结果对象的引用实例（相当于 outgoing references）。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> java.util.ArrayList</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> v.elementData <span class="keyword">from</span> java.util.ArrayList v</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>使用“OBJECTS”关键字，可以将返回结果集中的项以对象的形式显示。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">select objects v.elementData from java.util.ArrayList v</span><br><span class="line"></span><br><span class="line">SELECT objects s.value from java.lang.String s</span><br></pre></td></tr></table></figure>

<p>在 Select 子句中，使用“AS RETAINED SET”关键字可以得到所得对象的保留集。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select as retained set * from top.lvxiaoyi.three.chapter03.Student</span><br></pre></td></tr></table></figure>

<p>“DISTINCT”关键字用于在结果集中去除重复对象。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT DISTINCT OBJECTS classof(s) FROM java.lang.String s</span><br></pre></td></tr></table></figure>

<h3 id="FROM-子句"><a href="#FROM-子句" class="headerlink" title="FROM 子句"></a>FROM 子句</h3><p>From 子句用于指定查询范围，它可以指定类名、正则表达式或者对象地址。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT * FROM java.lang.String s</span><br></pre></td></tr></table></figure>

<p>使用正则表达式，限定搜索范围，输出所有top.lvxiaoyi.three.chapter03包下所有类的实例</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT * FROM &quot;top\.lvxiaoyi\.three\.chapter03\..*&quot;</span><br></pre></td></tr></table></figure>

<p>使用类的地址进行搜索。使用类的地址的好处是可以区分被不同 ClassLoader 加载的同一种类型。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select * from 0x37a0b4d</span><br></pre></td></tr></table></figure>

<h3 id="WHERE-子句"><a href="#WHERE-子句" class="headerlink" title="WHERE 子句"></a>WHERE 子句</h3><p>Where 子句用于指定 OQL 的查询条件。OQL 查询将只返回满足 Where 子句指定条件的对象。Where 子句的格式与传统 SQL 极为相似。</p>
<p>返回长度大于 10 的 char 数组。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT * FROM char[] s WHERE s.@length &gt; 10</span><br></pre></td></tr></table></figure>

<p>返回包含“java”子字符串的所有字符串，使用“LIKE”操作符，“LIKE”操作符的操作参数为正则表达式。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT * FROM java.lang.String s WHERE toString(s) LIKE &quot;.*java.*&quot;</span><br></pre></td></tr></table></figure>

<p>返回所有 value 域不为 null 的字符串，使用“＝”操作符。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT * FROM java.lang.String s where s.value!=null</span><br></pre></td></tr></table></figure>

<p>返回数组长度大于 15，并且深堆大于 1000 字节的所有 Vector 对象。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT * FROM java.util.Vector v WHERE v.elementData.@length&gt;15 AND v.@retainedHeapSize&gt;1000</span><br></pre></td></tr></table></figure>

<h3 id="内置对象与方法"><a href="#内置对象与方法" class="headerlink" title="内置对象与方法"></a>内置对象与方法</h3><p>OQL 中可以访问堆内对象的属性，也可以访问堆内代理对象的属性。访问堆内对象的属性时，格式如下，其中 alias 为对象名称：</p>
<p><code>[ &lt;alias&gt;. ] &lt;field&gt; . &lt;field&gt;. &lt;field&gt;</code></p>
<p>访问 java.io.File 对象的 path 属性，并进一步访问 path 的 value 属性：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT toString(f.path.value) FROM java.io.File f</span><br></pre></td></tr></table></figure>

<p>显示 String 对象的内容、objectid 和 objectAddress。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT s.toString(),s.@objectId, s.@objectAddress FROM java.lang.String s</span><br></pre></td></tr></table></figure>

<p>显示 java.util.Vector 内部数组的长度。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT v.elementData.@length FROM java.util.Vector v</span><br></pre></td></tr></table></figure>

<p>显示所有的 java.util.Vector 对象及其子类型</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select * from INSTANCEOF java.util.Vector</span><br></pre></td></tr></table></figure>



<h2 id="补充：OOM"><a href="#补充：OOM" class="headerlink" title="补充：OOM"></a>补充：OOM</h2><h3 id="堆溢出"><a href="#堆溢出" class="headerlink" title="堆溢出"></a>堆溢出</h3><h3 id="元空间溢出"><a href="#元空间溢出" class="headerlink" title="元空间溢出"></a>元空间溢出</h3><h3 id="OOM：GC-overhead-limit-exceeded"><a href="#OOM：GC-overhead-limit-exceeded" class="headerlink" title="OOM：GC overhead limit exceeded"></a>OOM：GC overhead limit exceeded</h3><p>98%的时间都在进行垃圾回收，但是回收效率特别低，就提前报了这个异常</p>
<h3 id="线程溢出"><a href="#线程溢出" class="headerlink" title="线程溢出"></a>线程溢出</h3><h2 id="JProfiler"><a href="#JProfiler" class="headerlink" title="JProfiler"></a>JProfiler</h2><h3 id="概述-8"><a href="#概述-8" class="headerlink" title="概述"></a>概述</h3><h4 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h4><p>在运行 Java 的时候有时候想测试运行时占用内存情况，这时候就需要使用测试工具查看了。在 eclipse 里面有 Eclipse Memory Analyzer tool（MAT）插件可以测试，而在 IDEA 中也有这么一个插件，就是 JProfiler。</p>
<p>JProfiler 是由 ej-technologies 公司开发的一款 Java 应用性能诊断工具。功能强大，但是收费。</p>
<p>官网地址：<a target="_blank" rel="noopener" href="https://www.ej-technologies.com/products/jprofiler/overview.html">https://www.ej-technologies.com/products/jprofiler/overview.html</a></p>
<h4 id="特点"><a href="#特点" class="headerlink" title="特点"></a><strong>特点</strong></h4><ul>
<li>使用方便、界面操作友好（简单且强大）</li>
<li>对被分析的应用影响小（提供模板）</li>
<li>CPU，Thread，Memory 分析功能尤其强大</li>
<li>支持对 jdbc，noSql，jsp，servlet，socket 等进行分析</li>
<li>支持多种模式（离线，在线）的分析</li>
<li>支持监控本地、远程的 JVM</li>
<li>跨平台，拥有多种操作系统的安装版本</li>
</ul>
<h4 id="主要功能"><a href="#主要功能" class="headerlink" title="主要功能"></a><strong>主要功能</strong></h4><ul>
<li>方法调用：对方法调用的分析可以帮助您了解应用程序正在做什么，并找到提高其性能的方法</li>
<li>内存分配：通过分析堆上对象、引用链和垃圾收集能帮您修复内存泄露问题，优化内存使用</li>
<li>线程和锁：JProfiler 提供多种针对线程和锁的分析视图助您发现多线程问题</li>
<li>高级子系统：许多性能问题都发生在更高的语义级别上。例如，对于 JDBC 调用，您可能希望找出执行最慢的 SQL 语句。JProfiler 支持对这些子系统进行集成分析</li>
</ul>
<h3 id="下载与安装"><a href="#下载与安装" class="headerlink" title="下载与安装"></a>下载与安装</h3><h4 id="下载"><a href="#下载" class="headerlink" title="下载"></a>下载</h4><p><a target="_blank" rel="noopener" href="https://www.ej-technologies.com/download/jprofiler/files">https://www.ej-technologies.com/download/jprofiler/files</a></p>
<h4 id="JProfile中配置IDEA"><a href="#JProfile中配置IDEA" class="headerlink" title="JProfile中配置IDEA"></a>JProfile中配置IDEA</h4><img src="https://img.lvxiaoyi.top/typora-img/image-20210930162308657.png/lvxiaoyi" alt="image-20210930162308657" style="zoom:50%;" />

<p>点击Integrate（合并）</p>
<img src="https://img.lvxiaoyi.top/typora-img/image-20210930162337456.png/lvxiaoyi" alt="image-20210930162337456" style="zoom:50%;" />



<p><img src="https://img.lvxiaoyi.top/typora-img/image-20210930163423373.png/lvxiaoyi" alt="image-20210930163423373"></p>
<h4 id="idea集成JProfiler"><a href="#idea集成JProfiler" class="headerlink" title="idea集成JProfiler"></a>idea集成JProfiler</h4><img src="https://img.lvxiaoyi.top/typora-img/image-20210930162730772.png/lvxiaoyi" alt="image-20210930162730772" style="zoom:50%;" />

<img src="https://img.lvxiaoyi.top/typora-img/image-20210930162830076.png/lvxiaoyi" alt="image-20210930162830076" style="zoom:50%;" />

<p>OOMTest测试：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">JProfiler&gt; Protocol version 63</span><br><span class="line">JProfiler&gt; Java 8 detected.</span><br><span class="line">JProfiler&gt; 64-bit library</span><br><span class="line">JProfiler&gt; Listening on port: 34877.</span><br><span class="line">JProfiler&gt; Enabling native methods instrumentation.</span><br><span class="line">JProfiler&gt; Can retransform classes.</span><br><span class="line">JProfiler&gt; Can retransform any class.</span><br><span class="line">JProfiler&gt; Native library initialized</span><br><span class="line">JProfiler&gt; VM initialized</span><br><span class="line">JProfiler&gt; Waiting for a connection from the JProfiler GUI ...</span><br><span class="line">JProfiler&gt; Using sampling (5 ms)</span><br><span class="line">JProfiler&gt; Time measurement: elapsed time</span><br><span class="line">JProfiler&gt; CPU profiling enabled</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="https://img.lvxiaoyi.top/typora-img/image-20210930163828055.png/lvxiaoyi" alt="image-20210930163828055"></p>
<h3 id="具体使用"><a href="#具体使用" class="headerlink" title="具体使用"></a>具体使用</h3><img src="https://img.lvxiaoyi.top/typora-img/image-20210930164430916.png/lvxiaoyi" alt="image-20210930164430916" style="zoom:67%;" />

<p>Open session：分析一个保存的文件</p>
<p>Quick Attach：分析正在运行的java进程（jps）</p>
<h4 id="数据采集方式："><a href="#数据采集方式：" class="headerlink" title="数据采集方式："></a><strong>数据采集方式：</strong></h4><p>JProfier 数据采集方式分为两种：Sampling（样本采集）和 Instrumentation（重构模式）</p>
<p><strong>Instrumentation</strong>：这是 JProfiler 全功能模式。在 class 加载之前，JProfier 把相关功能代码写入到需要分析的 class 的 bytecode 中，对正在运行的 jvm 有一定影响。</p>
<ul>
<li>优点：功能强大。在此设置中，调用堆栈信息是准确的。</li>
<li>缺点：若要分析的 class 较多，则对应用的性能影响较大，CPU 开销可能很高（取决于 Filter 的控制）。因此使用此模式一般配合 Filter 使用，只对特定的类或包进行分析</li>
</ul>
<p><strong>Sampling</strong>（推荐）：类似于样本统计，每隔一定时间（5ms）将每个线程栈中方法栈中的信息统计出来。</p>
<ul>
<li>优点：对 CPU 的开销非常低，对应用影响小（即使你不配置任何 Filter）</li>
<li>缺点：一些数据／特性不能提供（例如：方法的调用次数、执行时间）</li>
</ul>
<p>注：JProfiler 本身没有指出数据的采集类型，这里的采集类型是针对方法调用的采集类型。因为 JProfiler 的绝大多数核心功能都依赖方法调用采集的数据，所以可以直接认为是 JProfiler 的数据采集类型。</p>
<h4 id="遥感监测-Telemetries"><a href="#遥感监测-Telemetries" class="headerlink" title="遥感监测 Telemetries"></a><strong>遥感监测 Telemetries</strong></h4><p>图示一：Overview</p>
<p><img src="https://img.lvxiaoyi.top/typora-img/image-20210930170232606.png/lvxiaoyi" alt="image-20210930170232606"></p>
<p>图示二：Memory</p>
<p><img src="https://img.lvxiaoyi.top/typora-img/image-20210930170253181.png/lvxiaoyi" alt="image-20210930170253181"></p>
<p>图示三：Recorded Objects</p>
<p><img src="https://img.lvxiaoyi.top/typora-img/image-20210930170416808.png/lvxiaoyi" alt="image-20210930170416808"></p>
<p> 图示四：Recorded Throughput</p>
<p><img src="https://img.lvxiaoyi.top/typora-img/image-20210930170454509.png/lvxiaoyi" alt="image-20210930170454509"></p>
<p>图示五：GC Activity</p>
<p><img src="https://img.lvxiaoyi.top/typora-img/image-20210930170552263.png/lvxiaoyi" alt="image-20210930170552263"></p>
<p>图示六：</p>
<p><img src="https://img.lvxiaoyi.top/typora-img/image-20210930170621339.png/lvxiaoyi" alt="image-20210930170621339"></p>
<p>图示七：Threads</p>
<p><img src="https://img.lvxiaoyi.top/typora-img/image-20210930170649546.png/lvxiaoyi" alt="image-20210930170649546"></p>
<p>图示八：CPU Load</p>
<p><img src="https://img.lvxiaoyi.top/typora-img/image-20210930170720803.png/lvxiaoyi" alt="image-20210930170720803"></p>
<h4 id="内存视图-Live-Memory"><a href="#内存视图-Live-Memory" class="headerlink" title="内存视图 Live Memory"></a><strong>内存视图 Live Memory</strong></h4><p>Live memory 内存剖析：class／class instance 的相关信息。例如对象的个数，大小，对象创建的方法执行栈，对象创建的热点。</p>
<h5 id="所有对象-All-Objects："><a href="#所有对象-All-Objects：" class="headerlink" title="所有对象 All Objects："></a><strong>所有对象 All Objects</strong>：</h5><p>显示所有加载的类的列表和在堆上分配的实例数。只有 Java 1.5（JVMTI）才会显示此视图。</p>
<img src="https://img.lvxiaoyi.top/typora-img/image-20210930171435035.png/lvxiaoyi" alt="image-20210930171435035" style="zoom:67%;" />

<p>分析：内存中的对象的情况</p>
<ul>
<li>频繁创建的java对象：死循环、循环次数过多</li>
<li>存在大的对象：读取文件时，byte[]应该边读边写</li>
</ul>
<h5 id="记录对象-Record-Objects："><a href="#记录对象-Record-Objects：" class="headerlink" title="记录对象 Record Objects："></a><strong>记录对象 Record Objects</strong>：</h5><p>查看特定时间段对象的分配，并记录分配的调用堆栈。</p>
<p>判断内存泄露的时候才会使用的功能，内次GC后的剩余内存都在向上增长，说明gc不可回收的对象越来越多，发生了内存泄露</p>
<p><img src="https://img.lvxiaoyi.top/typora-img/image-20210930203148388.png/lvxiaoyi" alt="image-20210930203148388"></p>
<p>可以选择存活的对象，垃圾回收过的对象和存活且被垃圾回收过的对象</p>
<p><img src="https://img.lvxiaoyi.top/typora-img/image-20210930203431039.png/lvxiaoyi" alt="image-20210930203431039"></p>
<h5 id="分配访问树-Allocation-Call-Tree："><a href="#分配访问树-Allocation-Call-Tree：" class="headerlink" title="分配访问树 Allocation Call Tree："></a><strong>分配访问树 Allocation Call Tree</strong>：</h5><p>显示一棵请求树或者方法、类、包或对已选择类有带注释的分配信息的 J2EE 组件。</p>
<h5 id="分配热点-Allocation-Hot-Spots："><a href="#分配热点-Allocation-Hot-Spots：" class="headerlink" title="分配热点 Allocation Hot Spots："></a><strong>分配热点 Allocation Hot Spots</strong>：</h5><p>显示一个列表，包括方法、类、包或分配已选类的 J2EE 组件。你可以标注当前值并且显示差异值。对于每个热点都可以显示它的跟踪记录树。</p>
<h5 id="类追踪器-Class-Tracker："><a href="#类追踪器-Class-Tracker：" class="headerlink" title="类追踪器 Class Tracker："></a><strong>类追踪器 Class Tracker</strong>：</h5><p>类跟踪视图可以包含任意数量的图表，显示选定的类和包的实例与时间。</p>
<h4 id="堆遍历-heap-walker"><a href="#堆遍历-heap-walker" class="headerlink" title="堆遍历 heap walker"></a><strong>堆遍历 heap walker</strong></h4><p>查看references</p>
<p><img src="https://img.lvxiaoyi.top/typora-img/image-20210930210100718.png/lvxiaoyi" alt="image-20210930210100718"></p>
<p>查看对象graph引用</p>
<p><img src="https://img.lvxiaoyi.top/typora-img/image-20210930210155941.png/lvxiaoyi" alt="image-20210930210155941"></p>
<p>离线分析heap快照</p>
<img src="https://img.lvxiaoyi.top/typora-img/image-20210930205937579.png/lvxiaoyi" alt="image-20210930205937579" style="zoom:50%;" />

<h4 id="cpu-视图-cpu-views"><a href="#cpu-视图-cpu-views" class="headerlink" title="cpu 视图 cpu views"></a><strong>cpu 视图 cpu views</strong></h4><p>JProfiler 提供不同的方法来记录访问树以优化性能和细节。线程或者线程组以及线程状况可以被所有的视图选择。所有的视图都可以聚集到方法、类、包或 J2EE 组件等不同层上。</p>
<ul>
<li><p><strong>访问树 Call Tree</strong>：显示一个积累的自顶向下的树，树中包含所有在 JVM 中已记录的访问队列。JDBC，JMS 和 JNDI 服务请求都被注释在请求树中。请求树可以根据 Servlet 和 JSP 对 URL 的不同需要进行拆分。</p>
<p>方法执行越长说明对cpu的占用越长</p>
<p><img src="https://img.lvxiaoyi.top/typora-img/image-20210930210910878.png/lvxiaoyi" alt="image-20210930210910878"></p>
<p><img src="https://img.lvxiaoyi.top/typora-img/image-20210930211146019.png/lvxiaoyi" alt="image-20210930211146019"></p>
</li>
<li><p><strong>热点 Hot Spots</strong>：显示消耗时间最多的方法的列表。对每个热点都能够显示回溯树。该热点可以按照方法请求，JDBC，JMS 和 JNDI 服务请求以及按照 URL 请求来进行计算。</p>
</li>
</ul>
<ul>
<li><p><strong>访问图 Call Graph</strong>：显示一个从已选方法、类、包或 J2EE 组件开始的访问队列的图。</p>
</li>
<li><p><strong>方法统计 Method Statistis</strong>：显示一段时间内记录的方法的调用时间细节。</p>
</li>
</ul>
<p>新版本使用Outliner Detection（异常检测）</p>
<p><img src="https://img.lvxiaoyi.top/typora-img/image-20210930211457206.png/lvxiaoyi" alt="image-20210930211457206"></p>
<h4 id="线程视图-threads"><a href="#线程视图-threads" class="headerlink" title="线程视图 threads"></a><strong>线程视图 threads</strong></h4><p>JProfiler 通过对线程历史的监控判断其运行状态，并监控是否有线程阻塞产生，还能将一个线程所管理的方法以树状形式呈现。对线程剖析。</p>
<ul>
<li><strong>线程历史 Thread History</strong>：显示一个与线程活动和线程状态在一起的活动时间表。</li>
<li><strong>线程监控 Thread Monitor</strong>：显示一个列表，包括所有的活动线程以及它们目前的活动状况。</li>
<li><strong>线程转储 Thread Dumps</strong>：显示所有线程的堆栈跟踪。</li>
</ul>
<p>线程分析主要关心三个方面：</p>
<ul>
<li>1．web 容器的线程最大数。比如：Tomcat 的线程容量应该略大于最大并发数。</li>
<li>2．线程阻塞</li>
<li>3．线程死锁</li>
</ul>
<img src="https://img.lvxiaoyi.top/typora-img/image-20210930212238474.png/lvxiaoyi" alt="image-20210930212238474" style="zoom:67%;" />

<h4 id="监控和锁-Monitors-＆Locks"><a href="#监控和锁-Monitors-＆Locks" class="headerlink" title="监控和锁 Monitors ＆Locks"></a><strong>监控和锁 Monitors ＆Locks</strong></h4><p>所有线程持有锁的情况以及锁的信息。观察 JVM 的内部线程并查看状态：</p>
<ul>
<li><strong>死锁探测图表 Current Locking Graph</strong>：显示 JVM 中的当前死锁图表。</li>
<li><strong>目前使用的监测器 Current Monitors</strong>：显示目前使用的监测器并且包括它们的关联线程。</li>
<li><strong>锁定历史图表 Locking History Graph</strong>：显示记录在 JVM 中的锁定历史。</li>
<li><strong>历史检测记录 Monitor History</strong>：显示重大的等待事件和阻塞事件的历史记录。</li>
<li><strong>监控器使用统计 Monitor Usage Statistics</strong>：显示分组监测，线程和监测类的统计监测数据</li>
</ul>
<h3 id="案例分析"><a href="#案例分析" class="headerlink" title="案例分析"></a>案例分析</h3><h4 id="案例一"><a href="#案例一" class="headerlink" title="案例一"></a>案例一</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> top.lvxiaoyi.three.chapter03.code05;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> lvxiaoyi</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021/9/30 21:25</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JProfilerTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            ArrayList&lt;Data&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">500</span>; i++) &#123;</span><br><span class="line">                Data data = <span class="keyword">new</span> Data();</span><br><span class="line">                list.add(data);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Thread.sleep(<span class="number">500</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Data</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> size = <span class="number">10</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">byte</span>[] buffer = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1204</span> * <span class="number">1024</span>];</span><br><span class="line">    <span class="keyword">private</span> String info = <span class="string">&quot;hello, lvxiaoyi&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="https://img.lvxiaoyi.top/typora-img/image-20210930213349340.png/lvxiaoyi" alt="image-20210930213349340"></p>
<h4 id="案例二-1"><a href="#案例二-1" class="headerlink" title="案例二"></a>案例二</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> top.lvxiaoyi.three.chapter03.code05;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> lvxiaoyi</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021/9/30 21:35</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MemoryLeak</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            ArrayList&lt;Object&gt; beanlist = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">500</span>; i++) &#123;</span><br><span class="line">               <span class="comment">// Bean data = new Bean();</span></span><br><span class="line">                Bean.list.add(<span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1204</span> * <span class="number">10</span>]);</span><br><span class="line">                data.list.add(<span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1204</span> * <span class="number">10</span>]);</span><br><span class="line">                beanlist.add(data);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Thread.sleep(<span class="number">500</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Bean</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> size = <span class="number">10</span>;</span><br><span class="line">    String info = <span class="string">&quot;hello,lvxiaoyi&quot;</span>;</span><br><span class="line">    <span class="keyword">static</span> ArrayList list = <span class="keyword">new</span> ArrayList();</span><br><span class="line">    <span class="comment">//    ArrayList list = new ArrayList();</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="https://img.lvxiaoyi.top/typora-img/image-20210930215739784.png/lvxiaoyi" alt="image-20210930215739784"></p>
<p><img src="https://img.lvxiaoyi.top/typora-img/image-20210930214843517.png/lvxiaoyi" alt="image-20210930214843517"></p>
<p><img src="https://img.lvxiaoyi.top/typora-img/image-20210930214859453.png/lvxiaoyi" alt="image-20210930214859453"></p>
<p>修改后：</p>
<p><img src="https://img.lvxiaoyi.top/typora-img/image-20210930215250926.png/lvxiaoyi" alt="image-20210930215250926"></p>
<img src="https://img.lvxiaoyi.top/typora-img/image-20210930215350778.png/lvxiaoyi" alt="image-20210930215350778" style="zoom:67%;" />



<h2 id="Arthas"><a href="#Arthas" class="headerlink" title="Arthas"></a>Arthas</h2><h3 id="概述-9"><a href="#概述-9" class="headerlink" title="概述"></a>概述</h3><h4 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h4><p>前面，我们介绍了jdk自带的jvisualvm等免费工具，以及商业化工具JProfiler、jvisualvm界面。</p>
<p>这两款工具在业界知名度也比较高，他们的优点是可以图形界面上看到各维度的性能数据，使用者根据这些数据进行综合分析，然后判断哪里出现了性能问题。</p>
<p>但是这两款工具也有个缺点，上述工具都必须在服务端项目进程中配置相关的监控参数，然后工具通过远程连接到项目进程，获取相关的数据。这样就会带来一些不便，比如<strong>线上环境的网络是隔离的，本地的监控工具根本连不上线上环境</strong>。并且类似于 Jprofiler 这样的商业工具，是需要付费的。</p>
<p>那么有没有一款工具不需要远程连接，也不需要配置监控参数，同时也提供了丰富的性能监控数据呢？</p>
<p>阿里巴巴开源的性能分析神器 Arthas 应运而生。</p>
<h3 id="Arthas概述"><a href="#Arthas概述" class="headerlink" title="Arthas概述"></a>Arthas概述</h3><p>Arthas 是 Alibaba 开源的 Java 诊断工具，深受开发者喜爱。在线排查问题，无需重启；动态跟踪 Java 代码；实时监控 JVM 状态。</p>
<p>Arthas 支持 JDK 6 ＋，支持 Linux／Mac／Windows，采用命令行交互模式，同时提供丰富的 Tab 自动补全功能，进一步方便进行问题的定位和诊断。</p>
<p>Arthas 可以帮助你解决：</p>
<ul>
<li>这个类从哪个 jar 包加载的？为什么会报各种类相关的 Exception？</li>
<li>我改的代码为什么没有执行到？难道是我没 commit？分支搞错了？</li>
<li>遇到问题无法在线上 debug，难道只能通过加日志再重新发布吗？</li>
<li>线上遇到某个用户的数据处理有问题，但线上同样无法 debug，线下无法重现！</li>
<li>是否有一个全局视角来查看系统的运行状况？</li>
<li>有什么办法可以监控到 JVM 的实时运行状态？</li>
<li>怎么快速定位应用的热点，生成火焰图？</li>
</ul>
<h3 id="基于工具"><a href="#基于工具" class="headerlink" title="基于工具"></a>基于工具</h3><p>greys-anatomy：Arthas代码基于Greys二次开发而来，非常感谢Greys之前所有的工作，以及Greys原作者对Arthas提出的意见和建议！</p>
<p>termd：Arthas的命令行实现基于termd开发，是一款优秀的命令行程序开发框架，感谢termd提供了优秀的框架。</p>
<p>crash：Arthas的文本渲染功能基于crash中的文本渲染功能开发，可以从这里看到源码，感谢crash在这方面所做的优秀工作。</p>
<p>cli：Arthas的命令行界面基于vert.x提供的cli库进行开发，感谢vert.x在这方面做的优秀工作。</p>
<p>compiler Arthas里的内存编绎器代码来源</p>
<p>Apache Commons Net Arthas里的Telnet client代码来源</p>
<p>JavaAgent：运行在main方法之前的拦截器，它内定的方法名叫 premain ,也就是说先执行premain方法然后再执行main方法</p>
<p>ASM：一个通用的Java字节码操作和分析框架。它可以用于修改现有的类或直接以二进制形式动态生成类。ASM提供了一些常见的字节码转换和分析算法，可以从它们构建定制的复杂转换和代码分析工具。ASM提供了与其他Java字节码框架类似的功能，但是主要关注性能。因为它被设计和实现得尽可能小和快，所以非常适合在动态系统中使用（当然也可以以静态方式使用，例如在编译器中）</p>
<p>官方地址：<a target="_blank" rel="noopener" href="https://arthas.aliyun.com/zh-cn/">https://arthas.aliyun.com/zh-cn/</a></p>
<h4 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h4><p><a target="_blank" rel="noopener" href="https://arthas.aliyun.com/doc/install-detail.html">https://arthas.aliyun.com/doc/install-detail.html</a></p>
<h5 id="安装方式一"><a href="#安装方式一" class="headerlink" title="安装方式一"></a>安装方式一</h5><p>可以直接在linux上通过命令下载</p>
<p>可以在官方github上进行下载，如果速度较慢，可以尝试国内的码云下载。</p>
<ul>
<li><p>github下载</p>
<ul>
<li>```<br>wget <a target="_blank" rel="noopener" href="https://alibaba.github.io/arthas/arthas-boot.jar">https://alibaba.github.io/arthas/arthas-boot.jar</a><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">* gitee下载</span><br><span class="line"></span><br><span class="line">  * ```</span><br><span class="line">    wget https://arthas/gitee/io/arthas-boot.jar</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<h5 id="安装方式二："><a href="#安装方式二：" class="headerlink" title="安装方式二："></a>安装方式二：</h5><p>也可以在浏览器直接访问<a target="_blank" rel="noopener" href="https://alibaba.github.io/arthas/arthas-boot.jar%EF%BC%8C%E7%AD%89%E5%BE%85%E4%B8%8B%E8%BD%BD%E6%88%90%E5%8A%9F%E5%90%8E%EF%BC%8C%E4%B8%8A%E4%BC%A0%E5%88%B0Linux%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B8%8A%E3%80%82">https://alibaba.github.io/arthas/arthas-boot.jar，等待下载成功后，上传到Linux服务器上。</a></p>
<p>在系统启动文件中添加参数-XX:+StartAttachListener</p>
<h5 id="卸载"><a href="#卸载" class="headerlink" title="卸载"></a>卸载</h5><p>在 Linux/Unix/Mac平台</p>
<p>删除下面文件:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">-m -rf ~/.arthas/</span><br><span class="line"></span><br><span class="line">rm -rf ~/logs/arthas</span><br></pre></td></tr></table></figure>

<p>windows平台直接删除user home下面的.arthas和logs/arthas目录</p>
<h4 id="安装目录"><a href="#安装目录" class="headerlink" title="安装目录"></a>安装目录</h4><p>arthas-agent：基于JavaAgent技术的代理</p>
<p>bin：一些启动脚本</p>
<p>arthas-boot： Java版本的一键安装启动脚本</p>
<p>arthas-client： telnet client代码</p>
<p>arthas-common：一些共用的工具类和枚举类</p>
<p>arthas-core：核心库，各种arthas命令的交互和实现</p>
<p>arthas-demo：示例代码</p>
<p>arthas-memorycompiler：内存编绎器代码，Fork from <a target="_blank" rel="noopener" href="https://github.com/skalogs/SkaETL/tree/master/compiler">https://github.com/skalogs/SkaETL/tree/master/compiler</a></p>
<p>erarthas-packaging：maven打包相关的</p>
<p>arthas-site：arthas站点</p>
<p>arthas-spy：编织到目标类中的各个切面</p>
<p>static：静态资源</p>
<p>arthas-testcase：测试</p>
<h4 id="启动-1"><a href="#启动-1" class="headerlink" title="启动"></a>启动</h4><p>Arthas只是一个java程序，所以可以直接用java -jar运行。</p>
<p>执行成功后，arthas提供了一种命令行方式的交互方式，arthas会检测当前服务器上的Java进程，并将进程列表展示出来，用户输入对应的编号(1、2、3、4…）进行选择，然后回车。</p>
<p>比如：方式1：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar arthas-boot.jar</span><br></pre></td></tr></table></figure>

<ul>
<li>选择进程(输入[]内编号(不是PID)回车)</li>
</ul>
<p>方式2：运行时选择Java进程 PID</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar arthas-boot.jar [PID]</span><br></pre></td></tr></table></figure>

<h5 id="案例一-1"><a href="#案例一-1" class="headerlink" title="案例一"></a>案例一</h5><p>这里没有在linux中安装图像化界面</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 这里编译文件的时候，要把文件中的包去掉</span></span><br><span class="line">[root@VM-0-9-centos javatest]<span class="comment"># java -Xms600m -Xmx600m -XX:SurvivorRatio=8 OOMTest.java </span></span><br><span class="line">Error: Could not find or load main class OOMTest.java</span><br><span class="line">[root@VM-0-9-centos javatest]<span class="comment"># java OOMTest</span></span><br><span class="line">^C[root@VM-0-9-centos javatest]<span class="comment"># javac OOMTest.java</span></span><br><span class="line"><span class="comment"># 后台运行，要不然运行arthas-boot一直报错</span></span><br><span class="line">[root@VM-0-9-centos javatest]<span class="comment"># nohup java OOMTest &amp;</span></span><br><span class="line">[1] 19156</span><br><span class="line">[root@VM-0-9-centos javatest]<span class="comment"># nohup: ignoring input and appending output to ‘nohup.out’</span></span><br><span class="line"></span><br><span class="line">[root@VM-0-9-centos javatest]<span class="comment"># jps</span></span><br><span class="line">19156 OOMTest</span><br><span class="line">19405 Jps</span><br><span class="line">[root@VM-0-9-centos javatest]<span class="comment"># cd ../</span></span><br><span class="line">[root@VM-0-9-centos arthas]<span class="comment"># java -jar arthas-boot.jar </span></span><br><span class="line">[INFO] arthas-boot version: 3.5.3</span><br><span class="line">[INFO] Found existing java process, please choose one and input the serial number of the process, eg : 1. Then hit ENTER.</span><br><span class="line">* [1]: 19156 OOMTest</span><br><span class="line">1</span><br><span class="line">[INFO] arthas home: /root/.arthas/lib/3.5.4/arthas</span><br><span class="line">[INFO] Try to attach process 19156</span><br><span class="line">[INFO] Attach process 19156 success.</span><br><span class="line">[INFO] arthas-client connect 127.0.0.1 3658</span><br><span class="line">  ,---.  ,------. ,--------.,--.  ,--.  ,---.   ,---.                           </span><br><span class="line"> /  O  \ |  .--. <span class="string">&#x27;&#x27;</span>--.  .--<span class="string">&#x27;|  &#x27;</span>--<span class="string">&#x27;  | /  O  \ &#x27;</span>   .-<span class="string">&#x27;                          </span></span><br><span class="line"><span class="string">|  .-.  ||  &#x27;</span>--<span class="string">&#x27;.&#x27;</span>   |  |   |  .--.  ||  .-.  |`.  `-.                          </span><br><span class="line">|  | |  ||  |\  \    |  |   |  |  |  ||  | |  |.-<span class="string">&#x27;    |                         </span></span><br><span class="line"><span class="string">`--&#x27;</span> `--<span class="string">&#x27;`--&#x27;</span> <span class="string">&#x27;--&#x27;</span>   `--<span class="string">&#x27;   `--&#x27;</span>  `--<span class="string">&#x27;`--&#x27;</span> `--<span class="string">&#x27;`-----&#x27;</span>                          </span><br><span class="line">                                                                                </span><br><span class="line"></span><br><span class="line">wiki       https://arthas.aliyun.com/doc                                        </span><br><span class="line">tutorials  https://arthas.aliyun.com/doc/arthas-tutorials.html                  </span><br><span class="line">version    3.5.4                                                                </span><br><span class="line">main_class                                                                      </span><br><span class="line">pid        19156</span><br><span class="line">time       2021-10-01 14:05:27                                                  </span><br><span class="line"></span><br><span class="line">[arthas@19156]$  </span><br></pre></td></tr></table></figure>



<h4 id="查看进程"><a href="#查看进程" class="headerlink" title="查看进程"></a>查看进程</h4><p>jps</p>
<h4 id="查看日志"><a href="#查看日志" class="headerlink" title="查看日志"></a>查看日志</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-0-9-centos arthas]<span class="comment"># cat ~/logs/arthas/arthas.log</span></span><br><span class="line">Arthas server agent start...</span><br><span class="line">2021-10-01 11:28:06 [arthas-binding-thread] INFO  c.t.arthas.core.util.ArthasBanner -Current arthas version: 3.5.4, recommend latest version: 3.5.4</span><br><span class="line">2021-10-01 11:28:06 [arthas-binding-thread] INFO  c.t.arthas.core.util.ArthasBanner -Current arthas version: 3.5.4, recommend latest version: 3.5.4</span><br><span class="line">2021-10-01 11:28:06 [arthas-binding-thread] INFO  c.t.a.core.server.ArthasBootstrap -try to <span class="built_in">bind</span> telnet server, host: 127.0.0.1, port: 3658.</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<h4 id="查看帮助"><a href="#查看帮助" class="headerlink" title="查看帮助"></a>查看帮助</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar arthas-boot.jar -h</span><br></pre></td></tr></table></figure>

<h4 id="web-console"><a href="#web-console" class="headerlink" title="web console"></a>web console</h4><p>除了在命令行查看外，Arthas目前还支持 web Console。在成功启动连接进程之后就已经自动启动，可以直接访问<a target="_blank" rel="noopener" href="http://127.0.0.1:8563/%E8%AE%BF%E9%97%AE%EF%BC%8C%E9%A1%B5%E9%9D%A2%E4%B8%8A%E7%9A%84%E6%93%8D%E4%BD%9C%E6%A8%A1%E5%BC%8F%E5%92%8C%E6%8E%A7%E5%88%B6%E5%8F%B0%E5%AE%8C%E5%85%A8%E4%B8%80%E6%A0%B7%E3%80%82">http://127.0.0.1:8563/访问，页面上的操作模式和控制台完全一样。</a></p>
<p>linux使用curl指令验证</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-0-9-centos ~]<span class="comment"># curl 127.0.0.1:8563</span></span><br><span class="line">&lt;!doctype html&gt;</span><br><span class="line">&lt;html lang=<span class="string">&quot;en&quot;</span>&gt;</span><br><span class="line"></span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;!-- Required meta tags --&gt;</span><br><span class="line">    &lt;meta charset=<span class="string">&quot;utf-8&quot;</span>&gt;</span><br><span class="line">    &lt;meta name=<span class="string">&quot;viewport&quot;</span> content=<span class="string">&quot;width=device-width, initial-scale=1, shrink-to-fit=no&quot;</span>&gt;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>



<h4 id="退出"><a href="#退出" class="headerlink" title="退出"></a>退出</h4><p>最后一行[arthas@7457]$，说明打开进入了监控客户端，在这里就可以执行相关命令进行查看了。</p>
<ul>
<li>使用<code>qui</code>t`exit`：退出当前客户端</li>
<li>使用<code>stop</code>`shutdown`：关闭arthas服务端,并退出所有客户端。</li>
</ul>
<h3 id="相关诊断指令"><a href="#相关诊断指令" class="headerlink" title="相关诊断指令"></a>相关诊断指令</h3><h4 id="基础指令"><a href="#基础指令" class="headerlink" title="基础指令"></a><strong>基础指令</strong></h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">quit/exit 退出当前 Arthas客户端，其他 Arthas喜户端不受影响</span><br><span class="line">stop/shutdown 关闭 Arthas服务端，所有 Arthas客户端全部退出</span><br><span class="line">help 查看命令帮助信息</span><br><span class="line">cat 打印文件内容，和linux里的cat命令类似</span><br><span class="line">echo 打印参数，和linux里的echo命令类似</span><br><span class="line">grep 匹配查找，和linux里的gep命令类似</span><br><span class="line">tee 复制标隹输入到标准输出和指定的文件，和linux里的tee命令类似</span><br><span class="line">pwd 返回当前的工作目录，和linux命令类似</span><br><span class="line">cs 清空当前屏幕区域</span><br><span class="line">session 查看当前会话的信息</span><br><span class="line">reset 重置增强类，将被 Arthas增强过的类全部还原, Arthas服务端关闭时会重置所有增强过的类</span><br><span class="line">version 输出当前目标Java进程所加载的 Arthas版本号</span><br><span class="line">history 打印命令历史</span><br><span class="line">keymap Arthas快捷键列表及自定义快捷键</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-0-9-centos javatest]<span class="comment"># nohup java -Xms600m -Xmx600m -XX:SurvivorRatio=8 OOMTest  &amp;</span></span><br><span class="line">[1] 27496</span><br><span class="line">[root@VM-0-9-centos javatest]<span class="comment"># nohup: ignoring input and appending output to ‘nohup.out’</span></span><br><span class="line"></span><br><span class="line">[root@VM-0-9-centos javatest]<span class="comment"># jps</span></span><br><span class="line">27496 OOMTest</span><br><span class="line">27518 Jps</span><br><span class="line">[root@VM-0-9-centos javatest]<span class="comment"># jinfo -flags 27496</span></span><br><span class="line">Attaching to process ID 27496, please <span class="built_in">wait</span>...</span><br><span class="line">Debugger attached successfully.</span><br><span class="line">Server compiler detected.</span><br><span class="line">JVM version is 25.144-b01</span><br><span class="line">Non-default VM flags: -XX:CICompilerCount=2 -XX:InitialHeapSize=629145600 -XX:MaxHeapSize=629145600 -XX:MaxNewSize=209715200 -XX:MinHeapDeltaBytes=196608 -XX:NewSize=209715200 -XX:OldSize=419430400 -XX:SurvivorRatio=8 -XX:+UseCompressedClassPointers -XX:+UseCompressedOops </span><br><span class="line">Command line:  -Xms600m -Xmx600m -XX:SurvivorRatio=8</span><br><span class="line">[root@VM-0-9-centos arthas]<span class="comment"># javar -jar arthas-boot.jar </span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure>



<h4 id="jvm-相关"><a href="#jvm-相关" class="headerlink" title="jvm 相关"></a><strong>jvm 相关</strong></h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">dashboard 当前系统的实时数据面板</span><br><span class="line">thread 查看当前JVM的线程堆栈信息</span><br><span class="line">jvm 查看当前JVM的信息</span><br><span class="line">sysprop 查看和修改JVM的系统属性</span><br><span class="line">sysem 查看JVM的环境变量</span><br><span class="line">vmoption 查看和修改JVM里诊断相关的option</span><br><span class="line">perfcounter 查看当前JVM的 Perf Counter信息</span><br><span class="line">logger 查看和修改logger</span><br><span class="line">getstatic 查看类的静态属性</span><br><span class="line">ognl 执行ognl表达式</span><br><span class="line">mbean 查看 Mbean的信息</span><br><span class="line">heapdump dump java heap，类似jmap命令的 heap dump功能</span><br></pre></td></tr></table></figure>

<h4 id="class-classloader-相关"><a href="#class-classloader-相关" class="headerlink" title="class/classloader 相关"></a><strong>class/classloader 相关</strong></h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">sc 查看JVM已加载的类信息</span><br><span class="line">	-d 输出当前类的详细信息，包括这个类所加载的原始文件来源、类的声明、加载的Classloader等详细信息。如果一个类被多个Classloader所加载，则会出现多次</span><br><span class="line">	-E 开启正则表达式匹配，默认为通配符匹配</span><br><span class="line">	-f 输出当前类的成员变量信息（需要配合参数-d一起使用）</span><br><span class="line">	-X 指定输出静态变量时属性的遍历深度，默认为0，即直接使用toString输出</span><br><span class="line">sm 查看已加载类的方法信息</span><br><span class="line">	-d 展示每个方法的详细信息</span><br><span class="line">	-E 开启正则表达式匹配,默认为通配符匹配</span><br><span class="line">jad 反编译指定已加载类的源码</span><br><span class="line">mc 内存编译器，内存编译.java文件为.class文件</span><br><span class="line">retransform 加载外部的.class文件, retransform到JVM里</span><br><span class="line">redefine 加载外部的.class文件，redefine到JVM里</span><br><span class="line">dump dump已加载类的byte code到特定目录</span><br><span class="line">classloader 查看classloader的继承树，urts，类加载信息，使用classloader去getResource</span><br><span class="line">	-t 查看classloader的继承树</span><br><span class="line">	-l 按类加载实例查看统计信息</span><br><span class="line">	-c 用classloader对应的hashcode来查看对应的 Jar urls</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[arthas@31533]$ sc -d Picture</span><br></pre></td></tr></table></figure>



<h4 id="monitor-watch-trace-相关"><a href="#monitor-watch-trace-相关" class="headerlink" title="monitor/watch/trace 相关"></a><strong>monitor/watch/trace 相关</strong></h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">monitor 方法执行监控，调用次数、执行时间、失败率</span><br><span class="line">	-c 统计周期，默认值为120秒</span><br><span class="line">watch 方法执行观测，能观察到的范围为：返回值、抛出异常、入参，通过编写groovy表达式进行对应变量的查看</span><br><span class="line">	-b 在方法调用之前观察(默认关闭)</span><br><span class="line">	-e 在方法异常之后观察(默认关闭)</span><br><span class="line">	-s 在方法返回之后观察(默认关闭)</span><br><span class="line">	-f 在方法结束之后(正常返回和异常返回)观察(默认开启)</span><br><span class="line">	-x 指定输岀结果的属性遍历深度,默认为0</span><br><span class="line">trace 方法内部调用路径,并输出方法路径上的每个节点上耗时</span><br><span class="line">	-n 执行次数限制</span><br><span class="line">stack 输出当前方法被调用的调用路径</span><br><span class="line">tt 方法执行数据的时空隧道,记录下指定方法每次调用的入参和返回信息,并能对这些不同的时间下调用进行观测</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">stack Picture &lt;init&gt;</span><br><span class="line"></span><br><span class="line">watch Picture &lt;init&gt; &quot;&#123;params,returnObj&#125;&quot; -x 2</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h4 id="其他-1"><a href="#其他-1" class="headerlink" title="其他"></a><strong>其他</strong></h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">jobs 列出所有job</span><br><span class="line">kill 强制终止任务</span><br><span class="line">fg 将暂停的任务拉到前台执行</span><br><span class="line">bg 将暂停的任务放到后台执行</span><br><span class="line">grep 搜索满足条件的结果</span><br><span class="line">plaintext 将命令的结果去除ANSI颜色</span><br><span class="line">wc 按行统计输出结果</span><br><span class="line">options 查看或设置Arthas全局开关</span><br><span class="line">profiler 使用async-profiler对应用采样，生成火焰图</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[arthas@9226]$ profiler start</span><br><span class="line">Started [cpu] profiling</span><br><span class="line">[arthas@9226]$ profiler getSamples</span><br><span class="line">8</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h2 id="Java-Misssion-Control"><a href="#Java-Misssion-Control" class="headerlink" title="Java Misssion Control"></a>Java Misssion Control</h2><h3 id="历史"><a href="#历史" class="headerlink" title="历史"></a>历史</h3><p>在 Oracle 收购 Sun 之前，Oracle 的 JRockit 虚拟机提供了一款叫做 JRockit Mission Control 的虚拟机诊断工具。</p>
<p>在 Oracle 收购 sun 之后，Oracle 公司同时拥有了 Hotspot 和 JRockit 两款虚拟机。根据 Oracle 对于 Java 的战略，在今后的发展中，会将 JRokit 的优秀特性移植到 Hotspot 上。其中一个重要的改进就是在 Sun 的 JDK 中加入了 JRockit 的支持。</p>
<p>在 Oracle JDK 7u40 之后，Mission Control 这款工具己经绑定在 Oracle JDK 中发布。</p>
<p>自 Java11 开始，本节介绍的 JFR 己经开源。但在之前的 Java 版本，JFR 属于 Commercial Feature 通过 Java 虚拟机参数-XX:+UnlockCommercialFeatures 开启。</p>
<p>官方地址：<a target="_blank" rel="noopener" href="https://github.com/JDKMissionControl/jmc">https://github.com/JDKMissionControl/jmc</a></p>
<p><img src="https://img-blog.csdnimg.cn/img_convert/042f2d109ebcf51894f822706963e399.png" alt="image-20210505184358041"></p>
<h3 id="启动-2"><a href="#启动-2" class="headerlink" title="启动"></a>启动</h3><p>jdk安装位置/bin/jmc.exe</p>
<h3 id="概述-10"><a href="#概述-10" class="headerlink" title="概述"></a>概述</h3><p>Java Mission Control（简称 JMC) ， Java 官方提供的性能强劲的工具，是一个用于对 Java 应用程序进行管理、监视、概要分析和故障排除的工具套件。它包含一个 GUI 客户端以及众多用来收集 Java 虚拟机性能数据的插件如 JMX Console（能够访问用来存放虚拟机齐个于系统运行数据的 MXBeans）以及虚拟机内置的高效 profiling 工具 Java Flight Recorder（JFR）。</p>
<p>JMC 的另一个优点就是：采用取样，而不是传统的代码植入技术，对应用性能的影响非常非常小，完全可以开着 JMC 来做压测（唯一影响可能是 full gc 多了）。</p>
<h3 id="功能"><a href="#功能" class="headerlink" title="功能"></a>功能</h3><p>如果是远程服务器，使用前要开JMX。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">-Dcom.sun.management.jmxremote.port=<span class="variable">$&#123;YOUR PORT&#125;</span></span><br><span class="line">-Dcom.sun.management.jmxremote</span><br><span class="line">-Dcom.sun.management.jmxremote.authenticate=<span class="literal">false</span></span><br><span class="line">-Dcom.sun.management.jmxremote.ssl=<span class="literal">false</span></span><br><span class="line">-Djava.rmi.server.hostname=<span class="variable">$&#123;YOUR HOST/IP&#125;</span></span><br></pre></td></tr></table></figure>

<p>文件-&gt;连接-&gt;创建新连接，填入上面JMX参数的 host 和 port</p>
<h3 id="Java-Flight-Recorder"><a href="#Java-Flight-Recorder" class="headerlink" title="Java Flight Recorder"></a><strong>Java Flight Recorder</strong></h3><h4 id="事件类型"><a href="#事件类型" class="headerlink" title="事件类型"></a>事件类型</h4><p>Java Flight Recorder 是 JMC 的其中一个组件，能够以极低的性能开销收集 Java 虚拟机的性能数据。与其他工具相比，JFR 的性能开销很小，在默认配置下平均低于 1%。JFR 能够直接访问虚拟机内的数据并且不会影响虚拟机的优化。因此它非常适用于生产环境下满负荷运行的 Java 程序。</p>
<p>Java Flight Recorder 和 JDK Mission Control 共同创建了一个完整的工具链。JDK Mission Control 可对 Java Flight Recorder 连续收集低水平和详细的运行时信息进行高效、详细的分析。</p>
<p>当启用时 JFR 将记录运行过程中发生的一系列事件。其中包括 Java 层面的事件如线程事件、锁事件，以及 Java 虚拟机内部的事件，如新建对象，垃圾回收和即时编译事件。按照发生时机以及持续时间来划分，JFR 的事件共有四种类型，它们分别为以下四种：</p>
<ul>
<li>瞬时事件（Instant Event) ，用户关心的是它们发生与否，例如异常、线程启动事件。</li>
<li>持续事件(Duration Event) ，用户关心的是它们的持续时间，例如垃圾回收事件。</li>
<li>计时事件(Timed Event) ，是时长超出指定阈值的持续事件。</li>
<li>取样事件（Sample Event)，是周期性取样的事件。</li>
</ul>
<p>取样事件的其中一个常见例子便是方法抽样（Method Sampling），即每隔一段时问统计各个线程的栈轨迹。如果在这些抽样取得的栈轨迹中存在一个反复出现的方法，那么我们可以推测该方法是热点方法</p>
<h4 id="启动方式"><a href="#启动方式" class="headerlink" title="启动方式"></a>启动方式</h4><p>方式1：使用-XX:StartFlightRecording=参数</p>
<p>第一种是在运行目标 Java程序时添加-XX:StartFlightRecording=参数。</p>
<p>比如：下面命令中，JFR将会在Java 虚拟机启动5s 后（对应delay=5s）收集数据，持续20s （对应duration=20s）。当收集完毕后，JFR会将收集得到的数据保存至指定的文件中（对应filename=myrecording.jfr）</p>
<p>java-XX:StartFlightRecording=delay=5s,duration=20s,filename=myrecording.jfr,settings=profile MyApp<br>由于JFR将持续收集数据，如果不加以限制，那么JFR可能会填满硬盘的所有空间。因此，我们有必要对这种模式下所收集的数据进行限制。<br>比如:<br>java -xX:StartFlightRecording=maxage=10m,maxsize=100m, name=SomeLabel MyApp</p>
<p>方式2：使用jcmd的JFR.*子命令</p>
<p>通过jcmd来让JFR开始收集数据、停止收集数据，或者保存所收集的数据，对应的子命令分别为FR.start，JFR.stop，以及FR.dump。<br>jcmd &lt;PID〉JFR.start settings=profile maxage=10m maxsize=150m name=SomeLabel<br>上述命令运行过后，目标进程中的JFR已经开始收集数据。此时，我们可以通过下述命令来导出已,经收集到的数据:<br>jcmd <PID>JFR.dump name=SomeLabel filename=myrecording.jfr<br>最后，我们可以通过下述命令关闭目标进程中的JFR:<br>jcmd <PID>JFR.stop name=SomeLabel</p>
<p>方式3：JMC的JFR插件</p>
<h4 id="取样分析"><a href="#取样分析" class="headerlink" title="取样分析"></a>取样分析</h4><p>要采用取样，必须先添加参数:<br>-XX:+UnlockCommercialFeatures· -XX:+FlightRecorder<br>否则:</p>
<p>取样时间默认1分钟，可自行按需调整，事件设置选为 profiling，然后可以设置取样 profile哪些信息，比如:<br>·加上对象数量的统计:Java Virtual Machine -&gt; 6c -&gt; Detailed -&gt; 0bject<br>Count/0bject Count after Gc<br>·方法调用采样的间隔从 10ms改为1ms(但不能低于1ms，否则会影响性能了):JavaVirtual Machine -&gt; Profizing -&gt;Method Profiling Sample/Method SamplingInformation<br>Socket 与 File采样，10ms太久，但即使改为 1ms 也未必能抓住什么，可以干脆取消掉:Java Application-&gt;File Read/Filewrite/Socket Read/Socket write</p>
<p>然后就开始 Profile，到时间后 Profile结束，会自动把记录下载回来，在JNC 中展示。</p>
<p>从展示信息中，我们大致可以读到内存和CPU信息、代码、线程和Io等比较重要的信息展示。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * -Xms600m -Xmx600m -XX:SurvivorRatio=8</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OOMTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        ArrayList&lt;Picture&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="keyword">while</span>(<span class="keyword">true</span>)&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Thread.sleep(<span class="number">5</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            list.add(<span class="keyword">new</span> Picture(<span class="keyword">new</span> Random().nextInt(<span class="number">100</span> * <span class="number">50</span>)));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Picture</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">byte</span>[] pixels;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Picture</span><span class="params">(<span class="keyword">int</span> length)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.pixels = <span class="keyword">new</span> <span class="keyword">byte</span>[length];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">byte</span>[] getPixels() &#123;</span><br><span class="line">        <span class="keyword">return</span> pixels;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPixels</span><span class="params">(<span class="keyword">byte</span>[] pixels)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.pixels = pixels;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h2 id="其他工具"><a href="#其他工具" class="headerlink" title="其他工具"></a>其他工具</h2><h3 id="Flame-Graphs（火焰图）"><a href="#Flame-Graphs（火焰图）" class="headerlink" title="Flame Graphs（火焰图）"></a><strong>Flame Graphs（火焰图）</strong></h3><p>在追求极致性能的场景下，了解你的程序运行过程中 cpu 在干什么很重要，火焰图就是一种非常直观的展示 CPU 在程序整个生命周期过程中<strong>时间分配</strong>的工具。火焰图对于现代的程序员不应该陌生，这个工具<strong>可以非常直观的显示出调用找中的 CPU 消耗瓶颈</strong>。</p>
<p>网上的关于 Java 火焰图的讲解大部分来自于 Brenden Gregg 的博客 <a target="_blank" rel="noopener" href="http://new.brendangregg.com/flamegraphs.html">http://new.brendangregg.com/flamegraphs.html</a></p>
<p><img src="https://img-blog.csdnimg.cn/img_convert/c2692cea072a29b00b420933892ae9f9.png" alt="image-20210505190823214"></p>
<p>火焰图，简单通过 x 轴横条宽度来度量时间指标，y 轴代表线程栈的层次。</p>
<h3 id="Tprofiler"><a href="#Tprofiler" class="headerlink" title="Tprofiler"></a><strong>Tprofiler</strong></h3><p>案例： 使用 JDK 自身提供的工具进行 JVM 调优可以将下 TPS 由 2.5 提升到 20（提升了 7 倍），并准确 定位系统瓶颈。</p>
<p>系统瓶颈有：应用里释态对象不是太多、有大量的业务线程在频繁创建一些生命周期很长的临时对象，代码里有问题。</p>
<p>那么，如何在海量业务代码里边准确定位这些性能代码？这里使用阿里开源工具 Tprofiler 来定位 这些性能代码，成功解决掉了 GC 过于频繁的性能瓶预，并最终在上次优化的基础上将 TPS 再提升了 4 倍，即提升到 100。</p>
<ul>
<li>Tprofiler 配置部署、远程操作、 日志阅谈都不太复杂，操作还是很简单的。但是其却是能够 起到一针见血、立竿见影的效果，帮我们解决了 GC 过于频繁的性能瓶预。</li>
<li>Tprofiler 最重要的特性就是能够统汁出你指定时间段内 JVM 的 top method 这些 top method 极有可能就是造成你 JVM 性能瓶颈的元凶。这是其他大多数 JVM 调优工具所不具备的，包括 JRockit Mission Control。JRokit 首席开发者 Marcus Hirt 在其私人博客《 Lom Overhead Method Profiling cith Java Mission Control》下的评论中曾明确指出 JRMC 井不支持 TOP 方法的统计。</li>
</ul>
<p>官方地址：<a target="_blank" rel="noopener" href="http://github.com/alibaba/Tprofiler">http://github.com/alibaba/Tprofiler</a></p>
<h3 id="Btrace"><a href="#Btrace" class="headerlink" title="Btrace"></a><strong>Btrace</strong></h3><p>常见的动态追踪工具有 BTrace、HouseHD（该项目己经停止开发）、Greys-Anatomy（国人开发 个人开发者）、Byteman（JBoss 出品），注意 Java 运行时追踪工具井不限干这几种，但是这几个是相对比较常用的。</p>
<p>BTrace 是 SUN Kenai 云计算开发平台下的一个开源项目，旨在为 java 提供安全可靠的动态跟踪分析工具。先看一卜日 Trace 的官方定义：</p>
<p><img src="https://img-blog.csdnimg.cn/img_convert/8df058bdfb18387a90cd5dd87a2a2f04.png" alt="image-20210505192042974"></p>
<p>大概意思是一个 Java 平台的安全的动态追踪工具，可以用来动态地追踪一个运行的 Java 程序。BTrace 动态调整目标应用程序的类以注入跟踪代码（“字节码跟踪“）。</p>
<p><strong>YourKit</strong></p>
<p><strong>JProbe</strong></p>
<p><strong>Spring Insight</strong></p>
<h1 id="JVM-运行时参数"><a href="#JVM-运行时参数" class="headerlink" title="JVM 运行时参数"></a>JVM 运行时参数</h1><h2 id="JVM-参数选项"><a href="#JVM-参数选项" class="headerlink" title="JVM 参数选项"></a>JVM 参数选项</h2><p>官网地址：<a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/8/docs/technotes/tools/windows/java.html">https://docs.oracle.com/javase/8/docs/technotes/tools/windows/java.html</a></p>
<p><a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/8/docs/technotes/tools/unix/java.html">https://docs.oracle.com/javase/8/docs/technotes/tools/unix/java.html</a></p>
<h3 id="类型一：标准参数选项"><a href="#类型一：标准参数选项" class="headerlink" title="类型一：标准参数选项"></a>类型一：标准参数选项</h3><p>特点：比较稳定，后续版本基本不会变化</p>
<p>以-开头</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">&gt; java -<span class="built_in">help</span></span><br><span class="line">用法: java [-options] class [args...]</span><br><span class="line">           (执行类)</span><br><span class="line">   或  java [-options] -jar jarfile [args...]</span><br><span class="line">           (执行 jar 文件)</span><br><span class="line">其中选项包括:</span><br><span class="line">    -d32          使用 32 位数据模型 (如果可用)</span><br><span class="line">    -d64          使用 64 位数据模型 (如果可用)</span><br><span class="line">    -server       选择 <span class="string">&quot;server&quot;</span> VM</span><br><span class="line">                  默认 VM 是 server.</span><br><span class="line"></span><br><span class="line">    -cp &lt;目录和 zip/jar 文件的类搜索路径&gt;</span><br><span class="line">    -classpath &lt;目录和 zip/jar 文件的类搜索路径&gt;</span><br><span class="line">                  用 ; 分隔的目录, JAR 档案</span><br><span class="line">                  和 ZIP 档案列表, 用于搜索类文件。</span><br><span class="line">    -D&lt;名称&gt;=&lt;值&gt;</span><br><span class="line">                  设置系统属性</span><br><span class="line">    -verbose:[class|gc|jni]</span><br><span class="line">                  启用详细输出</span><br><span class="line">    -version      输出产品版本并退出</span><br><span class="line">    -version:&lt;值&gt;</span><br><span class="line">                  警告: 此功能已过时, 将在</span><br><span class="line">                  未来发行版中删除。</span><br><span class="line">                  需要指定的版本才能运行</span><br><span class="line">    -showversion  输出产品版本并继续</span><br><span class="line">    -jre-restrict-search | -no-jre-restrict-search</span><br><span class="line">                  警告: 此功能已过时, 将在</span><br><span class="line">                  未来发行版中删除。</span><br><span class="line">                  在版本搜索中包括/排除用户专用 JRE</span><br><span class="line">    -? -<span class="built_in">help</span>      输出此帮助消息</span><br><span class="line">    -X            输出非标准选项的帮助</span><br><span class="line">    -ea[:&lt;packagename&gt;...|:&lt;classname&gt;]</span><br><span class="line">    -enableassertions[:&lt;packagename&gt;...|:&lt;classname&gt;]</span><br><span class="line">                  按指定的粒度启用断言</span><br><span class="line">    -da[:&lt;packagename&gt;...|:&lt;classname&gt;]</span><br><span class="line">    -disableassertions[:&lt;packagename&gt;...|:&lt;classname&gt;]</span><br><span class="line">                  禁用具有指定粒度的断言</span><br><span class="line">    -esa | -enablesystemassertions</span><br><span class="line">                  启用系统断言</span><br><span class="line">    -dsa | -disablesystemassertions</span><br><span class="line">                  禁用系统断言</span><br><span class="line">    -agentlib:&lt;libname&gt;[=&lt;选项&gt;]</span><br><span class="line">                  加载本机代理库 &lt;libname&gt;, 例如 -agentlib:hprof</span><br><span class="line">                  另请参阅 -agentlib:jdwp=<span class="built_in">help</span> 和 -agentlib:hprof=<span class="built_in">help</span></span><br><span class="line">    -agentpath:&lt;pathname&gt;[=&lt;选项&gt;]</span><br><span class="line">                  按完整路径名加载本机代理库</span><br><span class="line">    -javaagent:&lt;jarpath&gt;[=&lt;选项&gt;]</span><br><span class="line">                  加载 Java 编程语言代理, 请参阅 java.lang.instrument</span><br><span class="line">    -splash:&lt;imagepath&gt;</span><br><span class="line">                  使用指定的图像显示启动屏幕</span><br><span class="line">有关详细信息, 请参阅 http://www.oracle.com/technetwork/java/javase/documentation/index.html。</span><br></pre></td></tr></table></figure>

<h4 id="Server-模式和-Client-模式"><a href="#Server-模式和-Client-模式" class="headerlink" title="Server 模式和 Client 模式"></a><strong>Server 模式和 Client 模式</strong></h4><p>Hotspot JVM 有两种模式，分别是 server 和 client，分别通过-server 和-client 模式设置</p>
<ul>
<li><p>32 位系统上，默认使用 Client 类型的 JVM。要想使用 Server 模式，机器配置至少有 2 个以上的 CPU 和 2G 以上的物理内存。client 模式适用于对内存要求较小的桌面应用程序，默认使用 Serial 串行垃圾收集器</p>
</li>
<li><p>64 位系统上，只支持 server 模式的 JVM，适用于需要大内存的应用程序，默认使用并行垃圾收集器</p>
<p>C1模式和C2模式，C1模式比较简单运行时间少，C2模式比较复杂运行时间长，但是C2对字节码的优化比较好</p>
</li>
</ul>
<p>官网地址：<a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/8/docs/technotes/guides/vm/server-class.html">https://docs.oracle.com/javase/8/docs/technotes/guides/vm/server-class.html</a></p>
<table>
<thead>
<tr>
<th>Architecture</th>
<th>OS</th>
<th>Default client VM</th>
<th>if server-class, server VM; otherwise, client VM</th>
<th>Default server VM</th>
</tr>
</thead>
<tbody><tr>
<td>SPARC 32-bit</td>
<td>Solaris</td>
<td></td>
<td><strong>X</strong></td>
<td></td>
</tr>
<tr>
<td>i586</td>
<td>Solaris</td>
<td></td>
<td><strong>X</strong></td>
<td></td>
</tr>
<tr>
<td>i586</td>
<td>Linux</td>
<td></td>
<td><strong>X</strong></td>
<td></td>
</tr>
<tr>
<td>i586</td>
<td>Microsoft Windows</td>
<td><strong>X</strong></td>
<td></td>
<td></td>
</tr>
<tr>
<td>SPARC 64-bit</td>
<td>Solaris</td>
<td>—</td>
<td></td>
<td><strong>X</strong></td>
</tr>
<tr>
<td>AMD64</td>
<td>Solaris</td>
<td>—</td>
<td></td>
<td><strong>X</strong></td>
</tr>
<tr>
<td>AMD64</td>
<td>Linux</td>
<td>—</td>
<td></td>
<td><strong>X</strong></td>
</tr>
<tr>
<td>AMD64</td>
<td>Microsoft Windows</td>
<td>—</td>
<td></td>
<td><strong>X</strong></td>
</tr>
</tbody></table>
<p>如何知道系统默认使用的是那种模式呢？</p>
<p>通过 java -version 命令：可以看到 Server VM 字样，代表当前系统使用是 Server 模式</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\Think&gt;java -version</span><br><span class="line">java version <span class="string">&quot;1.8.0_101&quot;</span></span><br><span class="line">Java(TM) SE Runtime Environment (build 1.8.0_101-b13)</span><br><span class="line">Java HotSpot(TM) 64-Bit Server VM (build 25.101-b13, mixed mode)</span><br></pre></td></tr></table></figure>

<h3 id="类型二：-X-参数选项"><a href="#类型二：-X-参数选项" class="headerlink" title="类型二：-X 参数选项"></a>类型二：-X 参数选项</h3><h4 id="特点："><a href="#特点：" class="headerlink" title="特点："></a>特点：</h4><p>非标准化参数</p>
<p>功能还是比较稳定的。但官方说后续版本可能会变更</p>
<p>以-X开头</p>
<h4 id="选项"><a href="#选项" class="headerlink" title="选项"></a>选项</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\Think&gt;java -X</span><br><span class="line">    -Xmixed           混合模式执行 (默认)</span><br><span class="line">    -Xint             仅解释模式执行</span><br><span class="line">    -Xbootclasspath:&lt;用 ; 分隔的目录和 zip/jar 文件&gt;</span><br><span class="line">                      设置搜索路径以引导类和资源</span><br><span class="line">    -Xbootclasspath/a:&lt;用 ; 分隔的目录和 zip/jar 文件&gt;</span><br><span class="line">                      附加在引导类路径末尾</span><br><span class="line">    -Xbootclasspath/p:&lt;用 ; 分隔的目录和 zip/jar 文件&gt;</span><br><span class="line">                      置于引导类路径之前</span><br><span class="line">    -Xdiag            显示附加诊断消息</span><br><span class="line">    -Xnoclassgc       禁用类垃圾收集</span><br><span class="line">    -Xincgc           启用增量垃圾收集</span><br><span class="line">    -Xloggc:&lt;file&gt;    将 GC 状态记录在文件中 (带时间戳)</span><br><span class="line">    -Xbatch           禁用后台编译</span><br><span class="line">    -Xms&lt;size&gt;        设置初始 Java 堆大小</span><br><span class="line">    -Xmx&lt;size&gt;        设置最大 Java 堆大小</span><br><span class="line">    -Xss&lt;size&gt;        设置 Java 线程堆栈大小</span><br><span class="line">    -Xprof            输出 cpu 配置文件数据</span><br><span class="line">    -Xfuture          启用最严格的检查, 预期将来的默认值</span><br><span class="line">    -Xrs              减少 Java/VM 对操作系统信号的使用 (请参阅文档)</span><br><span class="line">    -Xcheck:jni       对 JNI 函数执行其他检查</span><br><span class="line">    -Xshare:off       不尝试使用共享类数据</span><br><span class="line">    -Xshare:auto      在可能的情况下使用共享类数据 (默认)</span><br><span class="line">    -Xshare:on        要求使用共享类数据, 否则将失败。</span><br><span class="line">    -XshowSettings    显示所有设置并继续</span><br><span class="line">    -XshowSettings:all</span><br><span class="line">                      显示所有设置并继续</span><br><span class="line">    -XshowSettings:vm 显示所有与 vm 相关的设置并继续</span><br><span class="line">    -XshowSettings:properties</span><br><span class="line">                      显示所有属性设置并继续</span><br><span class="line">    -XshowSettings:locale</span><br><span class="line">                      显示所有与区域设置相关的设置并继续</span><br><span class="line"></span><br><span class="line">-X 选项是非标准选项, 如有更改, 恕不另行通知。</span><br></pre></td></tr></table></figure>

<p>如何知道 JVM 默认使用的是混合模式呢？</p>
<p>同样地，通过 java -version 命令：可以看到 mixed mode 字样，代表当前系统使用的是混合模式</p>
<h4 id="JVM的JIT编译模式相关的选项"><a href="#JVM的JIT编译模式相关的选项" class="headerlink" title="JVM的JIT编译模式相关的选项"></a>JVM的JIT编译模式相关的选项</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">-Xint			只使用解释器：所有字节码都被解释执行，这个模式的速度是很慢的</span><br><span class="line"></span><br><span class="line">-Xcomp			只使用编译器：所有字节码第一次使用就被编译成本地代码，然后在执行</span><br><span class="line"></span><br><span class="line">-Xmixed			混合模式：这是默认模式，刚开始的时候使用解释器慢慢解释执行，后来让JIT即时编译器根据程序运行的情况，有选择地将某些热点代码提前编译并缓存在本地，在执行的时候效率就非常高了</span><br></pre></td></tr></table></figure>



<h4 id="特别的"><a href="#特别的" class="headerlink" title="特别的"></a>特别的</h4><p>-Xmx -Xms -Xss属于XX参数？</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">-Xms&lt;size&gt;       设置初始Java堆大小，等价于-XX:InitialHeapSize</span><br><span class="line"></span><br><span class="line">-Xmx&lt;size&gt;       设置最大Java堆大小，等价于-XX:MaxHeapSize</span><br><span class="line"></span><br><span class="line">-Xss&lt;size&gt;         设置Java线程堆栈大小，等价于-XX:ThreadStackSize</span><br></pre></td></tr></table></figure>



<h3 id="类型三：-XX-参数选项"><a href="#类型三：-XX-参数选项" class="headerlink" title="类型三：-XX 参数选项"></a>类型三：-XX 参数选项</h3><h4 id="特点-1"><a href="#特点-1" class="headerlink" title="特点"></a>特点</h4><p>非标准化参数</p>
<p>使用的最多的参数类型</p>
<p>这类选项属于实验性，不稳定</p>
<p>以-XX开头</p>
<h4 id="作用-1"><a href="#作用-1" class="headerlink" title="作用"></a>作用</h4><p>用于开发和调试JVM</p>
<h4 id="分类"><a href="#分类" class="headerlink" title="分类"></a>分类</h4><h5 id="Boolean-类型格式"><a href="#Boolean-类型格式" class="headerlink" title="Boolean 类型格式"></a><strong>Boolean 类型格式</strong></h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">-XX:+&lt;option&gt;  启用option属性</span><br><span class="line">-XX:-&lt;option&gt;  禁用option属性</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">-XX:+UseParallelGC           选择垃圾收集器为并行收集器</span><br><span class="line">-XX:+UseG1GC				 表示启用G1收集器</span><br><span class="line">-XX:+UseAdaptiveSizePolicy   自动选择年轻代区大小和相应的Survivor区比例</span><br></pre></td></tr></table></figure>

<p>说明：因为有的指令默认是开启的，所以可以使用-关闭</p>
<h5 id="非-Boolean-类型格式（key-value）"><a href="#非-Boolean-类型格式（key-value）" class="headerlink" title="非 Boolean 类型格式（key value）"></a><strong>非 Boolean 类型格式</strong>（key value）</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-XX:&lt;option&gt;=&lt;number&gt;  设置option数值，可以带单位如k/K/m/M/g/G</span><br></pre></td></tr></table></figure>

<p>number表示数值，number可以带上单位，比如: ‘m’、‘’M’表示兆，‘k ’、’K’表示Kb，’g’、’G’表示g（例如32k跟32768是一样的效果）<br>例如:<br>-XX:NewSize=1024m表示设置新生代初始大小为1024兆</p>
<p>-XX:MaxGCPauseMillis=500表示设置Gc停顿时间:5日0毫秒</p>
<p>-XX:GCTimeRatio=19表示设置吞吐量</p>
<p>-XX:NewRatio=2 表示新生代与老年代的比例</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-XX:&lt;option&gt;=&lt;string&gt;  设置option字符值</span><br></pre></td></tr></table></figure>

<p>-XX:HeapDumpPath=/usr/local/heapdump.hprof         用来指定heap转存文件的存储路径。</p>
<h4 id="特别的-1"><a href="#特别的-1" class="headerlink" title="特别的"></a>特别的</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-XX:+PrintFlagsFinal</span><br></pre></td></tr></table></figure>

<p>输出所有参数的名称和默认值</p>
<p>默认不包括Diagnostic和Experimental的参数</p>
<p>可以配合-XX:+UnlockDiagnosticVMOptions和-XX:UnlockExperimentalVMOptions使用</p>
<h4 id="全部"><a href="#全部" class="headerlink" title="全部"></a>全部</h4><p>==官网地址：==</p>
<p><a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/8/docs/technotes/tools/windows/java.html">https://docs.oracle.com/javase/8/docs/technotes/tools/windows/java.html</a></p>
<p><a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/8/docs/technotes/tools/unix/java.html">https://docs.oracle.com/javase/8/docs/technotes/tools/unix/java.html</a></p>
<h2 id="添加-JVM-参数选项"><a href="#添加-JVM-参数选项" class="headerlink" title="添加 JVM 参数选项"></a>添加 JVM 参数选项</h2><p>idea配置：</p>
<img src="https://img.lvxiaoyi.top/typora-img/image-20211002100529728.png/lvxiaoyi" alt="image-20211002100529728" style="zoom:67%;" />

<p><strong>运行 jar 包</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -Xms100m -Xmx100m -XX:+PrintGCDetails -XX:+PrintGCDateStamps -XX:+PrintGCTimeStamps -jar demo.jar</span><br></pre></td></tr></table></figure>

<p><strong>Tomcat 运行 war 包</strong></p>
<p>Linux系统下可以在tomcat/bin/catalina.sh中添加类似如下配置：JAVA_OPTS=”-Xms512M -Xmx1024M”</p>
<p>Windows系统下载catalina.bat中添加类似如下配置：<br>set “JAVA_OPTS=-Xms512M -Xmx1024M”</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># linux下catalina.sh添加</span></span><br><span class="line">JAVA_OPTS=<span class="string">&quot;-Xms512M -Xmx1024M&quot;</span></span><br><span class="line"><span class="comment"># windows下catalina.bat添加</span></span><br><span class="line"><span class="built_in">set</span> <span class="string">&quot;JAVA_OPTS=-Xms512M -Xmx1024M&quot;</span></span><br></pre></td></tr></table></figure>

<p><strong>程序运行中</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 设置Boolean类型参数</span></span><br><span class="line">jinfo -flag [+|-]&lt;name&gt; &lt;pid&gt;</span><br><span class="line"><span class="comment"># 设置非Boolean类型参数</span></span><br><span class="line">jinfo -flag &lt;name&gt;=&lt;value&gt; &lt;pid&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\Think&gt;jps</span><br><span class="line">27968 Jps</span><br><span class="line">33616 Eclipse</span><br><span class="line">13780 OOMTest</span><br><span class="line">6628 KotlinCompileDaemon</span><br><span class="line">31608 Launcher</span><br><span class="line">39784</span><br><span class="line"></span><br><span class="line">C:\Users\Think&gt;jinfo -flag InitialHeapSize 13780</span><br><span class="line">-XX:InitialHeapSize=629145600</span><br><span class="line"></span><br><span class="line">C:\Users\Think&gt;jinfo -flag MaxHeapSize 13780</span><br><span class="line">-XX:MaxHeapSize=629145600</span><br><span class="line"></span><br><span class="line">C:\Users\Think&gt;jinfo -flag MaxHeapSize=14780 13780</span><br><span class="line">Exception <span class="keyword">in</span> thread <span class="string">&quot;main&quot;</span> com.sun.tools.attach.AttachOperationFailedException: flag <span class="string">&#x27;MaxHeapSize&#x27;</span> cannot be changed</span><br><span class="line"></span><br><span class="line">        at sun.tools.attach.WindowsVirtualMachine.execute(WindowsVirtualMachine.java:117)</span><br><span class="line">        at sun.tools.attach.HotSpotVirtualMachine.executeCommand(HotSpotVirtualMachine.java:261)</span><br><span class="line">        at sun.tools.attach.HotSpotVirtualMachine.setFlag(HotSpotVirtualMachine.java:234)</span><br><span class="line">        at sun.tools.jinfo.JInfo.flag(JInfo.java:134)</span><br><span class="line">        at sun.tools.jinfo.JInfo.main(JInfo.java:81)</span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line">C:\Users\Think&gt;jinfo -flag HeapDumpAfterFullGC 13780</span><br><span class="line">-XX:-HeapDumpAfterFullGC</span><br><span class="line"></span><br><span class="line">C:\Users\Think&gt;jinfo -flag +HeapDumpAfterFullGC 13780</span><br><span class="line"></span><br><span class="line">C:\Users\Think&gt;jinfo -flag HeapDumpAfterFullGC 13780</span><br><span class="line">-XX:+HeapDumpAfterFullGC</span><br></pre></td></tr></table></figure>



<h2 id="常用的-JVM-参数选项"><a href="#常用的-JVM-参数选项" class="headerlink" title="常用的 JVM 参数选项"></a>常用的 JVM 参数选项</h2><h3 id="打印设置的-XX-选项及值"><a href="#打印设置的-XX-选项及值" class="headerlink" title="打印设置的 XX 选项及值"></a>打印设置的 XX 选项及值</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">-XX:+PrintCommandLineFlags 程序运行时JVM默认设置或用户手动设置的XX选项</span><br><span class="line">-XX:+PrintFlagsInitial 打印所有XX选项的默认值</span><br><span class="line">-XX:+PrintFlagsFinal 打印所有XX选项的实际值</span><br><span class="line">-XX:+PrintVMOptions 打印JVM的参数</span><br></pre></td></tr></table></figure>

<h3 id="堆、栈、方法区等内存大小设置"><a href="#堆、栈、方法区等内存大小设置" class="headerlink" title="堆、栈、方法区等内存大小设置"></a>堆、栈、方法区等内存大小设置</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 栈</span></span><br><span class="line">-Xss128k &lt;==&gt; -XX:ThreadStackSize=128k 设置线程栈的大小为128K</span><br><span class="line"></span><br><span class="line"><span class="comment"># 堆</span></span><br><span class="line">-Xms2048m &lt;==&gt; -XX:InitialHeapSize=2048m 设置JVM初始堆内存为2048M，默认为内存的1/64</span><br><span class="line">-Xmx2048m &lt;==&gt; -XX:MaxHeapSize=2048m 设置JVM最大堆内存为2048M，默认为内存的1/4</span><br><span class="line">-Xmn2g &lt;==&gt; -XX:NewSize=2g -XX:MaxNewSize=2g 设置年轻代大小为2G</span><br><span class="line">-XX:SurvivorRatio=8 设置Eden区与Survivor区的比值，默认为8</span><br><span class="line">-XX:NewRatio=2 设置老年代与年轻代的比例，默认为2</span><br><span class="line">-XX:+UseAdaptiveSizePolicy 设置大小比例自适应，默认开启，默认自适应（6:1:1）后SurvivorRatio就会失效</span><br><span class="line">-XX:PretenureSizeThreadshold=1024 设置让大于此阈值的对象直接分配在老年代，只对Serial、ParNew收集器有效</span><br><span class="line">-XX:MaxTenuringThreshold=15 设置新生代晋升老年代的年龄限制，默认为15</span><br><span class="line">-XX:TargetSurvivorRatio 设置MinorGC结束后Survivor区占用空间的期望比例</span><br><span class="line"></span><br><span class="line"><span class="comment"># 方法区</span></span><br><span class="line">-XX:MetaspaceSize / -XX:PermSize=256m 设置元空间/永久代初始值为256M</span><br><span class="line">-XX:MaxMetaspaceSize / -XX:MaxPermSize=256m 设置元空间/永久代最大值为256M</span><br><span class="line">-XX:+UseCompressedOops 使用压缩对象</span><br><span class="line">-XX:+UseCompressedClassPointers 使用压缩类指针</span><br><span class="line">-XX:CompressedClassSpaceSize 设置Klass Metaspace的大小，默认1G</span><br><span class="line"></span><br><span class="line"><span class="comment"># 直接内存</span></span><br><span class="line">-XX:MaxDirectMemorySize 指定DirectMemory容量，默认等于Java堆最大值</span><br></pre></td></tr></table></figure>

<h3 id="OutOfMemory-相关的选项"><a href="#OutOfMemory-相关的选项" class="headerlink" title="OutOfMemory 相关的选项"></a>OutOfMemory 相关的选项</h3><p>-XX:+HeapDumpOnOutMemoryError(在出现OOM的时候生成dump文件)和-XX:+HeapDumpBeforeFullGC(在出现Full GC的时候生成dump文件)只能设置1个，如果不没置<code>-XX:HeapDumpPath=&lt;path&gt;</code>，那么将会在当前目录下生成dump文件，如果设置的话，将会在指定位置生成dump文件</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">-XX:+HeapDumpOnOutMemoryError 	内存出现OOM时生成Heap转储文件，两者互斥</span><br><span class="line">-XX:+HeapDumpBeforeFullGC 		出现FullGC时生成Heap转储文件，两者互斥</span><br><span class="line"></span><br><span class="line">-XX:HeapDumpPath=&lt;path&gt; 		指定heap转储文件的存储路径，默认当前目录</span><br><span class="line">-XX:OnOutOfMemoryError=&lt;path&gt; 	指定可行性程序或脚本的路径，当发生OOM时执行脚本</span><br></pre></td></tr></table></figure>



<p>对OnoutOfMemoryError的运维处理：</p>
<p>以部署在linux系统/opt/Server目录下的Server.jar为例</p>
<ol>
<li>在run.sh启动脚本中添加jvm参数:</li>
</ol>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-XX:OnOutOfMemoryError=/opt/Server/restart.sh</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>restart.sh脚本</li>
<li>linux环境：</li>
</ol>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">pid=$(ps -ef|grep Server.jar|awk <span class="string">&#x27;&#123;if($8==&quot;java&quot;) &#123;print $2&#125;&#125;&#x27;</span>)</span><br><span class="line"><span class="built_in">kill</span> -9 <span class="variable">$pid</span></span><br><span class="line"><span class="built_in">cd</span> /opt/Server/</span><br><span class="line">sh run.sh</span><br></pre></td></tr></table></figure>

<p>windows环境:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> off</span><br><span class="line">wmic process <span class="built_in">where</span> Name=<span class="string">&#x27;java.exe&#x27;</span> delete</span><br><span class="line"><span class="built_in">cd</span> D:\Server</span><br><span class="line">start run.bat</span><br></pre></td></tr></table></figure>



<h3 id="垃圾收集器相关选项"><a href="#垃圾收集器相关选项" class="headerlink" title="垃圾收集器相关选项"></a>垃圾收集器相关选项</h3><p>首先需了解垃圾收集器之间的搭配使用关系</p>
<ul>
<li>红色虚线表示在 jdk8 时被 Deprecate，jdk9 时被删除</li>
<li>绿色虚线表示在 jdk14 时被 Deprecate</li>
<li>绿色虚框表示在 jdk9 时被 Deprecate，jdk14 时被删除</li>
</ul>
<p><img src="https://img-blog.csdnimg.cn/img_convert/46dec5b346fcc5b147491481787ea8ec.png" alt="image-20210506182458663"></p>
<h4 id="查看默认垃圾回收器"><a href="#查看默认垃圾回收器" class="headerlink" title="查看默认垃圾回收器"></a>查看默认垃圾回收器</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">-XX:+PrintCommandLineFlags 			查看命令行相关参数（包含使用的垃圾收集器)</span><br><span class="line"></span><br><span class="line">jinfo -flag 相关垃圾回收器参数  进程ID  使用命令行指令</span><br></pre></td></tr></table></figure>

<p>以上两种方式都可以查看默认使用的垃圾回收器，第一种方式更加准备，但是需要程序的支持；第二种方式需要去尝试，如果使用了，返回的值中有+号，否则就是-号</p>
<h4 id="Serial回收器"><a href="#Serial回收器" class="headerlink" title="Serial回收器"></a>Serial回收器</h4><p>SeriaI收集器作为HotSpot中client模式下的默认新生代垃圾收集器。Serial old是运行在client模式下默认的老年代的垃圾回收器。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Serial回收器</span></span><br><span class="line">-XX:+UseSerialGC  年轻代使用Serial GC， 老年代使用Serial Old GC</span><br></pre></td></tr></table></figure>

<p>指定年轻代和老年代都使用串行收集器。等价于新生代用Serial GC，且老年代用Serial old GC。可以获得最高的单线程收集效率。</p>
<h4 id="ParNew回收器"><a href="#ParNew回收器" class="headerlink" title="ParNew回收器"></a>ParNew回收器</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-XX:+UseParNewGC</span><br></pre></td></tr></table></figure>

<p>手动指定使用ParNew收集器执行内存回收任务。它表示年轻代使用并行收集器，不影响老年代。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-XX:ParallelGCThreads=N</span><br></pre></td></tr></table></figure>

<p>设置年轻代并行收集器的线程数。一般地，最好与CPU数量相等，以避免过多的线程数影响垃圾收集性能。</p>
<ul>
<li>在默认情况下，当CPU 数量小于8个，ParallelGCThreads 的值等于CPU 数量。</li>
<li>当CPU数量大于8个，ParallelGCThreads 的值等于3+[5*CPu_Count]/8]。</li>
</ul>
<p>在jdk14后，ParNew没有组合关系，相当于被废弃了，但是jdk14之前还能继续使用</p>
<h4 id="Parallel回收器"><a href="#Parallel回收器" class="headerlink" title="Parallel回收器"></a>Parallel回收器</h4><p>==吞吐量优先，主打服务器端==</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-XX:+UseParallelGC</span><br></pre></td></tr></table></figure>

<p>年轻代使用 Parallel Scavenge GC，互相激活</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-XX:+UseParallelOldGC</span><br></pre></td></tr></table></figure>

<p>老年代使用 Parallel Old GC，互相激活</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-XX:ParallelGCThreads</span><br></pre></td></tr></table></figure>

<p>设置年轻代并行收集器的线程数。一般地，最好与CPU数量相等，以避免过多的线程数影响垃圾收集性能。<br>    * 在默认情况下，当CPU 数量小于8个，ParallelGCThreads 的值等于CPU 数量。<br>    * 当CPU数量大于8个，ParallelGCThreads 的值等于3+[5*CPu_Count]/8]。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-XX:MaxGCPauseMillis</span><br></pre></td></tr></table></figure>

<p>设置垃圾收集器最大停顿时间（即STW的时间），单位是毫秒。</p>
<ul>
<li>为了尽可能地把停顿时间控制在MaxGCPauseMills以内，收集器在工作时会调整Java堆大小或者其他一些参数。</li>
<li>对于用户来讲，停顿时间越短体验越好；但是服务器端注重高并发，整体的吞吐量。</li>
<li>所以服务器端适合Parallel，进行控制。</li>
<li>==该参数使用需谨慎==</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-XX:GCTimeRatio</span><br></pre></td></tr></table></figure>

<p> 垃圾收集时间占总时间的比例（1 / (N＋1)），用于衡量吞吐量的大小<br>    * 取值范围（0,100），默认值99，也就是垃圾回收时间不超过1％。<br>    * 与前一个<code>-XX:MaxGCPauseMillis</code>参数有一定矛盾性。暂停时间越长，Radio参数就容易超过设定的比例。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-XX:+UseAdaptiveSizePolicy</span><br></pre></td></tr></table></figure>

<p>设置Parallel Scavenge收集器具有自适应调节策略。</p>
<pre><code>* 在这种模式下，年轻代的大小、Eden和Survivor的比例、晋升老年代的对象年龄等参数会被自动调整，以达到在堆大小、吞吐量和停顿时间之间的平衡点。
* 在手动调优比较困难的场合，可以直接使用这种自适应的方式，仅指定虚拟机的最大堆、目标的吞吐量（GCTimeRatio）和停顿时间（MaxGCPauseMills），让虚拟机自己完成调优工作。
</code></pre>
<h4 id="CMS回收器"><a href="#CMS回收器" class="headerlink" title="CMS回收器"></a>CMS回收器</h4><p> 年轻代使用CMS GC。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-XX:+UseConcMarkSweepGC</span><br></pre></td></tr></table></figure>

<p>手动指定使用CMS收集器执行内存回收任务</p>
<p>​    * 开启该参数后会自动将<code>-XX:+UseParNewGC</code>打开。即：ParNew（Young区）+ CMS（Old区）+ Serial Old的组合</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-XX:CMSInitiatingOccupanyFraction  </span><br></pre></td></tr></table></figure>

<p>设置堆内存使用率的阈值，一旦达到该阈值，便开始进行回收。</p>
<ul>
<li>JDK5及以前版本的默认值为68，DK6及以上版本默认值为92％。</li>
<li>如果内存增长缓慢，则可以设置一个稍大的值，大的阈值可以有效降低CMS的触发频率，减少老年代回收的次数可以较为明显地改善应用程序性能。反之，如果应用程序内存使用率增长很快，则应该降低这个阈值，以避免频繁触发老年代串行收集器。因此通过该选项便可以有效降低FullGC的执行次数。</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-XX:+UseCMSInitiatingOccupancyOnly</span><br></pre></td></tr></table></figure>

<p>是否动态可调，使CMS一直按CMSInitiatingOccupancyFraction设定的值启动</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-XX:+UseCMSCompactAtFullCollection</span><br></pre></td></tr></table></figure>

<p> 用于指定在执行完Full GC后对内存空间进行压缩整理，以此避免内存碎片的产生。不过由于内存压缩整理过程无法并发执行，所带来的问题就是停顿时间变得更长了。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-XX:CMSFullGCsBeforeCompaction</span><br></pre></td></tr></table></figure>

<p>设置在执行多少次Full GC后对内存空间进行压缩整理。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-XX:ParallelCMSThreads</span><br></pre></td></tr></table></figure>

<p>设置CMS的线程数量。</p>
<pre><code>* CMS 默认启动的线程数是(ParallelGCThreads＋3)/4，ParallelGCThreads 是年轻代并行收集器的线程数。
* 当CPU 资源比较紧张时，受到CMS收集器线程的影响，应用程序的性能在垃圾回收阶段可能会非常糟糕。
</code></pre>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-XX:ConcGCThreads</span><br></pre></td></tr></table></figure>

<p> 设置并发垃圾收集的线程数，默认该值是基于ParallelGCThreads计算出来的</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-XX:+CMSScavengeBeforeRemark</span><br></pre></td></tr></table></figure>

<p>强制hotspot在cms remark阶段之前做一次minor gc，用于提高remark阶段的速度</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-XX:+CMSClassUnloadingEnable</span><br></pre></td></tr></table></figure>

<p>如果有的话，启用回收Perm 区（JDK8之前）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-XX:+CMSParallelInitialEnabled</span><br></pre></td></tr></table></figure>

<p>用于开启CMS initial-mark阶段采用多线程的方式进行标记</p>
<ul>
<li>用于提高标记速度，在Java8开始已经默认开启</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># CMS回收器</span></span><br><span class="line">  </span><br><span class="line">  用于开启CMS initial-mark阶段采用多线程的方式进行标记</span><br><span class="line">	用于提高标记速度，在Java8开始已经默认开启</span><br><span class="line">-XX:+CMSParallelRemarkEnabled  用户开启CMS remark阶段采用多线程的方式进行重新标记，默认开启</span><br><span class="line">-XX:+ExplicitGCInvokesConcurrent</span><br><span class="line">-XX:+ExplicitGCInvokesConcurrentAndUnloadsClasses</span><br><span class="line">	这两个参数用户指定hotspot虚拟在执行System.gc()时使用CMS周期</span><br><span class="line">-XX:+CMSPrecleaningEnabled  指定CMS是否需要进行Pre cleaning阶段</span><br></pre></td></tr></table></figure>

<p>-XX:ParallelCMSThreads和ParallelGCThreads有关系，ParallelGCThreads在上面Parnew回收器中有提到</p>
<h4 id="G1回收器"><a href="#G1回收器" class="headerlink" title="G1回收器"></a>G1回收器</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># G1回收器</span></span><br><span class="line">-XX:+UseG1GC 手动指定使用G1收集器执行内存回收任务。</span><br><span class="line">-XX:G1HeapRegionSize 设置每个Region的大小。</span><br><span class="line">	值是2的幂，范围是1MB到32MB之间，目标是根据最小的Java堆大小划分出约2048个区域。默认是堆内存的1/2000。</span><br><span class="line">-XX:MaxGCPauseMillis  设置期望达到的最大GC停顿时间指标（JVM会尽力实现，但不保证达到）。默认值是200ms</span><br><span class="line">-XX:ParallelGCThread  设置STW时GC线程数的值。最多设置为8</span><br><span class="line">-XX:ConcGCThreads  设置并发标记的线程数。将n设置为并行垃圾回收线程数（ParallelGCThreads）的1/4左右。</span><br><span class="line">-XX:InitiatingHeapOccupancyPercent 设置触发并发GC周期的Java堆占用率阈值。超过此值，就触发GC。默认值是45。</span><br><span class="line">-XX:G1NewSizePercent  新生代占用整个堆内存的最小百分比（默认5％）</span><br><span class="line">-XX:G1MaxNewSizePercent  新生代占用整个堆内存的最大百分比（默认60％）</span><br><span class="line">-XX:G1ReservePercent=10  保留内存区域，防止 to space（Survivor中的to区）溢出</span><br></pre></td></tr></table></figure>

<h4 id="怎么选择"><a href="#怎么选择" class="headerlink" title="怎么选择"></a>怎么选择</h4><ul>
<li>优先让 JVM 自适应，调整堆的大小</li>
<li>串行收集器：内存小于 100M；单核、单机程序，并且没有停顿时间的要求</li>
<li>并行收集器：多 CPU、高吞吐量、允许停顿时间超过 1 秒</li>
<li>并发收集器：多 CPU、追求低停顿时间、快速响应（比如延迟不能超过 1 秒，如互联网应用）</li>
<li>官方推荐 G1，性能高。现在互联网的项目，基本都是使用 G1</li>
</ul>
<p>特别说明：</p>
<ul>
<li>没有最好的收集器，更没有万能的收集器</li>
<li>调优永远是针对特定场景、特定需求，不存在一劳永逸的收集器</li>
</ul>
<h3 id="GC-日志相关选项"><a href="#GC-日志相关选项" class="headerlink" title="GC 日志相关选项"></a>GC 日志相关选项</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">-XX:+PrintGC &lt;==&gt; -verbose:gc  打印简要日志信息</span><br><span class="line">-XX:+PrintGCDetails            打印详细日志信息</span><br><span class="line">-XX:+PrintGCTimeStamps  打印程序启动到GC发生的时间，搭配-XX:+PrintGCDetails使用</span><br><span class="line">-XX:+PrintGCDateStamps  打印GC发生时的时间戳，搭配-XX:+PrintGCDetails使用</span><br><span class="line">-XX:+PrintHeapAtGC  打印GC前后的堆信息，如下图</span><br><span class="line">-Xloggc:&lt;file&gt; 输出GC导指定路径下的文件中</span><br></pre></td></tr></table></figure>

<p><img src="https://img-blog.csdnimg.cn/img_convert/9f323dd9b55235ed0a33e6a0af8adbca.png" alt="image-20210506195156935"></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">-XX:+TraceClassLoading  监控类的加载</span><br><span class="line">-XX:+PrintGCApplicationStoppedTime  打印GC时线程的停顿时间</span><br><span class="line">-XX:+PrintGCApplicationConcurrentTime  打印垃圾收集之前应用未中断的执行时间</span><br><span class="line">-XX:+PrintReferenceGC 打印回收了多少种不同引用类型的引用</span><br><span class="line">-XX:+PrintTenuringDistribution  打印JVM在每次MinorGC后当前使用的Survivor中对象的年龄分布</span><br><span class="line">-XX:+UseGCLogFileRotation 启用GC日志文件的自动转储</span><br><span class="line">-XX:NumberOfGCLogFiles=1  设置GC日志文件的循环数目</span><br><span class="line">-XX:GCLogFileSize=1M  设置GC日志文件的大小</span><br></pre></td></tr></table></figure>

<h3 id="其他参数"><a href="#其他参数" class="headerlink" title="其他参数"></a>其他参数</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">-XX:+DisableExplicitGC  禁用hotspot执行System.gc()，默认禁用</span><br><span class="line">-XX:ReservedCodeCacheSize=&lt;n&gt;[g|m|k]、-XX:InitialCodeCacheSize=&lt;n&gt;[g|m|k]  指定代码缓存的大小</span><br><span class="line">-XX:+UseCodeCacheFlushing  放弃一些被编译的代码，避免代码缓存被占满时JVM切换到interpreted-only的情况</span><br><span class="line">-XX:+DoEscapeAnalysis  开启逃逸分析</span><br><span class="line">-XX:+UseBiasedLocking  开启偏向锁</span><br><span class="line">-XX:+UseLargePages  开启使用大页面</span><br><span class="line">-XX:+PrintTLAB  打印TLAB的使用情况</span><br><span class="line">-XX:TLABSize  设置TLAB大小</span><br></pre></td></tr></table></figure>

<h2 id="通过-Java-代码获取-JVM-参数"><a href="#通过-Java-代码获取-JVM-参数" class="headerlink" title="通过 Java 代码获取 JVM 参数"></a>通过 Java 代码获取 JVM 参数</h2><p>Java 提供了 java.lang.management 包用于监视和管理 Java 虚拟机和 Java 运行时中的其他组件，它允许本地或远程监控和管理运行的 Java 虚拟机。其中 ManagementFactory 类较为常用，另外 Runtime 类可获取内存、CPU 核数等相关的数据。通过使用这些 api，可以监控应用服务器的堆内存使用情况，设置一些阈值进行报警等处理。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">public class MemoryMonitor &#123;</span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        MemoryMXBean memorymbean = ManagementFactory.getMemoryMXBean();</span><br><span class="line">        MemoryUsage usage = memorymbean.getHeapMemoryUsage();</span><br><span class="line">        System.out.println(<span class="string">&quot;INIT HEAP: &quot;</span> + usage.getInit() / 1024 / 1024 + <span class="string">&quot;m&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;MAX HEAP: &quot;</span> + usage.getMax() / 1024 / 1024 + <span class="string">&quot;m&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;USE HEAP: &quot;</span> + usage.getUsed() / 1024 / 1024 + <span class="string">&quot;m&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;\nFull Information:&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;Heap Memory Usage: &quot;</span> + memorymbean.getHeapMemoryUsage());</span><br><span class="line">        System.out.println(<span class="string">&quot;Non-Heap Memory Usage: &quot;</span> + memorymbean.getNonHeapMemoryUsage());</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;=======================通过java来获取相关系统状态============================ &quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;当前堆内存大小totalMemory &quot;</span> + (int) Runtime.getRuntime().totalMemory() / 1024 / 1024 + <span class="string">&quot;m&quot;</span>);// 当前堆内存大小</span><br><span class="line">        System.out.println(<span class="string">&quot;空闲堆内存大小freeMemory &quot;</span> + (int) Runtime.getRuntime().freeMemory() / 1024 / 1024 + <span class="string">&quot;m&quot;</span>);// 空闲堆内存大小</span><br><span class="line">        System.out.println(<span class="string">&quot;最大可用总堆内存maxMemory &quot;</span> + Runtime.getRuntime().maxMemory() / 1024 / 1024 + <span class="string">&quot;m&quot;</span>);// 最大可用总堆内存大小</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="分析-GC-日志"><a href="#分析-GC-日志" class="headerlink" title="分析 GC 日志"></a>分析 GC 日志</h1><h2 id="GC-分类"><a href="#GC-分类" class="headerlink" title="GC 分类"></a>GC 分类</h2><p>针对 HotSpot VM 的实现，它里面的 GC 按照回收区域又分为两大种类型：一种是部分收集（Partial GC），一种是整堆收集（Full GC）</p>
<ul>
<li>部分收集（Partial GC）：不是完整收集整个 Java 堆的垃圾收集。其中又分为：<ul>
<li>新生代收集（Minor GC / Young GC）：只是新生代（Eden / S0, S1）的垃圾收集</li>
<li>老年代收集（Major GC / Old GC）：只是老年代的垃圾收集。目前，只有 CMS GC 会有单独收集老年代的行为。注意，很多时候 Major GC 会和 Full GC 混淆使用，需要具体分辨是老年代回收还是整堆回收。</li>
</ul>
</li>
<li>混合收集（Mixed GC）：收集整个新生代以及部分老年代的垃圾收集。目前，只有 G1 GC 会有这种行为</li>
<li>整堆收集（Full GC）：收集整个 java 堆和方法区的垃圾收集。</li>
</ul>
<h2 id="GC-日志分类"><a href="#GC-日志分类" class="headerlink" title="GC 日志分类"></a>GC 日志分类</h2><p><strong>MinorGC</strong></p>
<p>MinorGC（或 young GC 或 YGC）日志：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[GC (Allocation Failure) [PSYoungGen: 31744K-&gt;2192K (36864K) ] 31744K-&gt;2200K (121856K), 0.0139308 secs] [Times: user=0.05 sys=0.01, real=0.01 secs]</span><br></pre></td></tr></table></figure>

<p><img src="https://img-blog.csdnimg.cn/img_convert/df81757685ca21a927d9335273f561c5.png" alt="image-20210506202126562"></p>
<p><img src="https://img-blog.csdnimg.cn/img_convert/b9a7575380bcdb91b54c0556557d8ad9.png" alt="image-20210506202156090"></p>
<p><strong>FullGC</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[Full GC (Metadata GC Threshold) [PSYoungGen: 5104K-&gt;0K (132096K) ] [Par01dGen: 416K-&gt;5453K (50176K) ]5520K-&gt;5453K (182272K), [Metaspace: 20637K-&gt;20637K (1067008K) ], 0.0245883 secs] [Times: user=0.06 sys=0.00, real=0.02 secs]</span><br></pre></td></tr></table></figure>

<p><img src="https://img-blog.csdnimg.cn/img_convert/0dcb239f0928bc374ac1b376b4189295.png" alt="image-20210506202330868"></p>
<p><img src="https://img-blog.csdnimg.cn/img_convert/7817f28a52c836d5ed08a4b992823f64.png" alt="image-20210506202349072"></p>
<h2 id="GC-日志结构剖析"><a href="#GC-日志结构剖析" class="headerlink" title="GC 日志结构剖析"></a>GC 日志结构剖析</h2><p><strong>透过日志看垃圾收集器</strong></p>
<ul>
<li>Serial 收集器：新生代显示 “[DefNew”，即 Default New Generation</li>
<li>ParNew 收集器：新生代显示 “[ParNew”，即 Parallel New Generation</li>
<li>Parallel Scavenge 收集器：新生代显示”[PSYoungGen”，JDK1.7 使用的即 PSYoungGen</li>
<li>Parallel Old 收集器：老年代显示”[ParoldGen”</li>
<li>G1 收集器：显示”garbage-first heap“</li>
</ul>
<p><strong>透过日志看 GC 原因</strong></p>
<ul>
<li>Allocation Failure：表明本次引起 GC 的原因是因为新生代中没有足够的区域存放需要分配的数据</li>
<li>Metadata GCThreshold：Metaspace 区不够用了</li>
<li>FErgonomics：JVM 自适应调整导致的 GC</li>
<li>System：调用了 System.gc()方法</li>
</ul>
<p><strong>透过日志看 GC 前后情况</strong></p>
<p>通过图示，我们可以发现 GC 日志格式的规律一般都是：GC 前内存占用-＞ GC 后内存占用（该区域内存总大小）</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[PSYoungGen: 5986K-&gt;696K (8704K) ] 5986K-&gt;704K (9216K)</span><br></pre></td></tr></table></figure>

<ul>
<li>中括号内：GC 回收前年轻代堆大小，回收后大小，（年轻代堆总大小）</li>
<li>括号外：GC 回收前年轻代和老年代大小，回收后大小，（年轻代和老年代总大小）</li>
</ul>
<p>注意：Minor GC 堆内存总容量 = 9/10 年轻代 + 老年代。原因是 Survivor 区只计算 from 部分，而 JVM 默认年轻代中 Eden 区和 Survivor 区的比例关系，Eden:S0:S1=8:1:1。</p>
<p><strong>透过日志看 GC 时间</strong></p>
<p>GC 日志中有三个时间：user，sys 和 real</p>
<ul>
<li>user：进程执行用户态代码（核心之外）所使用的时间。这是执行此进程所使用的实际 CPU 时间，其他进程和此进程阻塞的时间并不包括在内。在垃圾收集的情况下，表示 GC 线程执行所使用的 CPU 总时间。</li>
<li>sys：进程在内核态消耗的 CPU 时间，即在内核执行系统调用或等待系统事件所使用的 CPU 时间</li>
<li>real：程序从开始到结束所用的时钟时间。这个时间包括其他进程使用的时间片和进程阻塞的时间（比如等待 I/O 完成）。对于并行 gc，这个数字应该接近（用户时间＋系统时间）除以垃圾收集器使用的线程数。</li>
</ul>
<p>由于多核的原因，一般的 GC 事件中，real time 是小于 sys time ＋ user time 的，因为一般是多个线程并发的去做 GC，所以 real time 是要小于 sys ＋ user time 的。如果 real ＞ sys ＋ user 的话，则你的应用可能存在下列问题：IO 负载非常重或 CPU 不够用。</p>
<h2 id="GC-日志分析工具"><a href="#GC-日志分析工具" class="headerlink" title="GC 日志分析工具"></a>GC 日志分析工具</h2><p><strong>GCEasy</strong></p>
<p>GCEasy 是一款在线的 GC 日志分析器，可以通过 GC 日志分析进行内存泄露检测、GC 暂停原因分析、JVM 配置建议优化等功能，大多数功能是免费的。</p>
<p>官网地址：<a target="_blank" rel="noopener" href="https://gceasy.io/">https://gceasy.io/</a></p>
<p><strong>GCViewer</strong></p>
<p>GCViewer 是一款离线的 GC 日志分析器，用于可视化 Java VM 选项 -verbose:gc 和 .NET 生成的数据 -Xloggc:<file>。还可以计算与垃圾回收相关的性能指标（吞吐量、累积的暂停、最长的暂停等）。当通过更改世代大小或设置初始堆大小来调整特定应用程序的垃圾回收时，此功能非常有用。</p>
<p>源码下载：<a target="_blank" rel="noopener" href="https://github.com/chewiebug/GCViewer">https://github.com/chewiebug/GCViewer</a></p>
<p>运行版本下载：<a target="_blank" rel="noopener" href="https://github.com/chewiebug/GCViewer/wiki/Changelog">https://github.com/chewiebug/GCViewer/wiki/Changelog</a></p>
<p><strong>GChisto</strong></p>
<ul>
<li>官网上没有下载的地方，需要自己从 SVN 上拉下来编译</li>
<li>不过这个工具似乎没怎么维护了，存在不少 bug</li>
</ul>
<p><strong>HPjmeter</strong></p>
<ul>
<li>工具很强大，但是只能打开由以下参数生成的 GC log，-verbose:gc -Xloggc:gc.log。添加其他参数生成的 gc.log 无法打开</li>
<li>HPjmeter 集成了以前的 HPjtune 功能，可以分析在 HP 机器上产生的垃圾回收日志文件</li>
</ul>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="https://lvxiaoyi.top">lvxiaoyi</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://lvxiaoyi.top/6197d47a.html">https://lvxiaoyi.top/6197d47a.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://lvxiaoyi.top" target="_blank">吕小医's BLOG</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/jvm/">jvm</a></div><div class="post_share"><div class="social-share" data-image="https://img.lvxiaoyi.top/typora-img/202111011421399.jpeg/lvxiaoyi" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2134a338.html"><img class="prev-cover" src="https://img.lvxiaoyi.top/typora-img/image-20210913142135732.png/lvxiaoyi" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">源码级别理解java拆箱装箱过程</div></div></a></div><div class="next-post pull-right"><a href="/9f1e208e.html"><img class="next-cover" src="https://img.lvxiaoyi.top/typora-img/202111011421399.jpeg/lvxiaoyi" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">jvm基础2之字节码与类的加载篇</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/127ae04f.html" title="Jvm基础4之案例篇"><img class="cover" src="https://img.lvxiaoyi.top/typora-img/202111011421399.jpeg/lvxiaoyi" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-09-12</div><div class="title">Jvm基础4之案例篇</div></div></a></div><div><a href="/dd88deb1.html" title="前端编译器和后端编译器"><img class="cover" src="https://pic2.zhimg.com/v2-9964d2894516902605191817111ec781_r.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-09-12</div><div class="title">前端编译器和后端编译器</div></div></a></div><div><a href="/561c47f9.html" title="jvm中对象的内存布局"><img class="cover" src="https://img.lvxiaoyi.top/typora-img/202111011413329.png/lvxiaoyi" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-09-12</div><div class="title">jvm中对象的内存布局</div></div></a></div><div><a href="/9f1e208e.html" title="jvm基础2之字节码与类的加载篇"><img class="cover" src="https://img.lvxiaoyi.top/typora-img/202111011421399.jpeg/lvxiaoyi" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-09-12</div><div class="title">jvm基础2之字节码与类的加载篇</div></div></a></div><div><a href="/539b1196.html" title="jvm基础1之内存与垃圾回收篇"><img class="cover" src="https://img.lvxiaoyi.top/typora-img/202111011421399.jpeg/lvxiaoyi" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-09-12</div><div class="title">jvm基础1之内存与垃圾回收篇</div></div></a></div><div><a href="/2134a338.html" title="源码级别理解java拆箱装箱过程"><img class="cover" src="https://img.lvxiaoyi.top/typora-img/image-20210913142135732.png/lvxiaoyi" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-09-12</div><div class="title">源码级别理解java拆箱装箱过程</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://p0.meituan.net/csc/8a1b1d488e6a8ab5108c9c78f36b3a1776955.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">lvxiaoyi</div><div class="author-info__description">ISFP到ESFJ</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">204</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">26</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">50</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#jvm%E5%9F%BA%E7%A1%803%E4%B9%8B%E6%80%A7%E8%83%BD%E7%9B%91%E6%8E%A7%E4%B8%8E%E8%B0%83%E4%BC%98%E7%AF%87"><span class="toc-number">1.</span> <span class="toc-text">jvm基础3之性能监控与调优篇</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%A6%82%E8%BF%B0%E7%AF%87"><span class="toc-number">2.</span> <span class="toc-text">概述篇</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A4%A7%E5%8E%82%E9%9D%A2%E8%AF%95%E9%A2%98"><span class="toc-number">2.1.</span> <span class="toc-text">大厂面试题</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%83%8C%E6%99%AF%E8%AF%B4%E6%98%8E"><span class="toc-number">2.2.</span> <span class="toc-text">背景说明</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%9F%E4%BA%A7%E7%8E%AF%E5%A2%83%E4%B8%AD%E7%9A%84%E9%97%AE%E9%A2%98"><span class="toc-number">2.2.1.</span> <span class="toc-text">生产环境中的问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E8%B0%83%E4%BC%98"><span class="toc-number">2.2.2.</span> <span class="toc-text">为什么要调优</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%8D%E5%90%8C%E9%98%B6%E6%AE%B5%E7%9A%84%E8%80%83%E8%99%91"><span class="toc-number">2.2.3.</span> <span class="toc-text">不同阶段的考虑</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B0%83%E4%BC%98%E6%A6%82%E8%BF%B0"><span class="toc-number">2.3.</span> <span class="toc-text">调优概述</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9B%91%E6%8E%A7%E7%9A%84%E4%BE%9D%E6%8D%AE"><span class="toc-number">2.3.1.</span> <span class="toc-text">监控的依据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B0%83%E4%BC%98%E7%9A%84%E5%A4%A7%E6%96%B9%E5%90%91"><span class="toc-number">2.3.2.</span> <span class="toc-text">调优的大方向</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E7%9A%84%E6%AD%A5%E9%AA%A4"><span class="toc-number">2.4.</span> <span class="toc-text">性能优化的步骤</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%AC-1-%E6%AD%A5%EF%BC%9A%E6%80%A7%E8%83%BD%E7%9B%91%E6%8E%A7"><span class="toc-number">2.4.1.</span> <span class="toc-text">第 1 步：性能监控</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%AC-2-%E6%AD%A5%EF%BC%9A%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90"><span class="toc-number">2.4.2.</span> <span class="toc-text">第 2 步：性能分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%AC-3-%E6%AD%A5%EF%BC%9A%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98"><span class="toc-number">2.4.3.</span> <span class="toc-text">第 3 步：性能调优</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%A7%E8%83%BD%E8%AF%84%E4%BB%B7-%E6%B5%8B%E8%AF%95%E6%8C%87%E6%A0%87"><span class="toc-number">2.5.</span> <span class="toc-text">性能评价&#x2F;测试指标</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%81%9C%E9%A1%BF%E6%97%B6%E9%97%B4%EF%BC%88%E6%88%96%E5%93%8D%E5%BA%94%E6%97%B6%E9%97%B4%EF%BC%89"><span class="toc-number">2.5.1.</span> <span class="toc-text">停顿时间（或响应时间）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%9E%E5%90%90%E9%87%8F"><span class="toc-number">2.5.2.</span> <span class="toc-text">吞吐量</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B9%B6%E5%8F%91%E6%95%B0"><span class="toc-number">2.5.3.</span> <span class="toc-text">并发数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%86%85%E5%AD%98%E5%8D%A0%E7%94%A8"><span class="toc-number">2.5.4.</span> <span class="toc-text">内存占用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9B%B8%E4%BA%92%E9%97%B4%E7%9A%84%E5%85%B3%E7%B3%BB"><span class="toc-number">2.5.5.</span> <span class="toc-text">相互间的关系</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#JVM-%E7%9B%91%E6%8E%A7%E5%8F%8A%E8%AF%8A%E6%96%AD%E5%B7%A5%E5%85%B7-%E5%91%BD%E4%BB%A4%E8%A1%8C%E7%AF%87"><span class="toc-number">3.</span> <span class="toc-text">JVM 监控及诊断工具-命令行篇</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A6%82%E8%BF%B0"><span class="toc-number">3.1.</span> <span class="toc-text">概述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#jps%EF%BC%9A%E6%9F%A5%E7%9C%8B%E6%AD%A3%E5%9C%A8%E8%BF%90%E8%A1%8C%E7%9A%84-Java-%E8%BF%9B%E7%A8%8B"><span class="toc-number">3.2.</span> <span class="toc-text">jps：查看正在运行的 Java 进程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A6%82%E5%BF%B5"><span class="toc-number">3.2.1.</span> <span class="toc-text">概念</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#options-%E5%8F%82%E6%95%B0"><span class="toc-number">3.2.2.</span> <span class="toc-text">options 参数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#hostid-%E5%8F%82%E6%95%B0"><span class="toc-number">3.2.3.</span> <span class="toc-text">hostid 参数</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#jstat%EF%BC%9A%E6%9F%A5%E7%9C%8B-JVM-%E7%BB%9F%E8%AE%A1%E4%BF%A1%E6%81%AF"><span class="toc-number">3.3.</span> <span class="toc-text">jstat：查看 JVM 统计信息</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A6%82%E5%BF%B5-1"><span class="toc-number">3.3.1.</span> <span class="toc-text">概念</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#option-%E5%8F%82%E6%95%B0"><span class="toc-number">3.3.2.</span> <span class="toc-text">option 参数</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%B1%BB%E8%A3%85%E8%BD%BD%E7%9B%B8%E5%85%B3%E7%9A%84"><span class="toc-number">3.3.2.1.</span> <span class="toc-text">类装载相关的</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#jstat-class"><span class="toc-number">3.3.2.1.1.</span> <span class="toc-text">jstat -class</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#JIT-%E7%9B%B8%E5%85%B3%E7%9A%84"><span class="toc-number">3.3.2.2.</span> <span class="toc-text">JIT 相关的</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#jstat-compiler"><span class="toc-number">3.3.2.2.1.</span> <span class="toc-text">jstat -compiler</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#jstat-printcompilation"><span class="toc-number">3.3.2.2.2.</span> <span class="toc-text">jstat -printcompilation</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E7%9B%B8%E5%85%B3%E7%9A%84"><span class="toc-number">3.3.2.3.</span> <span class="toc-text">垃圾回收相关的</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#jstat-gc"><span class="toc-number">3.3.2.3.1.</span> <span class="toc-text">jstat -gc</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E4%BE%8B%E4%B8%80%EF%BC%9A"><span class="toc-number">3.3.2.3.1.1.</span> <span class="toc-text">例一：</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E4%BE%8B%E4%BA%8C%EF%BC%9A"><span class="toc-number">3.3.2.3.1.2.</span> <span class="toc-text">例二：</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#jstat-gccapacity"><span class="toc-number">3.3.2.3.2.</span> <span class="toc-text">jstat -gccapacity</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#jstat-gcutil"><span class="toc-number">3.3.2.3.3.</span> <span class="toc-text">jstat -gcutil</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#jstat-gccause"><span class="toc-number">3.3.2.3.4.</span> <span class="toc-text">jstat -gccause</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#jstat-gcnew"><span class="toc-number">3.3.2.3.5.</span> <span class="toc-text">jstat -gcnew</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#jstat-gcnewcapacity"><span class="toc-number">3.3.2.3.6.</span> <span class="toc-text">jstat -gcnewcapacity</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#jstat-gcold"><span class="toc-number">3.3.2.3.7.</span> <span class="toc-text">jstat -gcold</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#jstat-gcoldcapacity"><span class="toc-number">3.3.2.3.8.</span> <span class="toc-text">jstat -gcoldcapacity</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#jstat-gcmetacapacity"><span class="toc-number">3.3.2.3.9.</span> <span class="toc-text">jstat -gcmetacapacity</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#interval-%E5%8F%82%E6%95%B0%EF%BC%9A"><span class="toc-number">3.3.3.</span> <span class="toc-text">interval 参数：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#count-%E5%8F%82%E6%95%B0%EF%BC%9A"><span class="toc-number">3.3.4.</span> <span class="toc-text">count 参数：</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#t-%E5%8F%82%E6%95%B0%EF%BC%9A"><span class="toc-number">3.3.4.1.</span> <span class="toc-text">-t 参数：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#h-%E5%8F%82%E6%95%B0%EF%BC%9A"><span class="toc-number">3.3.4.2.</span> <span class="toc-text">-h 参数：</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A1%A5%E5%85%85%EF%BC%9A"><span class="toc-number">3.3.5.</span> <span class="toc-text">补充：</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#jinfo%EF%BC%9A%E5%AE%9E%E6%97%B6%E6%9F%A5%E7%9C%8B%E5%92%8C%E4%BF%AE%E6%94%B9-JVM-%E9%85%8D%E7%BD%AE%E5%8F%82%E6%95%B0"><span class="toc-number">3.4.</span> <span class="toc-text">jinfo：实时查看和修改 JVM 配置参数</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A6%82%E8%BF%B0-1"><span class="toc-number">3.4.1.</span> <span class="toc-text">概述</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B"><span class="toc-number">3.4.2.</span> <span class="toc-text">查看</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#jinfo-sysprops-PID"><span class="toc-number">3.4.2.1.</span> <span class="toc-text">jinfo -sysprops PID</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#jinfo-flags-PID"><span class="toc-number">3.4.2.2.</span> <span class="toc-text">jinfo -flags PID</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#jinfo-flag-name-PID"><span class="toc-number">3.4.2.3.</span> <span class="toc-text">jinfo -flag name PID</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9"><span class="toc-number">3.4.3.</span> <span class="toc-text">修改</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#jinfo-flag-name-PID-1"><span class="toc-number">3.4.3.1.</span> <span class="toc-text">jinfo -flag [+-]name PID</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#jinfo-flag-name-value-PID"><span class="toc-number">3.4.3.2.</span> <span class="toc-text">jinfo -flag name&#x3D;value PID</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#jmap%EF%BC%9A%E5%AF%BC%E5%87%BA%E5%86%85%E5%AD%98%E6%98%A0%E5%83%8F%E6%96%87%E4%BB%B6-amp-%E5%86%85%E5%AD%98%E4%BD%BF%E7%94%A8%E6%83%85%E5%86%B5"><span class="toc-number">3.5.</span> <span class="toc-text">jmap：导出内存映像文件&amp;内存使用情况</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E6%83%85%E5%86%B5"><span class="toc-number">3.5.1.</span> <span class="toc-text">基本情况</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E8%AF%AD%E6%B3%95"><span class="toc-number">3.5.2.</span> <span class="toc-text">基本语法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AF%BC%E5%87%BA%E5%86%85%E5%AD%98%E6%98%A0%E5%83%8F%E6%96%87%E4%BB%B6"><span class="toc-number">3.5.3.</span> <span class="toc-text">导出内存映像文件</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%89%8B%E5%8A%A8"><span class="toc-number">3.5.3.1.</span> <span class="toc-text">手动</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#jmap-dump"><span class="toc-number">3.5.3.1.1.</span> <span class="toc-text">jmap -dump</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%87%AA%E5%8A%A8"><span class="toc-number">3.5.3.2.</span> <span class="toc-text">自动</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%98%BE%E7%A4%BA%E5%A0%86%E5%86%85%E5%AD%98%E7%9B%B8%E5%85%B3%E4%BF%A1%E6%81%AF"><span class="toc-number">3.5.4.</span> <span class="toc-text">显示堆内存相关信息</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#jmap-heap"><span class="toc-number">3.5.4.1.</span> <span class="toc-text">jmap -heap</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#jmap-histo"><span class="toc-number">3.5.4.2.</span> <span class="toc-text">jmap -histo</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B6%E4%BB%96"><span class="toc-number">3.5.5.</span> <span class="toc-text">其他</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#jmap-clstats-pid"><span class="toc-number">3.5.5.1.</span> <span class="toc-text">jmap -clstats pid</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#jmap-finalizerinfo"><span class="toc-number">3.5.5.2.</span> <span class="toc-text">jmap -finalizerinfo</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B0%8F%E7%BB%93"><span class="toc-number">3.5.6.</span> <span class="toc-text">小结</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#jhat%EF%BC%9AJDK-%E8%87%AA%E5%B8%A6%E5%A0%86%E5%88%86%E6%9E%90%E5%B7%A5%E5%85%B7"><span class="toc-number">3.6.</span> <span class="toc-text">jhat：JDK 自带堆分析工具</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A6%82%E8%BF%B0-2"><span class="toc-number">3.6.1.</span> <span class="toc-text">概述</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AF%AD%E6%B3%95"><span class="toc-number">3.6.2.</span> <span class="toc-text">语法</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#jhat"><span class="toc-number">3.6.2.1.</span> <span class="toc-text">jhat</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#jstack%EF%BC%9A%E6%89%93%E5%8D%B0-JVM-%E4%B8%AD%E7%BA%BF%E7%A8%8B%E5%BF%AB%E7%85%A7"><span class="toc-number">3.7.</span> <span class="toc-text">jstack：打印 JVM 中线程快照</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A6%82%E8%BF%B0-3"><span class="toc-number">3.7.1.</span> <span class="toc-text">概述</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AF%AD%E6%B3%95-1"><span class="toc-number">3.7.2.</span> <span class="toc-text">语法</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BE%8B%E4%B8%80"><span class="toc-number">3.7.2.1.</span> <span class="toc-text">例一</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BE%8B%E4%BA%8C"><span class="toc-number">3.7.2.2.</span> <span class="toc-text">例二</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BE%8B%E4%B8%89"><span class="toc-number">3.7.2.3.</span> <span class="toc-text">例三</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#jstack-l"><span class="toc-number">3.7.2.4.</span> <span class="toc-text">jstack -l</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BE%8B%E5%9B%9B"><span class="toc-number">3.7.2.5.</span> <span class="toc-text">例四</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BE%8B%E4%BA%94"><span class="toc-number">3.7.2.6.</span> <span class="toc-text">例五</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#jcmd%EF%BC%9A%E5%A4%9A%E5%8A%9F%E8%83%BD%E5%91%BD%E4%BB%A4%E8%A1%8C"><span class="toc-number">3.8.</span> <span class="toc-text">jcmd：多功能命令行</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A6%82%E8%BF%B0-4"><span class="toc-number">3.8.1.</span> <span class="toc-text">概述</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E8%AF%AD%E6%B3%95-1"><span class="toc-number">3.8.2.</span> <span class="toc-text">基本语法</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#jcmd-l"><span class="toc-number">3.8.2.1.</span> <span class="toc-text">jcmd -l</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#jcmd-%E8%BF%9B%E7%A8%8B%E5%8F%B7-help"><span class="toc-number">3.8.2.2.</span> <span class="toc-text">jcmd 进程号 help</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#jstatd%EF%BC%9A%E8%BF%9C%E7%A8%8B%E4%B8%BB%E6%9C%BA%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86"><span class="toc-number">3.9.</span> <span class="toc-text">jstatd：远程主机信息收集</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#JVM-%E7%9B%91%E6%8E%A7%E5%8F%8A%E8%AF%8A%E6%96%AD%E5%B7%A5%E5%85%B7-GUI-%E7%AF%87"><span class="toc-number">4.</span> <span class="toc-text">JVM 监控及诊断工具-GUI 篇</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B7%A5%E5%85%B7%E6%A6%82%E8%BF%B0"><span class="toc-number">4.1.</span> <span class="toc-text">工具概述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#JConsole"><span class="toc-number">4.2.</span> <span class="toc-text">JConsole</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A6%82%E8%BF%B0-5"><span class="toc-number">4.2.1.</span> <span class="toc-text">概述</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8"><span class="toc-number">4.2.2.</span> <span class="toc-text">启动</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%9E%E6%8E%A5%E6%96%B9%E5%BC%8F"><span class="toc-number">4.2.3.</span> <span class="toc-text">连接方式</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#local"><span class="toc-number">4.2.3.1.</span> <span class="toc-text">local</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Remote"><span class="toc-number">4.2.3.2.</span> <span class="toc-text">Remote</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Advanced"><span class="toc-number">4.2.3.3.</span> <span class="toc-text">Advanced</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%9C%E7%94%A8"><span class="toc-number">4.2.4.</span> <span class="toc-text">作用</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A6%82%E8%A7%88"><span class="toc-number">4.2.4.1.</span> <span class="toc-text">概览</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%86%85%E5%AD%98"><span class="toc-number">4.2.4.2.</span> <span class="toc-text">内存</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A0%B9%E6%8D%AE%E7%BA%BF%E7%A8%8B%E6%A3%80%E6%B5%8B%E6%AD%BB%E9%94%81"><span class="toc-number">4.2.4.3.</span> <span class="toc-text">根据线程检测死锁</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BA%BF%E7%A8%8B"><span class="toc-number">4.2.4.4.</span> <span class="toc-text">线程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#VM%E6%A6%82%E8%A6%81"><span class="toc-number">4.2.4.5.</span> <span class="toc-text">VM概要</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Visual-VM"><span class="toc-number">4.3.</span> <span class="toc-text">Visual VM</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A6%82%E8%BF%B0-6"><span class="toc-number">4.3.1.</span> <span class="toc-text">概述</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8F%92%E4%BB%B6%E7%9A%84%E5%AE%89%E8%A3%85"><span class="toc-number">4.3.2.</span> <span class="toc-text">插件的安装</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BD%AF%E4%BB%B6%E5%AE%89%E8%A3%85"><span class="toc-number">4.3.2.1.</span> <span class="toc-text">软件安装</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8F%92%E4%BB%B6%E5%AE%89%E8%A3%85"><span class="toc-number">4.3.2.2.</span> <span class="toc-text">插件安装</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#idea%E6%8F%92%E4%BB%B6%E5%AE%89%E8%A3%85"><span class="toc-number">4.3.2.3.</span> <span class="toc-text">idea插件安装</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%9E%E6%8E%A5%E6%96%B9%E5%BC%8F-1"><span class="toc-number">4.3.3.</span> <span class="toc-text">连接方式</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9C%AC%E5%9C%B0%E8%BF%9E%E6%8E%A5"><span class="toc-number">4.3.3.1.</span> <span class="toc-text">本地连接</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%9C%E7%A8%8B%E8%BF%9E%E6%8E%A5"><span class="toc-number">4.3.3.2.</span> <span class="toc-text">远程连接</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%BB%E8%A6%81%E5%8A%9F%E8%83%BD%EF%BC%9A"><span class="toc-number">4.3.4.</span> <span class="toc-text">主要功能：</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%94%9F%E6%88%90-%E8%AF%BB%E5%8F%96%E5%A0%86%E5%86%85%E5%AD%98-%E7%BA%BF%E7%A8%8B%E5%BF%AB%E7%85%A7"><span class="toc-number">4.3.4.1.</span> <span class="toc-text">生成&#x2F;读取堆内存&#x2F;线程快照</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B-JVM-%E5%8F%82%E6%95%B0%E5%92%8C%E7%B3%BB%E7%BB%9F%E5%B1%9E%E6%80%A7"><span class="toc-number">4.3.4.2.</span> <span class="toc-text">查看 JVM 参数和系统属性</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E8%BF%90%E8%A1%8C%E4%B8%AD%E7%9A%84%E8%99%9A%E6%8B%9F%E6%9C%BA%E8%BF%9B%E7%A8%8B"><span class="toc-number">4.3.4.3.</span> <span class="toc-text">查看运行中的虚拟机进程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%94%9F%E6%88%90-%E8%AF%BB%E5%8F%96%E7%BA%BF%E7%A8%8B%E5%BF%AB%E7%85%A7"><span class="toc-number">4.3.4.4.</span> <span class="toc-text">生成&#x2F;读取线程快照</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%A8%8B%E5%BA%8F%E8%B5%84%E6%BA%90%E7%9A%84%E5%AE%9E%E6%97%B6%E7%9B%91%E6%8E%A7"><span class="toc-number">4.3.4.5.</span> <span class="toc-text">程序资源的实时监控</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#JMX-%E4%BB%A3%E7%90%86%E8%BF%9E%E6%8E%A5%E3%80%81%E8%BF%9C%E7%A8%8B%E7%8E%AF%E5%A2%83%E7%9B%91%E6%8E%A7%E3%80%81CPU-%E5%88%86%E6%9E%90%E5%92%8C%E5%86%85%E5%AD%98%E5%88%86%E6%9E%90"><span class="toc-number">4.3.4.6.</span> <span class="toc-text">JMX 代理连接、远程环境监控、CPU 分析和内存分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%B6%E4%BB%96%E5%8A%9F%E8%83%BD"><span class="toc-number">4.3.4.7.</span> <span class="toc-text">其他功能</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#JMX%E4%BB%A3%E7%90%86%E8%BF%9E%E6%8E%A5"><span class="toc-number">4.3.4.7.1.</span> <span class="toc-text">JMX代理连接</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%BF%9C%E7%A8%8B%E7%8E%AF%E5%A2%83%E7%9B%91%E6%8E%A7"><span class="toc-number">4.3.4.7.2.</span> <span class="toc-text">远程环境监控</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#CPU%E5%88%86%E6%9E%90%E5%92%8C%E5%86%85%E5%AD%98%E5%88%86%E6%9E%90"><span class="toc-number">4.3.4.7.3.</span> <span class="toc-text">CPU分析和内存分析</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Eclipse-MAT"><span class="toc-number">4.4.</span> <span class="toc-text">Eclipse MAT</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E6%A6%82%E8%BF%B0"><span class="toc-number">4.4.1.</span> <span class="toc-text">基本概述</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E5%A0%86dump%E6%96%87%E4%BB%B6"><span class="toc-number">4.4.2.</span> <span class="toc-text">获取堆dump文件</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#dump%E6%96%87%E4%BB%B6%E5%86%85%E5%AE%B9"><span class="toc-number">4.4.2.1.</span> <span class="toc-text">dump文件内容</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AF%B4%E6%98%8E"><span class="toc-number">4.4.2.2.</span> <span class="toc-text">说明</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96dump%E6%96%87%E4%BB%B6"><span class="toc-number">4.4.2.3.</span> <span class="toc-text">获取dump文件</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E6%9E%90%E5%A0%86dump%E6%96%87%E4%BB%B6"><span class="toc-number">4.4.3.</span> <span class="toc-text">分析堆dump文件</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#histogram-%E7%9B%B4%E6%96%B9%E5%9B%BE"><span class="toc-number">4.4.3.1.</span> <span class="toc-text">histogram(直方图)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#thread-overview"><span class="toc-number">4.4.3.2.</span> <span class="toc-text">thread overview</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%8E%B7%E5%BE%97%E5%AF%B9%E8%B1%A1%E7%9B%B8%E4%BA%92%E5%BC%95%E7%94%A8%E7%9A%84%E5%85%B3%E7%B3%BB"><span class="toc-number">4.4.3.3.</span> <span class="toc-text">获得对象相互引用的关系</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#with-outgoing-references"><span class="toc-number">4.4.3.4.</span> <span class="toc-text">with outgoing references</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#with-incoming-references"><span class="toc-number">4.4.3.4.1.</span> <span class="toc-text">with incoming references</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B5%85%E5%A0%86%E5%92%8C%E6%B7%B1%E5%A0%86"><span class="toc-number">4.4.3.5.</span> <span class="toc-text">浅堆和深堆</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#shallow-heap%EF%BC%88%E6%B5%85%E5%A0%86%EF%BC%89"><span class="toc-number">4.4.3.5.1.</span> <span class="toc-text">shallow heap（浅堆）</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#retained-heap%EF%BC%88%E6%B7%B1%E5%A0%86%EF%BC%89"><span class="toc-number">4.4.3.5.2.</span> <span class="toc-text">retained heap（深堆）</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E4%BF%9D%E7%95%99%E9%9B%86-Retained-Set-%EF%BC%9A"><span class="toc-number">4.4.3.5.2.1.</span> <span class="toc-text">保留集(Retained Set)：</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%B7%B1%E5%A0%86-Retained-Heap-%EF%BC%9A"><span class="toc-number">4.4.3.5.2.2.</span> <span class="toc-text">深堆(Retained Heap)：</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%A1%A5%E5%85%85%EF%BC%9A%E5%AF%B9%E8%B1%A1%E7%9A%84%E5%AE%9E%E9%99%85%E5%A4%A7%E5%B0%8F"><span class="toc-number">4.4.3.5.3.</span> <span class="toc-text">补充：对象的实际大小</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%BB%83%E4%B9%A0"><span class="toc-number">4.4.3.5.4.</span> <span class="toc-text">练习</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%A1%88%E4%BE%8B%E5%88%86%E6%9E%90%EF%BC%9A"><span class="toc-number">4.4.3.5.5.</span> <span class="toc-text">案例分析：</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%AF%B9%E8%B1%A1%E5%A4%A7%E5%B0%8F%E5%88%86%E6%9E%90%EF%BC%9A"><span class="toc-number">4.4.3.5.5.1.</span> <span class="toc-text">对象大小分析：</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%B7%B1%E5%A0%86%E5%88%86%E6%9E%90"><span class="toc-number">4.4.3.5.5.2.</span> <span class="toc-text">深堆分析</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%94%AF%E9%85%8D%E6%A0%91%EF%BC%88Dominator-Tree"><span class="toc-number">4.4.3.6.</span> <span class="toc-text">支配树（Dominator Tree)</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A1%88%E4%BE%8B%EF%BC%9ATomcat%E5%A0%86%E6%BA%A2%E5%87%BA%E5%88%86%E6%9E%90"><span class="toc-number">4.4.4.</span> <span class="toc-text">案例：Tomcat堆溢出分析</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AF%B4%E6%98%8E-1"><span class="toc-number">4.4.4.1.</span> <span class="toc-text">说明</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%86%E6%9E%90%E8%BF%87%E7%A8%8B"><span class="toc-number">4.4.4.2.</span> <span class="toc-text">分析过程</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A1%A5%E5%85%85%EF%BC%9A%E5%86%85%E5%AD%98%E6%B3%84%E9%9C%B2"><span class="toc-number">4.5.</span> <span class="toc-text">补充：内存泄露</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A6%82%E8%BF%B0-7"><span class="toc-number">4.5.1.</span> <span class="toc-text">概述</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E5%86%85%E5%AD%98%E6%B3%84%E9%9C%B2"><span class="toc-number">4.5.1.1.</span> <span class="toc-text">什么是内存泄露</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%86%85%E5%AD%98%E6%B3%84%E9%9C%B2%E7%90%86%E8%A7%A3"><span class="toc-number">4.5.1.2.</span> <span class="toc-text">内存泄露理解</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%86%85%E5%AD%98%E6%B3%84%E9%9C%B2%E4%B8%8E%E5%92%8C%E5%86%85%E5%AD%98%E6%BA%A2%E5%87%BA%E5%85%B3%E7%B3%BB"><span class="toc-number">4.5.1.3.</span> <span class="toc-text">内存泄露与和内存溢出关系</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%86%85%E5%AD%98%E6%B3%84%E9%9C%B2%EF%BC%88memory-leak%EF%BC%89"><span class="toc-number">4.5.1.3.1.</span> <span class="toc-text">内存泄露（memory leak）</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%86%85%E5%AD%98%E6%BA%A2%E5%87%BA%EF%BC%88out-of-memory%EF%BC%89"><span class="toc-number">4.5.1.3.2.</span> <span class="toc-text">内存溢出（out of memory）</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Java-%E4%B8%AD%E5%86%85%E5%AD%98%E6%B3%84%E9%9C%B2%E7%9A%84-8-%E7%A7%8D%E6%83%85%E5%86%B5"><span class="toc-number">4.5.2.</span> <span class="toc-text">Java 中内存泄露的 8 种情况</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%9D%99%E6%80%81%E9%9B%86%E5%90%88%E7%B1%BB"><span class="toc-number">4.5.2.1.</span> <span class="toc-text">静态集合类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8D%95%E4%BE%8B%E6%A8%A1%E5%BC%8F"><span class="toc-number">4.5.2.2.</span> <span class="toc-text">单例模式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%86%85%E9%83%A8%E7%B1%BB%E6%8C%81%E6%9C%89%E5%A4%96%E9%83%A8%E7%B1%BB"><span class="toc-number">4.5.2.3.</span> <span class="toc-text">内部类持有外部类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%90%84%E7%A7%8D%E8%BF%9E%E6%8E%A5%EF%BC%8C%E5%A6%82%E6%95%B0%E6%8D%AE%E5%BA%93%E8%BF%9E%E6%8E%A5%E3%80%81%E7%BD%91%E7%BB%9C%E8%BF%9E%E6%8E%A5%E5%92%8C-IO-%E8%BF%9E%E6%8E%A5%E7%AD%89"><span class="toc-number">4.5.2.4.</span> <span class="toc-text">各种连接，如数据库连接、网络连接和 IO 连接等</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%98%E9%87%8F%E4%B8%8D%E5%90%88%E7%90%86%E7%9A%84%E4%BD%9C%E7%94%A8%E5%9F%9F"><span class="toc-number">4.5.2.5.</span> <span class="toc-text">变量不合理的作用域</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%94%B9%E5%8F%98%E5%93%88%E5%B8%8C%E5%80%BC"><span class="toc-number">4.5.2.6.</span> <span class="toc-text">改变哈希值</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BC%93%E5%AD%98%E6%B3%84%E9%9C%B2"><span class="toc-number">4.5.2.7.</span> <span class="toc-text">缓存泄露</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%9B%91%E5%90%AC%E5%99%A8%E5%92%8C%E5%85%B6%E4%BB%96%E5%9B%9E%E8%B0%83"><span class="toc-number">4.5.2.8.</span> <span class="toc-text">监听器和其他回调</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%86%85%E5%AD%98%E6%B3%84%E9%9C%B2%E6%A1%88%E4%BE%8B%E5%88%86%E6%9E%90"><span class="toc-number">4.5.3.</span> <span class="toc-text">内存泄露案例分析</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A1%88%E4%BE%8B%E4%B8%80%EF%BC%9A"><span class="toc-number">4.5.3.1.</span> <span class="toc-text">案例一：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A1%88%E4%BE%8B%E4%BA%8C"><span class="toc-number">4.5.3.2.</span> <span class="toc-text">案例二</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A1%A5%E5%85%85%EF%BC%9A%E4%BD%BF%E7%94%A8-OQL-%E8%AF%AD%E8%A8%80%E6%9F%A5%E8%AF%A2%E5%AF%B9%E8%B1%A1%E4%BF%A1%E6%81%AF"><span class="toc-number">4.6.</span> <span class="toc-text">补充：使用 OQL 语言查询对象信息</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#SELECT-%E5%AD%90%E5%8F%A5"><span class="toc-number">4.6.1.</span> <span class="toc-text">SELECT 子句</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#FROM-%E5%AD%90%E5%8F%A5"><span class="toc-number">4.6.2.</span> <span class="toc-text">FROM 子句</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#WHERE-%E5%AD%90%E5%8F%A5"><span class="toc-number">4.6.3.</span> <span class="toc-text">WHERE 子句</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%86%85%E7%BD%AE%E5%AF%B9%E8%B1%A1%E4%B8%8E%E6%96%B9%E6%B3%95"><span class="toc-number">4.6.4.</span> <span class="toc-text">内置对象与方法</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A1%A5%E5%85%85%EF%BC%9AOOM"><span class="toc-number">4.7.</span> <span class="toc-text">补充：OOM</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A0%86%E6%BA%A2%E5%87%BA"><span class="toc-number">4.7.1.</span> <span class="toc-text">堆溢出</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%83%E7%A9%BA%E9%97%B4%E6%BA%A2%E5%87%BA"><span class="toc-number">4.7.2.</span> <span class="toc-text">元空间溢出</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#OOM%EF%BC%9AGC-overhead-limit-exceeded"><span class="toc-number">4.7.3.</span> <span class="toc-text">OOM：GC overhead limit exceeded</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BA%BF%E7%A8%8B%E6%BA%A2%E5%87%BA"><span class="toc-number">4.7.4.</span> <span class="toc-text">线程溢出</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#JProfiler"><span class="toc-number">4.8.</span> <span class="toc-text">JProfiler</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A6%82%E8%BF%B0-8"><span class="toc-number">4.8.1.</span> <span class="toc-text">概述</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%8B%E7%BB%8D"><span class="toc-number">4.8.1.1.</span> <span class="toc-text">介绍</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%89%B9%E7%82%B9"><span class="toc-number">4.8.1.2.</span> <span class="toc-text">特点</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%BB%E8%A6%81%E5%8A%9F%E8%83%BD"><span class="toc-number">4.8.1.3.</span> <span class="toc-text">主要功能</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%8B%E8%BD%BD%E4%B8%8E%E5%AE%89%E8%A3%85"><span class="toc-number">4.8.2.</span> <span class="toc-text">下载与安装</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%8B%E8%BD%BD"><span class="toc-number">4.8.2.1.</span> <span class="toc-text">下载</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#JProfile%E4%B8%AD%E9%85%8D%E7%BD%AEIDEA"><span class="toc-number">4.8.2.2.</span> <span class="toc-text">JProfile中配置IDEA</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#idea%E9%9B%86%E6%88%90JProfiler"><span class="toc-number">4.8.2.3.</span> <span class="toc-text">idea集成JProfiler</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B7%E4%BD%93%E4%BD%BF%E7%94%A8"><span class="toc-number">4.8.3.</span> <span class="toc-text">具体使用</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E9%87%87%E9%9B%86%E6%96%B9%E5%BC%8F%EF%BC%9A"><span class="toc-number">4.8.3.1.</span> <span class="toc-text">数据采集方式：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%81%A5%E6%84%9F%E7%9B%91%E6%B5%8B-Telemetries"><span class="toc-number">4.8.3.2.</span> <span class="toc-text">遥感监测 Telemetries</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%86%85%E5%AD%98%E8%A7%86%E5%9B%BE-Live-Memory"><span class="toc-number">4.8.3.3.</span> <span class="toc-text">内存视图 Live Memory</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%89%80%E6%9C%89%E5%AF%B9%E8%B1%A1-All-Objects%EF%BC%9A"><span class="toc-number">4.8.3.3.1.</span> <span class="toc-text">所有对象 All Objects：</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%AE%B0%E5%BD%95%E5%AF%B9%E8%B1%A1-Record-Objects%EF%BC%9A"><span class="toc-number">4.8.3.3.2.</span> <span class="toc-text">记录对象 Record Objects：</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%86%E9%85%8D%E8%AE%BF%E9%97%AE%E6%A0%91-Allocation-Call-Tree%EF%BC%9A"><span class="toc-number">4.8.3.3.3.</span> <span class="toc-text">分配访问树 Allocation Call Tree：</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%86%E9%85%8D%E7%83%AD%E7%82%B9-Allocation-Hot-Spots%EF%BC%9A"><span class="toc-number">4.8.3.3.4.</span> <span class="toc-text">分配热点 Allocation Hot Spots：</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%B1%BB%E8%BF%BD%E8%B8%AA%E5%99%A8-Class-Tracker%EF%BC%9A"><span class="toc-number">4.8.3.3.5.</span> <span class="toc-text">类追踪器 Class Tracker：</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A0%86%E9%81%8D%E5%8E%86-heap-walker"><span class="toc-number">4.8.3.4.</span> <span class="toc-text">堆遍历 heap walker</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#cpu-%E8%A7%86%E5%9B%BE-cpu-views"><span class="toc-number">4.8.3.5.</span> <span class="toc-text">cpu 视图 cpu views</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BA%BF%E7%A8%8B%E8%A7%86%E5%9B%BE-threads"><span class="toc-number">4.8.3.6.</span> <span class="toc-text">线程视图 threads</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%9B%91%E6%8E%A7%E5%92%8C%E9%94%81-Monitors-%EF%BC%86Locks"><span class="toc-number">4.8.3.7.</span> <span class="toc-text">监控和锁 Monitors ＆Locks</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A1%88%E4%BE%8B%E5%88%86%E6%9E%90"><span class="toc-number">4.8.4.</span> <span class="toc-text">案例分析</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A1%88%E4%BE%8B%E4%B8%80"><span class="toc-number">4.8.4.1.</span> <span class="toc-text">案例一</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A1%88%E4%BE%8B%E4%BA%8C-1"><span class="toc-number">4.8.4.2.</span> <span class="toc-text">案例二</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Arthas"><span class="toc-number">4.9.</span> <span class="toc-text">Arthas</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A6%82%E8%BF%B0-9"><span class="toc-number">4.9.1.</span> <span class="toc-text">概述</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%83%8C%E6%99%AF"><span class="toc-number">4.9.1.1.</span> <span class="toc-text">背景</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Arthas%E6%A6%82%E8%BF%B0"><span class="toc-number">4.9.2.</span> <span class="toc-text">Arthas概述</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8E%E5%B7%A5%E5%85%B7"><span class="toc-number">4.9.3.</span> <span class="toc-text">基于工具</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%89%E8%A3%85"><span class="toc-number">4.9.3.1.</span> <span class="toc-text">安装</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E6%96%B9%E5%BC%8F%E4%B8%80"><span class="toc-number">4.9.3.1.1.</span> <span class="toc-text">安装方式一</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E6%96%B9%E5%BC%8F%E4%BA%8C%EF%BC%9A"><span class="toc-number">4.9.3.1.2.</span> <span class="toc-text">安装方式二：</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8D%B8%E8%BD%BD"><span class="toc-number">4.9.3.1.3.</span> <span class="toc-text">卸载</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E7%9B%AE%E5%BD%95"><span class="toc-number">4.9.3.2.</span> <span class="toc-text">安装目录</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8-1"><span class="toc-number">4.9.3.3.</span> <span class="toc-text">启动</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%A1%88%E4%BE%8B%E4%B8%80-1"><span class="toc-number">4.9.3.3.1.</span> <span class="toc-text">案例一</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E8%BF%9B%E7%A8%8B"><span class="toc-number">4.9.3.4.</span> <span class="toc-text">查看进程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E6%97%A5%E5%BF%97"><span class="toc-number">4.9.3.5.</span> <span class="toc-text">查看日志</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E5%B8%AE%E5%8A%A9"><span class="toc-number">4.9.3.6.</span> <span class="toc-text">查看帮助</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#web-console"><span class="toc-number">4.9.3.7.</span> <span class="toc-text">web console</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%80%80%E5%87%BA"><span class="toc-number">4.9.3.8.</span> <span class="toc-text">退出</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9B%B8%E5%85%B3%E8%AF%8A%E6%96%AD%E6%8C%87%E4%BB%A4"><span class="toc-number">4.9.4.</span> <span class="toc-text">相关诊断指令</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80%E6%8C%87%E4%BB%A4"><span class="toc-number">4.9.4.1.</span> <span class="toc-text">基础指令</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#jvm-%E7%9B%B8%E5%85%B3"><span class="toc-number">4.9.4.2.</span> <span class="toc-text">jvm 相关</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#class-classloader-%E7%9B%B8%E5%85%B3"><span class="toc-number">4.9.4.3.</span> <span class="toc-text">class&#x2F;classloader 相关</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#monitor-watch-trace-%E7%9B%B8%E5%85%B3"><span class="toc-number">4.9.4.4.</span> <span class="toc-text">monitor&#x2F;watch&#x2F;trace 相关</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%B6%E4%BB%96-1"><span class="toc-number">4.9.4.5.</span> <span class="toc-text">其他</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Java-Misssion-Control"><span class="toc-number">4.10.</span> <span class="toc-text">Java Misssion Control</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%86%E5%8F%B2"><span class="toc-number">4.10.1.</span> <span class="toc-text">历史</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8-2"><span class="toc-number">4.10.2.</span> <span class="toc-text">启动</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A6%82%E8%BF%B0-10"><span class="toc-number">4.10.3.</span> <span class="toc-text">概述</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8A%9F%E8%83%BD"><span class="toc-number">4.10.4.</span> <span class="toc-text">功能</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Java-Flight-Recorder"><span class="toc-number">4.10.5.</span> <span class="toc-text">Java Flight Recorder</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BA%8B%E4%BB%B6%E7%B1%BB%E5%9E%8B"><span class="toc-number">4.10.5.1.</span> <span class="toc-text">事件类型</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E6%96%B9%E5%BC%8F"><span class="toc-number">4.10.5.2.</span> <span class="toc-text">启动方式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%96%E6%A0%B7%E5%88%86%E6%9E%90"><span class="toc-number">4.10.5.3.</span> <span class="toc-text">取样分析</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B6%E4%BB%96%E5%B7%A5%E5%85%B7"><span class="toc-number">4.11.</span> <span class="toc-text">其他工具</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Flame-Graphs%EF%BC%88%E7%81%AB%E7%84%B0%E5%9B%BE%EF%BC%89"><span class="toc-number">4.11.1.</span> <span class="toc-text">Flame Graphs（火焰图）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Tprofiler"><span class="toc-number">4.11.2.</span> <span class="toc-text">Tprofiler</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Btrace"><span class="toc-number">4.11.3.</span> <span class="toc-text">Btrace</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#JVM-%E8%BF%90%E8%A1%8C%E6%97%B6%E5%8F%82%E6%95%B0"><span class="toc-number">5.</span> <span class="toc-text">JVM 运行时参数</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#JVM-%E5%8F%82%E6%95%B0%E9%80%89%E9%A1%B9"><span class="toc-number">5.1.</span> <span class="toc-text">JVM 参数选项</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%B1%BB%E5%9E%8B%E4%B8%80%EF%BC%9A%E6%A0%87%E5%87%86%E5%8F%82%E6%95%B0%E9%80%89%E9%A1%B9"><span class="toc-number">5.1.1.</span> <span class="toc-text">类型一：标准参数选项</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Server-%E6%A8%A1%E5%BC%8F%E5%92%8C-Client-%E6%A8%A1%E5%BC%8F"><span class="toc-number">5.1.1.1.</span> <span class="toc-text">Server 模式和 Client 模式</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%B1%BB%E5%9E%8B%E4%BA%8C%EF%BC%9A-X-%E5%8F%82%E6%95%B0%E9%80%89%E9%A1%B9"><span class="toc-number">5.1.2.</span> <span class="toc-text">类型二：-X 参数选项</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%89%B9%E7%82%B9%EF%BC%9A"><span class="toc-number">5.1.2.1.</span> <span class="toc-text">特点：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%80%89%E9%A1%B9"><span class="toc-number">5.1.2.2.</span> <span class="toc-text">选项</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#JVM%E7%9A%84JIT%E7%BC%96%E8%AF%91%E6%A8%A1%E5%BC%8F%E7%9B%B8%E5%85%B3%E7%9A%84%E9%80%89%E9%A1%B9"><span class="toc-number">5.1.2.3.</span> <span class="toc-text">JVM的JIT编译模式相关的选项</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%89%B9%E5%88%AB%E7%9A%84"><span class="toc-number">5.1.2.4.</span> <span class="toc-text">特别的</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%B1%BB%E5%9E%8B%E4%B8%89%EF%BC%9A-XX-%E5%8F%82%E6%95%B0%E9%80%89%E9%A1%B9"><span class="toc-number">5.1.3.</span> <span class="toc-text">类型三：-XX 参数选项</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%89%B9%E7%82%B9-1"><span class="toc-number">5.1.3.1.</span> <span class="toc-text">特点</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%9C%E7%94%A8-1"><span class="toc-number">5.1.3.2.</span> <span class="toc-text">作用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%86%E7%B1%BB"><span class="toc-number">5.1.3.3.</span> <span class="toc-text">分类</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Boolean-%E7%B1%BB%E5%9E%8B%E6%A0%BC%E5%BC%8F"><span class="toc-number">5.1.3.3.1.</span> <span class="toc-text">Boolean 类型格式</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%9D%9E-Boolean-%E7%B1%BB%E5%9E%8B%E6%A0%BC%E5%BC%8F%EF%BC%88key-value%EF%BC%89"><span class="toc-number">5.1.3.3.2.</span> <span class="toc-text">非 Boolean 类型格式（key value）</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%89%B9%E5%88%AB%E7%9A%84-1"><span class="toc-number">5.1.3.4.</span> <span class="toc-text">特别的</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%A8%E9%83%A8"><span class="toc-number">5.1.3.5.</span> <span class="toc-text">全部</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0-JVM-%E5%8F%82%E6%95%B0%E9%80%89%E9%A1%B9"><span class="toc-number">5.2.</span> <span class="toc-text">添加 JVM 参数选项</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B8%B8%E7%94%A8%E7%9A%84-JVM-%E5%8F%82%E6%95%B0%E9%80%89%E9%A1%B9"><span class="toc-number">5.3.</span> <span class="toc-text">常用的 JVM 参数选项</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%93%E5%8D%B0%E8%AE%BE%E7%BD%AE%E7%9A%84-XX-%E9%80%89%E9%A1%B9%E5%8F%8A%E5%80%BC"><span class="toc-number">5.3.1.</span> <span class="toc-text">打印设置的 XX 选项及值</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A0%86%E3%80%81%E6%A0%88%E3%80%81%E6%96%B9%E6%B3%95%E5%8C%BA%E7%AD%89%E5%86%85%E5%AD%98%E5%A4%A7%E5%B0%8F%E8%AE%BE%E7%BD%AE"><span class="toc-number">5.3.2.</span> <span class="toc-text">堆、栈、方法区等内存大小设置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#OutOfMemory-%E7%9B%B8%E5%85%B3%E7%9A%84%E9%80%89%E9%A1%B9"><span class="toc-number">5.3.3.</span> <span class="toc-text">OutOfMemory 相关的选项</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9E%83%E5%9C%BE%E6%94%B6%E9%9B%86%E5%99%A8%E7%9B%B8%E5%85%B3%E9%80%89%E9%A1%B9"><span class="toc-number">5.3.4.</span> <span class="toc-text">垃圾收集器相关选项</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E9%BB%98%E8%AE%A4%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E5%99%A8"><span class="toc-number">5.3.4.1.</span> <span class="toc-text">查看默认垃圾回收器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Serial%E5%9B%9E%E6%94%B6%E5%99%A8"><span class="toc-number">5.3.4.2.</span> <span class="toc-text">Serial回收器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ParNew%E5%9B%9E%E6%94%B6%E5%99%A8"><span class="toc-number">5.3.4.3.</span> <span class="toc-text">ParNew回收器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Parallel%E5%9B%9E%E6%94%B6%E5%99%A8"><span class="toc-number">5.3.4.4.</span> <span class="toc-text">Parallel回收器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#CMS%E5%9B%9E%E6%94%B6%E5%99%A8"><span class="toc-number">5.3.4.5.</span> <span class="toc-text">CMS回收器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#G1%E5%9B%9E%E6%94%B6%E5%99%A8"><span class="toc-number">5.3.4.6.</span> <span class="toc-text">G1回收器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%80%8E%E4%B9%88%E9%80%89%E6%8B%A9"><span class="toc-number">5.3.4.7.</span> <span class="toc-text">怎么选择</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#GC-%E6%97%A5%E5%BF%97%E7%9B%B8%E5%85%B3%E9%80%89%E9%A1%B9"><span class="toc-number">5.3.5.</span> <span class="toc-text">GC 日志相关选项</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B6%E4%BB%96%E5%8F%82%E6%95%B0"><span class="toc-number">5.3.6.</span> <span class="toc-text">其他参数</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%80%9A%E8%BF%87-Java-%E4%BB%A3%E7%A0%81%E8%8E%B7%E5%8F%96-JVM-%E5%8F%82%E6%95%B0"><span class="toc-number">5.4.</span> <span class="toc-text">通过 Java 代码获取 JVM 参数</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%88%86%E6%9E%90-GC-%E6%97%A5%E5%BF%97"><span class="toc-number">6.</span> <span class="toc-text">分析 GC 日志</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#GC-%E5%88%86%E7%B1%BB"><span class="toc-number">6.1.</span> <span class="toc-text">GC 分类</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#GC-%E6%97%A5%E5%BF%97%E5%88%86%E7%B1%BB"><span class="toc-number">6.2.</span> <span class="toc-text">GC 日志分类</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#GC-%E6%97%A5%E5%BF%97%E7%BB%93%E6%9E%84%E5%89%96%E6%9E%90"><span class="toc-number">6.3.</span> <span class="toc-text">GC 日志结构剖析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#GC-%E6%97%A5%E5%BF%97%E5%88%86%E6%9E%90%E5%B7%A5%E5%85%B7"><span class="toc-number">6.4.</span> <span class="toc-text">GC 日志分析工具</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/7ef7bbd4.html" title="LeetCode 118. 杨辉三角"><img src="https://img.lvxiaoyi.top/typora-img/202111011355394.png/lvxiaoyi" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="LeetCode 118. 杨辉三角"/></a><div class="content"><a class="title" href="/7ef7bbd4.html" title="LeetCode 118. 杨辉三角">LeetCode 118. 杨辉三角</a><time datetime="2023-03-19T14:25:59.394Z" title="发表于 2023-03-19 22:25:59">2023-03-19</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/82c8cab7.html" title="shell基础"><img src="https://pic2.zhimg.com/v2-9964d2894516902605191817111ec781_r.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="shell基础"/></a><div class="content"><a class="title" href="/82c8cab7.html" title="shell基础">shell基础</a><time datetime="2022-10-12T16:07:18.841Z" title="发表于 2022-10-13 00:07:18">2022-10-13</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/f1601c3e.html" title="单例模式"><img src="https://img.lvxiaoyi.top/typora-img/1002892-20180912131026735-781767905.png/lvxiaoyi" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="单例模式"/></a><div class="content"><a class="title" href="/f1601c3e.html" title="单例模式">单例模式</a><time datetime="2022-09-12T07:22:48.777Z" title="发表于 2022-09-12 15:22:48">2022-09-12</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/b15f0f1b.html" title="设计模式基础-1"><img src="https://img.lvxiaoyi.top/typora-img/image-20211012093705433.png/lvxiaoyi" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="设计模式基础-1"/></a><div class="content"><a class="title" href="/b15f0f1b.html" title="设计模式基础-1">设计模式基础-1</a><time datetime="2022-09-12T07:22:48.777Z" title="发表于 2022-09-12 15:22:48">2022-09-12</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2109f677.html" title="计算机网络常见面试题"><img src="https://img.lvxiaoyi.top/typora-img/java-interview/1.png/lvxiaoyi" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="计算机网络常见面试题"/></a><div class="content"><a class="title" href="/2109f677.html" title="计算机网络常见面试题">计算机网络常见面试题</a><time datetime="2022-09-12T07:22:48.777Z" title="发表于 2022-09-12 15:22:48">2022-09-12</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url('https://img.lvxiaoyi.top/typora-img/202111011421399.jpeg/lvxiaoyi')"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2023 By lvxiaoyi</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"></div><canvas id="universe"></canvas><script defer src="/js/lvxiaoyi.js"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/metingjs/dist/Meting.min.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>