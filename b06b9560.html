<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>LongAdderå’ŒSyncå’ŒAtomic | å•å°åŒ»'s BLOG</title><meta name="keywords" content="å¤šçº¿ç¨‹"><meta name="author" content="lvxiaoyi"><meta name="copyright" content="lvxiaoyi"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="LongAdderå’ŒSyncå’ŒAtomicLongAdderå†…éƒ¨ä½¿ç”¨äº†åˆ†æ®µé”ï¼Œå°†å•ä¸€çš„CASæ“ä½œåˆ†æ•£ä¸ºå¯¹æ•°ç»„Cellsä¸­å¤šä¸ªå…ƒç¥–çš„CAS åœ¨é«˜å¹¶å‘ï¼ˆåƒã€ä¸‡çº§å¹¶å‘ä»¥ä¸Šï¼‰LongAdderçš„æ•ˆç‡å¤§äºAtomicå¤§äºsynchronized AtomicAtomic åŸå­ç±»ä»‹ç»Atomic ç¿»è¯‘æˆä¸­æ–‡æ˜¯åŸå­çš„æ„æ€ã€‚åœ¨åŒ–å­¦ä¸Šï¼Œæˆ‘ä»¬çŸ¥é“åŸå­æ˜¯æ„æˆä¸€èˆ¬ç‰©è´¨çš„æœ€å°å•ä½ï¼Œåœ¨åŒ–å­¦ååº”ä¸­æ˜¯ä¸å¯åˆ†å‰²çš„ã€‚åœ¨æˆ‘ä»¬è¿™é‡Œ At">
<meta property="og:type" content="article">
<meta property="og:title" content="LongAdderå’ŒSyncå’ŒAtomic">
<meta property="og:url" content="https://lvxiaoyi.top/b06b9560.html">
<meta property="og:site_name" content="å•å°åŒ»&#39;s BLOG">
<meta property="og:description" content="LongAdderå’ŒSyncå’ŒAtomicLongAdderå†…éƒ¨ä½¿ç”¨äº†åˆ†æ®µé”ï¼Œå°†å•ä¸€çš„CASæ“ä½œåˆ†æ•£ä¸ºå¯¹æ•°ç»„Cellsä¸­å¤šä¸ªå…ƒç¥–çš„CAS åœ¨é«˜å¹¶å‘ï¼ˆåƒã€ä¸‡çº§å¹¶å‘ä»¥ä¸Šï¼‰LongAdderçš„æ•ˆç‡å¤§äºAtomicå¤§äºsynchronized AtomicAtomic åŸå­ç±»ä»‹ç»Atomic ç¿»è¯‘æˆä¸­æ–‡æ˜¯åŸå­çš„æ„æ€ã€‚åœ¨åŒ–å­¦ä¸Šï¼Œæˆ‘ä»¬çŸ¥é“åŸå­æ˜¯æ„æˆä¸€èˆ¬ç‰©è´¨çš„æœ€å°å•ä½ï¼Œåœ¨åŒ–å­¦ååº”ä¸­æ˜¯ä¸å¯åˆ†å‰²çš„ã€‚åœ¨æˆ‘ä»¬è¿™é‡Œ At">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://img.lvxiaoyi.top/typora-img/thread-2-img/285763-20200617223221933-644434653.png/lvxiaoyi">
<meta property="article:published_time" content="2022-09-12T07:22:48.762Z">
<meta property="article:modified_time" content="2022-09-12T07:22:48.762Z">
<meta property="article:author" content="lvxiaoyi">
<meta property="article:tag" content="å¤šçº¿ç¨‹">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://img.lvxiaoyi.top/typora-img/thread-2-img/285763-20200617223221933-644434653.png/lvxiaoyi"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://lvxiaoyi.top/b06b9560"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":true,"languages":{"hits_empty":"æ‰¾ä¸åˆ°æ‚¨æŸ¥è¯¢çš„å†…å®¹ï¼š${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: 'å¤åˆ¶æˆåŠŸ',
    error: 'å¤åˆ¶é”™è¯¯',
    noSupport: 'æµè§ˆå™¨ä¸æ”¯æŒ'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: 'åˆšåˆš',
    min: 'åˆ†é’Ÿå‰',
    hour: 'å°æ—¶å‰',
    day: 'å¤©å‰',
    month: 'ä¸ªæœˆå‰'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'LongAdderå’ŒSyncå’ŒAtomic',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-09-12 15:22:48'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 5.4.0"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://p0.meituan.net/csc/8a1b1d488e6a8ab5108c9c78f36b3a1776955.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">æ–‡ç« </div><div class="length-num">204</div></a><a href="/tags/"><div class="headline">æ ‡ç­¾</div><div class="length-num">26</div></a><a href="/categories/"><div class="headline">åˆ†ç±»</div><div class="length-num">50</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> åˆ†ç±»</span></a></div><div class="menus_item"><a class="site-page" href="/music/"><i class="fa-fw fas fa-music"></i><span> éŸ³ä¹</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> å°åŒ»</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://img.lvxiaoyi.top/typora-img/thread-2-img/285763-20200617223221933-644434653.png/lvxiaoyi')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">å•å°åŒ»'s BLOG</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> æœç´¢</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> åˆ†ç±»</span></a></div><div class="menus_item"><a class="site-page" href="/music/"><i class="fa-fw fas fa-music"></i><span> éŸ³ä¹</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> å°åŒ»</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">LongAdderå’ŒSyncå’ŒAtomic</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">å‘è¡¨äº</span><time class="post-meta-date-created" datetime="2022-09-12T07:22:48.762Z" title="å‘è¡¨äº 2022-09-12 15:22:48">2022-09-12</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">æ›´æ–°äº</span><time class="post-meta-date-updated" datetime="2022-09-12T07:22:48.762Z" title="æ›´æ–°äº 2022-09-12 15:22:48">2022-09-12</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E5%A4%9A%E7%BA%BF%E7%A8%8B/">å¤šçº¿ç¨‹</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E5%A4%9A%E7%BA%BF%E7%A8%8B/%E5%A4%9A%E7%BA%BF%E7%A8%8B%E7%90%86%E8%AE%BA%E7%AF%87/">å¤šçº¿ç¨‹ç†è®ºç¯‡</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="LongAdderå’ŒSyncå’ŒAtomic"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">é˜…è¯»é‡:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="LongAdderå’ŒSyncå’ŒAtomic"><a href="#LongAdderå’ŒSyncå’ŒAtomic" class="headerlink" title="LongAdderå’ŒSyncå’ŒAtomic"></a>LongAdderå’ŒSyncå’ŒAtomic</h1><p>LongAdderå†…éƒ¨ä½¿ç”¨äº†åˆ†æ®µé”ï¼Œå°†å•ä¸€çš„CASæ“ä½œåˆ†æ•£ä¸ºå¯¹æ•°ç»„Cellsä¸­å¤šä¸ªå…ƒç¥–çš„CAS</p>
<p>åœ¨é«˜å¹¶å‘ï¼ˆåƒã€ä¸‡çº§å¹¶å‘ä»¥ä¸Šï¼‰LongAdderçš„æ•ˆç‡å¤§äºAtomicå¤§äºsynchronized</p>
<h1 id="Atomic"><a href="#Atomic" class="headerlink" title="Atomic"></a>Atomic</h1><h2 id="Atomic-åŸå­ç±»ä»‹ç»"><a href="#Atomic-åŸå­ç±»ä»‹ç»" class="headerlink" title="Atomic åŸå­ç±»ä»‹ç»"></a>Atomic åŸå­ç±»ä»‹ç»</h2><p>Atomic ç¿»è¯‘æˆä¸­æ–‡æ˜¯åŸå­çš„æ„æ€ã€‚åœ¨åŒ–å­¦ä¸Šï¼Œæˆ‘ä»¬çŸ¥é“åŸå­æ˜¯æ„æˆä¸€èˆ¬ç‰©è´¨çš„æœ€å°å•ä½ï¼Œåœ¨åŒ–å­¦ååº”ä¸­æ˜¯ä¸å¯åˆ†å‰²çš„ã€‚åœ¨æˆ‘ä»¬è¿™é‡Œ Atomic æ˜¯æŒ‡ä¸€ä¸ªæ“ä½œæ˜¯ä¸å¯ä¸­æ–­çš„ã€‚å³ä½¿æ˜¯åœ¨å¤šä¸ªçº¿ç¨‹ä¸€èµ·æ‰§è¡Œçš„æ—¶å€™ï¼Œä¸€ä¸ªæ“ä½œä¸€æ—¦å¼€å§‹ï¼Œå°±ä¸ä¼šè¢«å…¶ä»–çº¿ç¨‹å¹²æ‰°ã€‚</p>
<p>æ‰€ä»¥ï¼Œæ‰€è°“åŸå­ç±»è¯´ç®€å•ç‚¹å°±æ˜¯å…·æœ‰åŸå­/åŸå­æ“ä½œç‰¹å¾çš„ç±»ã€‚</p>
<p>å¹¶å‘åŒ… <code>java.util.concurrent</code> çš„åŸå­ç±»éƒ½å­˜æ”¾åœ¨<code>java.util.concurrent.atomic</code>ä¸‹,å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p>
<p><img src="https://my-blog-to-use.oss-cn-beijing.aliyuncs.com/2019-6/JUC%E5%8E%9F%E5%AD%90%E7%B1%BB%E6%A6%82%E8%A7%88.png" alt="JUCåŸå­ç±»æ¦‚è§ˆ"></p>
<p>æ ¹æ®æ“ä½œçš„æ•°æ®ç±»å‹ï¼Œå¯ä»¥å°† JUC åŒ…ä¸­çš„åŸå­ç±»åˆ†ä¸º 4 ç±»</p>
<p><strong>åŸºæœ¬ç±»å‹</strong></p>
<p>ä½¿ç”¨åŸå­çš„æ–¹å¼æ›´æ–°åŸºæœ¬ç±»å‹</p>
<ul>
<li>AtomicIntegerï¼šæ•´å‹åŸå­ç±»</li>
<li>AtomicLongï¼šé•¿æ•´å‹åŸå­ç±»</li>
<li>AtomicBoolean ï¼šå¸ƒå°”å‹åŸå­ç±»</li>
</ul>
<p><strong>æ•°ç»„ç±»å‹</strong></p>
<p>ä½¿ç”¨åŸå­çš„æ–¹å¼æ›´æ–°æ•°ç»„é‡Œçš„æŸä¸ªå…ƒç´ </p>
<ul>
<li>AtomicIntegerArrayï¼šæ•´å‹æ•°ç»„åŸå­ç±»</li>
<li>AtomicLongArrayï¼šé•¿æ•´å‹æ•°ç»„åŸå­ç±»</li>
<li>AtomicReferenceArray ï¼šå¼•ç”¨ç±»å‹æ•°ç»„åŸå­ç±»</li>
</ul>
<p><strong>å¼•ç”¨ç±»å‹</strong></p>
<ul>
<li>AtomicReferenceï¼šå¼•ç”¨ç±»å‹åŸå­ç±»</li>
<li>AtomicMarkableReferenceï¼šåŸå­æ›´æ–°å¸¦æœ‰æ ‡è®°çš„å¼•ç”¨ç±»å‹ã€‚è¯¥ç±»å°† boolean æ ‡è®°ä¸å¼•ç”¨å…³è”èµ·æ¥ï¼Œ<del>ä¹Ÿå¯ä»¥è§£å†³ä½¿ç”¨ CAS è¿›è¡ŒåŸå­æ›´æ–°æ—¶å¯èƒ½å‡ºç°çš„ ABA é—®é¢˜ã€‚</del></li>
<li>AtomicStampedReference ï¼šåŸå­æ›´æ–°å¸¦æœ‰ç‰ˆæœ¬å·çš„å¼•ç”¨ç±»å‹ã€‚è¯¥ç±»å°†æ•´æ•°å€¼ä¸å¼•ç”¨å…³è”èµ·æ¥ï¼Œå¯ç”¨äºè§£å†³åŸå­çš„æ›´æ–°æ•°æ®å’Œæ•°æ®çš„ç‰ˆæœ¬å·ï¼Œå¯ä»¥è§£å†³ä½¿ç”¨ CAS è¿›è¡ŒåŸå­æ›´æ–°æ—¶å¯èƒ½å‡ºç°çš„ ABA é—®é¢˜ã€‚</li>
</ul>
<p><strong>å¯¹è±¡çš„å±æ€§ä¿®æ”¹ç±»å‹</strong></p>
<ul>
<li>AtomicIntegerFieldUpdater:åŸå­æ›´æ–°æ•´å‹å­—æ®µçš„æ›´æ–°å™¨</li>
<li>AtomicLongFieldUpdaterï¼šåŸå­æ›´æ–°é•¿æ•´å‹å­—æ®µçš„æ›´æ–°å™¨</li>
<li>AtomicReferenceFieldUpdaterï¼šåŸå­æ›´æ–°å¼•ç”¨ç±»å‹é‡Œçš„å­—æ®µ</li>
</ul>
<blockquote>
<p><strong>ğŸ› ä¿®æ­£ï¼ˆå‚è§ï¼š<a target="_blank" rel="noopener" href="https://github.com/Snailclimb/JavaGuide/issues/626">issue#626</a>ï¼‰</strong> : <code>AtomicMarkableReference</code> ä¸èƒ½è§£å†³ ABA é—®é¢˜ã€‚</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">AtomicMarkableReferenceæ˜¯å°†ä¸€ä¸ªbooleanå€¼ä½œæ˜¯å¦æœ‰æ›´æ”¹çš„æ ‡è®°ï¼Œæœ¬è´¨å°±æ˜¯å®ƒçš„ç‰ˆæœ¬å·åªæœ‰ä¸¤ä¸ªï¼Œtrueå’Œfalseï¼Œ</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">ä¿®æ”¹çš„æ—¶å€™åœ¨è¿™ä¸¤ä¸ªç‰ˆæœ¬å·ä¹‹é—´æ¥å›åˆ‡æ¢ï¼Œè¿™æ ·åšå¹¶ä¸èƒ½è§£å†³ABAçš„é—®é¢˜ï¼Œåªæ˜¯ä¼šé™ä½ABAé—®é¢˜å‘ç”Ÿçš„å‡ ç‡è€Œå·²</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"><span class="doctag">@author</span> : mazh</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"><span class="doctag">@Date</span> : 2020/1/17 14:41</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SolveABAByAtomicMarkableReference</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">private</span> <span class="keyword">static</span> AtomicMarkableReference atomicMarkableReference = <span class="keyword">new</span> AtomicMarkableReference(<span class="number">100</span>, <span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">            Thread refT1 = <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">                atomicMarkableReference.compareAndSet(<span class="number">100</span>, <span class="number">101</span>, atomicMarkableReference.isMarked(), !atomicMarkableReference.isMarked());</span><br><span class="line">                atomicMarkableReference.compareAndSet(<span class="number">101</span>, <span class="number">100</span>, atomicMarkableReference.isMarked(), !atomicMarkableReference.isMarked());</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">            Thread refT2 = <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">                <span class="keyword">boolean</span> marked = atomicMarkableReference.isMarked();</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    TimeUnit.SECONDS.sleep(<span class="number">2</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">boolean</span> c3 = atomicMarkableReference.compareAndSet(<span class="number">100</span>, <span class="number">101</span>, marked, !marked);</span><br><span class="line">                System.out.println(c3); <span class="comment">// è¿”å›true,å®é™…åº”è¯¥è¿”å›false</span></span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">            refT1.start();</span><br><span class="line">            refT2.start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><strong>CAS ABA é—®é¢˜</strong></p>
<ul>
<li>æè¿°: ç¬¬ä¸€ä¸ªçº¿ç¨‹å–åˆ°äº†å˜é‡ x çš„å€¼ Aï¼Œç„¶åå·´æ‹‰å·´æ‹‰å¹²åˆ«çš„äº‹ï¼Œæ€»ä¹‹å°±æ˜¯åªæ‹¿åˆ°äº†å˜é‡ x çš„å€¼ Aã€‚è¿™æ®µæ—¶é—´å†…ç¬¬äºŒä¸ªçº¿ç¨‹ä¹Ÿå–åˆ°äº†å˜é‡ x çš„å€¼ Aï¼Œç„¶åæŠŠå˜é‡ x çš„å€¼æ”¹ä¸º Bï¼Œç„¶åå·´æ‹‰å·´æ‹‰å¹²åˆ«çš„äº‹ï¼Œæœ€ååˆæŠŠå˜é‡ x çš„å€¼å˜ä¸º A ï¼ˆç›¸å½“äºè¿˜åŸäº†ï¼‰ã€‚åœ¨è¿™ä¹‹åç¬¬ä¸€ä¸ªçº¿ç¨‹ç»ˆäºè¿›è¡Œäº†å˜é‡ x çš„æ“ä½œï¼Œä½†æ˜¯æ­¤æ—¶å˜é‡ x çš„å€¼è¿˜æ˜¯ Aï¼Œæ‰€ä»¥ compareAndSet æ“ä½œæ˜¯æˆåŠŸã€‚</li>
<li>ä¾‹å­æè¿°(å¯èƒ½ä¸å¤ªåˆé€‚ï¼Œä½†å¥½ç†è§£): å¹´åˆï¼Œç°é‡‘ä¸ºé›¶ï¼Œç„¶åé€šè¿‡æ­£å¸¸åŠ³åŠ¨èµšäº†ä¸‰ç™¾ä¸‡ï¼Œä¹‹åæ­£å¸¸æ¶ˆè´¹äº†ï¼ˆæ¯”å¦‚ä¹°æˆ¿å­ï¼‰ä¸‰ç™¾ä¸‡ã€‚å¹´æœ«ï¼Œè™½ç„¶ç°é‡‘é›¶æ”¶å…¥ï¼ˆå¯èƒ½å˜æˆå…¶ä»–å½¢å¼äº†ï¼‰ï¼Œä½†æ˜¯èµšäº†é’±æ˜¯äº‹å®ï¼Œè¿˜æ˜¯å¾—äº¤ç¨çš„ï¼</li>
<li>ä»£ç ä¾‹å­ï¼ˆä»¥<code>AtomicInteger</code>ä¸ºä¾‹ï¼‰</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.concurrent.atomic.AtomicInteger;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AtomicIntegerDefectDemo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        defectOfABA();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">defectOfABA</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> AtomicInteger atomicInteger = <span class="keyword">new</span> AtomicInteger(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        Thread coreThread = <span class="keyword">new</span> Thread(</span><br><span class="line">                () -&gt; &#123;</span><br><span class="line">                    <span class="keyword">final</span> <span class="keyword">int</span> currentValue = atomicInteger.get();</span><br><span class="line">                    System.out.println(Thread.currentThread().getName() + <span class="string">&quot; ------ currentValue=&quot;</span> + currentValue);</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// è¿™æ®µç›®çš„ï¼šæ¨¡æ‹Ÿå¤„ç†å…¶ä»–ä¸šåŠ¡èŠ±è´¹çš„æ—¶é—´</span></span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        Thread.sleep(<span class="number">300</span>);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">boolean</span> casResult = atomicInteger.compareAndSet(<span class="number">1</span>, <span class="number">2</span>);</span><br><span class="line">                    System.out.println(Thread.currentThread().getName()</span><br><span class="line">                            + <span class="string">&quot; ------ currentValue=&quot;</span> + currentValue</span><br><span class="line">                            + <span class="string">&quot;, finalValue=&quot;</span> + atomicInteger.get()</span><br><span class="line">                            + <span class="string">&quot;, compareAndSet Result=&quot;</span> + casResult);</span><br><span class="line">                &#125;</span><br><span class="line">        );</span><br><span class="line">        coreThread.start();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è¿™æ®µç›®çš„ï¼šä¸ºäº†è®© coreThread çº¿ç¨‹å…ˆè·‘èµ·æ¥</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">100</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Thread amateurThread = <span class="keyword">new</span> Thread(</span><br><span class="line">                () -&gt; &#123;</span><br><span class="line">                    <span class="keyword">int</span> currentValue = atomicInteger.get();</span><br><span class="line">                    <span class="keyword">boolean</span> casResult = atomicInteger.compareAndSet(<span class="number">1</span>, <span class="number">2</span>);</span><br><span class="line">                    System.out.println(Thread.currentThread().getName()</span><br><span class="line">                            + <span class="string">&quot; ------ currentValue=&quot;</span> + currentValue</span><br><span class="line">                            + <span class="string">&quot;, finalValue=&quot;</span> + atomicInteger.get()</span><br><span class="line">                            + <span class="string">&quot;, compareAndSet Result=&quot;</span> + casResult);</span><br><span class="line"></span><br><span class="line">                    currentValue = atomicInteger.get();</span><br><span class="line">                    casResult = atomicInteger.compareAndSet(<span class="number">2</span>, <span class="number">1</span>);</span><br><span class="line">                    System.out.println(Thread.currentThread().getName()</span><br><span class="line">                            + <span class="string">&quot; ------ currentValue=&quot;</span> + currentValue</span><br><span class="line">                            + <span class="string">&quot;, finalValue=&quot;</span> + atomicInteger.get()</span><br><span class="line">                            + <span class="string">&quot;, compareAndSet Result=&quot;</span> + casResult);</span><br><span class="line">                &#125;</span><br><span class="line">        );</span><br><span class="line">        amateurThread.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¾“å‡ºå†…å®¹å¦‚ä¸‹ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Thread-0 ------ currentValue=1</span><br><span class="line">Thread-1 ------ currentValue=1, finalValue=2, compareAndSet Result=true</span><br><span class="line">Thread-1 ------ currentValue=2, finalValue=1, compareAndSet Result=true</span><br><span class="line">Thread-0 ------ currentValue=1, finalValue=2, compareAndSet Result=true</span><br></pre></td></tr></table></figure>

<p>ä¸‹é¢æˆ‘ä»¬æ¥è¯¦ç»†ä»‹ç»ä¸€ä¸‹è¿™äº›åŸå­ç±»ã€‚</p>
<h2 id="åŸºæœ¬ç±»å‹åŸå­ç±»"><a href="#åŸºæœ¬ç±»å‹åŸå­ç±»" class="headerlink" title="åŸºæœ¬ç±»å‹åŸå­ç±»"></a>åŸºæœ¬ç±»å‹åŸå­ç±»</h2><h3 id="åŸºæœ¬ç±»å‹åŸå­ç±»ä»‹ç»"><a href="#åŸºæœ¬ç±»å‹åŸå­ç±»ä»‹ç»" class="headerlink" title="åŸºæœ¬ç±»å‹åŸå­ç±»ä»‹ç»"></a>åŸºæœ¬ç±»å‹åŸå­ç±»ä»‹ç»</h3><p>ä½¿ç”¨åŸå­çš„æ–¹å¼æ›´æ–°åŸºæœ¬ç±»å‹</p>
<ul>
<li>AtomicIntegerï¼šæ•´å‹åŸå­ç±»</li>
<li>AtomicLongï¼šé•¿æ•´å‹åŸå­ç±»</li>
<li>AtomicBoolean ï¼šå¸ƒå°”å‹åŸå­ç±»</li>
</ul>
<p>ä¸Šé¢ä¸‰ä¸ªç±»æä¾›çš„æ–¹æ³•å‡ ä¹ç›¸åŒï¼Œæ‰€ä»¥æˆ‘ä»¬è¿™é‡Œä»¥ AtomicInteger ä¸ºä¾‹å­æ¥ä»‹ç»ã€‚</p>
<p><strong>AtomicInteger ç±»å¸¸ç”¨æ–¹æ³•</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">get</span><span class="params">()</span> <span class="comment">//è·å–å½“å‰çš„å€¼</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">getAndSet</span><span class="params">(<span class="keyword">int</span> newValue)</span><span class="comment">//è·å–å½“å‰çš„å€¼ï¼Œå¹¶è®¾ç½®æ–°çš„å€¼</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">getAndIncrement</span><span class="params">()</span><span class="comment">//è·å–å½“å‰çš„å€¼ï¼Œå¹¶è‡ªå¢</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">getAndDecrement</span><span class="params">()</span> <span class="comment">//è·å–å½“å‰çš„å€¼ï¼Œå¹¶è‡ªå‡</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">getAndAdd</span><span class="params">(<span class="keyword">int</span> delta)</span> <span class="comment">//è·å–å½“å‰çš„å€¼ï¼Œå¹¶åŠ ä¸Šé¢„æœŸçš„å€¼</span></span></span><br><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">compareAndSet</span><span class="params">(<span class="keyword">int</span> expect, <span class="keyword">int</span> update)</span> <span class="comment">//å¦‚æœè¾“å…¥çš„æ•°å€¼ç­‰äºé¢„æœŸå€¼ï¼Œåˆ™ä»¥åŸå­æ–¹å¼å°†è¯¥å€¼è®¾ç½®ä¸ºè¾“å…¥å€¼ï¼ˆupdateï¼‰</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">lazySet</span><span class="params">(<span class="keyword">int</span> newValue)</span><span class="comment">//æœ€ç»ˆè®¾ç½®ä¸ºnewValue,ä½¿ç”¨ lazySet è®¾ç½®ä¹‹åå¯èƒ½å¯¼è‡´å…¶ä»–çº¿ç¨‹åœ¨ä¹‹åçš„ä¸€å°æ®µæ—¶é—´å†…è¿˜æ˜¯å¯ä»¥è¯»åˆ°æ—§çš„å€¼ã€‚</span></span></span><br></pre></td></tr></table></figure>

<h3 id="AtomicInteger-å¸¸è§æ–¹æ³•ä½¿ç”¨"><a href="#AtomicInteger-å¸¸è§æ–¹æ³•ä½¿ç”¨" class="headerlink" title="AtomicInteger å¸¸è§æ–¹æ³•ä½¿ç”¨"></a>AtomicInteger å¸¸è§æ–¹æ³•ä½¿ç”¨</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.concurrent.atomic.AtomicInteger;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AtomicIntegerTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">		<span class="comment">// TODO Auto-generated method stub</span></span><br><span class="line">		<span class="keyword">int</span> temvalue = <span class="number">0</span>;</span><br><span class="line">		AtomicInteger i = <span class="keyword">new</span> AtomicInteger(<span class="number">0</span>);</span><br><span class="line">		temvalue = i.getAndSet(<span class="number">3</span>);</span><br><span class="line">		System.out.println(<span class="string">&quot;temvalue:&quot;</span> + temvalue + <span class="string">&quot;;  i:&quot;</span> + i);<span class="comment">//temvalue:0;  i:3</span></span><br><span class="line">		temvalue = i.getAndIncrement();</span><br><span class="line">		System.out.println(<span class="string">&quot;temvalue:&quot;</span> + temvalue + <span class="string">&quot;;  i:&quot;</span> + i);<span class="comment">//temvalue:3;  i:4</span></span><br><span class="line">		temvalue = i.getAndAdd(<span class="number">5</span>);</span><br><span class="line">		System.out.println(<span class="string">&quot;temvalue:&quot;</span> + temvalue + <span class="string">&quot;;  i:&quot;</span> + i);<span class="comment">//temvalue:4;  i:9</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="åŸºæœ¬æ•°æ®ç±»å‹åŸå­ç±»çš„ä¼˜åŠ¿"><a href="#åŸºæœ¬æ•°æ®ç±»å‹åŸå­ç±»çš„ä¼˜åŠ¿" class="headerlink" title="åŸºæœ¬æ•°æ®ç±»å‹åŸå­ç±»çš„ä¼˜åŠ¿"></a>åŸºæœ¬æ•°æ®ç±»å‹åŸå­ç±»çš„ä¼˜åŠ¿</h3><p>é€šè¿‡ä¸€ä¸ªç®€å•ä¾‹å­å¸¦å¤§å®¶çœ‹ä¸€ä¸‹åŸºæœ¬æ•°æ®ç±»å‹åŸå­ç±»çš„ä¼˜åŠ¿</p>
<p><strong>â‘  å¤šçº¿ç¨‹ç¯å¢ƒä¸ä½¿ç”¨åŸå­ç±»ä¿è¯çº¿ç¨‹å®‰å…¨ï¼ˆåŸºæœ¬æ•°æ®ç±»å‹ï¼‰</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line">        <span class="comment">//è‹¥è¦çº¿ç¨‹å®‰å…¨æ‰§è¡Œæ‰§è¡Œcount++ï¼Œéœ€è¦åŠ é”</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">increment</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                  count++;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getCount</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                  <span class="keyword">return</span> count;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>â‘¡ å¤šçº¿ç¨‹ç¯å¢ƒä½¿ç”¨åŸå­ç±»ä¿è¯çº¿ç¨‹å®‰å…¨ï¼ˆåŸºæœ¬æ•°æ®ç±»å‹ï¼‰</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test2</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> AtomicInteger count = <span class="keyword">new</span> AtomicInteger();</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">increment</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                  count.incrementAndGet();</span><br><span class="line">        &#125;</span><br><span class="line">      <span class="comment">//ä½¿ç”¨AtomicIntegerä¹‹åï¼Œä¸éœ€è¦åŠ é”ï¼Œä¹Ÿå¯ä»¥å®ç°çº¿ç¨‹å®‰å…¨ã€‚</span></span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getCount</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> count.get();</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="AtomicInteger-çº¿ç¨‹å®‰å…¨åŸç†ç®€å•åˆ†æ"><a href="#AtomicInteger-çº¿ç¨‹å®‰å…¨åŸç†ç®€å•åˆ†æ" class="headerlink" title="AtomicInteger çº¿ç¨‹å®‰å…¨åŸç†ç®€å•åˆ†æ"></a>AtomicInteger çº¿ç¨‹å®‰å…¨åŸç†ç®€å•åˆ†æ</h3><p>AtomicInteger ç±»çš„éƒ¨åˆ†æºç ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// setup to use Unsafe.compareAndSwapInt for updatesï¼ˆæ›´æ–°æ“ä½œæ—¶æä¾›â€œæ¯”è¾ƒå¹¶æ›¿æ¢â€çš„ä½œç”¨ï¼‰</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Unsafe unsafe = Unsafe.getUnsafe();</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> valueOffset;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        valueOffset = unsafe.objectFieldOffset</span><br><span class="line">            (AtomicInteger.class.getDeclaredField(<span class="string">&quot;value&quot;</span>));</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception ex) &#123; <span class="keyword">throw</span> <span class="keyword">new</span> Error(ex); &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">int</span> value;</span><br></pre></td></tr></table></figure>

<p>AtomicInteger ç±»ä¸»è¦åˆ©ç”¨ CAS (compare and swap) + volatile å’Œ native æ–¹æ³•æ¥ä¿è¯åŸå­æ“ä½œï¼Œä»è€Œé¿å… synchronized çš„é«˜å¼€é”€ï¼Œæ‰§è¡Œæ•ˆç‡å¤§ä¸ºæå‡ã€‚</p>
<p>CAS çš„åŸç†æ˜¯æ‹¿æœŸæœ›çš„å€¼å’ŒåŸæœ¬çš„ä¸€ä¸ªå€¼ä½œæ¯”è¾ƒï¼Œå¦‚æœç›¸åŒåˆ™æ›´æ–°æˆæ–°çš„å€¼ã€‚UnSafe ç±»çš„ objectFieldOffset() æ–¹æ³•æ˜¯ä¸€ä¸ªæœ¬åœ°æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•æ˜¯ç”¨æ¥æ‹¿åˆ°â€œåŸæ¥çš„å€¼â€çš„å†…å­˜åœ°å€ã€‚å¦å¤– value æ˜¯ä¸€ä¸ª volatile å˜é‡ï¼Œåœ¨å†…å­˜ä¸­å¯è§ï¼Œå› æ­¤ JVM å¯ä»¥ä¿è¯ä»»ä½•æ—¶åˆ»ä»»ä½•çº¿ç¨‹æ€»èƒ½æ‹¿åˆ°è¯¥å˜é‡çš„æœ€æ–°å€¼ã€‚</p>
<h2 id="æ•°ç»„ç±»å‹åŸå­ç±»"><a href="#æ•°ç»„ç±»å‹åŸå­ç±»" class="headerlink" title="æ•°ç»„ç±»å‹åŸå­ç±»"></a>æ•°ç»„ç±»å‹åŸå­ç±»</h2><h3 id="æ•°ç»„ç±»å‹åŸå­ç±»ä»‹ç»"><a href="#æ•°ç»„ç±»å‹åŸå­ç±»ä»‹ç»" class="headerlink" title="æ•°ç»„ç±»å‹åŸå­ç±»ä»‹ç»"></a>æ•°ç»„ç±»å‹åŸå­ç±»ä»‹ç»</h3><p>ä½¿ç”¨åŸå­çš„æ–¹å¼æ›´æ–°æ•°ç»„é‡Œçš„æŸä¸ªå…ƒç´ </p>
<ul>
<li>AtomicIntegerArrayï¼šæ•´å½¢æ•°ç»„åŸå­ç±»</li>
<li>AtomicLongArrayï¼šé•¿æ•´å½¢æ•°ç»„åŸå­ç±»</li>
<li>AtomicReferenceArray ï¼šå¼•ç”¨ç±»å‹æ•°ç»„åŸå­ç±»</li>
</ul>
<p>ä¸Šé¢ä¸‰ä¸ªç±»æä¾›çš„æ–¹æ³•å‡ ä¹ç›¸åŒï¼Œæ‰€ä»¥æˆ‘ä»¬è¿™é‡Œä»¥ AtomicIntegerArray ä¸ºä¾‹å­æ¥ä»‹ç»ã€‚</p>
<p><strong>AtomicIntegerArray ç±»å¸¸ç”¨æ–¹æ³•</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">get</span><span class="params">(<span class="keyword">int</span> i)</span> <span class="comment">//è·å– index=i ä½ç½®å…ƒç´ çš„å€¼</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">getAndSet</span><span class="params">(<span class="keyword">int</span> i, <span class="keyword">int</span> newValue)</span><span class="comment">//è¿”å› index=i ä½ç½®çš„å½“å‰çš„å€¼ï¼Œå¹¶å°†å…¶è®¾ç½®ä¸ºæ–°å€¼ï¼šnewValue</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">getAndIncrement</span><span class="params">(<span class="keyword">int</span> i)</span><span class="comment">//è·å– index=i ä½ç½®å…ƒç´ çš„å€¼ï¼Œå¹¶è®©è¯¥ä½ç½®çš„å…ƒç´ è‡ªå¢</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">getAndDecrement</span><span class="params">(<span class="keyword">int</span> i)</span> <span class="comment">//è·å– index=i ä½ç½®å…ƒç´ çš„å€¼ï¼Œå¹¶è®©è¯¥ä½ç½®çš„å…ƒç´ è‡ªå‡</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">getAndAdd</span><span class="params">(<span class="keyword">int</span> i, <span class="keyword">int</span> delta)</span> <span class="comment">//è·å– index=i ä½ç½®å…ƒç´ çš„å€¼ï¼Œå¹¶åŠ ä¸Šé¢„æœŸçš„å€¼</span></span></span><br><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">compareAndSet</span><span class="params">(<span class="keyword">int</span> i, <span class="keyword">int</span> expect, <span class="keyword">int</span> update)</span> <span class="comment">//å¦‚æœè¾“å…¥çš„æ•°å€¼ç­‰äºé¢„æœŸå€¼ï¼Œåˆ™ä»¥åŸå­æ–¹å¼å°† index=i ä½ç½®çš„å…ƒç´ å€¼è®¾ç½®ä¸ºè¾“å…¥å€¼ï¼ˆupdateï¼‰</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">lazySet</span><span class="params">(<span class="keyword">int</span> i, <span class="keyword">int</span> newValue)</span><span class="comment">//æœ€ç»ˆ å°†index=i ä½ç½®çš„å…ƒç´ è®¾ç½®ä¸ºnewValue,ä½¿ç”¨ lazySet è®¾ç½®ä¹‹åå¯èƒ½å¯¼è‡´å…¶ä»–çº¿ç¨‹åœ¨ä¹‹åçš„ä¸€å°æ®µæ—¶é—´å†…è¿˜æ˜¯å¯ä»¥è¯»åˆ°æ—§çš„å€¼ã€‚</span></span></span><br></pre></td></tr></table></figure>

<h3 id="AtomicIntegerArray-å¸¸è§æ–¹æ³•ä½¿ç”¨"><a href="#AtomicIntegerArray-å¸¸è§æ–¹æ³•ä½¿ç”¨" class="headerlink" title="AtomicIntegerArray å¸¸è§æ–¹æ³•ä½¿ç”¨"></a>AtomicIntegerArray å¸¸è§æ–¹æ³•ä½¿ç”¨</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.concurrent.atomic.AtomicIntegerArray;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AtomicIntegerArrayTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">		<span class="comment">// TODO Auto-generated method stub</span></span><br><span class="line">		<span class="keyword">int</span> temvalue = <span class="number">0</span>;</span><br><span class="line">		<span class="keyword">int</span>[] nums = &#123; <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span> &#125;;</span><br><span class="line">		AtomicIntegerArray i = <span class="keyword">new</span> AtomicIntegerArray(nums);</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; nums.length; j++) &#123;</span><br><span class="line">			System.out.println(i.get(j));</span><br><span class="line">		&#125;</span><br><span class="line">		temvalue = i.getAndSet(<span class="number">0</span>, <span class="number">2</span>);</span><br><span class="line">		System.out.println(<span class="string">&quot;temvalue:&quot;</span> + temvalue + <span class="string">&quot;;  i:&quot;</span> + i);</span><br><span class="line">		temvalue = i.getAndIncrement(<span class="number">0</span>);</span><br><span class="line">		System.out.println(<span class="string">&quot;temvalue:&quot;</span> + temvalue + <span class="string">&quot;;  i:&quot;</span> + i);</span><br><span class="line">		temvalue = i.getAndAdd(<span class="number">0</span>, <span class="number">5</span>);</span><br><span class="line">		System.out.println(<span class="string">&quot;temvalue:&quot;</span> + temvalue + <span class="string">&quot;;  i:&quot;</span> + i);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="å¼•ç”¨ç±»å‹åŸå­ç±»"><a href="#å¼•ç”¨ç±»å‹åŸå­ç±»" class="headerlink" title="å¼•ç”¨ç±»å‹åŸå­ç±»"></a>å¼•ç”¨ç±»å‹åŸå­ç±»</h2><h3 id="å¼•ç”¨ç±»å‹åŸå­ç±»ä»‹ç»"><a href="#å¼•ç”¨ç±»å‹åŸå­ç±»ä»‹ç»" class="headerlink" title="å¼•ç”¨ç±»å‹åŸå­ç±»ä»‹ç»"></a>å¼•ç”¨ç±»å‹åŸå­ç±»ä»‹ç»</h3><p>åŸºæœ¬ç±»å‹åŸå­ç±»åªèƒ½æ›´æ–°ä¸€ä¸ªå˜é‡ï¼Œå¦‚æœéœ€è¦åŸå­æ›´æ–°å¤šä¸ªå˜é‡ï¼Œéœ€è¦ä½¿ç”¨ å¼•ç”¨ç±»å‹åŸå­ç±»ã€‚</p>
<ul>
<li>AtomicReferenceï¼šå¼•ç”¨ç±»å‹åŸå­ç±»</li>
<li>AtomicStampedReferenceï¼šåŸå­æ›´æ–°å¸¦æœ‰ç‰ˆæœ¬å·çš„å¼•ç”¨ç±»å‹ã€‚è¯¥ç±»å°†æ•´æ•°å€¼ä¸å¼•ç”¨å…³è”èµ·æ¥ï¼Œå¯ç”¨äºè§£å†³åŸå­çš„æ›´æ–°æ•°æ®å’Œæ•°æ®çš„ç‰ˆæœ¬å·ï¼Œå¯ä»¥è§£å†³ä½¿ç”¨ CAS è¿›è¡ŒåŸå­æ›´æ–°æ—¶å¯èƒ½å‡ºç°çš„ ABA é—®é¢˜ã€‚</li>
<li>AtomicMarkableReference ï¼šåŸå­æ›´æ–°å¸¦æœ‰æ ‡è®°çš„å¼•ç”¨ç±»å‹ã€‚è¯¥ç±»å°† boolean æ ‡è®°ä¸å¼•ç”¨å…³è”èµ·æ¥ï¼Œ<del>ä¹Ÿå¯ä»¥è§£å†³ä½¿ç”¨ CAS è¿›è¡ŒåŸå­æ›´æ–°æ—¶å¯èƒ½å‡ºç°çš„ ABA é—®é¢˜ã€‚</del></li>
</ul>
<p>ä¸Šé¢ä¸‰ä¸ªç±»æä¾›çš„æ–¹æ³•å‡ ä¹ç›¸åŒï¼Œæ‰€ä»¥æˆ‘ä»¬è¿™é‡Œä»¥ AtomicReference ä¸ºä¾‹å­æ¥ä»‹ç»ã€‚</p>
<h3 id="AtomicReference-ç±»ä½¿ç”¨ç¤ºä¾‹"><a href="#AtomicReference-ç±»ä½¿ç”¨ç¤ºä¾‹" class="headerlink" title="AtomicReference ç±»ä½¿ç”¨ç¤ºä¾‹"></a>AtomicReference ç±»ä½¿ç”¨ç¤ºä¾‹</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.concurrent.atomic.AtomicReference;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AtomicReferenceTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">		AtomicReference&lt;Person&gt; ar = <span class="keyword">new</span> AtomicReference&lt;Person&gt;();</span><br><span class="line">		Person person = <span class="keyword">new</span> Person(<span class="string">&quot;SnailClimb&quot;</span>, <span class="number">22</span>);</span><br><span class="line">		ar.set(person);</span><br><span class="line">		Person updatePerson = <span class="keyword">new</span> Person(<span class="string">&quot;Daisy&quot;</span>, <span class="number">20</span>);</span><br><span class="line">		ar.compareAndSet(person, updatePerson);</span><br><span class="line"></span><br><span class="line">		System.out.println(ar.get().getName());</span><br><span class="line">		System.out.println(ar.get().getAge());</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span> </span>&#123;</span><br><span class="line">	<span class="keyword">private</span> String name;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> age;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Person</span><span class="params">(String name, <span class="keyword">int</span> age)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>();</span><br><span class="line">		<span class="keyword">this</span>.name = name;</span><br><span class="line">		<span class="keyword">this</span>.age = age;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> name;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.name = name;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getAge</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> age;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAge</span><span class="params">(<span class="keyword">int</span> age)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.age = age;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸Šè¿°ä»£ç é¦–å…ˆåˆ›å»ºäº†ä¸€ä¸ª Person å¯¹è±¡ï¼Œç„¶åæŠŠ Person å¯¹è±¡è®¾ç½®è¿› AtomicReference å¯¹è±¡ä¸­ï¼Œç„¶åè°ƒç”¨ compareAndSet æ–¹æ³•ï¼Œè¯¥æ–¹æ³•å°±æ˜¯é€šè¿‡ CAS æ“ä½œè®¾ç½® arã€‚å¦‚æœ ar çš„å€¼ä¸º person çš„è¯ï¼Œåˆ™å°†å…¶è®¾ç½®ä¸º updatePersonã€‚å®ç°åŸç†ä¸ AtomicInteger ç±»ä¸­çš„ compareAndSet æ–¹æ³•ç›¸åŒã€‚è¿è¡Œä¸Šé¢çš„ä»£ç åçš„è¾“å‡ºç»“æœå¦‚ä¸‹ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Daisy</span><br><span class="line">20</span><br></pre></td></tr></table></figure>

<h3 id="AtomicStampedReference-ç±»ä½¿ç”¨ç¤ºä¾‹"><a href="#AtomicStampedReference-ç±»ä½¿ç”¨ç¤ºä¾‹" class="headerlink" title="AtomicStampedReference ç±»ä½¿ç”¨ç¤ºä¾‹"></a>AtomicStampedReference ç±»ä½¿ç”¨ç¤ºä¾‹</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.concurrent.atomic.AtomicStampedReference;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AtomicStampedReferenceDemo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// å®ä¾‹åŒ–ã€å–å½“å‰å€¼å’Œ stamp å€¼</span></span><br><span class="line">        <span class="keyword">final</span> Integer initialRef = <span class="number">0</span>, initialStamp = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">final</span> AtomicStampedReference&lt;Integer&gt; asr = <span class="keyword">new</span> AtomicStampedReference&lt;&gt;(initialRef, initialStamp);</span><br><span class="line">        System.out.println(<span class="string">&quot;currentValue=&quot;</span> + asr.getReference() + <span class="string">&quot;, currentStamp=&quot;</span> + asr.getStamp());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// compare and set</span></span><br><span class="line">        <span class="keyword">final</span> Integer newReference = <span class="number">666</span>, newStamp = <span class="number">999</span>;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> casResult = asr.compareAndSet(initialRef, newReference, initialStamp, newStamp);</span><br><span class="line">        System.out.println(<span class="string">&quot;currentValue=&quot;</span> + asr.getReference()</span><br><span class="line">                + <span class="string">&quot;, currentStamp=&quot;</span> + asr.getStamp()</span><br><span class="line">                + <span class="string">&quot;, casResult=&quot;</span> + casResult);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è·å–å½“å‰çš„å€¼å’Œå½“å‰çš„ stamp å€¼</span></span><br><span class="line">        <span class="keyword">int</span>[] arr = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">1</span>];</span><br><span class="line">        <span class="keyword">final</span> Integer currentValue = asr.get(arr);</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> currentStamp = arr[<span class="number">0</span>];</span><br><span class="line">        System.out.println(<span class="string">&quot;currentValue=&quot;</span> + currentValue + <span class="string">&quot;, currentStamp=&quot;</span> + currentStamp);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å•ç‹¬è®¾ç½® stamp å€¼</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> attemptStampResult = asr.attemptStamp(newReference, <span class="number">88</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;currentValue=&quot;</span> + asr.getReference()</span><br><span class="line">                + <span class="string">&quot;, currentStamp=&quot;</span> + asr.getStamp()</span><br><span class="line">                + <span class="string">&quot;, attemptStampResult=&quot;</span> + attemptStampResult);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// é‡æ–°è®¾ç½®å½“å‰å€¼å’Œ stamp å€¼</span></span><br><span class="line">        asr.set(initialRef, initialStamp);</span><br><span class="line">        System.out.println(<span class="string">&quot;currentValue=&quot;</span> + asr.getReference() + <span class="string">&quot;, currentStamp=&quot;</span> + asr.getStamp());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// [ä¸æ¨èä½¿ç”¨ï¼Œé™¤éææ¸…æ¥šæ³¨é‡Šçš„æ„æ€äº†] weak compare and set</span></span><br><span class="line">        <span class="comment">// å›°æƒ‘ï¼weakCompareAndSet è¿™ä¸ªæ–¹æ³•æœ€ç»ˆè¿˜æ˜¯è°ƒç”¨ compareAndSet æ–¹æ³•ã€‚[ç‰ˆæœ¬: jdk-8u191]</span></span><br><span class="line">        <span class="comment">// ä½†æ˜¯æ³¨é‡Šä¸Šå†™ç€ &quot;May fail spuriously and does not provide ordering guarantees,</span></span><br><span class="line">        <span class="comment">// so is only rarely an appropriate alternative to compareAndSet.&quot;</span></span><br><span class="line">        <span class="comment">// todo æ„Ÿè§‰æœ‰å¯èƒ½æ˜¯ jvm é€šè¿‡æ–¹æ³•ååœ¨ native æ–¹æ³•é‡Œé¢åšäº†è½¬å‘</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> wCasResult = asr.weakCompareAndSet(initialRef, newReference, initialStamp, newStamp);</span><br><span class="line">        System.out.println(<span class="string">&quot;currentValue=&quot;</span> + asr.getReference()</span><br><span class="line">                + <span class="string">&quot;, currentStamp=&quot;</span> + asr.getStamp()</span><br><span class="line">                + <span class="string">&quot;, wCasResult=&quot;</span> + wCasResult);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¾“å‡ºç»“æœå¦‚ä¸‹ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">currentValue=0, currentStamp=0</span><br><span class="line">currentValue=666, currentStamp=999, casResult=true</span><br><span class="line">currentValue=666, currentStamp=999</span><br><span class="line">currentValue=666, currentStamp=88, attemptStampResult=true</span><br><span class="line">currentValue=0, currentStamp=0</span><br><span class="line">currentValue=666, currentStamp=999, wCasResult=true</span><br></pre></td></tr></table></figure>

<h3 id="AtomicMarkableReference-ç±»ä½¿ç”¨ç¤ºä¾‹"><a href="#AtomicMarkableReference-ç±»ä½¿ç”¨ç¤ºä¾‹" class="headerlink" title="AtomicMarkableReference ç±»ä½¿ç”¨ç¤ºä¾‹"></a>AtomicMarkableReference ç±»ä½¿ç”¨ç¤ºä¾‹</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.concurrent.atomic.AtomicMarkableReference;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AtomicMarkableReferenceDemo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// å®ä¾‹åŒ–ã€å–å½“å‰å€¼å’Œ mark å€¼</span></span><br><span class="line">        <span class="keyword">final</span> Boolean initialRef = <span class="keyword">null</span>, initialMark = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">final</span> AtomicMarkableReference&lt;Boolean&gt; amr = <span class="keyword">new</span> AtomicMarkableReference&lt;&gt;(initialRef, initialMark);</span><br><span class="line">        System.out.println(<span class="string">&quot;currentValue=&quot;</span> + amr.getReference() + <span class="string">&quot;, currentMark=&quot;</span> + amr.isMarked());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// compare and set</span></span><br><span class="line">        <span class="keyword">final</span> Boolean newReference1 = <span class="keyword">true</span>, newMark1 = <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> casResult = amr.compareAndSet(initialRef, newReference1, initialMark, newMark1);</span><br><span class="line">        System.out.println(<span class="string">&quot;currentValue=&quot;</span> + amr.getReference()</span><br><span class="line">                + <span class="string">&quot;, currentMark=&quot;</span> + amr.isMarked()</span><br><span class="line">                + <span class="string">&quot;, casResult=&quot;</span> + casResult);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è·å–å½“å‰çš„å€¼å’Œå½“å‰çš„ mark å€¼</span></span><br><span class="line">        <span class="keyword">boolean</span>[] arr = <span class="keyword">new</span> <span class="keyword">boolean</span>[<span class="number">1</span>];</span><br><span class="line">        <span class="keyword">final</span> Boolean currentValue = amr.get(arr);</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> currentMark = arr[<span class="number">0</span>];</span><br><span class="line">        System.out.println(<span class="string">&quot;currentValue=&quot;</span> + currentValue + <span class="string">&quot;, currentMark=&quot;</span> + currentMark);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å•ç‹¬è®¾ç½® mark å€¼</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> attemptMarkResult = amr.attemptMark(newReference1, <span class="keyword">false</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;currentValue=&quot;</span> + amr.getReference()</span><br><span class="line">                + <span class="string">&quot;, currentMark=&quot;</span> + amr.isMarked()</span><br><span class="line">                + <span class="string">&quot;, attemptMarkResult=&quot;</span> + attemptMarkResult);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// é‡æ–°è®¾ç½®å½“å‰å€¼å’Œ mark å€¼</span></span><br><span class="line">        amr.set(initialRef, initialMark);</span><br><span class="line">        System.out.println(<span class="string">&quot;currentValue=&quot;</span> + amr.getReference() + <span class="string">&quot;, currentMark=&quot;</span> + amr.isMarked());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// [ä¸æ¨èä½¿ç”¨ï¼Œé™¤éææ¸…æ¥šæ³¨é‡Šçš„æ„æ€äº†] weak compare and set</span></span><br><span class="line">        <span class="comment">// å›°æƒ‘ï¼weakCompareAndSet è¿™ä¸ªæ–¹æ³•æœ€ç»ˆè¿˜æ˜¯è°ƒç”¨ compareAndSet æ–¹æ³•ã€‚[ç‰ˆæœ¬: jdk-8u191]</span></span><br><span class="line">        <span class="comment">// ä½†æ˜¯æ³¨é‡Šä¸Šå†™ç€ &quot;May fail spuriously and does not provide ordering guarantees,</span></span><br><span class="line">        <span class="comment">// so is only rarely an appropriate alternative to compareAndSet.&quot;</span></span><br><span class="line">        <span class="comment">// todo æ„Ÿè§‰æœ‰å¯èƒ½æ˜¯ jvm é€šè¿‡æ–¹æ³•ååœ¨ native æ–¹æ³•é‡Œé¢åšäº†è½¬å‘</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> wCasResult = amr.weakCompareAndSet(initialRef, newReference1, initialMark, newMark1);</span><br><span class="line">        System.out.println(<span class="string">&quot;currentValue=&quot;</span> + amr.getReference()</span><br><span class="line">                + <span class="string">&quot;, currentMark=&quot;</span> + amr.isMarked()</span><br><span class="line">                + <span class="string">&quot;, wCasResult=&quot;</span> + wCasResult);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¾“å‡ºç»“æœå¦‚ä¸‹ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">currentValue=null, currentMark=false</span><br><span class="line">currentValue=true, currentMark=true, casResult=true</span><br><span class="line">currentValue=true, currentMark=true</span><br><span class="line">currentValue=true, currentMark=false, attemptMarkResult=true</span><br><span class="line">currentValue=null, currentMark=false</span><br><span class="line">currentValue=true, currentMark=true, wCasResult=true</span><br></pre></td></tr></table></figure>

<h2 id="å¯¹è±¡çš„å±æ€§ä¿®æ”¹ç±»å‹åŸå­ç±»"><a href="#å¯¹è±¡çš„å±æ€§ä¿®æ”¹ç±»å‹åŸå­ç±»" class="headerlink" title="å¯¹è±¡çš„å±æ€§ä¿®æ”¹ç±»å‹åŸå­ç±»"></a>å¯¹è±¡çš„å±æ€§ä¿®æ”¹ç±»å‹åŸå­ç±»</h2><h3 id="å¯¹è±¡çš„å±æ€§ä¿®æ”¹ç±»å‹åŸå­ç±»ä»‹ç»"><a href="#å¯¹è±¡çš„å±æ€§ä¿®æ”¹ç±»å‹åŸå­ç±»ä»‹ç»" class="headerlink" title="å¯¹è±¡çš„å±æ€§ä¿®æ”¹ç±»å‹åŸå­ç±»ä»‹ç»"></a>å¯¹è±¡çš„å±æ€§ä¿®æ”¹ç±»å‹åŸå­ç±»ä»‹ç»</h3><p>å¦‚æœéœ€è¦åŸå­æ›´æ–°æŸä¸ªç±»é‡Œçš„æŸä¸ªå­—æ®µæ—¶ï¼Œéœ€è¦ç”¨åˆ°å¯¹è±¡çš„å±æ€§ä¿®æ”¹ç±»å‹åŸå­ç±»ã€‚</p>
<ul>
<li>AtomicIntegerFieldUpdater:åŸå­æ›´æ–°æ•´å½¢å­—æ®µçš„æ›´æ–°å™¨</li>
<li>AtomicLongFieldUpdaterï¼šåŸå­æ›´æ–°é•¿æ•´å½¢å­—æ®µçš„æ›´æ–°å™¨</li>
<li>AtomicReferenceFieldUpdater ï¼šåŸå­æ›´æ–°å¼•ç”¨ç±»å‹é‡Œçš„å­—æ®µçš„æ›´æ–°å™¨</li>
</ul>
<p>è¦æƒ³åŸå­åœ°æ›´æ–°å¯¹è±¡çš„å±æ€§éœ€è¦ä¸¤æ­¥ã€‚ç¬¬ä¸€æ­¥ï¼Œå› ä¸ºå¯¹è±¡çš„å±æ€§ä¿®æ”¹ç±»å‹åŸå­ç±»éƒ½æ˜¯æŠ½è±¡ç±»ï¼Œæ‰€ä»¥æ¯æ¬¡ä½¿ç”¨éƒ½å¿…é¡»ä½¿ç”¨é™æ€æ–¹æ³• newUpdater()åˆ›å»ºä¸€ä¸ªæ›´æ–°å™¨ï¼Œå¹¶ä¸”éœ€è¦è®¾ç½®æƒ³è¦æ›´æ–°çš„ç±»å’Œå±æ€§ã€‚ç¬¬äºŒæ­¥ï¼Œæ›´æ–°çš„å¯¹è±¡å±æ€§å¿…é¡»ä½¿ç”¨ public volatile ä¿®é¥°ç¬¦ã€‚</p>
<p>ä¸Šé¢ä¸‰ä¸ªç±»æä¾›çš„æ–¹æ³•å‡ ä¹ç›¸åŒï¼Œæ‰€ä»¥æˆ‘ä»¬è¿™é‡Œä»¥ <code>AtomicIntegerFieldUpdater</code>ä¸ºä¾‹å­æ¥ä»‹ç»ã€‚</p>
<h3 id="AtomicIntegerFieldUpdater-ç±»ä½¿ç”¨ç¤ºä¾‹"><a href="#AtomicIntegerFieldUpdater-ç±»ä½¿ç”¨ç¤ºä¾‹" class="headerlink" title="AtomicIntegerFieldUpdater ç±»ä½¿ç”¨ç¤ºä¾‹"></a>AtomicIntegerFieldUpdater ç±»ä½¿ç”¨ç¤ºä¾‹</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.concurrent.atomic.AtomicIntegerFieldUpdater;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AtomicIntegerFieldUpdaterTest</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">		AtomicIntegerFieldUpdater&lt;User&gt; a = AtomicIntegerFieldUpdater.newUpdater(User.class, <span class="string">&quot;age&quot;</span>);</span><br><span class="line"></span><br><span class="line">		User user = <span class="keyword">new</span> User(<span class="string">&quot;Java&quot;</span>, <span class="number">22</span>);</span><br><span class="line">		System.out.println(a.getAndIncrement(user));<span class="comment">// 22</span></span><br><span class="line">		System.out.println(a.get(user));<span class="comment">// 23</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">	<span class="keyword">private</span> String name;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">volatile</span> <span class="keyword">int</span> age;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">User</span><span class="params">(String name, <span class="keyword">int</span> age)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>();</span><br><span class="line">		<span class="keyword">this</span>.name = name;</span><br><span class="line">		<span class="keyword">this</span>.age = age;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> name;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.name = name;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getAge</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> age;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAge</span><span class="params">(<span class="keyword">int</span> age)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.age = age;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¾“å‡ºç»“æœï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">22</span><br><span class="line">23</span><br></pre></td></tr></table></figure>



<h1 id="LongAdder"><a href="#LongAdder" class="headerlink" title="LongAdder"></a>LongAdder</h1><p><strong>LongAdderå®ç°åŸç†å›¾</strong></p>
<img src="https://img-blog.csdnimg.cn/20200105170054240.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2ppYW5ndGlhbmppYW8=,size_16,color_FFFFFF,t_70" alt="img" style="zoom:67%;" />

<p>LongAdderåˆ™æ˜¯å†…éƒ¨ç»´æŠ¤ä¸€ä¸ªCellsæ•°ç»„ï¼Œæ¯ä¸ªCellé‡Œé¢æœ‰ä¸€ä¸ªåˆå§‹å€¼ä¸º0çš„longå‹å˜é‡ï¼Œåœ¨åŒç­‰å¹¶å‘é‡çš„æƒ…å†µä¸‹ï¼Œäº‰å¤ºå•ä¸ªå˜é‡çš„çº¿ç¨‹ä¼šå‡å°‘ï¼Œè¿™æ˜¯å˜ç›¸çš„å‡å°‘äº†äº‰å¤ºå…±äº«èµ„æºçš„å¹¶å‘é‡ï¼Œå¦å¤–å¤šä¸ªçº¿ç¨‹åœ¨äº‰å¤ºåŒä¸€ä¸ªåŸå­å˜é‡æ—¶å€™ï¼Œå¦‚æœå¤±è´¥å¹¶ä¸æ˜¯è‡ªæ—‹CASé‡è¯•ï¼Œè€Œæ˜¯å°è¯•è·å–å…¶ä»–åŸå­å˜é‡çš„é”ï¼Œæœ€åå½“è·å–å½“å‰å€¼æ—¶å€™æ˜¯æŠŠæ‰€æœ‰å˜é‡çš„å€¼ç´¯åŠ åå†åŠ ä¸Šbaseçš„å€¼è¿”å›çš„ã€‚</p>
<p>LongAdderç»´æŠ¤äº†è¦ç»™å»¶è¿Ÿåˆå§‹åŒ–çš„åŸå­æ€§æ›´æ–°æ•°ç»„å’Œä¸€ä¸ªåŸºå€¼å˜é‡baseæ•°ç»„çš„å¤§å°ä¿æŒæ˜¯2çš„Næ¬¡æ–¹å¤§å°ï¼Œæ•°ç»„è¡¨çš„ä¸‹æ ‡ä½¿ç”¨æ¯ä¸ªçº¿ç¨‹çš„hashcodeå€¼çš„æ©ç è¡¨ç¤ºï¼Œæ•°ç»„é‡Œé¢çš„å˜é‡å®ä½“æ˜¯Cellç±»å‹ã€‚</p>
<p>Cell ç±»å‹æ˜¯Atomicçš„ä¸€ä¸ªæ”¹è¿›ï¼Œç”¨æ¥å‡å°‘ç¼“å­˜çš„äº‰ç”¨ï¼Œå¯¹äºå¤§å¤šæ•°åŸå­æ“ä½œå­—èŠ‚å¡«å……æ˜¯æµªè´¹çš„ï¼Œå› ä¸ºåŸå­æ“ä½œéƒ½æ˜¯æ— è§„å¾‹çš„åˆ†æ•£åœ¨å†…å­˜ä¸­è¿›è¡Œçš„ï¼Œå¤šä¸ªåŸå­æ€§æ“ä½œå½¼æ­¤ä¹‹é—´æ˜¯æ²¡æœ‰æ¥è§¦çš„ï¼Œä½†æ˜¯åŸå­æ€§æ•°ç»„å…ƒç´ å½¼æ­¤ç›¸é‚»å­˜æ”¾å°†èƒ½ç»å¸¸å…±äº«ç¼“å­˜è¡Œï¼Œä¹Ÿå°±æ˜¯ä¼ªå…±äº«ã€‚æ‰€ä»¥è¿™åœ¨æ€§èƒ½ä¸Šæ˜¯ä¸€ä¸ªæå‡ã€‚</p>
<p>å¦å¤–ç”±äºCellså ç”¨å†…å­˜æ˜¯ç›¸å¯¹æ¯”è¾ƒå¤§çš„ï¼Œæ‰€ä»¥ä¸€å¼€å§‹å¹¶ä¸åˆ›å»ºï¼Œè€Œæ˜¯åœ¨éœ€è¦æ—¶å€™å†åˆ›å»ºï¼Œä¹Ÿå°±æ˜¯æƒ°æ€§åŠ è½½ï¼Œå½“ä¸€å¼€å§‹æ²¡æœ‰ç©ºé—´æ—¶å€™ï¼Œæ‰€æœ‰çš„æ›´æ–°éƒ½æ˜¯æ“ä½œbaseå˜é‡ã€‚</p>
<p><strong>LongAdderç±»å…³ç³»å›¾</strong></p>
<p><img src="https://img-blog.csdnimg.cn/20200105170951382.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2ppYW5ndGlhbmppYW8=,size_16,color_FFFFFF,t_70" alt="img"></p>
<p><strong>Striped64ç±»</strong><br>Striped64æ˜¯ä¸€ä¸ªé«˜å¹¶å‘ç´¯åŠ çš„å·¥å…·ç±»ã€‚<br>Striped64çš„è®¾è®¡æ ¸å¿ƒæ€è·¯å°±æ˜¯é€šè¿‡å†…éƒ¨çš„åˆ†æ•£è®¡ç®—æ¥é¿å…ç«äº‰ã€‚<br>Striped64å†…éƒ¨åŒ…å«ä¸€ä¸ªbaseå’Œä¸€ä¸ªCell[] cellsæ•°ç»„ï¼Œåˆå«hashè¡¨ã€‚<br>æ²¡æœ‰ç«äº‰çš„æƒ…å†µä¸‹ï¼Œè¦ç´¯åŠ çš„æ•°é€šè¿‡casç´¯åŠ åˆ°baseä¸Šï¼›å¦‚æœæœ‰ç«äº‰çš„è¯ï¼Œä¼šå°†è¦ç´¯åŠ çš„æ•°ç´¯åŠ åˆ°Cellsæ•°ç»„ä¸­çš„æŸä¸ªcellå…ƒç´ é‡Œé¢ã€‚æ‰€ä»¥æ•´ä¸ªStriped64çš„å€¼ä¸ºsum=base+âˆ‘[0~n]cellsã€‚</p>
<p>Striped64æ ¸å¿ƒå±æ€§<br>transient volatile Cell[] cells; // å­˜æ”¾cellçš„hashè¡¨ï¼Œå¤§å°ä¸º2ä¹˜å¹‚<br>transient volatile long base; // åŸºç¡€å€¼ï¼ˆ1.æ— ç«äº‰æ—¶æ›´æ–°ï¼Œ2.cellsæ•°ç»„åˆå§‹åŒ–è¿‡ç¨‹ä¸å¯ç”¨æ—¶ï¼Œä¹Ÿä¼šé€šè¿‡casç´¯åŠ åˆ°baseï¼‰<br>transient volatile int cellsBusy;  // è‡ªæ—‹é”ï¼Œé€šè¿‡CASæ“ä½œåŠ é”ï¼ˆ1.åˆå§‹åŒ–cellsæ•°ç»„ï¼Œ2.åˆ›å»ºcellå•å…ƒï¼Œ3.cellsæ‰©å®¹ï¼‰</p>
<p>æˆå‘˜å˜é‡cells<br>cellsæ•°ç»„æ˜¯LongAdderé«˜æ€§èƒ½å®ç°çš„å¿…æ€å™¨ï¼š<br>AtomicIntegeråªæœ‰ä¸€ä¸ªvalueï¼Œæ‰€æœ‰çº¿ç¨‹ç´¯åŠ éƒ½è¦é€šè¿‡casç«äº‰valueè¿™ä¸€ä¸ªå˜é‡ï¼Œé«˜å¹¶å‘ä¸‹çº¿ç¨‹äº‰ç”¨éå¸¸ä¸¥é‡ï¼›<br>è€ŒLongAdderåˆ™æœ‰ä¸¤ä¸ªå€¼ç”¨äºç´¯åŠ ï¼Œä¸€ä¸ªæ˜¯baseï¼Œå®ƒçš„ä½œç”¨ç±»ä¼¼äºAtomicIntegeré‡Œé¢çš„valueï¼Œåœ¨æ²¡æœ‰ç«äº‰çš„æƒ…å†µä¸ä¼šç”¨åˆ°cellsæ•°ç»„ï¼Œè¿™æ—¶ä½¿ç”¨baseåšç´¯åŠ ï¼Œæœ‰äº†ç«äº‰åcellsæ•°ç»„å°±ä¸Šåœºäº†ï¼Œç¬¬ä¸€æ¬¡åˆå§‹åŒ–é•¿åº¦ä¸º2ï¼Œä»¥åæ¯æ¬¡æ‰©å®¹éƒ½æ˜¯å˜ä¸ºåŸæ¥çš„ä¸¤å€ï¼Œç›´åˆ°cellsæ•°ç»„çš„é•¿åº¦å¤§äºç­‰äºå½“å‰æœåŠ¡å™¨cpuçš„æ•°é‡ä¸ºæ­¢å°±ä¸åœ¨æ‰©å®¹ï¼ˆ<strong>CPUèƒ½å¤Ÿå¹¶è¡Œçš„CASæ“ä½œçš„æœ€å¤§æ•°é‡æ˜¯å®ƒçš„æ ¸å¿ƒæ•°</strong>ï¼‰ï¼Œæ¯ä¸ªçº¿ç¨‹ä¼šé€šè¿‡çº¿ç¨‹å¯¹cells[threadLocalRandomProbe%cells.length]ä½ç½®çš„Cellå¯¹è±¡ä¸­çš„valueåšç´¯åŠ ï¼Œè¿™æ ·ç›¸å½“äºå°†çº¿ç¨‹ç»‘å®šåˆ°äº†cellsä¸­çš„æŸä¸ªcellå¯¹è±¡ä¸Šã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä¸ºæé«˜æ€§èƒ½ï¼Œä½¿ç”¨æ³¨è§£@sun.misc.Contendedï¼Œç”¨æ¥é¿å…ä¼ªå…±äº«</span></span><br><span class="line"><span class="comment">// ä¼ªå…±äº«ç®€å•æ¥è¯´å°±æ˜¯ä¼šç ´åå…¶å®ƒçº¿ç¨‹åœ¨ç¼“å­˜è¡Œä¸­çš„å€¼ï¼Œå¯¼è‡´é‡æ–°ä»ä¸»å†…å­˜è¯»å–ï¼Œé™ä½æ€§èƒ½ã€‚</span></span><br><span class="line"><span class="meta">@sun</span>.misc.Contended <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Cell</span> </span>&#123;</span><br><span class="line">       <span class="comment">//ç”¨æ¥ä¿å­˜è¦ç´¯åŠ çš„å€¼</span></span><br><span class="line">       <span class="keyword">volatile</span> <span class="keyword">long</span> value;</span><br><span class="line">       Cell(<span class="keyword">long</span> x) &#123; value = x; &#125;</span><br><span class="line">       <span class="comment">//ä½¿ç”¨UNSAFEç±»çš„casæ¥æ›´æ–°valueå€¼</span></span><br><span class="line">       <span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">cas</span><span class="params">(<span class="keyword">long</span> cmp, <span class="keyword">long</span> val)</span> </span>&#123;</span><br><span class="line">           <span class="keyword">return</span> UNSAFE.compareAndSwapLong(<span class="keyword">this</span>, valueOffset, cmp, val);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> sun.misc.Unsafe UNSAFE;</span><br><span class="line">       <span class="comment">//valueåœ¨Cellç±»ä¸­å­˜å‚¨ä½ç½®çš„åç§»é‡ï¼›</span></span><br><span class="line">       <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> valueOffset;</span><br><span class="line">       <span class="comment">//è¿™ä¸ªé™æ€æ–¹æ³•ç”¨äºè·å–åç§»é‡</span></span><br><span class="line">       <span class="keyword">static</span> &#123;</span><br><span class="line">           <span class="keyword">try</span> &#123;</span><br><span class="line">               UNSAFE = sun.misc.Unsafe.getUnsafe();</span><br><span class="line">               Class&lt;?&gt; ak = Cell.class;</span><br><span class="line">               valueOffset = UNSAFE.objectFieldOffset</span><br><span class="line">                   (ak.getDeclaredField(<span class="string">&quot;value&quot;</span>));</span><br><span class="line">           &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">               <span class="keyword">throw</span> <span class="keyword">new</span> Error(e);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>æˆå‘˜å˜é‡cellsBusy<br>cellsBusyä½œç”¨æ˜¯å½“è¦ä¿®æ”¹cellsæ•°ç»„æ—¶åŠ é”ï¼Œé˜²æ­¢å¤šçº¿ç¨‹åŒæ—¶ä¿®æ”¹cellsæ•°ç»„ï¼Œ0ä¸ºæ— é”ï¼Œ1ä¸ºåŠ é”ï¼ŒåŠ é”çš„çŠ¶å†µæœ‰ä¸‰ç§ </p>
<ol>
<li>cellsæ•°ç»„åˆå§‹åŒ–çš„æ—¶å€™</li>
<li>cellsæ•°ç»„æ‰©å®¹çš„æ—¶å€™</li>
<li>å¦‚æœcellsæ•°ç»„ä¸­æŸä¸ªå…ƒç´ ä¸ºnullï¼Œç»™è¿™ä¸ªä½ç½®åˆ›å»ºæ–°çš„Cellå¯¹è±¡çš„æ—¶å€™</li>
</ol>
<p>æˆå‘˜å˜é‡base<br>å®ƒæœ‰ä¸¤ä¸ªä½œç”¨ï¼š </p>
<ol>
<li>åœ¨å¼€å§‹æ²¡æœ‰ç«äº‰çš„æƒ…å†µä¸‹ï¼Œå°†ç´¯åŠ å€¼ç´¯åŠ åˆ°base </li>
<li>åœ¨cellsåˆå§‹åŒ–çš„è¿‡ç¨‹ä¸­ï¼Œcellsä¸å¯ç”¨ï¼Œè¿™æ—¶ä¼šå°è¯•å°†å€¼ç´¯åŠ åˆ°baseä¸Š</li>
</ol>
<p><strong>LongAdder</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç´¯åŠ æ–¹æ³•ï¼Œå‚æ•°xä¸ºç´¯åŠ çš„å€¼    </span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(<span class="keyword">long</span> x)</span> </span>&#123;</span><br><span class="line">    	<span class="comment">/**</span></span><br><span class="line"><span class="comment">    	* as è¡¨ç¤ºcellså¼•ç”¨</span></span><br><span class="line"><span class="comment">    	* b è¡¨ç¤ºè·å–çš„baseå€¼</span></span><br><span class="line"><span class="comment">    	* v è¡¨ç¤ºæœŸæœ›å€¼</span></span><br><span class="line"><span class="comment">    	* m è¡¨ç¤ºcellsæ•°ç»„çš„é•¿åº¦</span></span><br><span class="line"><span class="comment">    	* a è¡¨ç¤ºå½“å‰çº¿ç¨‹å‘½ä¸­çš„cellå•å…ƒæ ¼</span></span><br><span class="line"><span class="comment">    	/</span></span><br><span class="line"><span class="comment">        Cell[] as; long b, v; int m; Cell a;</span></span><br><span class="line"><span class="comment">        /**</span></span><br><span class="line"><span class="comment">         * å¦‚æœä¸€ä¸‹ä¸¤ç§æ¡ä»¶åˆ™ç»§ç»­æ‰§è¡Œifå†…çš„è¯­å¥</span></span><br><span class="line"><span class="comment">         * 1. cellsæ•°ç»„ä¸ä¸ºnullï¼ˆä¸å­˜åœ¨äº‰ç”¨çš„æ—¶å€™ï¼Œcellsæ•°ç»„ä¸€å®šä¸ºnullï¼Œä¸€æ—¦å¯¹baseçš„casæ“ä½œå¤±è´¥ï¼Œæ‰ä¼šåˆå§‹åŒ–cellsæ•°ç»„ï¼‰</span></span><br><span class="line"><span class="comment">         * 2. å¦‚æœcellsæ•°ç»„ä¸ºnullï¼Œå¦‚æœcasBaseæ‰§è¡ŒæˆåŠŸï¼Œåˆ™ç›´æ¥è¿”å›ï¼Œå¦‚æœcasBaseæ–¹æ³•æ‰§è¡Œå¤±è´¥ï¼ˆcasBaseå¤±è´¥ï¼Œè¯´æ˜ç¬¬ä¸€æ¬¡äº‰ç”¨å†²çªäº§ç”Ÿï¼Œéœ€è¦å¯¹cellsæ•°ç»„åˆå§‹åŒ–ï¼‰è¿›å…¥ifå†…ï¼›</span></span><br><span class="line"><span class="comment">         * casBaseæ–¹æ³•å¾ˆç®€å•ï¼Œå°±æ˜¯é€šè¿‡UNSAFEç±»çš„casè®¾ç½®æˆå‘˜å˜é‡baseçš„å€¼ä¸ºbase+è¦ç´¯åŠ çš„å€¼</span></span><br><span class="line"><span class="comment">         * casBaseæ‰§è¡ŒæˆåŠŸçš„å‰ææ˜¯æ— ç«äº‰ï¼Œè¿™æ—¶å€™cellsæ•°ç»„è¿˜æ²¡æœ‰ç”¨åˆ°ä¸ºnullï¼Œå¯è§åœ¨æ— ç«äº‰çš„æƒ…å†µä¸‹æ˜¯ç±»ä¼¼äºAtomticIntegerå¤„ç†æ–¹å¼ï¼Œä½¿ç”¨casåšç´¯åŠ ã€‚</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">if</span> ((as = cells) != <span class="keyword">null</span> || !casBase(b = base, b + x)) &#123;</span><br><span class="line">            <span class="comment">//uncontendedåˆ¤æ–­cellsæ•°ç»„ä¸­ï¼Œå½“å‰çº¿ç¨‹è¦åšcasç´¯åŠ æ“ä½œçš„æŸä¸ªå…ƒç´ æ˜¯å¦#ä¸#å­˜åœ¨äº‰ç”¨ï¼Œå¦‚æœcaså¤±è´¥åˆ™å­˜åœ¨äº‰ç”¨ï¼›uncontended=falseä»£è¡¨å­˜åœ¨äº‰ç”¨ï¼Œuncontended=trueä»£è¡¨ä¸å­˜åœ¨äº‰ç”¨ã€‚</span></span><br><span class="line">            <span class="keyword">boolean</span> uncontended = <span class="keyword">true</span>;</span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">            *1. as == null ï¼š cellsæ•°ç»„æœªè¢«åˆå§‹åŒ–ï¼Œæˆç«‹åˆ™ç›´æ¥è¿›å…¥ifæ‰§è¡Œcellåˆå§‹åŒ–</span></span><br><span class="line"><span class="comment">            *2. (m = as.length - 1) &lt; 0ï¼š cellsæ•°ç»„çš„é•¿åº¦ä¸º0</span></span><br><span class="line"><span class="comment">            *æ¡ä»¶1ä¸2éƒ½ä»£è¡¨cellsæ•°ç»„æ²¡æœ‰è¢«åˆå§‹åŒ–æˆåŠŸï¼Œåˆå§‹åŒ–æˆåŠŸçš„cellsæ•°ç»„é•¿åº¦ä¸º2ï¼›</span></span><br><span class="line"><span class="comment">            *3. (a = as[getProbe() &amp; m]) == null ï¼šå¦‚æœcellsè¢«åˆå§‹åŒ–ï¼Œä¸”å®ƒçš„é•¿åº¦ä¸ä¸º0ï¼Œåˆ™é€šè¿‡getProbeæ–¹æ³•è·å–å½“å‰çº¿ç¨‹Threadçš„threadLocalRandomProbeå˜é‡çš„å€¼ï¼Œåˆå§‹ä¸º0ï¼Œç„¶åæ‰§è¡ŒthreadLocalRandomProbe&amp;(cells.length-1 ),ç›¸å½“äºm%cells.length;å¦‚æœcells[threadLocalRandomProbe%cells.length]çš„ä½ç½®ä¸ºnullï¼Œè¿™è¯´æ˜è¿™ä¸ªä½ç½®ä»æ¥æ²¡æœ‰çº¿ç¨‹åšè¿‡ç´¯åŠ ï¼Œéœ€è¦è¿›å…¥ifç»§ç»­æ‰§è¡Œï¼Œåœ¨è¿™ä¸ªä½ç½®åˆ›å»ºä¸€ä¸ªæ–°çš„Cellå¯¹è±¡ï¼›</span></span><br><span class="line"><span class="comment">            *4. !(uncontended = a.cas(v = a.value, v + x))ï¼šå°è¯•å¯¹cells[threadLocalRandomProbe%cells.length]ä½ç½®çš„Cellå¯¹è±¡ä¸­çš„valueå€¼åšç´¯åŠ æ“ä½œ,å¹¶è¿”å›æ“ä½œç»“æœ,å¦‚æœå¤±è´¥äº†åˆ™è¿›å…¥ifï¼Œé‡æ–°è®¡ç®—ä¸€ä¸ªthreadLocalRandomProbeï¼›</span></span><br><span class="line"><span class="comment">            å¦‚æœè¿›å…¥ifè¯­å¥æ‰§è¡ŒlongAccumulateæ–¹æ³•,æœ‰ä¸‰ç§æƒ…å†µ</span></span><br><span class="line"><span class="comment">            1. å‰ä¸¤ä¸ªæ¡ä»¶ä»£è¡¨cellsæ²¡æœ‰åˆå§‹åŒ–ï¼Œ</span></span><br><span class="line"><span class="comment">            2. ç¬¬ä¸‰ä¸ªæ¡ä»¶æŒ‡å½“å‰çº¿ç¨‹hashåˆ°çš„cellsæ•°ç»„ä¸­çš„ä½ç½®è¿˜æ²¡æœ‰å…¶å®ƒçº¿ç¨‹åšè¿‡ç´¯åŠ æ“ä½œï¼Œ</span></span><br><span class="line"><span class="comment">            3. ç¬¬å››ä¸ªæ¡ä»¶ä»£è¡¨äº§ç”Ÿäº†å†²çª,uncontended=false</span></span><br><span class="line"><span class="comment">            **/</span></span><br><span class="line">            <span class="keyword">if</span> (as == <span class="keyword">null</span> || (m = as.length - <span class="number">1</span>) &lt; <span class="number">0</span> ||</span><br><span class="line">                (a = as[getProbe() &amp; m]) == <span class="keyword">null</span> ||</span><br><span class="line">                !(uncontended = a.cas(v = a.value, v + x)))</span><br><span class="line">                longAccumulate(x, <span class="keyword">null</span>, uncontended);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">longAccumulate</span><span class="params">(<span class="keyword">long</span> x, LongBinaryOperator fn, <span class="keyword">boolean</span> wasUncontended)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//è·å–å½“å‰çº¿ç¨‹çš„threadLocalRandomProbeå€¼ä½œä¸ºhashå€¼,å¦‚æœå½“å‰çº¿ç¨‹çš„threadLocalRandomProbeä¸º0ï¼Œè¯´æ˜å½“å‰çº¿ç¨‹æ˜¯ç¬¬ä¸€æ¬¡è¿›å…¥è¯¥æ–¹æ³•ï¼Œåˆ™å¼ºåˆ¶è®¾ç½®çº¿ç¨‹çš„threadLocalRandomProbeä¸ºThreadLocalRandomç±»çš„æˆå‘˜é™æ€ç§æœ‰å˜é‡probeGeneratorçš„å€¼ï¼Œåé¢ä¼šè¯¦ç»†å°†hashå€¼çš„ç”Ÿæˆ;</span></span><br><span class="line">        <span class="comment">//å¦å¤–éœ€è¦æ³¨æ„ï¼Œå¦‚æœthreadLocalRandomProbe=0ï¼Œä»£è¡¨æ–°çš„çº¿ç¨‹å¼€å§‹å‚ä¸celläº‰ç”¨çš„æƒ…å†µ</span></span><br><span class="line">        <span class="comment">//1.å½“å‰çº¿ç¨‹ä¹‹å‰è¿˜æ²¡æœ‰å‚ä¸è¿‡cellsäº‰ç”¨ï¼ˆä¹Ÿè®¸cellsæ•°ç»„è¿˜æ²¡åˆå§‹åŒ–ï¼Œè¿›åˆ°å½“å‰æ–¹æ³•æ¥å°±æ˜¯ä¸ºäº†åˆå§‹åŒ–cellsæ•°ç»„åäº‰ç”¨çš„ï¼‰,æ˜¯ç¬¬ä¸€æ¬¡æ‰§è¡Œbaseçš„casç´¯åŠ æ“ä½œå¤±è´¥ï¼›</span></span><br><span class="line">        <span class="comment">//2.æˆ–è€…æ˜¯åœ¨æ‰§è¡Œaddæ–¹æ³•æ—¶ï¼Œå¯¹cellsæŸä¸ªä½ç½®çš„Cellçš„casæ“ä½œç¬¬ä¸€æ¬¡å¤±è´¥ï¼Œåˆ™å°†wasUncontendedè®¾ç½®ä¸ºfalseï¼Œé‚£ä¹ˆè¿™é‡Œä¼šå°†å…¶é‡æ–°ç½®ä¸ºtrueï¼›ç¬¬ä¸€æ¬¡æ‰§è¡Œæ“ä½œå¤±è´¥ï¼›</span></span><br><span class="line">       <span class="comment">//å‡¡æ˜¯å‚ä¸äº†celläº‰ç”¨æ“ä½œçš„çº¿ç¨‹threadLocalRandomProbeéƒ½ä¸ä¸º0ï¼›</span></span><br><span class="line">        <span class="keyword">int</span> h;</span><br><span class="line">        <span class="keyword">if</span> ((h = getProbe()) == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">//åˆå§‹åŒ–ThreadLocalRandom;</span></span><br><span class="line">            ThreadLocalRandom.current(); <span class="comment">// force initialization</span></span><br><span class="line">            <span class="comment">//å°†hè®¾ç½®ä¸º0x9e3779b9</span></span><br><span class="line">            h = getProbe();</span><br><span class="line">            <span class="comment">//è®¾ç½®æœªç«äº‰æ ‡è®°ä¸ºtrue</span></span><br><span class="line">            wasUncontended = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//caså†²çªæ ‡å¿—ï¼Œè¡¨ç¤ºå½“å‰çº¿ç¨‹hashåˆ°çš„Cellsæ•°ç»„çš„ä½ç½®ï¼Œåšcasç´¯åŠ æ“ä½œæ—¶ä¸å…¶å®ƒçº¿ç¨‹å‘ç”Ÿäº†å†²çªï¼Œcaså¤±è´¥ï¼›collide=trueä»£è¡¨æœ‰å†²çªï¼Œcollide=falseä»£è¡¨æ— å†²çª </span></span><br><span class="line">        <span class="keyword">boolean</span> collide = <span class="keyword">false</span>; </span><br><span class="line">        <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">            Cell[] as; Cell a; <span class="keyword">int</span> n; <span class="keyword">long</span> v;</span><br><span class="line">            <span class="comment">//è¿™ä¸ªä¸»å¹²ifæœ‰ä¸‰ä¸ªåˆ†æ”¯</span></span><br><span class="line">            <span class="comment">//1.ä¸»åˆ†æ”¯ä¸€ï¼šå¤„ç†cellsæ•°ç»„å·²ç»æ­£å¸¸åˆå§‹åŒ–äº†çš„æƒ…å†µï¼ˆè¿™ä¸ªifåˆ†æ”¯å¤„ç†addæ–¹æ³•çš„å››ä¸ªæ¡ä»¶ä¸­çš„3å’Œ4ï¼‰</span></span><br><span class="line">            <span class="comment">//2.ä¸»åˆ†æ”¯äºŒï¼šå¤„ç†cellsæ•°ç»„æ²¡æœ‰åˆå§‹åŒ–æˆ–è€…é•¿åº¦ä¸º0çš„æƒ…å†µï¼›ï¼ˆè¿™ä¸ªåˆ†æ”¯å¤„ç†addæ–¹æ³•çš„å››ä¸ªæ¡ä»¶ä¸­çš„1å’Œ2ï¼‰</span></span><br><span class="line">            <span class="comment">//3.ä¸»åˆ†æ”¯ä¸‰ï¼šå¤„ç†å¦‚æœcellæ•°ç»„æ²¡æœ‰åˆå§‹åŒ–ï¼Œå¹¶ä¸”å…¶å®ƒçº¿ç¨‹æ­£åœ¨æ‰§è¡Œå¯¹cellsæ•°ç»„åˆå§‹åŒ–çš„æ“ä½œï¼ŒåŠcellbusy=1ï¼›åˆ™å°è¯•å°†ç´¯åŠ å€¼é€šè¿‡casç´¯åŠ åˆ°baseä¸Š</span></span><br><span class="line">            <span class="comment">//å…ˆçœ‹ä¸»åˆ†æ”¯ä¸€</span></span><br><span class="line">            <span class="keyword">if</span> ((as = cells) != <span class="keyword">null</span> &amp;&amp; (n = as.length) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">/**</span></span><br><span class="line"><span class="comment">                 *å†…éƒ¨å°åˆ†æ”¯ä¸€ï¼šè¿™ä¸ªæ˜¯å¤„ç†addæ–¹æ³•å†…éƒ¨ifåˆ†æ”¯çš„æ¡ä»¶3ï¼šå¦‚æœè¢«hashåˆ°çš„ä½ç½®ä¸ºnullï¼Œè¯´æ˜æ²¡æœ‰çº¿ç¨‹åœ¨è¿™ä¸ªä½ç½®è®¾ç½®è¿‡å€¼ï¼Œæ²¡æœ‰ç«äº‰ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨ï¼Œåˆ™ç”¨xå€¼ä½œä¸ºåˆå§‹å€¼åˆ›å»ºä¸€ä¸ªæ–°çš„Cellå¯¹è±¡ï¼Œå¯¹cellsæ•°ç»„ä½¿ç”¨cellsBusyåŠ é”ï¼Œç„¶åå°†è¿™ä¸ªCellå¯¹è±¡æ”¾åˆ°cells[m%cells.length]ä½ç½®ä¸Š </span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line">                <span class="keyword">if</span> ((a = as[(n - <span class="number">1</span>) &amp; h]) == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="comment">//cellsBusy == 0 ä»£è¡¨å½“å‰æ²¡æœ‰çº¿ç¨‹cellsæ•°ç»„åšä¿®æ”¹</span></span><br><span class="line">                    <span class="keyword">if</span> (cellsBusy == <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="comment">//å°†è¦ç´¯åŠ çš„xå€¼ä½œä¸ºåˆå§‹å€¼åˆ›å»ºä¸€ä¸ªæ–°çš„Cellå¯¹è±¡ï¼Œ</span></span><br><span class="line">                        Cell r = <span class="keyword">new</span> Cell(x); </span><br><span class="line">                        <span class="comment">//å¦‚æœcellsBusy=0æ— é”ï¼Œåˆ™é€šè¿‡caså°†cellsBusyè®¾ç½®ä¸º1åŠ é”</span></span><br><span class="line">                        <span class="keyword">if</span> (cellsBusy == <span class="number">0</span> &amp;&amp; casCellsBusy()) &#123;</span><br><span class="line">                            <span class="comment">//æ ‡è®°Cellæ˜¯å¦åˆ›å»ºæˆåŠŸå¹¶æ”¾å…¥åˆ°cellsæ•°ç»„è¢«hashçš„ä½ç½®ä¸Š</span></span><br><span class="line">                            <span class="keyword">boolean</span> created = <span class="keyword">false</span>;</span><br><span class="line">                            <span class="keyword">try</span> &#123;</span><br><span class="line">                                Cell[] rs; <span class="keyword">int</span> m, j;</span><br><span class="line">                                <span class="comment">//å†æ¬¡æ£€æŸ¥cellsæ•°ç»„ä¸ä¸ºnullï¼Œä¸”é•¿åº¦ä¸ä¸ºç©ºï¼Œä¸”hashåˆ°çš„ä½ç½®çš„Cellä¸ºnull</span></span><br><span class="line">                                <span class="keyword">if</span> ((rs = cells) != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">                                    (m = rs.length) &gt; <span class="number">0</span> &amp;&amp;</span><br><span class="line">                                    rs[j = (m - <span class="number">1</span>) &amp; h] == <span class="keyword">null</span>) &#123;</span><br><span class="line">                                    <span class="comment">//å°†æ–°çš„cellè®¾ç½®åˆ°è¯¥ä½ç½®</span></span><br><span class="line">                                    rs[j] = r;</span><br><span class="line">                                    created = <span class="keyword">true</span>;</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                                <span class="comment">//å»æ‰é”</span></span><br><span class="line">                                cellsBusy = <span class="number">0</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="comment">//ç”ŸæˆæˆåŠŸï¼Œè·³å‡ºå¾ªç¯</span></span><br><span class="line">                            <span class="keyword">if</span> (created)</span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line">                            <span class="comment">//å¦‚æœcreatedä¸ºfalseï¼Œè¯´æ˜ä¸Šé¢æŒ‡å®šçš„cellsæ•°ç»„çš„ä½ç½®cells[m%cells.length]å·²ç»æœ‰å…¶å®ƒçº¿ç¨‹è®¾ç½®äº†celläº†ï¼Œç»§ç»­æ‰§è¡Œå¾ªç¯ã€‚</span></span><br><span class="line">                            <span class="keyword">continue</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                   <span class="comment">//å¦‚æœæ‰§è¡Œçš„å½“å‰è¡Œï¼Œä»£è¡¨cellsBusy=1ï¼Œæœ‰çº¿ç¨‹æ­£åœ¨æ›´æ”¹cellsæ•°ç»„ï¼Œä»£è¡¨äº§ç”Ÿäº†å†²çªï¼Œå°†collideè®¾ç½®ä¸ºfalse</span></span><br><span class="line">                    collide = <span class="keyword">false</span>;</span><br><span class="line"> </span><br><span class="line">                <span class="comment">/**</span></span><br><span class="line"><span class="comment">                 *å†…éƒ¨å°åˆ†æ”¯äºŒï¼šå¦‚æœaddæ–¹æ³•ä¸­æ¡ä»¶4çš„é€šè¿‡casè®¾ç½®cells[m%cells.length]ä½ç½®çš„Cellå¯¹è±¡ä¸­çš„valueå€¼è®¾ç½®ä¸ºv+xå¤±è´¥,è¯´æ˜å·²ç»å‘ç”Ÿç«äº‰ï¼Œå°†wasUncontendedè®¾ç½®ä¸ºtrueï¼Œè·³å‡ºå†…éƒ¨çš„ifåˆ¤æ–­ï¼Œæœ€åé‡æ–°è®¡ç®—ä¸€ä¸ªæ–°çš„probeï¼Œç„¶åé‡æ–°æ‰§è¡Œå¾ªç¯;</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!wasUncontended)  </span><br><span class="line">                    <span class="comment">//è®¾ç½®æœªç«äº‰æ ‡å¿—ä½trueï¼Œç»§ç»­æ‰§è¡Œï¼Œåé¢ä¼šç®—ä¸€ä¸ªæ–°çš„probeå€¼ï¼Œç„¶åé‡æ–°æ‰§è¡Œå¾ªç¯ã€‚ </span></span><br><span class="line">                    wasUncontended = <span class="keyword">true</span>;</span><br><span class="line">                <span class="comment">/**</span></span><br><span class="line"><span class="comment">                *å†…éƒ¨å°åˆ†æ”¯ä¸‰ï¼šæ–°çš„äº‰ç”¨çº¿ç¨‹å‚ä¸äº‰ç”¨çš„æƒ…å†µï¼šå¤„ç†åˆšè¿›å…¥å½“å‰æ–¹æ³•æ—¶threadLocalRandomProbe=0çš„æƒ…å†µï¼Œä¹Ÿå°±æ˜¯å½“å‰çº¿ç¨‹ç¬¬ä¸€æ¬¡å‚ä¸celläº‰ç”¨çš„caså¤±è´¥ï¼Œè¿™é‡Œä¼šå°è¯•å°†xå€¼åŠ åˆ°cells[m%cells.length]çš„value ï¼Œå¦‚æœæˆåŠŸç›´æ¥é€€å‡º  </span></span><br><span class="line"><span class="comment">                */</span></span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (a.cas(v = a.value, ((fn == <span class="keyword">null</span>) ? v + x :</span><br><span class="line">                                             fn.applyAsLong(v, x))))</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="comment">/**</span></span><br><span class="line"><span class="comment">                 *å†…éƒ¨å°åˆ†æ”¯å››ï¼šåˆ†æ”¯3å¤„ç†æ–°çš„çº¿ç¨‹äº‰ç”¨æ‰§è¡Œå¤±è´¥äº†ï¼Œè¿™æ—¶å¦‚æœcellsæ•°ç»„çš„é•¿åº¦å·²ç»åˆ°äº†æœ€å¤§å€¼ï¼ˆå¤§äºç­‰äºcupæ•°é‡ï¼‰ï¼Œæˆ–è€…æ˜¯å½“å‰cellså·²ç»åšäº†æ‰©å®¹ï¼Œåˆ™å°†collideè®¾ç½®ä¸ºfalseï¼Œåé¢é‡æ–°è®¡ç®—probçš„å€¼*/</span></span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (n &gt;= NCPU || cells != as)</span><br><span class="line">                    collide = <span class="keyword">false</span>;</span><br><span class="line">                <span class="comment">/**</span></span><br><span class="line"><span class="comment">                 *å†…éƒ¨å°åˆ†æ”¯äº”ï¼šå¦‚æœå‘ç”Ÿäº†å†²çªcollide=falseï¼Œåˆ™è®¾ç½®å…¶ä¸ºtrueï¼›ä¼šåœ¨æœ€åé‡æ–°è®¡ç®—hashå€¼åï¼Œè¿›å…¥ä¸‹ä¸€æ¬¡forå¾ªç¯</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (!collide)</span><br><span class="line">                    <span class="comment">//è®¾ç½®å†²çªæ ‡å¿—ï¼Œè¡¨ç¤ºå‘ç”Ÿäº†å†²çªï¼Œéœ€è¦å†æ¬¡ç”Ÿæˆhashï¼Œé‡è¯•ã€‚ å¦‚æœä¸‹æ¬¡é‡è¯•ä»»ç„¶èµ°åˆ°äº†æ”¹åˆ†æ”¯æ­¤æ—¶collide=trueï¼Œ!collideæ¡ä»¶ä¸æˆç«‹ï¼Œåˆ™èµ°åä¸€ä¸ªåˆ†æ”¯</span></span><br><span class="line">                    collide = <span class="keyword">true</span>;</span><br><span class="line">                <span class="comment">/**</span></span><br><span class="line"><span class="comment">                 *å†…éƒ¨å°åˆ†æ”¯å…­ï¼šæ‰©å®¹cellsæ•°ç»„ï¼Œæ–°å‚ä¸celläº‰ç”¨çš„çº¿ç¨‹ä¸¤æ¬¡å‡å¤±è´¥ï¼Œä¸”ç¬¦åˆåº“å®¹æ¡ä»¶ï¼Œä¼šæ‰§è¡Œè¯¥åˆ†æ”¯</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (cellsBusy == <span class="number">0</span> &amp;&amp; casCellsBusy()) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="comment">//æ£€æŸ¥cellsæ˜¯å¦å·²ç»è¢«æ‰©å®¹</span></span><br><span class="line">                        <span class="keyword">if</span> (cells == as) &#123;      <span class="comment">// Expand table unless stale</span></span><br><span class="line">                            Cell[] rs = <span class="keyword">new</span> Cell[n &lt;&lt; <span class="number">1</span>];</span><br><span class="line">                            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; ++i)</span><br><span class="line">                                rs[i] = as[i];</span><br><span class="line">                            cells = rs;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                        cellsBusy = <span class="number">0</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    collide = <span class="keyword">false</span>;</span><br><span class="line">                    <span class="keyword">continue</span>;                   <span class="comment">// Retry with expanded table</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//ä¸ºå½“å‰çº¿ç¨‹é‡æ–°è®¡ç®—hashå€¼</span></span><br><span class="line">                h = advanceProbe(h);</span><br><span class="line"> </span><br><span class="line">            <span class="comment">//è¿™ä¸ªå¤§çš„åˆ†æ”¯å¤„ç†addæ–¹æ³•ä¸­çš„æ¡ä»¶1ä¸æ¡ä»¶2æˆç«‹çš„æƒ…å†µï¼Œå¦‚æœcellè¡¨è¿˜æœªåˆå§‹åŒ–æˆ–è€…é•¿åº¦ä¸º0ï¼Œå…ˆå°è¯•è·å–cellsBusyé”ã€‚</span></span><br><span class="line">            &#125;<span class="keyword">else</span> <span class="keyword">if</span> (cellsBusy == <span class="number">0</span> &amp;&amp; cells == as &amp;&amp; casCellsBusy()) &#123;</span><br><span class="line">                <span class="keyword">boolean</span> init = <span class="keyword">false</span>;</span><br><span class="line">                <span class="keyword">try</span> &#123;  <span class="comment">// Initialize table</span></span><br><span class="line">                    <span class="comment">//åˆå§‹åŒ–cellsæ•°ç»„ï¼Œåˆå§‹å®¹é‡ä¸º2,å¹¶å°†xå€¼é€šè¿‡hash&amp;1ï¼Œæ”¾åˆ°0ä¸ªæˆ–ç¬¬1ä¸ªä½ç½®ä¸Š</span></span><br><span class="line">                    <span class="keyword">if</span> (cells == as) &#123;</span><br><span class="line">                        Cell[] rs = <span class="keyword">new</span> Cell[<span class="number">2</span>];</span><br><span class="line">                        rs[h &amp; <span class="number">1</span>] = <span class="keyword">new</span> Cell(x);</span><br><span class="line">                        cells = rs;</span><br><span class="line">                        init = <span class="keyword">true</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    <span class="comment">//è§£é”</span></span><br><span class="line">                    cellsBusy = <span class="number">0</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//å¦‚æœinitä¸ºtrueè¯´æ˜åˆå§‹åŒ–æˆåŠŸï¼Œè·³å‡ºå¾ªç¯</span></span><br><span class="line">                <span class="keyword">if</span> (init)</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             *å¦‚æœä»¥ä¸Šæ“ä½œéƒ½å¤±è´¥äº†ï¼Œåˆ™å°è¯•å°†å€¼ç´¯åŠ åˆ°baseä¸Šï¼›</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (casBase(v = base, ((fn == <span class="keyword">null</span>) ? v + x : fn.applyAsLong(v, x)))) <span class="comment">// Fall back on using base</span></span><br><span class="line">                <span class="keyword">break</span>;  </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><strong>hashç”Ÿæˆç­–ç•¥</strong><br>hashå†³å®šäº†å½“å‰çº¿ç¨‹å°†ç´¯åŠ å€¼å®šä½åˆ°å“ªä¸ªcellä¸­ï¼Œhashç®—æ³•å°¤å…¶é‡è¦ã€‚<br>hashå°±æ˜¯javaçš„Threadç±»é‡Œé¢æœ‰ä¸€ä¸ªæˆå‘˜å˜é‡ï¼Œåˆå§‹å€¼ä¸º0ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** Probe hash value; nonzero if threadLocalRandomSeed initialized */</span></span><br><span class="line"><span class="meta">@sun</span>.misc.Contended(<span class="string">&quot;tlr&quot;</span>) </span><br><span class="line"><span class="keyword">int</span> threadLocalRandomProbe;</span><br><span class="line"></span><br><span class="line"><span class="comment">// LongAdderçš„çˆ¶ç±»Striped64é‡Œé€šè¿‡getProbeæ–¹æ³•è·å–å½“å‰çº¿ç¨‹threadLocalRandomProbe</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">getProbe</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// PROBEæ˜¯threadLocalRandomProbeå˜é‡åœ¨Threadç±»é‡Œé¢çš„åç§»é‡</span></span><br><span class="line">    <span class="keyword">return</span> UNSAFE.getInt(Thread.currentThread(), PROBE);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// threadLocalRandomProbeåˆå§‹åŒ–</span></span><br><span class="line"><span class="comment">// çº¿ç¨‹å¯¹LongAdderçš„ç´¯åŠ æ“ä½œï¼Œåœ¨æ²¡æœ‰è¿›å…¥longAccumulateæ–¹æ³•å‰ï¼ŒthreadLocalRandomProbeä¸€ç›´éƒ½æ˜¯0ï¼Œå½“å‘ç”Ÿäº‰ç”¨åæ‰ä¼šè¿›å…¥longAccumulateæ–¹æ³•ä¸­ï¼Œè¿›å…¥è¯¥æ–¹æ³•ç¬¬ä¸€ä»¶äº‹å°±æ˜¯åˆ¤æ–­threadLocalRandomProbeæ˜¯å¦ä¸º0ï¼Œå¦‚æœä¸º0ï¼Œåˆ™å°†å…¶è®¾ç½®ä¸º0x9e3779b9</span></span><br><span class="line"><span class="keyword">int</span> h;</span><br><span class="line"><span class="keyword">if</span> ((h = getProbe()) == <span class="number">0</span>) &#123;</span><br><span class="line">   ThreadLocalRandom.current(); </span><br><span class="line">   h = getProbe();</span><br><span class="line">   <span class="comment">//è®¾ç½®æœªç«äº‰æ ‡è®°ä¸ºtrue</span></span><br><span class="line">   wasUncontended = <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">localInit</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   <span class="comment">// private static final AtomicInteger probeGenerator = new AtomicInteger();</span></span><br><span class="line">   <span class="comment">// private static final int PROBE_INCREMENT = 0x9e3779b9;</span></span><br><span class="line">   <span class="keyword">int</span> p = probeGenerator.addAndGet(PROBE_INCREMENT);</span><br><span class="line">   <span class="keyword">int</span> probe = (p == <span class="number">0</span>) ? <span class="number">1</span> : p; <span class="comment">// skip 0</span></span><br><span class="line">   <span class="keyword">long</span> seed = mix64(seeder.getAndAdd(SEEDER_INCREMENT));</span><br><span class="line">   Thread t = Thread.currentThread();</span><br><span class="line">   UNSAFE.putLong(t, SEED, seed);</span><br><span class="line">   UNSAFE.putInt(t, PROBE, probe);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">threadLocalRandomProbeé‡æ–°ç”Ÿæˆ</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">advanceProbe</span><span class="params">(<span class="keyword">int</span> probe)</span> </span>&#123;</span><br><span class="line">   probe ^= probe &lt;&lt; <span class="number">13</span>;   <span class="comment">// xorshift</span></span><br><span class="line">   probe ^= probe &gt;&gt;&gt; <span class="number">17</span>;</span><br><span class="line">   probe ^= probe &lt;&lt; <span class="number">5</span>;</span><br><span class="line">   UNSAFE.putInt(Thread.currentThread(), PROBE, probe);</span><br><span class="line">   <span class="keyword">return</span> probe;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">æ–‡ç« ä½œè€…: </span><span class="post-copyright-info"><a href="https://lvxiaoyi.top">lvxiaoyi</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">æ–‡ç« é“¾æ¥: </span><span class="post-copyright-info"><a href="https://lvxiaoyi.top/b06b9560.html">https://lvxiaoyi.top/b06b9560.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">ç‰ˆæƒå£°æ˜: </span><span class="post-copyright-info">æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> è®¸å¯åè®®ã€‚è½¬è½½è¯·æ³¨æ˜æ¥è‡ª <a href="https://lvxiaoyi.top" target="_blank">å•å°åŒ»'s BLOG</a>ï¼</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/">å¤šçº¿ç¨‹</a></div><div class="post_share"><div class="social-share" data-image="https://img.lvxiaoyi.top/typora-img/thread-2-img/285763-20200617223221933-644434653.png/lvxiaoyi" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/969d9481.html"><img class="prev-cover" src="https://img.lvxiaoyi.top/typora-img/image-20210826103838080.png/lvxiaoyi" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">ä¸Šä¸€ç¯‡</div><div class="prev_info">CAS</div></div></a></div><div class="next-post pull-right"><a href="/dd88deb1.html"><img class="next-cover" src="https://pic2.zhimg.com/v2-9964d2894516902605191817111ec781_r.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">ä¸‹ä¸€ç¯‡</div><div class="next_info">å‰ç«¯ç¼–è¯‘å™¨å’Œåç«¯ç¼–è¯‘å™¨</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>ç›¸å…³æ¨è</span></div><div class="relatedPosts-list"><div><a href="/cd598d8d.html" title="AQSè¯¦è§£"><img class="cover" src="https://img.lvxiaoyi.top/typora-img/thread-2-img/285763-20200617223221933-644434653.png/lvxiaoyi" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-09-12</div><div class="title">AQSè¯¦è§£</div></div></a></div><div><a href="/969d9481.html" title="CAS"><img class="cover" src="https://img.lvxiaoyi.top/typora-img/image-20210826103838080.png/lvxiaoyi" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-09-12</div><div class="title">CAS</div></div></a></div><div><a href="/9fbd3b67.html" title="JOLä½¿ç”¨"><img class="cover" src="https://pic2.zhimg.com/v2-9964d2894516902605191817111ec781_r.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-09-12</div><div class="title">JOLä½¿ç”¨</div></div></a></div><div><a href="/9682c195.html" title="ReentrantLockåº•å±‚å®ç°åŸç†"><img class="cover" src="https://pic2.zhimg.com/v2-9964d2894516902605191817111ec781_r.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-09-12</div><div class="title">ReentrantLockåº•å±‚å®ç°åŸç†</div></div></a></div><div><a href="/597b16fc.html" title="ThreadLocalåŸç†"><img class="cover" src="https://img.lvxiaoyi.top/typora-img/thread-2-img/285763-20200617223221933-644434653.png/lvxiaoyi" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-09-12</div><div class="title">ThreadLocalåŸç†</div></div></a></div><div><a href="/77ed6e38.html" title="åå‘é”å››ç§’å»¶è¿Ÿæ¢ç©¶"><img class="cover" src="https://pic2.zhimg.com/v2-9964d2894516902605191817111ec781_r.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-09-12</div><div class="title">åå‘é”å››ç§’å»¶è¿Ÿæ¢ç©¶</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://p0.meituan.net/csc/8a1b1d488e6a8ab5108c9c78f36b3a1776955.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">lvxiaoyi</div><div class="author-info__description">ISFPåˆ°ESFJ</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">æ–‡ç« </div><div class="length-num">204</div></a><a href="/tags/"><div class="headline">æ ‡ç­¾</div><div class="length-num">26</div></a><a href="/categories/"><div class="headline">åˆ†ç±»</div><div class="length-num">50</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>å…¬å‘Š</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>ç›®å½•</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#LongAdder%E5%92%8CSync%E5%92%8CAtomic"><span class="toc-number">1.</span> <span class="toc-text">LongAdderå’ŒSyncå’ŒAtomic</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Atomic"><span class="toc-number">2.</span> <span class="toc-text">Atomic</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Atomic-%E5%8E%9F%E5%AD%90%E7%B1%BB%E4%BB%8B%E7%BB%8D"><span class="toc-number">2.1.</span> <span class="toc-text">Atomic åŸå­ç±»ä»‹ç»</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E7%B1%BB%E5%9E%8B%E5%8E%9F%E5%AD%90%E7%B1%BB"><span class="toc-number">2.2.</span> <span class="toc-text">åŸºæœ¬ç±»å‹åŸå­ç±»</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E7%B1%BB%E5%9E%8B%E5%8E%9F%E5%AD%90%E7%B1%BB%E4%BB%8B%E7%BB%8D"><span class="toc-number">2.2.1.</span> <span class="toc-text">åŸºæœ¬ç±»å‹åŸå­ç±»ä»‹ç»</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#AtomicInteger-%E5%B8%B8%E8%A7%81%E6%96%B9%E6%B3%95%E4%BD%BF%E7%94%A8"><span class="toc-number">2.2.2.</span> <span class="toc-text">AtomicInteger å¸¸è§æ–¹æ³•ä½¿ç”¨</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B%E5%8E%9F%E5%AD%90%E7%B1%BB%E7%9A%84%E4%BC%98%E5%8A%BF"><span class="toc-number">2.2.3.</span> <span class="toc-text">åŸºæœ¬æ•°æ®ç±»å‹åŸå­ç±»çš„ä¼˜åŠ¿</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#AtomicInteger-%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8%E5%8E%9F%E7%90%86%E7%AE%80%E5%8D%95%E5%88%86%E6%9E%90"><span class="toc-number">2.2.4.</span> <span class="toc-text">AtomicInteger çº¿ç¨‹å®‰å…¨åŸç†ç®€å•åˆ†æ</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B0%E7%BB%84%E7%B1%BB%E5%9E%8B%E5%8E%9F%E5%AD%90%E7%B1%BB"><span class="toc-number">2.3.</span> <span class="toc-text">æ•°ç»„ç±»å‹åŸå­ç±»</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B0%E7%BB%84%E7%B1%BB%E5%9E%8B%E5%8E%9F%E5%AD%90%E7%B1%BB%E4%BB%8B%E7%BB%8D"><span class="toc-number">2.3.1.</span> <span class="toc-text">æ•°ç»„ç±»å‹åŸå­ç±»ä»‹ç»</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#AtomicIntegerArray-%E5%B8%B8%E8%A7%81%E6%96%B9%E6%B3%95%E4%BD%BF%E7%94%A8"><span class="toc-number">2.3.2.</span> <span class="toc-text">AtomicIntegerArray å¸¸è§æ–¹æ³•ä½¿ç”¨</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BC%95%E7%94%A8%E7%B1%BB%E5%9E%8B%E5%8E%9F%E5%AD%90%E7%B1%BB"><span class="toc-number">2.4.</span> <span class="toc-text">å¼•ç”¨ç±»å‹åŸå­ç±»</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BC%95%E7%94%A8%E7%B1%BB%E5%9E%8B%E5%8E%9F%E5%AD%90%E7%B1%BB%E4%BB%8B%E7%BB%8D"><span class="toc-number">2.4.1.</span> <span class="toc-text">å¼•ç”¨ç±»å‹åŸå­ç±»ä»‹ç»</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#AtomicReference-%E7%B1%BB%E4%BD%BF%E7%94%A8%E7%A4%BA%E4%BE%8B"><span class="toc-number">2.4.2.</span> <span class="toc-text">AtomicReference ç±»ä½¿ç”¨ç¤ºä¾‹</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#AtomicStampedReference-%E7%B1%BB%E4%BD%BF%E7%94%A8%E7%A4%BA%E4%BE%8B"><span class="toc-number">2.4.3.</span> <span class="toc-text">AtomicStampedReference ç±»ä½¿ç”¨ç¤ºä¾‹</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#AtomicMarkableReference-%E7%B1%BB%E4%BD%BF%E7%94%A8%E7%A4%BA%E4%BE%8B"><span class="toc-number">2.4.4.</span> <span class="toc-text">AtomicMarkableReference ç±»ä½¿ç”¨ç¤ºä¾‹</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AF%B9%E8%B1%A1%E7%9A%84%E5%B1%9E%E6%80%A7%E4%BF%AE%E6%94%B9%E7%B1%BB%E5%9E%8B%E5%8E%9F%E5%AD%90%E7%B1%BB"><span class="toc-number">2.5.</span> <span class="toc-text">å¯¹è±¡çš„å±æ€§ä¿®æ”¹ç±»å‹åŸå­ç±»</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AF%B9%E8%B1%A1%E7%9A%84%E5%B1%9E%E6%80%A7%E4%BF%AE%E6%94%B9%E7%B1%BB%E5%9E%8B%E5%8E%9F%E5%AD%90%E7%B1%BB%E4%BB%8B%E7%BB%8D"><span class="toc-number">2.5.1.</span> <span class="toc-text">å¯¹è±¡çš„å±æ€§ä¿®æ”¹ç±»å‹åŸå­ç±»ä»‹ç»</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#AtomicIntegerFieldUpdater-%E7%B1%BB%E4%BD%BF%E7%94%A8%E7%A4%BA%E4%BE%8B"><span class="toc-number">2.5.2.</span> <span class="toc-text">AtomicIntegerFieldUpdater ç±»ä½¿ç”¨ç¤ºä¾‹</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#LongAdder"><span class="toc-number">3.</span> <span class="toc-text">LongAdder</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>æœ€æ–°æ–‡ç« </span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/7ef7bbd4.html" title="LeetCode 118. æ¨è¾‰ä¸‰è§’"><img src="https://img.lvxiaoyi.top/typora-img/202111011355394.png/lvxiaoyi" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="LeetCode 118. æ¨è¾‰ä¸‰è§’"/></a><div class="content"><a class="title" href="/7ef7bbd4.html" title="LeetCode 118. æ¨è¾‰ä¸‰è§’">LeetCode 118. æ¨è¾‰ä¸‰è§’</a><time datetime="2023-03-19T14:25:59.394Z" title="å‘è¡¨äº 2023-03-19 22:25:59">2023-03-19</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/82c8cab7.html" title="shellåŸºç¡€"><img src="https://pic2.zhimg.com/v2-9964d2894516902605191817111ec781_r.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="shellåŸºç¡€"/></a><div class="content"><a class="title" href="/82c8cab7.html" title="shellåŸºç¡€">shellåŸºç¡€</a><time datetime="2022-10-12T16:07:18.841Z" title="å‘è¡¨äº 2022-10-13 00:07:18">2022-10-13</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/f1601c3e.html" title="å•ä¾‹æ¨¡å¼"><img src="https://img.lvxiaoyi.top/typora-img/1002892-20180912131026735-781767905.png/lvxiaoyi" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="å•ä¾‹æ¨¡å¼"/></a><div class="content"><a class="title" href="/f1601c3e.html" title="å•ä¾‹æ¨¡å¼">å•ä¾‹æ¨¡å¼</a><time datetime="2022-09-12T07:22:48.777Z" title="å‘è¡¨äº 2022-09-12 15:22:48">2022-09-12</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/b15f0f1b.html" title="è®¾è®¡æ¨¡å¼åŸºç¡€-1"><img src="https://img.lvxiaoyi.top/typora-img/image-20211012093705433.png/lvxiaoyi" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="è®¾è®¡æ¨¡å¼åŸºç¡€-1"/></a><div class="content"><a class="title" href="/b15f0f1b.html" title="è®¾è®¡æ¨¡å¼åŸºç¡€-1">è®¾è®¡æ¨¡å¼åŸºç¡€-1</a><time datetime="2022-09-12T07:22:48.777Z" title="å‘è¡¨äº 2022-09-12 15:22:48">2022-09-12</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2109f677.html" title="è®¡ç®—æœºç½‘ç»œå¸¸è§é¢è¯•é¢˜"><img src="https://img.lvxiaoyi.top/typora-img/java-interview/1.png/lvxiaoyi" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="è®¡ç®—æœºç½‘ç»œå¸¸è§é¢è¯•é¢˜"/></a><div class="content"><a class="title" href="/2109f677.html" title="è®¡ç®—æœºç½‘ç»œå¸¸è§é¢è¯•é¢˜">è®¡ç®—æœºç½‘ç»œå¸¸è§é¢è¯•é¢˜</a><time datetime="2022-09-12T07:22:48.777Z" title="å‘è¡¨äº 2022-09-12 15:22:48">2022-09-12</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url('https://img.lvxiaoyi.top/typora-img/thread-2-img/285763-20200617223221933-644434653.png/lvxiaoyi')"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2023 By lvxiaoyi</div><div class="framework-info"><span>æ¡†æ¶ </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>ä¸»é¢˜ </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="é˜…è¯»æ¨¡å¼"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="æµ…è‰²å’Œæ·±è‰²æ¨¡å¼è½¬æ¢"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="å•æ å’ŒåŒæ åˆ‡æ¢"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="è®¾ç½®"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="ç›®å½•"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="å›åˆ°é¡¶éƒ¨"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">æœç´¢</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  æ•°æ®åº“åŠ è½½ä¸­</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="æœç´¢æ–‡ç« " type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"></div><canvas id="universe"></canvas><script defer src="/js/lvxiaoyi.js"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/metingjs/dist/Meting.min.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>